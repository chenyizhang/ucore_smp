cscope 15 $HOME/research/project/ucore_smp -q 0000002610 0000331271
	@boot/asm.h

1 #i‚de‡
__BOOT_ASM_H__


2 
	#__BOOT_ASM_H__


	)

7 
	#SEG_NULLASM
 \

8 .
w‹d
 0, 0; \

9 .
byã
 0, 0, 0, 0

	)

11 
	#SEG_ASM
(
ty≥
,
ba£
,
lim
) \

12 .
	`w‹d
 (((
lim
Ë>> 12Ë& 0xffff), ((
ba£
) & 0xffff); \

13 .
	`byã
 (((
ba£
Ë>> 16Ë& 0xff), (0x90 | (
ty≥
)), \

14 (0xC0 | (((
lim
Ë>> 28Ë& 0xf)), (((
ba£
Ë>> 24Ë& 0xff)

	)

18 
	#STA_X
 0x8

19 
	#STA_E
 0x4

20 
	#STA_C
 0x4

21 
	#STA_W
 0x2

22 
	#STA_R
 0x2

23 
	#STA_A
 0x1

24 

	)

	@boot/bootmain.c

1 
	~<defs.h
>

2 
	~<x86.h
>

3 
	~<ñf.h
>

33 
	#SECTSIZE
 512

	)

34 
	#ELFHDR
 ((
ñfhdr
 *)0x10000)

35 

	)

38 
	$waôdisk
() {

39 (
	`öb
(0x1F7) & 0xC0) != 0x40)

41 
	}
}

45 
	$ªad£˘
(*
d°
, 
uöt32_t
 
£˙o
) {

47 
	`waôdisk
();

49 
	`outb
(0x1F2, 1);

50 
	`outb
(0x1F3, 
£˙o
 & 0xFF);

51 
	`outb
(0x1F4, (
£˙o
 >> 8) & 0xFF);

52 
	`outb
(0x1F5, (
£˙o
 >> 16) & 0xFF);

53 
	`outb
(0x1F6, ((
£˙o
 >> 24) & 0xF) | 0xE0);

54 
	`outb
(0x1F7, 0x20);

57 
	`waôdisk
();

60 
	`ö¶
(0x1F0, 
d°
, 
SECTSIZE
 / 4);

61 
	}
}

68 
	$ªad£g
(
uöçå_t
 
va
, 
uöt32_t
 
cou¡
, uöt32_à
off£t
) {

69 
uöçå_t
 
íd_va
 = 
va
 + 
cou¡
;

72 
va
 -
off£t
 % 
SECTSIZE
;

75 
uöt32_t
 
£˙o
 = (
off£t
 / 
SECTSIZE
) + 1;

80 ; 
va
 < 
íd_va
; v®+
SECTSIZE
, 
£˙o
 ++) {

81 
	`ªad£˘
((*)
va
, 
£˙o
);

83 
	}
}

87 
	$boŸmaö
() {

89 
	`ªad£g
((
uöçå_t
)
ELFHDR
, 
SECTSIZE
 * 8, 0);

92 i‡(
ELFHDR
->
e_magic
 !
ELF_MAGIC
) {

93 
bad
;

96 
¥oghdr
 *
ph
, *
ïh
;

99 
ph
 = (
¥oghdr
 *)((
uöçå_t
)
ELFHDR
 + ELFHDR->
e_phoff
);

100 
ïh
 = 
ph
 + 
ELFHDR
->
e_phnum
;

101 ; 
ph
 < 
ïh
;Öh ++) {

102 
	`ªad£g
(
ph
->
p_va
 & 0xFFFFFF,Öh->
p_memsz
,Öh->
p_off£t
);

107 (((*)())(
ELFHDR
->
e_íåy
 & 0xFFFFFF))();

109 
bad
:

110 
	`outw
(0x8A00, 0x8A00);

111 
	`outw
(0x8A00, 0x8E00);

115 
	}
}

	@kern/debug/assert.h

1 #i‚de‡
__KERN_DEBUG_ASSERT_H__


2 
	#__KERN_DEBUG_ASSERT_H__


	)

4 
	~<defs.h
>

6 
__w¨n
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
, ...);

7 
__n‹ëu∫
 
__∑nic
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
, ...);

9 
	#w¨n
(...) \

10 
	`__w¨n
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

12 
	#∑nic
(...) \

13 
	`__∑nic
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

15 
	#as£π
(
x
) \

17 i‡(!(
x
)) { \

18 
	`∑nic
("assertion failed: %s", #x); \

20 } 0)

	)

23 
	#°©ic_as£π
(
x
) \

24 
x
Ë{ 0: (x): ; }

	)

	@kern/debug/kdebug.c

1 
	~<defs.h
>

2 
	~<x86.h
>

3 
	~<°ab.h
>

4 
	~<°dio.h
>

5 
	~<°rög.h
>

6 
	~<memœyout.h
>

7 
	~<sync.h
>

8 
	~<vmm.h
>

9 
	~<¥oc.h
>

10 
	~<kdebug.h
>

11 
	~<km⁄ô‹.h
>

12 
	~<as£π.h
>

14 
	#STACKFRAME_DEPTH
 20

	)

16 c⁄° 
°ab
 
__STAB_BEGIN__
[];

17 c⁄° 
°ab
 
__STAB_END__
[];

18 c⁄° 
__STABSTR_BEGIN__
[];

19 c⁄° 
__STABSTR_END__
[];

22 
	seùdebugöfo
 {

23 c⁄° *
	meù_fûe
;

24 
	meù_löe
;

25 c⁄° *
	meù_‚_«me
;

26 
	meù_‚_«mñí
;

27 
uöçå_t
 
	meù_‚_addr
;

28 
	meù_‚_«rg
;

32 
	su£r°abd©a
 {

33 c⁄° 
°ab
 *
	m°abs
;

34 c⁄° 
°ab
 *
	m°ab_íd
;

35 c⁄° *
	m°ab°r
;

36 c⁄° *
	m°ab°r_íd
;

81 
	$°ab_bö£¨ch
(c⁄° 
°ab
 *
°abs
, *
ªgi⁄_À·
, *
ªgi⁄_right
,

82 
ty≥
, 
uöçå_t
 
addr
) {

83 
l
 = *
ªgi⁄_À·
, 
r
 = *
ªgi⁄_right
, 
™y_m©ches
 = 0;

85 
l
 <
r
) {

86 
åue_m
 = (
l
 + 
r
Ë/ 2, 
m
 =Årue_m;

89 
m
 >
l
 && 
°abs
[m].
n_ty≥
 !
ty≥
) {

90 
m
 --;

92 i‡(
m
 < 
l
) {

93 
l
 = 
åue_m
 + 1;

98 
™y_m©ches
 = 1;

99 i‡(
°abs
[
m
].
n_vÆue
 < 
addr
) {

100 *
ªgi⁄_À·
 = 
m
;

101 
l
 = 
åue_m
 + 1;

102 } i‡(
°abs
[
m
].
n_vÆue
 > 
addr
) {

103 *
ªgi⁄_right
 = 
m
 - 1;

104 
r
 = 
m
 - 1;

108 *
ªgi⁄_À·
 = 
m
;

109 
l
 = 
m
;

110 
addr
 ++;

114 i‡(!
™y_m©ches
) {

115 *
ªgi⁄_right
 = *
ªgi⁄_À·
 - 1;

119 
l
 = *
ªgi⁄_right
;

120 ; 
l
 > *
ªgi⁄_À·
 && 
°abs
[l].
n_ty≥
 !
ty≥
;Ü --)

122 *
ªgi⁄_À·
 = 
l
;

124 
	}
}

133 
	$debugöfo_eù
(
uöçå_t
 
addr
, 
eùdebugöfo
 *
öfo
) {

134 c⁄° 
°ab
 *
°abs
, *
°ab_íd
;

135 c⁄° *
°ab°r
, *
°ab°r_íd
;

137 
öfo
->
eù_fûe
 = "<unknown>";

138 
öfo
->
eù_löe
 = 0;

139 
öfo
->
eù_‚_«me
 = "<unknown>";

140 
öfo
->
eù_‚_«mñí
 = 9;

141 
öfo
->
eù_‚_addr
 = 
addr
;

142 
öfo
->
eù_‚_«rg
 = 0;

145 i‡(
addr
 >
KERNBASE
) {

146 
°abs
 = 
__STAB_BEGIN__
;

147 
°ab_íd
 = 
__STAB_END__
;

148 
°ab°r
 = 
__STABSTR_BEGIN__
;

149 
°ab°r_íd
 = 
__STABSTR_END__
;

155 c⁄° 
u£r°abd©a
 *
usd
 = (u£r°abd©®*)
USTAB
;

158 
mm_°ru˘
 *
mm
;

159 i‡(
cuºít
 =
NULL
 || (
mm
 = current->mm) == NULL) {

162 i‡(!
	`u£r_mem_check
(
mm
, (
uöçå_t
)
usd
, (
u£r°abd©a
), 0)) {

166 
°abs
 = 
usd
->stabs;

167 
°ab_íd
 = 
usd
->stab_end;

168 
°ab°r
 = 
usd
->stabstr;

169 
°ab°r_íd
 = 
usd
->stabstr_end;

172 i‡(!
	`u£r_mem_check
(
mm
, (
uöçå_t
)
°abs
, (uöçå_t)
°ab_íd
 - (uintptr_t)stabs, 0)) {

175 i‡(!
	`u£r_mem_check
(
mm
, (
uöçå_t
)
°ab°r
, 
°ab°r_íd
 - stabstr, 0)) {

181 i‡(
°ab°r_íd
 <
°ab°r
 || stabstr_end[-1] != 0) {

191 
lfûe
 = 0, 
rfûe
 = (
°ab_íd
 - 
°abs
) - 1;

192 
	`°ab_bö£¨ch
(
°abs
, &
lfûe
, &
rfûe
, 
N_SO
, 
addr
);

193 i‡(
lfûe
 == 0)

198 
lfun
 = 
lfûe
, 
rfun
 = 
rfûe
;

199 
Œöe
, 
æöe
;

200 
	`°ab_bö£¨ch
(
°abs
, &
lfun
, &
rfun
, 
N_FUN
, 
addr
);

202 i‡(
lfun
 <
rfun
) {

205 i‡(
°abs
[
lfun
].
n_°rx
 < 
°ab°r_íd
 - 
°ab°r
) {

206 
öfo
->
eù_‚_«me
 = 
°ab°r
 + 
°abs
[
lfun
].
n_°rx
;

208 
öfo
->
eù_‚_addr
 = 
°abs
[
lfun
].
n_vÆue
;

209 
addr
 -
öfo
->
eù_‚_addr
;

211 
Œöe
 = 
lfun
;

212 
æöe
 = 
rfun
;

216 
öfo
->
eù_‚_addr
 = 
addr
;

217 
Œöe
 = 
lfûe
;

218 
æöe
 = 
rfûe
;

220 
öfo
->
eù_‚_«mñí
 = 
	`°rföd
(öfo->
eù_‚_«me
, ':') - info->eip_fn_name;

225 
	`°ab_bö£¨ch
(
°abs
, &
Œöe
, &
æöe
, 
N_SLINE
, 
addr
);

226 i‡(
Œöe
 <
æöe
) {

227 
öfo
->
eù_löe
 = 
°abs
[
æöe
].
n_desc
;

236 
Œöe
 >
lfûe


237 && 
°abs
[
Œöe
].
n_ty≥
 !
N_SOL


238 && (
°abs
[
Œöe
].
n_ty≥
 !
N_SO
 || !°abs[Œöe].
n_vÆue
)) {

239 
Œöe
 --;

241 i‡(
Œöe
 >
lfûe
 && 
°abs
[Œöe].
n_°rx
 < 
°ab°r_íd
 - 
°ab°r
) {

242 
öfo
->
eù_fûe
 = 
°ab°r
 + 
°abs
[
Œöe
].
n_°rx
;

247 i‡(
lfun
 < 
rfun
) {

248 
Œöe
 = 
lfun
 + 1;

249 
Œöe
 < 
rfun
 && 
°abs
[Œöe].
n_ty≥
 =
N_PSYM
;

250 
Œöe
 ++) {

251 
öfo
->
eù_‚_«rg
 ++;

255 
	}
}

263 
	$¥öt_kînöfo
() {

264 
ëext
[], 
ed©a
[], 
íd
[], 
kîn_öô
[];

265 
	`˝rötf
("Special kernel symbols:\n");

266 
	`˝rötf
("É¡ry 0x%08x (phys)\n", 
kîn_öô
);

267 
	`˝rötf
("Éãxà 0x%08x (phys)\n", 
ëext
);

268 
	`˝rötf
("Éd©® 0x%08x (phys)\n", 
ed©a
);

269 
	`˝rötf
("Énd 0x%08x (phys)\n", 
íd
);

270 
	`˝rötf
("Kî√»execuèbÀ mem‹y foŸ¥öt: %dKB\n", (
íd
 - 
kîn_öô
 + 1023)/1024);

271 
	}
}

278 
	$¥öt_debugöfo
(
uöçå_t
 
eù
) {

279 
eùdebugöfo
 
öfo
;

280 i‡(
	`debugöfo_eù
(
eù
, &
öfo
) != 0) {

281 
	`˝rötf
(" <unknow>: -- 0x%08x --\n", 
eù
);

284 
‚«me
[256];

285 
j
;

286 
j
 = 0; j < 
öfo
.
eù_‚_«mñí
; j ++) {

287 
‚«me
[
j
] = 
öfo
.
eù_‚_«me
[j];

289 
‚«me
[
j
] = '\0';

290 
	`˝rötf
(" %s:%d: %s+%d\n", 
öfo
.
eù_fûe
, info.
eù_löe
,

291 
‚«me
, 
eù
 - 
öfo
.
eù_‚_addr
);

293 
	}
}

295 
__noölöe
 
uöt32_t


296 
	$ªad_eù
() {

297 
uöt32_t
 
eù
;

298 
asm
 vﬁ©ûe("mov»4(%%ebp), %0" : "Ù" (
eù
));

299  
eù
;

300 
	}
}

337 
	$¥öt_°ack‰ame
() {

350 
uöt32_t
 
ebp
 = 
	`ªad_ebp
(), 
eù
 = 
	`ªad_eù
();

352 
i
, 
j
;

353 
i
 = 0; 
ebp
 !0 && i < 
STACKFRAME_DEPTH
; i ++) {

354 
	`˝rötf
("ebp:0x%08xÉù:0x%08xárgs:", 
ebp
, 
eù
);

355 
uöt32_t
 *
¨gs
 = (uöt32_à*)
ebp
 + 2;

356 
j
 = 0; j < 4; j ++) {

357 
	`˝rötf
("0x%08x ", 
¨gs
[
j
]);

359 
	`˝rötf
("\n");

360 
	`¥öt_debugöfo
(
eù
 - 1);

361 
eù
 = ((
uöt32_t
 *)
ebp
)[1];

362 
ebp
 = ((
uöt32_t
 *)ebp)[0];

364 
	}
}

	@kern/debug/kdebug.h

1 #i‚de‡
__KERN_DEBUG_KDEBUG_H__


2 
	#__KERN_DEBUG_KDEBUG_H__


	)

4 
	~<defs.h
>

5 
	~<å≠.h
>

7 
¥öt_kînöfo
();

8 
¥öt_°ack‰ame
();

9 
¥öt_debugöfo
(
uöçå_t
 
eù
);

	@kern/debug/kmonitor.c

1 
	~<°dio.h
>

2 
	~<°rög.h
>

3 
	~<mmu.h
>

4 
	~<å≠.h
>

5 
	~<km⁄ô‹.h
>

6 
	~<kdebug.h
>

13 
	scomm™d
 {

14 c⁄° *
	m«me
;

15 c⁄° *
	mdesc
;

17 (*
	mfunc
)(
	m¨gc
, **
	m¨gv
, 
å≠‰ame
 *
	mtf
);

20 
comm™d
 
	gcomm™ds
[] = {

21 {"hñp", "Di•œyÅhi†li° o‡comm™ds.", 
m⁄_hñp
},

22 {"kînöfo", "Di•œy inf‹m©i⁄ábouàthêkî√l.", 
m⁄_kînöfo
},

23 {"backåa˚", "Pröàbackåa˚ o‡°ack føme.", 
m⁄_backåa˚
},

27 
boﬁ
 
is_kî√l_∑nic
();

29 
	#NCOMMANDS
 ((
comm™ds
)/(
comm™d
))

	)

33 
	#MAXARGS
 16

	)

34 
	#WHITESPACE
 " \t\n\r"

	)

38 
	$∑r£
(*
buf
, **
¨gv
) {

39 
¨gc
 = 0;

42 *
buf
 !'\0' && 
	`°rchr
(
WHITESPACE
, *bufË!
NULL
) {

43 *
buf
 ++ = '\0';

45 i‡(*
buf
 == '\0') {

50 i‡(
¨gc
 =
MAXARGS
 - 1) {

51 
	`˝rötf
("Toÿm™yárgumít†(max %d).\n", 
MAXARGS
);

53 
¨gv
[
¨gc
 ++] = 
buf
;

54 *
buf
 !'\0' && 
	`°rchr
(
WHITESPACE
, *bufË=
NULL
) {

55 
buf
 ++;

58  
¨gc
;

59 
	}
}

66 
	$runcmd
(*
buf
, 
å≠‰ame
 *
tf
) {

67 *
¨gv
[
MAXARGS
];

68 
¨gc
 = 
	`∑r£
(
buf
, 
¨gv
);

69 i‡(
¨gc
 == 0) {

72 
i
;

73 
i
 = 0; i < 
NCOMMANDS
; i ++) {

74 i‡(
	`°rcmp
(
comm™ds
[
i
].
«me
, 
¨gv
[0]) == 0) {

75  
comm™ds
[
i
].
	`func
(
¨gc
 - 1, 
¨gv
 + 1, 
tf
);

78 
	`˝rötf
("Unknow¿comm™d '%s'\n", 
¨gv
[0]);

80 
	}
}

85 
	$km⁄ô‹
(
å≠‰ame
 *
tf
) {

86 
	`˝rötf
("WelcomeÅoÅhe kernel debug monitor!!\n");

87 
	`˝rötf
("Type 'help' foráÜist of commands.\n");

89 i‡(
tf
 !
NULL
) {

90 
	`¥öt_å≠‰ame
(
tf
);

93 *
buf
;

95 i‡((
buf
 = 
	`ªadlöe
("K> ")Ë!
NULL
) {

96 i‡(
	`runcmd
(
buf
, 
tf
) < 0) {

101 
	}
}

105 
	$m⁄_hñp
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
) {

106 
i
;

107 
i
 = 0; i < 
NCOMMANDS
; i ++) {

108 
	`˝rötf
("%†- %s\n", 
comm™ds
[
i
].
«me
, comm™ds[i].
desc
);

111 
	}
}

118 
	$m⁄_kînöfo
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
) {

119 
	`¥öt_kînöfo
();

121 
	}
}

128 
	$m⁄_backåa˚
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
) {

129 
	`¥öt_°ack‰ame
();

131 
	}
}

	@kern/debug/kmonitor.h

1 #i‚de‡
__KERN_DEBUG_MONITOR_H__


2 
	#__KERN_DEBUG_MONITOR_H__


	)

4 
	~<å≠.h
>

6 
km⁄ô‹
(
å≠‰ame
 *
tf
);

8 
m⁄_hñp
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
);

9 
m⁄_kînöfo
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
);

10 
m⁄_backåa˚
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
);

11 
m⁄_c⁄töue
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
);

12 
m⁄_°ï
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
);

13 
m⁄_bªakpoöt
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
);

14 
m⁄_w©chpoöt
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
);

15 
m⁄_dñëe_dr
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
);

16 
m⁄_li°_dr
(
¨gc
, **
¨gv
, 
å≠‰ame
 *
tf
);

	@kern/debug/panic.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<öå.h
>

4 
	~<km⁄ô‹.h
>

6 
boﬁ
 
	gis_∑nic
 = 0;

13 
	$__∑nic
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
, ...) {

14 i‡(
is_∑nic
) {

15 
∑nic_dód
;

17 
is_∑nic
 = 1;

20 
va_li°
 
≠
;

21 
	`va_°¨t
(
≠
, 
fmt
);

22 
	`˝rötf
("kî√»∑ni¯© %s:%d:\¿ ", 
fûe
, 
löe
);

23 
	`v˝rötf
(
fmt
, 
≠
);

24 
	`˝rötf
("\n");

25 
	`va_íd
(
≠
);

27 
∑nic_dód
:

28 
	`öå_dißbÀ
();

30 
	`km⁄ô‹
(
NULL
);

32 
	}
}

36 
	$__w¨n
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
, ...) {

37 
va_li°
 
≠
;

38 
	`va_°¨t
(
≠
, 
fmt
);

39 
	`˝rötf
("kî√»w¨nögáà%s:%d:\¿ ", 
fûe
, 
löe
);

40 
	`v˝rötf
(
fmt
, 
≠
);

41 
	`˝rötf
("\n");

42 
	`va_íd
(
≠
);

43 
	}
}

45 
boﬁ


46 
	$is_kî√l_∑nic
() {

47  
is_∑nic
;

48 
	}
}

	@kern/debug/stab.h

1 #i‚de‡
__KERN_DEBUG_STAB_H__


2 
	#__KERN_DEBUG_STAB_H__


	)

4 
	~<defs.h
>

17 
	#N_GSYM
 0x20

18 
	#N_FNAME
 0x22

19 
	#N_FUN
 0x24

20 
	#N_STSYM
 0x26

21 
	#N_LCSYM
 0x28

22 
	#N_MAIN
 0x2a

23 
	#N_PC
 0x30

24 
	#N_RSYM
 0x40

25 
	#N_SLINE
 0x44

26 
	#N_DSLINE
 0x46

27 
	#N_BSLINE
 0x48

28 
	#N_SSYM
 0x60

29 
	#N_SO
 0x64

30 
	#N_LSYM
 0x80

31 
	#N_BINCL
 0x82

32 
	#N_SOL
 0x84

33 
	#N_PSYM
 0xa0

34 
	#N_EINCL
 0xa2

35 
	#N_ENTRY
 0xa4

36 
	#N_LBRAC
 0xc0

37 
	#N_EXCL
 0xc2

38 
	#N_RBRAC
 0xe0

39 
	#N_BCOMM
 0xe2

40 
	#N_ECOMM
 0xe4

41 
	#N_ECOML
 0xe8

42 
	#N_LENG
 0xfe

43 

	)

45 
	s°ab
 {

46 
uöt32_t
 
	mn_°rx
;

47 
uöt8_t
 
	mn_ty≥
;

48 
uöt8_t
 
	mn_Ÿhî
;

49 
uöt16_t
 
	mn_desc
;

50 
uöçå_t
 
	mn_vÆue
;

	@kern/driver/clock.c

1 
	~<x86.h
>

2 
	~<å≠.h
>

3 
	~<°dio.h
>

4 
	~<picúq.h
>

11 
	#IO_TIMER1
 0x040

12 

	)

18 
	#TIMER_FREQ
 1193182

	)

19 
	#TIMER_DIV
(
x
Ë((
TIMER_FREQ
 + (xË/ 2Ë/ (x))

	)

21 
	#TIMER_MODE
 (
IO_TIMER1
 + 3)

22 
	#TIMER_SEL0
 0x00

23 
	#TIMER_RATEGEN
 0x04

24 
	#TIMER_16BIT
 0x30

25 

	)

26 vﬁ©ûê
size_t
 
	gticks
;

28 
	$SYSTEM_READ_TIMER
( ){

29  
ticks
;

30 
	}
}

37 
	$˛ock_öô
() {

39 
	`outb
(
TIMER_MODE
, 
TIMER_SEL0
 | 
TIMER_RATEGEN
 | 
TIMER_16BIT
);

40 
	`outb
(
IO_TIMER1
, 
	`TIMER_DIV
(100) % 256);

41 
	`outb
(
IO_TIMER1
, 
	`TIMER_DIV
(100) / 256);

44 
ticks
 = 0;

46 
	`˝rötf
("++ setupÅimer interrupts\n");

47 
	`pic_íabÀ
(
IRQ_TIMER
);

48 
	`iﬂpi˚«bÀ
(
IRQ_TIMER
,0);

49 
	}
}

	@kern/driver/clock.h

1 #i‚de‡
__KERN_DRIVER_CLOCK_H__


2 
	#__KERN_DRIVER_CLOCK_H__


	)

4 
	~<defs.h
>

6 vﬁ©ûê
size_t
 
ticks
;

8 
˛ock_öô
();

10 
SYSTEM_READ_TIMER
( );

	@kern/driver/console.c

1 
	~<defs.h
>

2 
	~<x86.h
>

3 
	~<°dio.h
>

4 
	~<°rög.h
>

5 
	~<kbdªg.h
>

6 
	~<picúq.h
>

7 
	~<å≠.h
>

8 
	~<memœyout.h
>

9 
	~<sync.h
>

10 
	~<iﬂpic.h
>

14 
	$dñay
() {

15 
	`öb
(0x84);

16 
	`öb
(0x84);

17 
	`öb
(0x84);

18 
	`öb
(0x84);

19 
	}
}

22 
	#COM1
 0x3F8

	)

24 
	#COM_RX
 0

25 
	#COM_TX
 0

26 
	#COM_DLL
 0

27 
	#COM_DLM
 1

28 
	#COM_IER
 1

29 
	#COM_IER_RDI
 0x01

30 
	#COM_IIR
 2

31 
	#COM_FCR
 2

32 
	#COM_LCR
 3

33 
	#COM_LCR_DLAB
 0x80

34 
	#COM_LCR_WLEN8
 0x03

35 
	#COM_MCR
 4

36 
	#COM_MCR_RTS
 0x02

37 
	#COM_MCR_DTR
 0x01

38 
	#COM_MCR_OUT2
 0x08

39 
	#COM_LSR
 5

40 
	#COM_LSR_DATA
 0x01

41 
	#COM_LSR_TXRDY
 0x20

42 
	#COM_LSR_TSRE
 0x40

43 

	)

44 
	#MONO_BASE
 0x3B4

	)

45 
	#MONO_BUF
 0xB0000

	)

46 
	#CGA_BASE
 0x3D4

	)

47 
	#CGA_BUF
 0xB8000

	)

48 
	#CRT_ROWS
 25

	)

49 
	#CRT_COLS
 80

	)

50 
	#CRT_SIZE
 (
CRT_ROWS
 * 
CRT_COLS
)

	)

52 
	#LPTPORT
 0x378

	)

54 
uöt16_t
 *
	g¸t_buf
;

55 
uöt16_t
 
	g¸t_pos
;

56 
uöt16_t
 
	gaddr_6845
;

61 
	$cga_öô
() {

62 vﬁ©ûê
uöt16_t
 *
˝
 = (uöt16_à*)(
CGA_BUF
 + 
KERNBASE
);

63 
uöt16_t
 
was
 = *
˝
;

64 *
˝
 = (
uöt16_t
) 0xA55A;

65 i‡(*
˝
 != 0xA55A) {

66 
˝
 = (
uöt16_t
*)(
MONO_BUF
 + 
KERNBASE
);

67 
addr_6845
 = 
MONO_BASE
;

69 *
˝
 = 
was
;

70 
addr_6845
 = 
CGA_BASE
;

74 
uöt32_t
 
pos
;

75 
	`outb
(
addr_6845
, 14);

76 
pos
 = 
	`öb
(
addr_6845
 + 1) << 8;

77 
	`outb
(
addr_6845
, 15);

78 
pos
 |
	`öb
(
addr_6845
 + 1);

80 
¸t_buf
 = (
uöt16_t
*Ë
˝
;

81 
¸t_pos
 = 
pos
;

82 
	}
}

84 
boﬁ
 
	g£rül_exi°s
 = 0;

87 
	$£rül_öô
() {

89 
	`outb
(
COM1
 + 
COM_FCR
, 0);

92 
	`outb
(
COM1
 + 
COM_LCR
, 
COM_LCR_DLAB
);

93 
	`outb
(
COM1
 + 
COM_DLL
, (
uöt8_t
) (115200 / 9600));

94 
	`outb
(
COM1
 + 
COM_DLM
, 0);

97 
	`outb
(
COM1
 + 
COM_LCR
, 
COM_LCR_WLEN8
 & ~
COM_LCR_DLAB
);

100 
	`outb
(
COM1
 + 
COM_MCR
, 0);

102 
	`outb
(
COM1
 + 
COM_IER
, 
COM_IER_RDI
);

106 
£rül_exi°s
 = (
	`öb
(
COM1
 + 
COM_LSR
) != 0xFF);

107 (Ë
	`öb
(
COM1
+
COM_IIR
);

108 (Ë
	`öb
(
COM1
+
COM_RX
);

110 i‡(
£rül_exi°s
) {

111 
	`pic_íabÀ
(
IRQ_COM1
);

112 
	`iﬂpi˚«bÀ
(
IRQ_COM1
, 0);

114 
	}
}

117 
	$Õt_putc_sub
(
c
) {

118 
i
;

119 
i
 = 0; !(
	`öb
(
LPTPORT
 + 1) & 0x80) && i < 12800; i ++) {

120 
	`dñay
();

122 
	`outb
(
LPTPORT
 + 0, 
c
);

123 
	`outb
(
LPTPORT
 + 2, 0x08 | 0x04 | 0x01);

124 
	`outb
(
LPTPORT
 + 2, 0x08);

125 
	}
}

129 
	$Õt_putc
(
c
) {

130 i‡(
c
 != '\b') {

131 
	`Õt_putc_sub
(
c
);

134 
	`Õt_putc_sub
('\b');

135 
	`Õt_putc_sub
(' ');

136 
	`Õt_putc_sub
('\b');

138 
	}
}

142 
	$cga_putc
(
c
) {

144 i‡(!(
c
 & ~0xFF)) {

145 
c
 |= 0x0700;

148 
c
 & 0xff) {

150 i‡(
¸t_pos
 > 0) {

151 
¸t_pos
 --;

152 
¸t_buf
[
¸t_pos
] = (
c
 & ~0xff) | ' ';

156 
¸t_pos
 +
CRT_COLS
;

158 
¸t_pos
 -(¸t_po†% 
CRT_COLS
);

161 
¸t_buf
[
¸t_pos
 ++] = 
c
;

166 i‡(
¸t_pos
 >
CRT_SIZE
) {

167 
i
;

168 
	`memmove
(
¸t_buf
, cπ_bu‡+ 
CRT_COLS
, (
CRT_SIZE
 - CRT_COLSË* (
uöt16_t
));

169 
i
 = 
CRT_SIZE
 - 
CRT_COLS
; i < CRT_SIZE; i ++) {

170 
¸t_buf
[
i
] = 0x0700 | ' ';

172 
¸t_pos
 -
CRT_COLS
;

176 
	`outb
(
addr_6845
, 14);

177 
	`outb
(
addr_6845
 + 1, 
¸t_pos
 >> 8);

178 
	`outb
(
addr_6845
, 15);

179 
	`outb
(
addr_6845
 + 1, 
¸t_pos
);

180 
	}
}

183 
	$£rül_putc_sub
(
c
) {

184 
i
;

185 
i
 = 0; !(
	`öb
(
COM1
 + 
COM_LSR
Ë& 
COM_LSR_TXRDY
) && i < 12800; i ++) {

186 
	`dñay
();

188 
	`outb
(
COM1
 + 
COM_TX
, 
c
);

189 
	}
}

193 
	$£rül_putc
(
c
) {

194 i‡(
c
 != '\b') {

195 
	`£rül_putc_sub
(
c
);

198 
	`£rül_putc_sub
('\b');

199 
	`£rül_putc_sub
(' ');

200 
	`£rül_putc_sub
('\b');

202 
	}
}

210 
	#CONSBUFSIZE
 512

	)

213 
uöt8_t
 
	mbuf
[
CONSBUFSIZE
];

214 
uöt32_t
 
	mΩos
;

215 
uöt32_t
 
	mwpos
;

216 } 
	gc⁄s
;

223 
c⁄s_öå
((*
¥oc
)()) {

224 
c
;

225 (
c
 = (*
¥oc
)()) != -1) {

226 i‡(
c
 != 0) {

227 
c⁄s
.
buf
[c⁄s.
wpos
 ++] = 
c
;

228 i‡(
c⁄s
.
wpos
 =
CONSBUFSIZE
) {

229 
c⁄s
.
wpos
 = 0;

233 
	}
}

237 
	$£rül_¥oc_d©a
() {

238 i‡(!(
	`öb
(
COM1
 + 
COM_LSR
Ë& 
COM_LSR_DATA
)) {

241 
c
 = 
	`öb
(
COM1
 + 
COM_RX
);

242 i‡(
c
 == 127) {

243 
c
 = '\b';

245  
c
;

246 
	}
}

250 
	$£rül_öå
() {

251 i‡(
£rül_exi°s
) {

252 
	`c⁄s_öå
(
£rül_¥oc_d©a
);

254 
	}
}

258 
	#NO
 0

	)

260 
	#SHIFT
 (1<<0)

	)

261 
	#CTL
 (1<<1)

	)

262 
	#ALT
 (1<<2)

	)

264 
	#CAPSLOCK
 (1<<3)

	)

265 
	#NUMLOCK
 (1<<4)

	)

266 
	#SCROLLLOCK
 (1<<5)

	)

268 
	#E0ESC
 (1<<6)

	)

270 
uöt8_t
 
	gshi·code
[256] = {

271 [0x1D] 
CTL
,

272 [0x2A] 
SHIFT
,

273 [0x36] 
SHIFT
,

274 [0x38] 
ALT
,

275 [0x9D] 
CTL
,

276 [0xB8] 
ALT


279 
uöt8_t
 
	gtoggÀcode
[256] = {

280 [0x3A] 
CAPSLOCK
,

281 [0x45] 
NUMLOCK
,

282 [0x46] 
SCROLLLOCK


285 
uöt8_t
 
	gn‹mÆm≠
[256] = {

286 
NO
, 0x1B, '1', '2', '3', '4', '5', '6',

289 'o', 'p', '[', ']', '\n', 
NO
, 'a', 's',

291 '\'', '`', 
NO
, '\\', 'z', 'x', 'c', 'v',

292 'b', 'n', 'm', ',', '.', '/', 
NO
, '*',

293 
NO
, ' ', NO, NO, NO, NO, NO, NO,

294 
NO
, NO, NO, NO, NO, NO, NO, '7',

296 '2', '3', '0', '.', 
NO
, NO, NO, NO,

297 [0xC7] 
KEY_HOME
, [0x9C] '\n' ,

298 [0xB5] '/' , [0xC8] 
KEY_UP
,

299 [0xC9] 
KEY_PGUP
, [0xCB] 
KEY_LF
,

300 [0xCD] 
KEY_RT
, [0xCF] 
KEY_END
,

301 [0xD0] 
KEY_DN
, [0xD1] 
KEY_PGDN
,

302 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL


305 
uöt8_t
 
	gshi·m≠
[256] = {

306 
NO
, 033, '!', '@', '#', '$', '%', '^',

309 'O', 'P', '{', '}', '\n', 
NO
, 'A', 'S',

311 '"', '~', 
NO
, '|', 'Z', 'X', 'C', 'V',

312 'B', 'N', 'M', '<', '>', '?', 
NO
, '*',

313 
NO
, ' ', NO, NO, NO, NO, NO, NO,

314 
NO
, NO, NO, NO, NO, NO, NO, '7',

316 '2', '3', '0', '.', 
NO
, NO, NO, NO,

317 [0xC7] 
KEY_HOME
, [0x9C] '\n' ,

318 [0xB5] '/' , [0xC8] 
KEY_UP
,

319 [0xC9] 
KEY_PGUP
, [0xCB] 
KEY_LF
,

320 [0xCD] 
KEY_RT
, [0xCF] 
KEY_END
,

321 [0xD0] 
KEY_DN
, [0xD1] 
KEY_PGDN
,

322 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL


325 
	#C
(
x
Ë(x - '@')

	)

327 
uöt8_t
 
	g˘lm≠
[256] = {

328 
NO
, NO, NO, NO, NO, NO, NO, NO,

329 
NO
, NO, NO, NO, NO, NO, NO, NO,

330 
C
('Q'), C('W'), C('E'), C('R'), C('T'), C('Y'), C('U'), C('I'),

331 
C
('O'), C('P'), 
NO
, NO, '\r', NO, C('A'), C('S'),

332 
C
('D'), C('F'), C('G'), C('H'), C('J'), C('K'), C('L'), 
NO
,

333 
NO
, NO, NO, 
C
('\\'), C('Z'), C('X'), C('C'), C('V'),

334 
C
('B'), C('N'), C('M'), 
NO
, NO, C('/'), NO, NO,

335 [0x97] 
KEY_HOME
,

336 [0xB5] 
C
('/'), [0xC8] 
KEY_UP
,

337 [0xC9] 
KEY_PGUP
, [0xCB] 
KEY_LF
,

338 [0xCD] 
KEY_RT
, [0xCF] 
KEY_END
,

339 [0xD0] 
KEY_DN
, [0xD1] 
KEY_PGDN
,

340 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL


343 
uöt8_t
 *
	gch¨code
[4] = {

344 
n‹mÆm≠
,

345 
shi·m≠
,

346 
˘lm≠
,

347 
˘lm≠


357 
	$kbd_¥oc_d©a
() {

358 
c
;

359 
uöt8_t
 
d©a
;

360 
uöt32_t
 
shi·
;

362 i‡((
	`öb
(
KBSTATP
Ë& 
KBS_DIB
) == 0) {

366 
d©a
 = 
	`öb
(
KBDATAP
);

368 i‡(
d©a
 == 0xE0) {

370 
shi·
 |
E0ESC
;

372 } i‡(
d©a
 & 0x80) {

374 
d©a
 = (
shi·
 & 
E0ESC
 ? data : data & 0x7F);

375 
shi·
 &~(
shi·code
[
d©a
] | 
E0ESC
);

377 } i‡(
shi·
 & 
E0ESC
) {

379 
d©a
 |= 0x80;

380 
shi·
 &~
E0ESC
;

383 
shi·
 |
shi·code
[
d©a
];

384 
shi·
 ^
toggÀcode
[
d©a
];

386 
c
 = 
ch¨code
[
shi·
 & (
CTL
 | 
SHIFT
)][
d©a
];

387 i‡(
shi·
 & 
CAPSLOCK
) {

388 i‡('a' <
c
 && c <= 'z')

389 
c
 += 'A' - 'a';

390 i‡('A' <
c
 && c <= 'Z')

391 
c
 += 'a' - 'A';

396 i‡(!(~
shi·
 & (
CTL
 | 
ALT
)Ë&& 
c
 =
KEY_DEL
) {

397 
	`˝rötf
("Rebooting!\n");

398 
	`outb
(0x92, 0x3);

400  
c
;

401 
	}
}

405 
	$kbd_öå
() {

406 
	`c⁄s_öå
(
kbd_¥oc_d©a
);

407 
	}
}

410 
	$kbd_öô
() {

412 
	`kbd_öå
();

413 
	`pic_íabÀ
(
IRQ_KBD
);

414 
	`iﬂpi˚«bÀ
(
IRQ_KBD
, 0);

415 
	}
}

419 
	$c⁄s_öô
() {

420 
	`cga_öô
();

421 
	`£rül_öô
();

423 i‡(!
£rül_exi°s
) {

424 
	`˝rötf
("serialÖort doesÇotÉxist!!\n");

426 
	}
}

429 
	$u¨töô
() {

430 
	`£rül_öô
();

431 
	}
}

437 
	$c⁄s_putc
(
c
) {

438 
boﬁ
 
öå_Êag
;

439 
	`loˇl_öå_ßve
(
öå_Êag
);

441 
	`Õt_putc
(
c
);

442 
	`cga_putc
(
c
);

443 
	`£rül_putc
(
c
);

445 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

446 
	}
}

453 
	$c⁄s_gëc
() {

454 
c
 = 0;

455 
boﬁ
 
öå_Êag
;

456 
	`loˇl_öå_ßve
(
öå_Êag
);

461 
	`£rül_öå
();

462 
	`kbd_öå
();

465 i‡(
c⁄s
.
Ωos
 !c⁄s.
wpos
) {

466 
c
 = 
c⁄s
.
buf
[c⁄s.
Ωos
 ++];

467 i‡(
c⁄s
.
Ωos
 =
CONSBUFSIZE
) {

468 
c⁄s
.
Ωos
 = 0;

472 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

473  
c
;

474 
	}
}

	@kern/driver/console.h

1 #i‚de‡
__KERN_DRIVER_CONSOLE_H__


2 
	#__KERN_DRIVER_CONSOLE_H__


	)

4 
c⁄s_öô
();

5 
c⁄s_putc
(
c
);

6 
c⁄s_gëc
();

7 
£rül_öå
();

8 
kbd_öå
();

9 
kbd_öô
();

	@kern/driver/ide.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<å≠.h
>

4 
	~<picúq.h
>

5 
	~<fs.h
>

6 
	~<ide.h
>

7 
	~<x86.h
>

8 
	~<as£π.h
>

9 
	~<mp.h
>

11 
	#ISA_DATA
 0x00

	)

12 
	#ISA_ERROR
 0x01

	)

13 
	#ISA_PRECOMP
 0x01

	)

14 
	#ISA_CTRL
 0x02

	)

15 
	#ISA_SECCNT
 0x02

	)

16 
	#ISA_SECTOR
 0x03

	)

17 
	#ISA_CYL_LO
 0x04

	)

18 
	#ISA_CYL_HI
 0x05

	)

19 
	#ISA_SDH
 0x06

	)

20 
	#ISA_COMMAND
 0x07

	)

21 
	#ISA_STATUS
 0x07

	)

23 
	#IDE_BSY
 0x80

	)

24 
	#IDE_DRDY
 0x40

	)

25 
	#IDE_DF
 0x20

	)

26 
	#IDE_DRQ
 0x08

	)

27 
	#IDE_ERR
 0x01

	)

29 
	#IDE_CMD_READ
 0x20

	)

30 
	#IDE_CMD_WRITE
 0x30

	)

31 
	#IDE_CMD_IDENTIFY
 0xEC

	)

33 
	#IDE_IDENT_SECTORS
 20

	)

34 
	#IDE_IDENT_MODEL
 54

	)

35 
	#IDE_IDENT_CAPABILITIES
 98

	)

36 
	#IDE_IDENT_CMDSETS
 164

	)

37 
	#IDE_IDENT_MAX_LBA
 120

	)

38 
	#IDE_IDENT_MAX_LBA_EXT
 200

	)

40 
	#IO_BASE0
 0x1F0

	)

41 
	#IO_BASE1
 0x170

	)

42 
	#IO_CTRL0
 0x3F4

	)

43 
	#IO_CTRL1
 0x374

	)

45 
	#MAX_IDE
 4

	)

46 
	#MAX_NSECS
 128

	)

47 
	#MAX_DISK_NSECS
 0x10000000U

	)

48 
	#VALID_IDE
(
idío
Ë(((idíoË>0Ë&& ((idíoË< 
MAX_IDE
Ë&& (
ide_devi˚s
[idío].
vÆid
))

	)

51 
	mba£
;

52 
	m˘æ
;

53 } 
	gch™√ls
[2] = {

54 {
IO_BASE0
, 
IO_CTRL0
},

55 {
IO_BASE1
, 
IO_CTRL1
},

58 
	#IO_BASE
(
idío
Ë(
ch™√ls
[(idíoË>> 1].
ba£
)

	)

59 
	#IO_CTRL
(
idío
Ë(
ch™√ls
[(idíoË>> 1].
˘æ
)

	)

61 
	side_devi˚
 {

62 
	mvÆid
;

63 
	m£ts
;

64 
	msize
;

65 
	mmodñ
[41];

66 } 
	gide_devi˚s
[
MAX_IDE
];

69 
	$ide_waô_ªady
(
ioba£
, 
boﬁ
 
check_îr‹
) {

70 
r
;

71 (
r
 = 
	`öb
(
ioba£
 + 
ISA_STATUS
)Ë& 
IDE_BSY
)

73 i‡(
check_îr‹
 && (
r
 & (
IDE_DF
 | 
IDE_ERR
)) != 0) {

77 
	}
}

80 
	$ide_öô
() {

81 
	`°©ic_as£π
((
SECTSIZE
 % 4) == 0);

82 
idío
, 
ioba£
;

83 
idío
 = 0; idíÿ< 
MAX_IDE
; ideno ++) {

85 
ide_devi˚s
[
idío
].
vÆid
 = 0;

87 
ioba£
 = 
	`IO_BASE
(
idío
);

90 
	`ide_waô_ªady
(
ioba£
, 0);

93 
	`outb
(
ioba£
 + 
ISA_SDH
, 0xE0 | ((
idío
 & 1) << 4));

94 
	`ide_waô_ªady
(
ioba£
, 0);

97 
	`outb
(
ioba£
 + 
ISA_COMMAND
, 
IDE_CMD_IDENTIFY
);

98 
	`ide_waô_ªady
(
ioba£
, 0);

101 i‡(
	`öb
(
ioba£
 + 
ISA_STATUS
Ë=0 || 
	`ide_waô_ªady
(iobase, 1) != 0) {

106 
ide_devi˚s
[
idío
].
vÆid
 = 1;

109 
buf„r
[128];

110 
	`ö¶
(
ioba£
 + 
ISA_DATA
, 
buf„r
, (buffer) / ());

112 *
idít
 = (*)
buf„r
;

113 
£˘‹s
;

114 
cmd£ts
 = *(*)(
idít
 + 
IDE_IDENT_CMDSETS
);

116 i‡(
cmd£ts
 & (1 << 26)) {

117 
£˘‹s
 = *(*)(
idít
 + 
IDE_IDENT_MAX_LBA_EXT
);

120 
£˘‹s
 = *(*)(
idít
 + 
IDE_IDENT_MAX_LBA
);

122 
ide_devi˚s
[
idío
].
£ts
 = 
cmd£ts
;

123 
ide_devi˚s
[
idío
].
size
 = 
£˘‹s
;

126 
	`as£π
((*(*)(
idít
 + 
IDE_IDENT_CAPABILITIES
) & 0x200) != 0);

128 *
modñ
 = 
ide_devi˚s
[
idío
].modñ, *
d©a
 = 
idít
 + 
IDE_IDENT_MODEL
;

129 
i
, 
Àngth
 = 40;

130 
i
 = 0; i < 
Àngth
; i += 2) {

131 
modñ
[
i
] = 
d©a
[i + 1], model[i + 1] = data[i];

134 
modñ
[
i
] = '\0';

135 } 
i
 -- > 0 && 
modñ
[i] == ' ');

137 
	`˝rötf
("idê%d: %10u(£˘‹s), '%s'.\n", 
idío
, 
ide_devi˚s
[idío].
size
, ide_devi˚s[idío].
modñ
);

141 
	`pic_íabÀ
(
IRQ_IDE1
);

142 
	`pic_íabÀ
(
IRQ_IDE2
);

143 
	`iﬂpi˚«bÀ
(
IRQ_IDE1
, 
n˝u
 - 1);

144 
	`iﬂpi˚«bÀ
(
IRQ_IDE2
, 
n˝u
 - 1);

147 
	}
}

149 
boﬁ


150 
	$ide_devi˚_vÆid
(
idío
) {

151  
	`VALID_IDE
(
idío
);

152 
	}
}

154 
size_t


155 
	$ide_devi˚_size
(
idío
) {

156 i‡(
	`ide_devi˚_vÆid
(
idío
)) {

157  
ide_devi˚s
[
idío
].
size
;

160 
	}
}

163 
	$ide_ªad_£cs
(
idío
, 
uöt32_t
 
£˙o
, *
d°
, 
size_t
 
n£cs
) {

164 
	`as£π
(
n£cs
 <
MAX_NSECS
 && 
	`VALID_IDE
(
idío
));

165 
	`as£π
(
£˙o
 < 
MAX_DISK_NSECS
 && se˙ÿ+ 
n£cs
 <= MAX_DISK_NSECS);

166 
ioba£
 = 
	`IO_BASE
(
idío
), 
io˘æ
 = 
	`IO_CTRL
(ideno);

168 
	`ide_waô_ªady
(
ioba£
, 0);

171 
	`outb
(
io˘æ
 + 
ISA_CTRL
, 0);

172 
	`outb
(
ioba£
 + 
ISA_SECCNT
, 
n£cs
);

173 
	`outb
(
ioba£
 + 
ISA_SECTOR
, 
£˙o
 & 0xFF);

174 
	`outb
(
ioba£
 + 
ISA_CYL_LO
, (
£˙o
 >> 8) & 0xFF);

175 
	`outb
(
ioba£
 + 
ISA_CYL_HI
, (
£˙o
 >> 16) & 0xFF);

176 
	`outb
(
ioba£
 + 
ISA_SDH
, 0xE0 | ((
idío
 & 1Ë<< 4Ë| ((
£˙o
 >> 24) & 0xF));

177 
	`outb
(
ioba£
 + 
ISA_COMMAND
, 
IDE_CMD_READ
);

179 
ªt
 = 0;

180 ; 
n£cs
 > 0;Ç£c†--, 
d°
 +
SECTSIZE
) {

181 i‡((
ªt
 = 
	`ide_waô_ªady
(
ioba£
, 1)) != 0) {

182 
out
;

184 
	`ö¶
(
ioba£
, 
d°
, 
SECTSIZE
 / (
uöt32_t
));

187 
out
:

188  
ªt
;

189 
	}
}

192 
	$ide_wrôe_£cs
(
idío
, 
uöt32_t
 
£˙o
, c⁄° *
§c
, 
size_t
 
n£cs
) {

193 
	`as£π
(
n£cs
 <
MAX_NSECS
 && 
	`VALID_IDE
(
idío
));

194 
	`as£π
(
£˙o
 < 
MAX_DISK_NSECS
 && se˙ÿ+ 
n£cs
 <= MAX_DISK_NSECS);

195 
ioba£
 = 
	`IO_BASE
(
idío
), 
io˘æ
 = 
	`IO_CTRL
(ideno);

197 
	`ide_waô_ªady
(
ioba£
, 0);

200 
	`outb
(
io˘æ
 + 
ISA_CTRL
, 0);

201 
	`outb
(
ioba£
 + 
ISA_SECCNT
, 
n£cs
);

202 
	`outb
(
ioba£
 + 
ISA_SECTOR
, 
£˙o
 & 0xFF);

203 
	`outb
(
ioba£
 + 
ISA_CYL_LO
, (
£˙o
 >> 8) & 0xFF);

204 
	`outb
(
ioba£
 + 
ISA_CYL_HI
, (
£˙o
 >> 16) & 0xFF);

205 
	`outb
(
ioba£
 + 
ISA_SDH
, 0xE0 | ((
idío
 & 1Ë<< 4Ë| ((
£˙o
 >> 24) & 0xF));

206 
	`outb
(
ioba£
 + 
ISA_COMMAND
, 
IDE_CMD_WRITE
);

208 
ªt
 = 0;

209 ; 
n£cs
 > 0;Ç£c†--, 
§c
 +
SECTSIZE
) {

210 i‡((
ªt
 = 
	`ide_waô_ªady
(
ioba£
, 1)) != 0) {

211 
out
;

213 
	`out¶
(
ioba£
, 
§c
, 
SECTSIZE
 / (
uöt32_t
));

216 
out
:

217  
ªt
;

218 
	}
}

	@kern/driver/ide.h

1 #i‚de‡
__KERN_DRIVER_IDE_H__


2 
	#__KERN_DRIVER_IDE_H__


	)

4 
	~<defs.h
>

6 
ide_öô
();

7 
boﬁ
 
ide_devi˚_vÆid
(
idío
);

8 
size_t
 
ide_devi˚_size
(
idío
);

10 
ide_ªad_£cs
(
idío
, 
uöt32_t
 
£˙o
, *
d°
, 
size_t
 
n£cs
);

11 
ide_wrôe_£cs
(
idío
, 
uöt32_t
 
£˙o
, c⁄° *
§c
, 
size_t
 
n£cs
);

	@kern/driver/intr.c

1 
	~<x86.h
>

2 
	~<öå.h
>

6 
	$öå_íabÀ
() {

7 
	`°i
();

8 
	}
}

12 
	$öå_dißbÀ
() {

13 
	`˛i
();

14 
	}
}

	@kern/driver/intr.h

1 #i‚de‡
__KERN_DRIVER_INTR_H__


2 
	#__KERN_DRIVER_INTR_H__


	)

4 
öå_íabÀ
();

5 
öå_dißbÀ
();

	@kern/driver/kbdreg.h

1 #i‚de‡
__KERN_DRIVER_KBDREG_H__


2 
	#__KERN_DRIVER_KBDREG_H__


	)

5 
	#KEY_HOME
 0xE0

	)

6 
	#KEY_END
 0xE1

	)

7 
	#KEY_UP
 0xE2

	)

8 
	#KEY_DN
 0xE3

	)

9 
	#KEY_LF
 0xE4

	)

10 
	#KEY_RT
 0xE5

	)

11 
	#KEY_PGUP
 0xE6

	)

12 
	#KEY_PGDN
 0xE7

	)

13 
	#KEY_INS
 0xE8

	)

14 
	#KEY_DEL
 0xE9

	)

19 
	#KBSTATP
 0x64

20 
	#KBS_DIB
 0x01

21 
	#KBS_IBF
 0x02

22 
	#KBS_WARM
 0x04

23 
	#BS_OCMD
 0x08

24 
	#KBS_NOSEC
 0x10

25 
	#KBS_TERR
 0x20

26 
	#KBS_RERR
 0x40

27 
	#KBS_PERR
 0x80

28 

	)

29 
	#KBCMDP
 0x64

30 
	#KBC_RAMREAD
 0x20

31 
	#KBC_RAMWRITE
 0x60

32 
	#KBC_AUXDISABLE
 0xa7

33 
	#KBC_AUXENABLE
 0xa8

34 
	#KBC_AUXTEST
 0xa9

35 
	#KBC_KBDECHO
 0xd2

36 
	#KBC_AUXECHO
 0xd3

37 
	#KBC_AUXWRITE
 0xd4

38 
	#KBC_SELFTEST
 0xaa

39 
	#KBC_KBDTEST
 0xab

40 
	#KBC_KBDDISABLE
 0xad

41 
	#KBC_KBDENABLE
 0xae

42 
	#KBC_PULSE0
 0xfe

43 
	#KBC_PULSE1
 0xfd

44 
	#KBC_PULSE2
 0xfb

45 
	#KBC_PULSE3
 0xf7

46 

	)

47 
	#KBDATAP
 0x60

48 
	#KBOUTP
 0x60

49 

	)

50 
	#K_RDCMDBYTE
 0x20

	)

51 
	#K_LDCMDBYTE
 0x60

	)

53 
	#KC8_TRANS
 0x40

54 
	#KC8_MDISABLE
 0x20

55 
	#KC8_KDISABLE
 0x10

56 
	#KC8_IGNSEC
 0x08

57 
	#KC8_CPU
 0x04

58 
	#KC8_MENABLE
 0x02

59 
	#KC8_KENABLE
 0x01

60 
	#CMDBYTE
 (
KC8_TRANS
|
KC8_CPU
|
KC8_MENABLE
|
KC8_KENABLE
)

	)

63 
	#KBC_RESET
 0xFF

64 
	#KBC_RESEND
 0xFE

65 
	#KBC_SETDEFAULT
 0xF6

66 
	#KBC_DISABLE
 0xF5

67 
	#KBC_ENABLE
 0xF4

68 
	#KBC_TYPEMATIC
 0xF3

69 
	#KBC_SETTABLE
 0xF0

70 
	#KBC_MODEIND
 0xED

71 
	#KBC_ECHO
 0xEE

72 

	)

74 
	#KBR_EXTENDED
 0xE0

75 
	#KBR_RESEND
 0xFE

76 
	#KBR_ACK
 0xFA

77 
	#KBR_OVERRUN
 0x00

78 
	#KBR_FAILURE
 0xFD

79 
	#KBR_BREAK
 0xF0

80 
	#KBR_RSTDONE
 0xAA

81 
	#KBR_ECHO
 0xEE

82 

	)

	@kern/driver/picirq.c

1 
	~<defs.h
>

2 
	~<x86.h
>

3 
	~<picúq.h
>

6 
	#IO_PIC1
 0x20

7 
	#IO_PIC2
 0xA0

8 

	)

9 
	#IRQ_SLAVE
 2

10 

	)

13 
uöt16_t
 
	gúq_mask
 = 0xFFFF & ~(1 << 
IRQ_SLAVE
);

14 
boﬁ
 
	gdid_öô
 = 0;

17 
	$pic_£tmask
(
uöt16_t
 
mask
) {

18 
úq_mask
 = 
mask
;

19 i‡(
did_öô
) {

20 
	`outb
(
IO_PIC1
 + 1, 
mask
);

21 
	`outb
(
IO_PIC2
 + 1, 
mask
 >> 8);

23 
	}
}

26 
	$pic_íabÀ
(
úq
) {

27 
	`pic_£tmask
(
úq_mask
 & ~(1 << 
úq
));

28 
	}
}

32 
	$pic_öô
() {

33 
did_öô
 = 1;

36 
	`outb
(
IO_PIC1
 + 1, 0xFF);

37 
	`outb
(
IO_PIC2
 + 1, 0xFF);

45 
	`outb
(
IO_PIC1
, 0x11);

48 
	`outb
(
IO_PIC1
 + 1, 
IRQ_OFFSET
);

52 
	`outb
(
IO_PIC1
 + 1, 1 << 
IRQ_SLAVE
);

62 
	`outb
(
IO_PIC1
 + 1, 0x3);

65 
	`outb
(
IO_PIC2
, 0x11);

66 
	`outb
(
IO_PIC2
 + 1, 
IRQ_OFFSET
 + 8);

67 
	`outb
(
IO_PIC2
 + 1, 
IRQ_SLAVE
);

70 
	`outb
(
IO_PIC2
 + 1, 0x3);

76 
	`outb
(
IO_PIC1
, 0x68);

77 
	`outb
(
IO_PIC1
, 0x0a);

79 
	`outb
(
IO_PIC2
, 0x68);

80 
	`outb
(
IO_PIC2
, 0x0a);

82 i‡(
úq_mask
 != 0xFFFF) {

83 
	`pic_£tmask
(
úq_mask
);

85 
	}
}

	@kern/driver/picirq.h

1 #i‚de‡
__KERN_DRIVER_PICIRQ_H__


2 
	#__KERN_DRIVER_PICIRQ_H__


	)

4 
pic_öô
();

5 
pic_íabÀ
(
úq
);

7 
	#IRQ_OFFSET
 32

	)

	@kern/fs/devs/dev.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<°©.h
>

4 
	~<dev.h
>

5 
	~<öode.h
>

6 
	~<uni°d.h
>

7 
	~<îr‹.h
>

13 
	$dev_›í
(
öode
 *
node
, 
uöt32_t
 
›í_Êags
) {

14 i‡(
›í_Êags
 & (
O_CREAT
 | 
O_TRUNC
 | 
O_EXCL
 | 
O_APPEND
)) {

15  -
E_INVAL
;

17 
devi˚
 *
dev
 = 
	`v›_öfo
(
node
, device);

18  
	`d›_›í
(
dev
, 
›í_Êags
);

19 
	}
}

25 
	$dev_˛o£
(
öode
 *
node
) {

26 
devi˚
 *
dev
 = 
	`v›_öfo
(
node
, device);

27  
	`d›_˛o£
(
dev
);

28 
	}
}

34 
	$dev_ªad
(
öode
 *
node
, 
iobuf
 *
iob
) {

35 
devi˚
 *
dev
 = 
	`v›_öfo
(
node
, device);

36  
	`d›_io
(
dev
, 
iob
, 0);

37 
	}
}

43 
	$dev_wrôe
(
öode
 *
node
, 
iobuf
 *
iob
) {

44 
devi˚
 *
dev
 = 
	`v›_öfo
(
node
, device);

45  
	`d›_io
(
dev
, 
iob
, 1);

46 
	}
}

52 
	$dev_io˘l
(
öode
 *
node
, 
›
, *
d©a
) {

53 
devi˚
 *
dev
 = 
	`v›_öfo
(
node
, device);

54  
	`d›_io˘l
(
dev
, 
›
, 
d©a
);

55 
	}
}

63 
	$dev_f°©
(
öode
 *
node
, 
°©
 *stat) {

64 
ªt
;

65 
	`mem£t
(
°©
, 0, (stat));

66 i‡((
ªt
 = 
	`v›_gëty≥
(
node
, &(
°©
->
°_mode
))) != 0) {

67  
ªt
;

69 
devi˚
 *
dev
 = 
	`v›_öfo
(
node
, device);

70 
°©
->
°_∆öks
 = 1;

71 
°©
->
°_blocks
 = 
dev
->
d_blocks
;

72 
°©
->
°_size
 = sèt->
°_blocks
 * 
dev
->
d_blocksize
;

74 
	}
}

82 
	$dev_gëty≥
(
öode
 *
node
, 
uöt32_t
 *
ty≥_°‹e
) {

83 
devi˚
 *
dev
 = 
	`v›_öfo
(
node
, device);

84 *
ty≥_°‹e
 = (
dev
->
d_blocks
 > 0Ë? 
S_IFBLK
 : 
S_IFCHR
;

86 
	}
}

94 
	$dev_åy£ek
(
öode
 *
node
, 
off_t
 
pos
) {

95 
devi˚
 *
dev
 = 
	`v›_öfo
(
node
, device);

96 i‡(
dev
->
d_blocks
 > 0) {

97 i‡((
pos
 % 
dev
->
d_blocksize
) == 0) {

98 i‡(
pos
 >0 &&Öo†< 
dev
->
d_blocks
 * dev->
d_blocksize
) {

103  -
E_INVAL
;

104 
	}
}

119 
	$dev_lookup
(
öode
 *
node
, *
∑th
, öodê**
node_°‹e
) {

120 i‡(*
∑th
 != '\0') {

121  -
E_NOENT
;

123 
	`v›_ªf_öc
(
node
);

124 *
node_°‹e
 = 
node
;

126 
	}
}

131 c⁄° 
öode_›s
 
	gdev_node_›s
 = {

132 .
v›_magic
 = 
VOP_MAGIC
,

133 .
	gv›_›í
 = 
dev_›í
,

134 .
	gv›_˛o£
 = 
dev_˛o£
,

135 .
	gv›_ªad
 = 
dev_ªad
,

136 .
	gv›_wrôe
 = 
dev_wrôe
,

137 .
	gv›_f°©
 = 
dev_f°©
,

138 .
	gv›_io˘l
 = 
dev_io˘l
,

139 .
	gv›_gëty≥
 = 
dev_gëty≥
,

140 .
	gv›_åy£ek
 = 
dev_åy£ek
,

141 .
	gv›_lookup
 = 
dev_lookup
,

144 
	#öô_devi˚
(
x
) \

146 
dev_öô_
##
	`x
(); \

147 
dev_öô_
##
	`x
(); \

148 } 0)

	)

152 
	$dev_öô
() {

154 
	`öô_devi˚
(
°dö
);

155 
	`öô_devi˚
(
°dout
);

156 
	`öô_devi˚
(
disk0
);

157 
	}
}

159 
öode
 *

160 
	$dev_¸óã_öode
() {

161 
öode
 *
node
;

162 i‡((
node
 = 
	`Æloc_öode
(
devi˚
)Ë!
NULL
) {

163 
	`v›_öô
(
node
, &
dev_node_›s
, 
NULL
);

165  
node
;

166 
	}
}

	@kern/fs/devs/dev.h

1 #i‚de‡
__KERN_FS_DEVS_DEV_H__


2 
	#__KERN_FS_DEVS_DEV_H__


	)

4 
	~<defs.h
>

6 
	göode
;

7 
	giobuf
;

13 
	sdevi˚
 {

14 
size_t
 
	md_blocks
;

15 
size_t
 
	md_blocksize
;

16 (*
	md_›í
)(
devi˚
 *
	mdev
, 
uöt32_t
 
	m›í_Êags
);

17 (*
	md_˛o£
)(
devi˚
 *
	mdev
);

18 (*
	md_io
)(
devi˚
 *
	mdev
, 
iobuf
 *
	miob
, 
boﬁ
 
	mwrôe
);

19 (*
	md_io˘l
)(
devi˚
 *
	mdev
, 
	m›
, *
	md©a
);

22 
	#d›_›í
(
dev
, 
›í_Êags
Ë((dev)->
	`d_›í
(dev, o≥n_Êags))

	)

23 
	#d›_˛o£
(
dev
Ë((dev)->
	`d_˛o£
(dev))

	)

24 
	#d›_io
(
dev
, 
iob
, 
wrôe
Ë((dev)->
	`d_io
(dev, iob, wrôe))

	)

25 
	#d›_io˘l
(
dev
, 
›
, 
d©a
Ë((dev)->
	`d_io˘l
(dev, op, d©a))

	)

27 
dev_öô
();

28 
öode
 *
dev_¸óã_öode
();

	@kern/fs/devs/dev_disk0.c

1 
	~<defs.h
>

2 
	~<mmu.h
>

3 
	~<£m.h
>

4 
	~<ide.h
>

5 
	~<öode.h
>

6 
	~<kmÆloc.h
>

7 
	~<dev.h
>

8 
	~<vfs.h
>

9 
	~<iobuf.h
>

10 
	~<îr‹.h
>

11 
	~<as£π.h
>

13 
	#DISK0_BLKSIZE
 
PGSIZE


	)

14 
	#DISK0_BUFSIZE
 (4 * 
DISK0_BLKSIZE
)

	)

15 
	#DISK0_BLK_NSECT
 (
DISK0_BLKSIZE
 / 
SECTSIZE
)

	)

17 *
	gdisk0_buf„r
;

18 
£m≠h‹e_t
 
	gdisk0_£m
;

21 
	$lock_disk0
() {

22 
	`down
(&(
disk0_£m
));

23 
	}
}

26 
	$u∆ock_disk0
() {

27 
	`up
(&(
disk0_£m
));

28 
	}
}

31 
	$disk0_›í
(
devi˚
 *
dev
, 
uöt32_t
 
›í_Êags
) {

33 
	}
}

36 
	$disk0_˛o£
(
devi˚
 *
dev
) {

38 
	}
}

41 
	$disk0_ªad_blks_nﬁock
(
uöt32_t
 
blkno
, uöt32_à
nblks
) {

42 
ªt
;

43 
uöt32_t
 
£˘no
 = 
blkno
 * 
DISK0_BLK_NSECT
, 
n£cs
 = 
nblks
 * DISK0_BLK_NSECT;

44 i‡((
ªt
 = 
	`ide_ªad_£cs
(
DISK0_DEV_NO
, 
£˘no
, 
disk0_buf„r
, 
n£cs
)) != 0) {

45 
	`∑nic
("disk0:Ñead blkno = %d (sectno = %d),Çblks = %d (nsecs = %d): 0x%08x.\n",

46 
blkno
, 
£˘no
, 
nblks
, 
n£cs
, 
ªt
);

48 
	}
}

51 
	$disk0_wrôe_blks_nﬁock
(
uöt32_t
 
blkno
, uöt32_à
nblks
) {

52 
ªt
;

53 
uöt32_t
 
£˘no
 = 
blkno
 * 
DISK0_BLK_NSECT
, 
n£cs
 = 
nblks
 * DISK0_BLK_NSECT;

54 i‡((
ªt
 = 
	`ide_wrôe_£cs
(
DISK0_DEV_NO
, 
£˘no
, 
disk0_buf„r
, 
n£cs
)) != 0) {

55 
	`∑nic
("disk0: write blkno = %d (sectno = %d),Çblks = %d (nsecs = %d): 0x%08x.\n",

56 
blkno
, 
£˘no
, 
nblks
, 
n£cs
, 
ªt
);

58 
	}
}

61 
	$disk0_io
(
devi˚
 *
dev
, 
iobuf
 *
iob
, 
boﬁ
 
wrôe
) {

62 
off_t
 
off£t
 = 
iob
->
io_off£t
;

63 
size_t
 
ªsid
 = 
iob
->
io_ªsid
;

64 
uöt32_t
 
blkno
 = 
off£t
 / 
DISK0_BLKSIZE
;

65 
uöt32_t
 
nblks
 = 
ªsid
 / 
DISK0_BLKSIZE
;

68 i‡((
off£t
 % 
DISK0_BLKSIZE
Ë!0 || (
ªsid
 % DISK0_BLKSIZE) != 0) {

69  -
E_INVAL
;

73 i‡(
blkno
 + 
nblks
 > 
dev
->
d_blocks
) {

74  -
E_INVAL
;

78 i‡(
nblks
 == 0) {

82 
	`lock_disk0
();

83 
ªsid
 != 0) {

84 
size_t
 
c›õd
, 
Æí
 = 
DISK0_BUFSIZE
;

85 i‡(
wrôe
) {

86 
	`iobuf_move
(
iob
, 
disk0_buf„r
, 
Æí
, 0, &
c›õd
);

87 
	`as£π
(
c›õd
 !0 && c›õd <
ªsid
 && c›õd % 
DISK0_BLKSIZE
 == 0);

88 
nblks
 = 
c›õd
 / 
DISK0_BLKSIZE
;

89 
	`disk0_wrôe_blks_nﬁock
(
blkno
, 
nblks
);

92 i‡(
Æí
 > 
ªsid
) {

93 
Æí
 = 
ªsid
;

95 
nblks
 = 
Æí
 / 
DISK0_BLKSIZE
;

96 
	`disk0_ªad_blks_nﬁock
(
blkno
, 
nblks
);

97 
	`iobuf_move
(
iob
, 
disk0_buf„r
, 
Æí
, 1, &
c›õd
);

98 
	`as£π
(
c›õd
 =
Æí
 && c›õd % 
DISK0_BLKSIZE
 == 0);

100 
ªsid
 -
c›õd
, 
blkno
 +
nblks
;

102 
	`u∆ock_disk0
();

104 
	}
}

107 
	$disk0_io˘l
(
devi˚
 *
dev
, 
›
, *
d©a
) {

108  -
E_UNIMP
;

109 
	}
}

112 
	$disk0_devi˚_öô
(
devi˚
 *
dev
) {

113 
	`°©ic_as£π
(
DISK0_BLKSIZE
 % 
SECTSIZE
 == 0);

114 i‡(!
	`ide_devi˚_vÆid
(
DISK0_DEV_NO
)) {

115 
	`∑nic
("disk0 device isn'távailable.\n");

117 
dev
->
d_blocks
 = 
	`ide_devi˚_size
(
DISK0_DEV_NO
Ë/ 
DISK0_BLK_NSECT
;

118 
dev
->
d_blocksize
 = 
DISK0_BLKSIZE
;

119 
dev
->
d_›í
 = 
disk0_›í
;

120 
dev
->
d_˛o£
 = 
disk0_˛o£
;

121 
dev
->
d_io
 = 
disk0_io
;

122 
dev
->
d_io˘l
 = 
disk0_io˘l
;

123 
	`£m_öô
(&(
disk0_£m
), 1);

125 
	`°©ic_as£π
(
DISK0_BUFSIZE
 % 
DISK0_BLKSIZE
 == 0);

126 i‡((
disk0_buf„r
 = 
	`kmÆloc
(
DISK0_BUFSIZE
)Ë=
NULL
) {

127 
	`∑nic
("disk0álloc buffer failed.\n");

129 
	}
}

132 
	$dev_öô_disk0
() {

133 
öode
 *
node
;

134 i‡((
node
 = 
	`dev_¸óã_öode
()Ë=
NULL
) {

135 
	`∑nic
("disk0: dev_create_node.\n");

137 
	`disk0_devi˚_öô
(
	`v›_öfo
(
node
, 
devi˚
));

139 
ªt
;

140 i‡((
ªt
 = 
	`vfs_add_dev
("disk0", 
node
, 1)) != 0) {

141 
	`∑nic
("disk0: vfs_add_dev: %e.\n", 
ªt
);

143 
	}
}

	@kern/fs/devs/dev_stdin.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<waô.h
>

4 
	~<sync.h
>

5 
	~<¥oc.h
>

6 
	~<sched.h
>

7 
	~<dev.h
>

8 
	~<vfs.h
>

9 
	~<iobuf.h
>

10 
	~<öode.h
>

11 
	~<uni°d.h
>

12 
	~<îr‹.h
>

13 
	~<as£π.h
>

15 
	#STDIN_BUFSIZE
 4096

	)

17 
	g°dö_buf„r
[
STDIN_BUFSIZE
];

18 
off_t
 
	gp_Ωos
, 
	gp_wpos
;

19 
waô_queue_t
 
	g__waô_queue
, *
	gwaô_queue
 = &
__waô_queue
;

22 
	$dev_°dö_wrôe
(
c
) {

23 
boﬁ
 
öå_Êag
;

24 i‡(
c
 != '\0') {

25 
	`loˇl_öå_ßve
(
öå_Êag
);

27 
°dö_buf„r
[
p_wpos
 % 
STDIN_BUFSIZE
] = 
c
;

28 i‡(
p_wpos
 - 
p_Ωos
 < 
STDIN_BUFSIZE
) {

29 
p_wpos
 ++;

31 i‡(!
	`waô_queue_em±y
(
waô_queue
)) {

32 
	`wakeup_queue
(
waô_queue
, 
WT_KBD
, 1);

35 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

37 
	}
}

40 
	$dev_°dö_ªad
(*
buf
, 
size_t
 
Àn
) {

41 
ªt
 = 0;

42 
boﬁ
 
öå_Êag
;

43 
	`loˇl_öå_ßve
(
öå_Êag
);

45 ; 
ªt
 < 
Àn
;Ñë ++, 
p_Ωos
 ++) {

46 
åy_agaö
:

47 i‡(
p_Ωos
 < 
p_wpos
) {

48 *
buf
 ++ = 
°dö_buf„r
[
p_Ωos
 % 
STDIN_BUFSIZE
];

51 
waô_t
 
__waô
, *
waô
 = &__wait;

52 
	`waô_cuºít_£t
(
waô_queue
, 
waô
, 
WT_KBD
);

53 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

55 
	`scheduÀ
();

57 
	`loˇl_öå_ßve
(
öå_Êag
);

58 
	`waô_cuºít_dñ
(
waô_queue
, 
waô
);

59 i‡(
waô
->
wakeup_Êags
 =
WT_KBD
) {

60 
åy_agaö
;

66 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

67  
ªt
;

68 
	}
}

71 
	$°dö_›í
(
devi˚
 *
dev
, 
uöt32_t
 
›í_Êags
) {

72 i‡(
›í_Êags
 !
O_RDONLY
) {

73  -
E_INVAL
;

76 
	}
}

79 
	$°dö_˛o£
(
devi˚
 *
dev
) {

81 
	}
}

84 
	$°dö_io
(
devi˚
 *
dev
, 
iobuf
 *
iob
, 
boﬁ
 
wrôe
) {

85 i‡(!
wrôe
) {

86 
ªt
;

87 i‡((
ªt
 = 
	`dev_°dö_ªad
(
iob
->
io_ba£
, iob->
io_ªsid
)) > 0) {

88 
iob
->
io_ªsid
 -
ªt
;

90  
ªt
;

92  -
E_INVAL
;

93 
	}
}

96 
	$°dö_io˘l
(
devi˚
 *
dev
, 
›
, *
d©a
) {

97  -
E_INVAL
;

98 
	}
}

101 
	$°dö_devi˚_öô
(
devi˚
 *
dev
) {

102 
dev
->
d_blocks
 = 0;

103 
dev
->
d_blocksize
 = 1;

104 
dev
->
d_›í
 = 
°dö_›í
;

105 
dev
->
d_˛o£
 = 
°dö_˛o£
;

106 
dev
->
d_io
 = 
°dö_io
;

107 
dev
->
d_io˘l
 = 
°dö_io˘l
;

109 
p_Ωos
 = 
p_wpos
 = 0;

110 
	`waô_queue_öô
(
waô_queue
);

111 
	}
}

114 
	$dev_öô_°dö
() {

115 
öode
 *
node
;

116 i‡((
node
 = 
	`dev_¸óã_öode
()Ë=
NULL
) {

117 
	`∑nic
("stdin: dev_create_node.\n");

119 
	`°dö_devi˚_öô
(
	`v›_öfo
(
node
, 
devi˚
));

121 
ªt
;

122 i‡((
ªt
 = 
	`vfs_add_dev
("°dö", 
node
, 0)) != 0) {

123 
	`∑nic
("°dö: vfs_add_dev: %e.\n", 
ªt
);

125 
	}
}

	@kern/fs/devs/dev_stdout.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<dev.h
>

4 
	~<vfs.h
>

5 
	~<iobuf.h
>

6 
	~<öode.h
>

7 
	~<uni°d.h
>

8 
	~<îr‹.h
>

9 
	~<as£π.h
>

12 
	$°dout_›í
(
devi˚
 *
dev
, 
uöt32_t
 
›í_Êags
) {

13 i‡(
›í_Êags
 !
O_WRONLY
) {

14  -
E_INVAL
;

17 
	}
}

20 
	$°dout_˛o£
(
devi˚
 *
dev
) {

22 
	}
}

25 
	$°dout_io
(
devi˚
 *
dev
, 
iobuf
 *
iob
, 
boﬁ
 
wrôe
) {

26 i‡(
wrôe
) {

27 *
d©a
 = 
iob
->
io_ba£
;

28 ; 
iob
->
io_ªsid
 != 0; iob->io_resid --) {

29 
	`˝utch¨
(*
d©a
 ++);

33  -
E_INVAL
;

34 
	}
}

37 
	$°dout_io˘l
(
devi˚
 *
dev
, 
›
, *
d©a
) {

38  -
E_INVAL
;

39 
	}
}

42 
	$°dout_devi˚_öô
(
devi˚
 *
dev
) {

43 
dev
->
d_blocks
 = 0;

44 
dev
->
d_blocksize
 = 1;

45 
dev
->
d_›í
 = 
°dout_›í
;

46 
dev
->
d_˛o£
 = 
°dout_˛o£
;

47 
dev
->
d_io
 = 
°dout_io
;

48 
dev
->
d_io˘l
 = 
°dout_io˘l
;

49 
	}
}

52 
	$dev_öô_°dout
() {

53 
öode
 *
node
;

54 i‡((
node
 = 
	`dev_¸óã_öode
()Ë=
NULL
) {

55 
	`∑nic
("stdout: dev_create_node.\n");

57 
	`°dout_devi˚_öô
(
	`v›_öfo
(
node
, 
devi˚
));

59 
ªt
;

60 i‡((
ªt
 = 
	`vfs_add_dev
("°dout", 
node
, 0)) != 0) {

61 
	`∑nic
("°dout: vfs_add_dev: %e.\n", 
ªt
);

63 
	}
}

	@kern/fs/file.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<vfs.h
>

4 
	~<¥oc.h
>

5 
	~<fûe.h
>

6 
	~<uni°d.h
>

7 
	~<iobuf.h
>

8 
	~<öode.h
>

9 
	~<°©.h
>

10 
	~<dúít.h
>

11 
	~<îr‹.h
>

12 
	~<as£π.h
>

14 
	#ã°fd
(
fd
Ë((fdË>0 && (fdË< 
FILES_STRUCT_NENTRY
)

	)

17 
fûe
 *

18 
	$gë_fd_¨øy
() {

19 
fûes_°ru˘
 *
fûe•
 = 
cuºít
->filesp;

20 
	`as£π
(
fûe•
 !
NULL
 && 
	`fûes_cou¡
(filesp) > 0);

21  
fûe•
->
fd_¨øy
;

22 
	}
}

26 
	$fd_¨øy_öô
(
fûe
 *
fd_¨øy
) {

27 
fd
;

28 
fûe
 *fûê
fd_¨øy
;

29 
fd
 = 0; fd < 
FILES_STRUCT_NENTRY
; fd ++, 
fûe
 ++) {

30 
fûe
->
›í_cou¡
 = 0;

31 
fûe
->
°©us
 = 
FD_NONE
, fûe->
fd
 = fd;

33 
	}
}

37 
	$fd_¨øy_Æloc
(
fd
, 
fûe
 **
fûe_°‹e
) {

39 
fûe
 *fûê
	`gë_fd_¨øy
();

40 i‡(
fd
 =
NO_FD
) {

41 
fd
 = 0; fd < 
FILES_STRUCT_NENTRY
; fd ++, 
fûe
 ++) {

42 i‡(
fûe
->
°©us
 =
FD_NONE
) {

43 
found
;

46  -
E_MAX_OPEN
;

49 i‡(
	`ã°fd
(
fd
)) {

50 
fûe
 +
fd
;

51 i‡(
fûe
->
°©us
 =
FD_NONE
) {

52 
found
;

54  -
E_BUSY
;

56  -
E_INVAL
;

58 
found
:

59 
	`as£π
(
	`f›í_cou¡
(
fûe
) == 0);

60 
fûe
->
°©us
 = 
FD_INIT
, fûe->
node
 = 
NULL
;

61 *
fûe_°‹e
 = 
fûe
;

63 
	}
}

67 
	$fd_¨øy_‰ì
(
fûe
 *file) {

68 
	`as£π
(
fûe
->
°©us
 =
FD_INIT
 || fûe->°©u†=
FD_CLOSED
);

69 
	`as£π
(
	`f›í_cou¡
(
fûe
) == 0);

70 i‡(
fûe
->
°©us
 =
FD_CLOSED
) {

71 
	`vfs_˛o£
(
fûe
->
node
);

73 
fûe
->
°©us
 = 
FD_NONE
;

74 
	}
}

77 
	$fd_¨øy_acquúe
(
fûe
 *file) {

78 
	`as£π
(
fûe
->
°©us
 =
FD_OPENED
);

79 
	`f›í_cou¡_öc
(
fûe
);

80 
	}
}

84 
	$fd_¨øy_ªÀa£
(
fûe
 *file) {

85 
	`as£π
(
fûe
->
°©us
 =
FD_OPENED
 || fûe->°©u†=
FD_CLOSED
);

86 
	`as£π
(
	`f›í_cou¡
(
fûe
) > 0);

87 i‡(
	`f›í_cou¡_dec
(
fûe
) == 0) {

88 
	`fd_¨øy_‰ì
(
fûe
);

90 
	}
}

94 
	$fd_¨øy_›í
(
fûe
 *file) {

95 
	`as£π
(
fûe
->
°©us
 =
FD_INIT
 && fûe->
node
 !
NULL
);

96 
fûe
->
°©us
 = 
FD_OPENED
;

97 
	`f›í_cou¡_öc
(
fûe
);

98 
	}
}

102 
	$fd_¨øy_˛o£
(
fûe
 *file) {

103 
	`as£π
(
fûe
->
°©us
 =
FD_OPENED
);

104 
	`as£π
(
	`f›í_cou¡
(
fûe
) > 0);

105 
fûe
->
°©us
 = 
FD_CLOSED
;

106 i‡(
	`f›í_cou¡_dec
(
fûe
) == 0) {

107 
	`fd_¨øy_‰ì
(
fûe
);

109 
	}
}

113 
	$fd_¨øy_dup
(
fûe
 *
to
, fûê*
‰om
) {

115 
	`as£π
(
to
->
°©us
 =
FD_INIT
 && 
‰om
->°©u†=
FD_OPENED
);

116 
to
->
pos
 = 
‰om
->pos;

117 
to
->
ªadabÀ
 = 
‰om
->readable;

118 
to
->
wrôabÀ
 = 
‰om
->writable;

119 
öode
 *
node
 = 
‰om
->node;

120 
	`v›_ªf_öc
(
node
), 
	`v›_›í_öc
(node);

121 
to
->
node
 =Çode;

122 
	`fd_¨øy_›í
(
to
);

123 
	}
}

126 
ölöe
 

127 
	$fd2fûe
(
fd
, 
fûe
 **
fûe_°‹e
) {

128 i‡(
	`ã°fd
(
fd
)) {

129 
fûe
 *fûê
	`gë_fd_¨øy
(Ë+ 
fd
;

130 i‡(
fûe
->
°©us
 =
FD_OPENED
 && fûe->
fd
 == fd) {

131 *
fûe_°‹e
 = 
fûe
;

135  -
E_INVAL
;

136 
	}
}

139 
boﬁ


140 
	$fûe_ã°fd
(
fd
, 
boﬁ
 
ªadabÀ
, boﬁ 
wrôabÀ
) {

141 
ªt
;

142 
fûe
 *file;

143 i‡((
ªt
 = 
	`fd2fûe
(
fd
, &
fûe
)) != 0) {

146 i‡(
ªadabÀ
 && !
fûe
->readable) {

149 i‡(
wrôabÀ
 && !
fûe
->writable) {

153 
	}
}

157 
	$fûe_›í
(*
∑th
, 
uöt32_t
 
›í_Êags
) {

158 
boﬁ
 
ªadabÀ
 = 0, 
wrôabÀ
 = 0;

159 
›í_Êags
 & 
O_ACCMODE
) {

160 
O_RDONLY
: 
ªadabÀ
 = 1; ;

161 
O_WRONLY
: 
wrôabÀ
 = 1; ;

162 
O_RDWR
:

163 
ªadabÀ
 = 
wrôabÀ
 = 1;

166  -
E_INVAL
;

169 
ªt
;

170 
fûe
 *file;

171 i‡((
ªt
 = 
	`fd_¨øy_Æloc
(
NO_FD
, &
fûe
)) != 0) {

172  
ªt
;

175 
öode
 *
node
;

176 i‡((
ªt
 = 
	`vfs_›í
(
∑th
, 
›í_Êags
, &
node
)) != 0) {

177 
	`fd_¨øy_‰ì
(
fûe
);

178  
ªt
;

181 
fûe
->
pos
 = 0;

182 i‡(
›í_Êags
 & 
O_APPEND
) {

183 
°©
 
__°©
, *stat = &__stat;

184 i‡((
ªt
 = 
	`v›_f°©
(
node
, 
°©
)) != 0) {

185 
	`vfs_˛o£
(
node
);

186 
	`fd_¨øy_‰ì
(
fûe
);

187  
ªt
;

189 
fûe
->
pos
 = 
°©
->
°_size
;

192 
fûe
->
node
 =Çode;

193 
fûe
->
ªadabÀ
 =Ñeadable;

194 
fûe
->
wrôabÀ
 = writable;

195 
	`fd_¨øy_›í
(
fûe
);

196  
fûe
->
fd
;

197 
	}
}

201 
	$fûe_˛o£
(
fd
) {

202 
ªt
;

203 
fûe
 *file;

204 i‡((
ªt
 = 
	`fd2fûe
(
fd
, &
fûe
)) != 0) {

205  
ªt
;

207 
	`fd_¨øy_˛o£
(
fûe
);

209 
	}
}

213 
	$fûe_ªad
(
fd
, *
ba£
, 
size_t
 
Àn
, size_à*
c›õd_°‹e
) {

214 
ªt
;

215 
fûe
 *file;

216 *
c›õd_°‹e
 = 0;

217 i‡((
ªt
 = 
	`fd2fûe
(
fd
, &
fûe
)) != 0) {

218  
ªt
;

220 i‡(!
fûe
->
ªadabÀ
) {

221  -
E_INVAL
;

223 
	`fd_¨øy_acquúe
(
fûe
);

225 
iobuf
 
__iob
, *
iob
 = 
	`iobuf_öô
(&__iob, 
ba£
, 
Àn
, 
fûe
->
pos
);

226 
ªt
 = 
	`v›_ªad
(
fûe
->
node
, 
iob
);

228 
size_t
 
c›õd
 = 
	`iobuf_u£d
(
iob
);

229 i‡(
fûe
->
°©us
 =
FD_OPENED
) {

230 
fûe
->
pos
 +
c›õd
;

232 *
c›õd_°‹e
 = 
c›õd
;

233 
	`fd_¨øy_ªÀa£
(
fûe
);

234  
ªt
;

235 
	}
}

239 
	$fûe_wrôe
(
fd
, *
ba£
, 
size_t
 
Àn
, size_à*
c›õd_°‹e
) {

240 
ªt
;

241 
fûe
 *file;

242 *
c›õd_°‹e
 = 0;

243 i‡((
ªt
 = 
	`fd2fûe
(
fd
, &
fûe
)) != 0) {

244  
ªt
;

246 i‡(!
fûe
->
wrôabÀ
) {

247  -
E_INVAL
;

249 
	`fd_¨øy_acquúe
(
fûe
);

251 
iobuf
 
__iob
, *
iob
 = 
	`iobuf_öô
(&__iob, 
ba£
, 
Àn
, 
fûe
->
pos
);

252 
ªt
 = 
	`v›_wrôe
(
fûe
->
node
, 
iob
);

254 
size_t
 
c›õd
 = 
	`iobuf_u£d
(
iob
);

255 i‡(
fûe
->
°©us
 =
FD_OPENED
) {

256 
fûe
->
pos
 +
c›õd
;

258 *
c›õd_°‹e
 = 
c›õd
;

259 
	`fd_¨øy_ªÀa£
(
fûe
);

260  
ªt
;

261 
	}
}

265 
	$fûe_£ek
(
fd
, 
off_t
 
pos
, 
whí˚
) {

266 
°©
 
__°©
, *stat = &__stat;

267 
ªt
;

268 
fûe
 *file;

269 i‡((
ªt
 = 
	`fd2fûe
(
fd
, &
fûe
)) != 0) {

270  
ªt
;

272 
	`fd_¨øy_acquúe
(
fûe
);

274 
whí˚
) {

275 
LSEEK_SET
: ;

276 
LSEEK_CUR
: 
pos
 +
fûe
->pos; ;

277 
LSEEK_END
:

278 i‡((
ªt
 = 
	`v›_f°©
(
fûe
->
node
, 
°©
)) == 0) {

279 
pos
 +
°©
->
°_size
;

282 : 
ªt
 = -
E_INVAL
;

285 i‡(
ªt
 == 0) {

286 i‡((
ªt
 = 
	`v›_åy£ek
(
fûe
->
node
, 
pos
)) == 0) {

287 
fûe
->
pos
 =Öos;

291 
	`fd_¨øy_ªÀa£
(
fûe
);

292  
ªt
;

293 
	}
}

297 
	$fûe_f°©
(
fd
, 
°©
 *stat) {

298 
ªt
;

299 
fûe
 *file;

300 i‡((
ªt
 = 
	`fd2fûe
(
fd
, &
fûe
)) != 0) {

301  
ªt
;

303 
	`fd_¨øy_acquúe
(
fûe
);

304 
ªt
 = 
	`v›_f°©
(
fûe
->
node
, 
°©
);

305 
	`fd_¨øy_ªÀa£
(
fûe
);

306  
ªt
;

307 
	}
}

311 
	$fûe_fsync
(
fd
) {

312 
ªt
;

313 
fûe
 *file;

314 i‡((
ªt
 = 
	`fd2fûe
(
fd
, &
fûe
)) != 0) {

315  
ªt
;

317 
	`fd_¨øy_acquúe
(
fûe
);

318 
ªt
 = 
	`v›_fsync
(
fûe
->
node
);

319 
	`fd_¨øy_ªÀa£
(
fûe
);

320  
ªt
;

321 
	}
}

325 
	$fûe_gëdúíåy
(
fd
, 
dúít
 *
dúíç
) {

326 
ªt
;

327 
fûe
 *file;

328 i‡((
ªt
 = 
	`fd2fûe
(
fd
, &
fûe
)) != 0) {

329  
ªt
;

331 
	`fd_¨øy_acquúe
(
fûe
);

333 
iobuf
 
__iob
, *
iob
 = 
	`iobuf_öô
(&__iob, 
dúíç
->
«me
, (dúíç->«me), dúíç->
off£t
);

334 i‡((
ªt
 = 
	`v›_gëdúíåy
(
fûe
->
node
, 
iob
)) == 0) {

335 
dúíç
->
off£t
 +
	`iobuf_u£d
(
iob
);

337 
	`fd_¨øy_ªÀa£
(
fûe
);

338  
ªt
;

339 
	}
}

343 
	$fûe_dup
(
fd1
, 
fd2
) {

344 
ªt
;

345 
fûe
 *
fûe1
, *
fûe2
;

346 i‡((
ªt
 = 
	`fd2fûe
(
fd1
, &
fûe1
)) != 0) {

347  
ªt
;

349 i‡((
ªt
 = 
	`fd_¨øy_Æloc
(
fd2
, &
fûe2
)) != 0) {

350  
ªt
;

352 
	`fd_¨øy_dup
(
fûe2
, 
fûe1
);

353  
fûe2
->
fd
;

354 
	}
}

	@kern/fs/file.h

1 #i‚de‡
__KERN_FS_FILE_H__


2 
	#__KERN_FS_FILE_H__


	)

5 
	~<fs.h
>

6 
	~<¥oc.h
>

7 
	~<©omic.h
>

8 
	~<as£π.h
>

10 
	göode
;

11 
	g°©
;

12 
	gdúít
;

14 
	sfûe
 {

16 
	mFD_NONE
, 
	mFD_INIT
, 
	mFD_OPENED
, 
	mFD_CLOSED
,

17 } 
	m°©us
;

18 
boﬁ
 
	mªadabÀ
;

19 
boﬁ
 
	mwrôabÀ
;

20 
	mfd
;

21 
off_t
 
	mpos
;

22 
öode
 *
	mnode
;

23 
	m›í_cou¡
;

26 
fd_¨øy_öô
(
fûe
 *
fd_¨øy
);

27 
fd_¨øy_›í
(
fûe
 *file);

28 
fd_¨øy_˛o£
(
fûe
 *file);

29 
fd_¨øy_dup
(
fûe
 *
to
, fûê*
‰om
);

30 
boﬁ
 
fûe_ã°fd
(
fd
, boﬁ 
ªadabÀ
, boﬁ 
wrôabÀ
);

32 
fûe_›í
(*
∑th
, 
uöt32_t
 
›í_Êags
);

33 
fûe_˛o£
(
fd
);

34 
fûe_ªad
(
fd
, *
ba£
, 
size_t
 
Àn
, size_à*
c›õd_°‹e
);

35 
fûe_wrôe
(
fd
, *
ba£
, 
size_t
 
Àn
, size_à*
c›õd_°‹e
);

36 
fûe_£ek
(
fd
, 
off_t
 
pos
, 
whí˚
);

37 
fûe_f°©
(
fd
, 
°©
 *stat);

38 
fûe_fsync
(
fd
);

39 
fûe_gëdúíåy
(
fd
, 
dúít
 *dirent);

40 
fûe_dup
(
fd1
, 
fd2
);

41 
fûe_pùe
(
fd
[]);

42 
fûe_mkfifo
(c⁄° *
«me
, 
uöt32_t
 
›í_Êags
);

44 
ölöe
 

45 
	$f›í_cou¡
(
fûe
 *file) {

46  
fûe
->
›í_cou¡
;

47 
	}
}

49 
ölöe
 

50 
	$f›í_cou¡_öc
(
fûe
 *file) {

51 
fûe
->
›í_cou¡
 += 1;

52  
fûe
->
›í_cou¡
;

53 
	}
}

55 
ölöe
 

56 
	$f›í_cou¡_dec
(
fûe
 *file) {

57 
fûe
->
›í_cou¡
 -= 1;

58  
fûe
->
›í_cou¡
;

59 
	}
}

	@kern/fs/fs.c

1 
	~<defs.h
>

2 
	~<kmÆloc.h
>

3 
	~<£m.h
>

4 
	~<vfs.h
>

5 
	~<dev.h
>

6 
	~<fûe.h
>

7 
	~<sfs.h
>

8 
	~<öode.h
>

9 
	~<as£π.h
>

12 
	$fs_öô
() {

13 
	`vfs_öô
();

14 
	`dev_öô
();

15 
	`sfs_öô
();

16 
	}
}

19 
	$fs_˛ónup
() {

20 
	`vfs_˛ónup
();

21 
	}
}

24 
	$lock_fûes
(
fûes_°ru˘
 *
fûe•
) {

25 
	`down
(&(
fûe•
->
fûes_£m
));

26 
	}
}

29 
	$u∆ock_fûes
(
fûes_°ru˘
 *
fûe•
) {

30 
	`up
(&(
fûe•
->
fûes_£m
));

31 
	}
}

33 
fûes_°ru˘
 *

34 
	$fûes_¸óã
() {

36 
	`°©ic_as£π
(()
FILES_STRUCT_NENTRY
 > 128);

37 
fûes_°ru˘
 *
fûe•
;

38 i‡((
fûe•
 = 
	`kmÆloc
((
fûes_°ru˘
Ë+ 
FILES_STRUCT_BUFSIZE
)Ë!
NULL
) {

39 
fûe•
->
pwd
 = 
NULL
;

40 
fûe•
->
fd_¨øy
 = (*)(filesp + 1);

41 
fûe•
->
fûes_cou¡
 = 0;

42 
	`£m_öô
(&(
fûe•
->
fûes_£m
), 1);

43 
	`fd_¨øy_öô
(
fûe•
->
fd_¨øy
);

45  
fûe•
;

46 
	}
}

49 
	$fûes_de°roy
(
fûes_°ru˘
 *
fûe•
) {

51 
	`as£π
(
fûe•
 !
NULL
 && 
	`fûes_cou¡
(filesp) == 0);

52 i‡(
fûe•
->
pwd
 !
NULL
) {

53 
	`v›_ªf_dec
(
fûe•
->
pwd
);

55 
i
;

56 
fûe
 *fûê
fûe•
->
fd_¨øy
;

57 
i
 = 0; i < 
FILES_STRUCT_NENTRY
; i ++, 
fûe
 ++) {

58 i‡(
fûe
->
°©us
 =
FD_OPENED
) {

59 
	`fd_¨øy_˛o£
(
fûe
);

61 
	`as£π
(
fûe
->
°©us
 =
FD_NONE
);

63 
	`k‰ì
(
fûe•
);

64 
	}
}

67 
	$fûes_˛o£Æl
(
fûes_°ru˘
 *
fûe•
) {

69 
	`as£π
(
fûe•
 !
NULL
 && 
	`fûes_cou¡
(filesp) > 0);

70 
i
;

71 
fûe
 *fûê
fûe•
->
fd_¨øy
;

73 
i
 = 2, 
fûe
 +2; i < 
FILES_STRUCT_NENTRY
; i ++, file ++) {

74 i‡(
fûe
->
°©us
 =
FD_OPENED
) {

75 
	`fd_¨øy_˛o£
(
fûe
);

78 
	}
}

81 
	$dup_fs
(
fûes_°ru˘
 *
to
, fûes_°ru˘ *
‰om
) {

83 
	`as£π
(
to
 !
NULL
 && 
‰om
 != NULL);

84 
	`as£π
(
	`fûes_cou¡
(
to
Ë=0 && fûes_cou¡(
‰om
) > 0);

85 i‡((
to
->
pwd
 = 
‰om
->pwdË!
NULL
) {

86 
	`v›_ªf_öc
(
to
->
pwd
);

88 
i
;

89 
fûe
 *
to_fûe
 = 
to
->
fd_¨øy
, *
‰om_fûe
 = 
‰om
->fd_array;

90 
i
 = 0; i < 
FILES_STRUCT_NENTRY
; i ++, 
to_fûe
 ++, 
‰om_fûe
 ++) {

91 i‡(
‰om_fûe
->
°©us
 =
FD_OPENED
) {

93 
to_fûe
->
°©us
 = 
FD_INIT
;

94 
	`fd_¨øy_dup
(
to_fûe
, 
‰om_fûe
);

98 
	}
}

	@kern/fs/fs.h

1 #i‚de‡
__KERN_FS_FS_H__


2 
	#__KERN_FS_FS_H__


	)

4 
	~<defs.h
>

5 
	~<mmu.h
>

6 
	~<£m.h
>

7 
	~<©omic.h
>

9 
	#SECTSIZE
 512

	)

10 
	#PAGE_NSECT
 (
PGSIZE
 / 
SECTSIZE
)

	)

12 
	#SWAP_DEV_NO
 1

	)

13 
	#DISK0_DEV_NO
 2

	)

14 
	#DISK1_DEV_NO
 3

	)

16 
fs_öô
();

17 
fs_˛ónup
();

19 
	göode
;

20 
	gfûe
;

25 
	sfûes_°ru˘
 {

26 
öode
 *
	mpwd
;

27 
fûe
 *
	mfd_¨øy
;

28 
	mfûes_cou¡
;

29 
£m≠h‹e_t
 
	mfûes_£m
;

32 
	#FILES_STRUCT_BUFSIZE
 (
PGSIZE
 - (
fûes_°ru˘
))

	)

33 
	#FILES_STRUCT_NENTRY
 (
FILES_STRUCT_BUFSIZE
 / (
fûe
))

	)

35 
lock_fûes
(
fûes_°ru˘
 *
fûe•
);

36 
u∆ock_fûes
(
fûes_°ru˘
 *
fûe•
);

38 
fûes_°ru˘
 *
fûes_¸óã
();

39 
fûes_de°roy
(
fûes_°ru˘
 *
fûe•
);

40 
fûes_˛o£Æl
(
fûes_°ru˘
 *
fûe•
);

41 
dup_fûes
(
fûes_°ru˘
 *
to
, fûes_°ru˘ *
‰om
);

43 
ölöe
 

44 
	$fûes_cou¡
(
fûes_°ru˘
 *
fûe•
) {

45  
fûe•
->
fûes_cou¡
;

46 
	}
}

48 
ölöe
 

49 
	$fûes_cou¡_öc
(
fûes_°ru˘
 *
fûe•
) {

50 
fûe•
->
fûes_cou¡
 += 1;

51  
fûe•
->
fûes_cou¡
;

52 
	}
}

54 
ölöe
 

55 
	$fûes_cou¡_dec
(
fûes_°ru˘
 *
fûe•
) {

56 
fûe•
->
fûes_cou¡
 -= 1;

57  
fûe•
->
fûes_cou¡
;

58 
	}
}

	@kern/fs/iobuf.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<iobuf.h
>

4 
	~<îr‹.h
>

5 
	~<as£π.h
>

13 
iobuf
 *

14 
	$iobuf_öô
(
iobuf
 *
iob
, *
ba£
, 
size_t
 
Àn
, 
off_t
 
off£t
) {

15 
iob
->
io_ba£
 = 
ba£
;

16 
iob
->
io_off£t
 = 
off£t
;

17 
iob
->
io_Àn
 = iob->
io_ªsid
 = 
Àn
;

18  
iob
;

19 
	}
}

29 
	$iobuf_move
(
iobuf
 *
iob
, *
d©a
, 
size_t
 
Àn
, 
boﬁ
 
m2b
, size_à*
c›õdp
) {

30 
size_t
 
Æí
;

31 i‡((
Æí
 = 
iob
->
io_ªsid
Ë> 
Àn
) {

32 
Æí
 = 
Àn
;

34 i‡(
Æí
 > 0) {

35 *
§c
 = 
iob
->
io_ba£
, *
d°
 = 
d©a
;

36 i‡(
m2b
) {

37 *
tmp
 = 
§c
;

38 
§c
 = 
d°
, d° = 
tmp
;

40 
	`memmove
(
d°
, 
§c
, 
Æí
);

41 
	`iobuf_skù
(
iob
, 
Æí
), 
Àn
 -=álen;

43 i‡(
c›õdp
 !
NULL
) {

44 *
c›õdp
 = 
Æí
;

46  (
Àn
 =0Ë? 0 : -
E_NO_MEM
;

47 
	}
}

54 
	$iobuf_move_zîos
(
iobuf
 *
iob
, 
size_t
 
Àn
, size_à*
c›õdp
) {

55 
size_t
 
Æí
;

56 i‡((
Æí
 = 
iob
->
io_ªsid
Ë> 
Àn
) {

57 
Æí
 = 
Àn
;

59 i‡(
Æí
 > 0) {

60 
	`mem£t
(
iob
->
io_ba£
, 0, 
Æí
);

61 
	`iobuf_skù
(
iob
, 
Æí
), 
Àn
 -=álen;

63 i‡(
c›õdp
 !
NULL
) {

64 *
c›õdp
 = 
Æí
;

66  (
Àn
 =0Ë? 0 : -
E_NO_MEM
;

67 
	}
}

73 
	$iobuf_skù
(
iobuf
 *
iob
, 
size_t
 
n
) {

74 
	`as£π
(
iob
->
io_ªsid
 >
n
);

75 
iob
->
io_ba£
 +
n
, iob->
io_off£t
 +n, iob->
io_ªsid
 -=Ç;

76 
	}
}

	@kern/fs/iobuf.h

1 #i‚de‡
__KERN_FS_IOBUF_H__


2 
	#__KERN_FS_IOBUF_H__


	)

4 
	~<defs.h
>

9 
	siobuf
 {

10 *
	mio_ba£
;

11 
off_t
 
	mio_off£t
;

12 
size_t
 
	mio_Àn
;

13 
size_t
 
	mio_ªsid
;

16 
	#iobuf_u£d
(
iob
Ë((
size_t
)((iob)->
io_Àn
 - (iob)->
io_ªsid
))

	)

18 
iobuf
 *
iobuf_öô
(iobu‡*
iob
, *
ba£
, 
size_t
 
Àn
, 
off_t
 
off£t
);

19 
iobuf_move
(
iobuf
 *
iob
, *
d©a
, 
size_t
 
Àn
, 
boﬁ
 
m2b
, size_à*
c›õdp
);

20 
iobuf_move_zîos
(
iobuf
 *
iob
, 
size_t
 
Àn
, size_à*
c›õdp
);

21 
iobuf_skù
(
iobuf
 *
iob
, 
size_t
 
n
);

	@kern/fs/sfs/bitmap.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<bôm≠.h
>

4 
	~<kmÆloc.h
>

5 
	~<îr‹.h
>

6 
	~<as£π.h
>

8 
	#WORD_TYPE
 
uöt32_t


	)

9 
	#WORD_BITS
 ((
WORD_TYPE
Ë* 
CHAR_BIT
)

	)

11 
	sbôm≠
 {

12 
uöt32_t
 
	mnbôs
;

13 
uöt32_t
 
	mnw‹ds
;

14 
WORD_TYPE
 *
	mm≠
;

18 
bôm≠
 *

19 
	$bôm≠_¸óã
(
uöt32_t
 
nbôs
) {

20 
	`°©ic_as£π
(
WORD_BITS
 != 0);

21 
	`as£π
(
nbôs
 !0 &&Çbô†+ 
WORD_BITS
 >Çbits);

23 
bôm≠
 *bitmap;

24 i‡((
bôm≠
 = 
	`kmÆloc
((bôm≠))Ë=
NULL
) {

25  
NULL
;

28 
uöt32_t
 
nw‹ds
 = 
	`ROUNDUP_DIV
(
nbôs
, 
WORD_BITS
);

29 
WORD_TYPE
 *
m≠
;

30 i‡((
m≠
 = 
	`kmÆloc
((
WORD_TYPE
Ë* 
nw‹ds
)Ë=
NULL
) {

31 
	`k‰ì
(
bôm≠
);

32  
NULL
;

35 
bôm≠
->
nbôs
 =Çbôs, bôm≠->
nw‹ds
 =Çwords;

36 
bôm≠
->
m≠
 = 
	`mem£t
(m≠, 0xFF, (
WORD_TYPE
Ë* 
nw‹ds
);

39 i‡(
nbôs
 !
nw‹ds
 * 
WORD_BITS
) {

40 
uöt32_t
 
ix
 = 
nw‹ds
 - 1, 
ovîbôs
 = 
nbôs
 - ix * 
WORD_BITS
;

42 
	`as£π
(
nbôs
 / 
WORD_BITS
 =
ix
);

43 
	`as£π
(
ovîbôs
 > 0 && ovîbô†< 
WORD_BITS
);

45 ; 
ovîbôs
 < 
WORD_BITS
; overbits ++) {

46 
bôm≠
->
m≠
[
ix
] ^(1 << 
ovîbôs
);

49  
bôm≠
;

50 
	}
}

54 
	$bôm≠_Æloc
(
bôm≠
 *bôm≠, 
uöt32_t
 *
ödex_°‹e
) {

55 
WORD_TYPE
 *
m≠
 = 
bôm≠
->map;

56 
uöt32_t
 
ix
, 
off£t
, 
nw‹ds
 = 
bôm≠
->nwords;

57 
ix
 = 0; ix < 
nw‹ds
; ix ++) {

58 i‡(
m≠
[
ix
] != 0) {

59 
off£t
 = 0; off£à< 
WORD_BITS
; offset ++) {

60 
WORD_TYPE
 
mask
 = (1 << 
off£t
);

61 i‡(
m≠
[
ix
] & 
mask
) {

62 
m≠
[
ix
] ^
mask
;

63 *
ödex_°‹e
 = 
ix
 * 
WORD_BITS
 + 
off£t
;

67 
	`as£π
(0);

70  -
E_NO_MEM
;

71 
	}
}

75 
	$bôm≠_å™¶©e
(
bôm≠
 *bôm≠, 
uöt32_t
 
ödex
, 
WORD_TYPE
 **
w‹d
, WORD_TYPE *
mask
) {

76 
	`as£π
(
ödex
 < 
bôm≠
->
nbôs
);

77 
uöt32_t
 
ix
 = 
ödex
 / 
WORD_BITS
, 
off£t
 = index % WORD_BITS;

78 *
w‹d
 = 
bôm≠
->
m≠
 + 
ix
;

79 *
mask
 = (1 << 
off£t
);

80 
	}
}

83 
boﬁ


84 
	$bôm≠_ã°
(
bôm≠
 *bôm≠, 
uöt32_t
 
ödex
) {

85 
WORD_TYPE
 *
w‹d
, 
mask
;

86 
	`bôm≠_å™¶©e
(
bôm≠
, 
ödex
, &
w‹d
, &
mask
);

87  (*
w‹d
 & 
mask
);

88 
	}
}

92 
	$bôm≠_‰ì
(
bôm≠
 *bôm≠, 
uöt32_t
 
ödex
) {

93 
WORD_TYPE
 *
w‹d
, 
mask
;

94 
	`bôm≠_å™¶©e
(
bôm≠
, 
ödex
, &
w‹d
, &
mask
);

95 
	`as£π
(!(*
w‹d
 & 
mask
));

96 *
w‹d
 |
mask
;

97 
	}
}

101 
	$bôm≠_de°roy
(
bôm≠
 *bitmap) {

102 
	`k‰ì
(
bôm≠
->
m≠
);

103 
	`k‰ì
(
bôm≠
);

104 
	}
}

108 
	$bôm≠_gëd©a
(
bôm≠
 *bôm≠, 
size_t
 *
Àn_°‹e
) {

109 i‡(
Àn_°‹e
 !
NULL
) {

110 *
Àn_°‹e
 = (
WORD_TYPE
Ë* 
bôm≠
->
nw‹ds
;

112  
bôm≠
->
m≠
;

113 
	}
}

	@kern/fs/sfs/bitmap.h

1 #i‚de‡
__KERN_FS_SFS_BITMAP_H__


2 
	#__KERN_FS_SFS_BITMAP_H__


	)

4 
	~<defs.h
>

22 
	gbôm≠
;

24 
bôm≠
 *
bôm≠_¸óã
(
uöt32_t
 
nbôs
);

25 
bôm≠_Æloc
(
bôm≠
 *bôm≠, 
uöt32_t
 *
ödex_°‹e
);

26 
boﬁ
 
bôm≠_ã°
(
bôm≠
 *bôm≠, 
uöt32_t
 
ödex
);

27 
bôm≠_‰ì
(
bôm≠
 *bôm≠, 
uöt32_t
 
ödex
);

28 
bôm≠_de°roy
(
bôm≠
 *bitmap);

29 *
bôm≠_gëd©a
(
bôm≠
 *bôm≠, 
size_t
 *
Àn_°‹e
);

	@kern/fs/sfs/sfs.c

1 
	~<defs.h
>

2 
	~<sfs.h
>

3 
	~<îr‹.h
>

4 
	~<as£π.h
>

13 
	$sfs_öô
() {

14 
ªt
;

15 i‡((
ªt
 = 
	`sfs_mou¡
("disk0")) != 0) {

16 
	`∑nic
("Áûed: sfs: sfs_mou¡: %e.\n", 
ªt
);

18 
	}
}

	@kern/fs/sfs/sfs.h

1 #i‚de‡
__KERN_FS_SFS_SFS_H__


2 
	#__KERN_FS_SFS_SFS_H__


	)

4 
	~<defs.h
>

5 
	~<mmu.h
>

6 
	~<li°.h
>

7 
	~<£m.h
>

8 
	~<uni°d.h
>

15 
	#SFS_MAGIC
 0x2f8dbe2®

	)

16 
	#SFS_BLKSIZE
 
PGSIZE


	)

17 
	#SFS_NDIRECT
 12

	)

18 
	#SFS_MAX_INFO_LEN
 31

	)

19 
	#SFS_MAX_FNAME_LEN
 
FS_MAX_FNAME_LEN


	)

20 
	#SFS_MAX_FILE_SIZE
 (1024UL * 1024 * 128Ë

	)

21 
	#SFS_BLKN_SUPER
 0

	)

22 
	#SFS_BLKN_ROOT
 1

	)

23 
	#SFS_BLKN_FREEMAP
 2

	)

26 
	#SFS_BLKBITS
 (
SFS_BLKSIZE
 * 
CHAR_BIT
)

	)

29 
	#SFS_BLK_NENTRY
 (
SFS_BLKSIZE
 / (
uöt32_t
))

	)

32 
	#SFS_TYPE_INVAL
 0

	)

33 
	#SFS_TYPE_FILE
 1

	)

34 
	#SFS_TYPE_DIR
 2

	)

35 
	#SFS_TYPE_LINK
 3

	)

40 
	ssfs_su≥r
 {

41 
uöt32_t
 
	mmagic
;

42 
uöt32_t
 
	mblocks
;

43 
uöt32_t
 
	munu£d_blocks
;

44 
	möfo
[
SFS_MAX_INFO_LEN
 + 1];

48 
	ssfs_disk_öode
 {

49 
uöt32_t
 
	msize
;

50 
uöt16_t
 
	mty≥
;

51 
uöt16_t
 
	m∆öks
;

52 
uöt32_t
 
	mblocks
;

53 
uöt32_t
 
	mdúe˘
[
SFS_NDIRECT
];

54 
uöt32_t
 
	mödúe˘
;

60 
	ssfs_disk_íåy
 {

61 
uöt32_t
 
	möo
;

62 
	m«me
[
SFS_MAX_FNAME_LEN
 + 1];

65 
	#sfs_díåy_size
 \

66 (((
sfs_disk_íåy
 *)0)->
«me
)

	)

69 
	ssfs_öode
 {

70 
sfs_disk_öode
 *
	mdö
;

71 
uöt32_t
 
	möo
;

72 
boﬁ
 
	mdúty
;

73 
	mª˛aim_cou¡
;

74 
£m≠h‹e_t
 
	m£m
;

75 
li°_íåy_t
 
	möode_lök
;

76 
li°_íåy_t
 
	mhash_lök
;

79 
	#À2sö
(
À
, 
membî
) \

80 
	`to_°ru˘
((
À
), 
sfs_öode
, 
membî
)

	)

83 
	ssfs_fs
 {

84 
sfs_su≥r
 
	msu≥r
;

85 
devi˚
 *
	mdev
;

86 
bôm≠
 *
	m‰ìm≠
;

87 
boﬁ
 
	msu≥r_dúty
;

88 *
	msfs_buf„r
;

89 
£m≠h‹e_t
 
	mfs_£m
;

90 
£m≠h‹e_t
 
	mio_£m
;

91 
£m≠h‹e_t
 
	mmuãx_£m
;

92 
li°_íåy_t
 
	möode_li°
;

93 
li°_íåy_t
 *
	mhash_li°
;

97 
	#SFS_HLIST_SHIFT
 10

	)

98 
	#SFS_HLIST_SIZE
 (1 << 
SFS_HLIST_SHIFT
)

	)

99 
	#sö_hash‚
(
x
Ë(
	`hash32
(x, 
SFS_HLIST_SHIFT
))

	)

102 
	#sfs_‰ìm≠_bôs
(
su≥r
Ë
	`ROUNDUP
((su≥r)->
blocks
, 
SFS_BLKBITS
)

	)

105 
	#sfs_‰ìm≠_blocks
(
su≥r
Ë
	`ROUNDUP_DIV
((su≥r)->
blocks
, 
SFS_BLKBITS
)

	)

107 
	gfs
;

108 
	göode
;

110 
sfs_öô
();

111 
sfs_mou¡
(c⁄° *
dev«me
);

113 
lock_sfs_fs
(
sfs_fs
 *
sfs
);

114 
lock_sfs_io
(
sfs_fs
 *
sfs
);

115 
u∆ock_sfs_fs
(
sfs_fs
 *
sfs
);

116 
u∆ock_sfs_io
(
sfs_fs
 *
sfs
);

118 
sfs_rblock
(
sfs_fs
 *
sfs
, *
buf
, 
uöt32_t
 
blkno
, uöt32_à
nblks
);

119 
sfs_wblock
(
sfs_fs
 *
sfs
, *
buf
, 
uöt32_t
 
blkno
, uöt32_à
nblks
);

120 
sfs_rbuf
(
sfs_fs
 *
sfs
, *
buf
, 
size_t
 
Àn
, 
uöt32_t
 
blkno
, 
off_t
 
off£t
);

121 
sfs_wbuf
(
sfs_fs
 *
sfs
, *
buf
, 
size_t
 
Àn
, 
uöt32_t
 
blkno
, 
off_t
 
off£t
);

122 
sfs_sync_su≥r
(
sfs_fs
 *
sfs
);

123 
sfs_sync_‰ìm≠
(
sfs_fs
 *
sfs
);

124 
sfs_˛ór_block
(
sfs_fs
 *
sfs
, 
uöt32_t
 
blkno
, uöt32_à
nblks
);

126 
sfs_lﬂd_öode
(
sfs_fs
 *
sfs
, 
öode
 **
node_°‹e
, 
uöt32_t
 
öo
);

	@kern/fs/sfs/sfs_fs.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<kmÆloc.h
>

5 
	~<li°.h
>

6 
	~<fs.h
>

7 
	~<vfs.h
>

8 
	~<dev.h
>

9 
	~<sfs.h
>

10 
	~<öode.h
>

11 
	~<iobuf.h
>

12 
	~<bôm≠.h
>

13 
	~<îr‹.h
>

14 
	~<as£π.h
>

20 
	$sfs_sync
(
fs
 *fs) {

21 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
fs
, sfs);

22 
	`lock_sfs_fs
(
sfs
);

24 
li°_íåy_t
 *
li°
 = &(
sfs
->
öode_li°
), *
À
 =Üist;

25 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

26 
sfs_öode
 *
sö
 = 
	`À2sö
(
À
, 
öode_lök
);

27 
	`v›_fsync
(
	`öfo2node
(
sö
, 
sfs_öode
));

30 
	`u∆ock_sfs_fs
(
sfs
);

32 
ªt
;

33 i‡(
sfs
->
su≥r_dúty
) {

34 
sfs
->
su≥r_dúty
 = 0;

35 i‡((
ªt
 = 
	`sfs_sync_su≥r
(
sfs
)) != 0) {

36 
sfs
->
su≥r_dúty
 = 1;

37  
ªt
;

39 i‡((
ªt
 = 
	`sfs_sync_‰ìm≠
(
sfs
)) != 0) {

40 
sfs
->
su≥r_dúty
 = 1;

41  
ªt
;

45 
	}
}

50 
öode
 *

51 
	$sfs_gë_roŸ
(
fs
 *fs) {

52 
öode
 *
node
;

53 
ªt
;

54 i‡((
ªt
 = 
	`sfs_lﬂd_öode
(
	`fs›_öfo
(
fs
, 
sfs
), &
node
, 
SFS_BLKN_ROOT
)) != 0) {

55 
	`∑nic
("lﬂd sf†roŸ faûed: %e", 
ªt
);

57  
node
;

58 
	}
}

64 
	$sfs_unmou¡
(
fs
 *fs) {

65 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
fs
, sfs);

66 i‡(!
	`li°_em±y
(&(
sfs
->
öode_li°
))) {

67  -
E_BUSY
;

69 
	`as£π
(!
sfs
->
su≥r_dúty
);

70 
	`bôm≠_de°roy
(
sfs
->
‰ìm≠
);

71 
	`k‰ì
(
sfs
->
sfs_buf„r
);

72 
	`k‰ì
(
sfs
->
hash_li°
);

73 
	`k‰ì
(
sfs
);

75 
	}
}

83 
	$sfs_˛ónup
(
fs
 *fs) {

84 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
fs
, sfs);

85 
uöt32_t
 
blocks
 = 
sfs
->
su≥r
.blocks, 
unu£d_blocks
 = sfs->super.unused_blocks;

86 
	`˝rötf
("sfs: cÀ™up: '%s' (%d/%d/%d)\n", 
sfs
->
su≥r
.
öfo
,

87 
blocks
 - 
unu£d_blocks
, unused_blocks, blocks);

88 
i
, 
ªt
;

89 
i
 = 0; i < 32; i ++) {

90 i‡((
ªt
 = 
	`fs›_sync
(
fs
)) == 0) {

94 i‡(
ªt
 != 0) {

95 
	`w¨n
("sfs: syn¯îr‹: '%s': %e.\n", 
sfs
->
su≥r
.
öfo
, 
ªt
);

97 
	}
}

110 
	$sfs_öô_ªad
(
devi˚
 *
dev
, 
uöt32_t
 
blkno
, *
blk_buf„r
) {

111 
iobuf
 
__iob
, *
iob
 = 
	`iobuf_öô
(&__iob, 
blk_buf„r
, 
SFS_BLKSIZE
, 
blkno
 * SFS_BLKSIZE);

112  
	`d›_io
(
dev
, 
iob
, 0);

113 
	}
}

128 
	$sfs_öô_‰ìm≠
(
devi˚
 *
dev
, 
bôm≠
 *
‰ìm≠
, 
uöt32_t
 
blkno
, uöt32_à
nblks
, *
blk_buf„r
) {

129 
size_t
 
Àn
;

130 *
d©a
 = 
	`bôm≠_gëd©a
(
‰ìm≠
, &
Àn
);

131 
	`as£π
(
d©a
 !
NULL
 && 
Àn
 =
nblks
 * 
SFS_BLKSIZE
);

132 
nblks
 != 0) {

133 
ªt
;

134 i‡((
ªt
 = 
	`sfs_öô_ªad
(
dev
, 
blkno
, 
d©a
)) != 0) {

135  
ªt
;

137 
blkno
 ++, 
nblks
 --, 
d©a
 +
SFS_BLKSIZE
;

140 
	}
}

149 
	$sfs_do_mou¡
(
devi˚
 *
dev
, 
fs
 **
fs_°‹e
) {

150 
	`°©ic_as£π
(
SFS_BLKSIZE
 >(
sfs_su≥r
));

151 
	`°©ic_as£π
(
SFS_BLKSIZE
 >(
sfs_disk_öode
));

152 
	`°©ic_as£π
(
SFS_BLKSIZE
 >(
sfs_disk_íåy
));

154 i‡(
dev
->
d_blocksize
 !
SFS_BLKSIZE
) {

155  -
E_NA_DEV
;

159 
fs
 *fs;

160 i‡((
fs
 = 
	`Æloc_fs
(
sfs
)Ë=
NULL
) {

161  -
E_NO_MEM
;

163 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
fs
, sfs);

164 
sfs
->
dev
 = dev;

166 
ªt
 = -
E_NO_MEM
;

168 *
sfs_buf„r
;

169 i‡((
sfs
->
sfs_buf„r
 = sfs_buf„∏
	`kmÆloc
(
SFS_BLKSIZE
)Ë=
NULL
) {

170 
Áûed_˛ónup_fs
;

174 i‡((
ªt
 = 
	`sfs_öô_ªad
(
dev
, 
SFS_BLKN_SUPER
, 
sfs_buf„r
)) != 0) {

175 
Áûed_˛ónup_sfs_buf„r
;

178 
ªt
 = -
E_INVAL
;

180 
sfs_su≥r
 *
su≥r
 = 
sfs_buf„r
;

181 i‡(
su≥r
->
magic
 !
SFS_MAGIC
) {

182 
	`˝rötf
("sfs: wrong magic in superblock. (%08x should be %08x).\n",

183 
su≥r
->
magic
, 
SFS_MAGIC
);

184 
Áûed_˛ónup_sfs_buf„r
;

186 i‡(
su≥r
->
blocks
 > 
dev
->
d_blocks
) {

187 
	`˝rötf
("sfs: fs has %u blocks, device has %u blocks.\n",

188 
su≥r
->
blocks
, 
dev
->
d_blocks
);

189 
Áûed_˛ónup_sfs_buf„r
;

191 
su≥r
->
öfo
[
SFS_MAX_INFO_LEN
] = '\0';

192 
sfs
->
su≥r
 = *super;

194 
ªt
 = -
E_NO_MEM
;

196 
uöt32_t
 
i
;

199 
li°_íåy_t
 *
hash_li°
;

200 i‡((
sfs
->
hash_li°
 = hash_li° = 
	`kmÆloc
((
li°_íåy_t
Ë* 
SFS_HLIST_SIZE
)Ë=
NULL
) {

201 
Áûed_˛ónup_sfs_buf„r
;

203 
i
 = 0; i < 
SFS_HLIST_SIZE
; i ++) {

204 
	`li°_öô
(
hash_li°
 + 
i
);

208 
bôm≠
 *
‰ìm≠
;

209 
uöt32_t
 
‰ìm≠_size_nbôs
 = 
	`sfs_‰ìm≠_bôs
(
su≥r
);

210 i‡((
sfs
->
‰ìm≠
 = fªem≠ = 
	`bôm≠_¸óã
(
‰ìm≠_size_nbôs
)Ë=
NULL
) {

211 
Áûed_˛ónup_hash_li°
;

213 
uöt32_t
 
‰ìm≠_size_nblks
 = 
	`sfs_‰ìm≠_blocks
(
su≥r
);

214 i‡((
ªt
 = 
	`sfs_öô_‰ìm≠
(
dev
, 
‰ìm≠
, 
SFS_BLKN_FREEMAP
, 
‰ìm≠_size_nblks
, 
sfs_buf„r
)) != 0) {

215 
Áûed_˛ónup_‰ìm≠
;

218 
uöt32_t
 
blocks
 = 
sfs
->
su≥r
.blocks, 
unu£d_blocks
 = 0;

219 
i
 = 0; i < 
‰ìm≠_size_nbôs
; i ++) {

220 i‡(
	`bôm≠_ã°
(
‰ìm≠
, 
i
)) {

221 
unu£d_blocks
 ++;

224 
	`as£π
(
unu£d_blocks
 =
sfs
->
su≥r
.unused_blocks);

227 
sfs
->
su≥r_dúty
 = 0;

228 
	`£m_öô
(&(
sfs
->
fs_£m
), 1);

229 
	`£m_öô
(&(
sfs
->
io_£m
), 1);

230 
	`£m_öô
(&(
sfs
->
muãx_£m
), 1);

231 
	`li°_öô
(&(
sfs
->
öode_li°
));

232 
	`˝rötf
("sfs: mou¡: '%s' (%d/%d/%d)\n", 
sfs
->
su≥r
.
öfo
,

233 
blocks
 - 
unu£d_blocks
, unused_blocks, blocks);

236 
fs
->
fs_sync
 = 
sfs_sync
;

237 
fs
->
fs_gë_roŸ
 = 
sfs_gë_roŸ
;

238 
fs
->
fs_unmou¡
 = 
sfs_unmou¡
;

239 
fs
->
fs_˛ónup
 = 
sfs_˛ónup
;

240 *
fs_°‹e
 = 
fs
;

243 
Áûed_˛ónup_‰ìm≠
:

244 
	`bôm≠_de°roy
(
‰ìm≠
);

245 
Áûed_˛ónup_hash_li°
:

246 
	`k‰ì
(
hash_li°
);

247 
Áûed_˛ónup_sfs_buf„r
:

248 
	`k‰ì
(
sfs_buf„r
);

249 
Áûed_˛ónup_fs
:

250 
	`k‰ì
(
fs
);

251  
ªt
;

252 
	}
}

255 
	$sfs_mou¡
(c⁄° *
dev«me
) {

256  
	`vfs_mou¡
(
dev«me
, 
sfs_do_mou¡
);

257 
	}
}

	@kern/fs/sfs/sfs_inode.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<°dlib.h
>

4 
	~<li°.h
>

5 
	~<°©.h
>

6 
	~<kmÆloc.h
>

7 
	~<vfs.h
>

8 
	~<dev.h
>

9 
	~<sfs.h
>

10 
	~<öode.h
>

11 
	~<iobuf.h
>

12 
	~<bôm≠.h
>

13 
	~<îr‹.h
>

14 
	~<as£π.h
>

16 c⁄° 
öode_›s
 
	gsfs_node_dú›s
;

17 c⁄° 
öode_›s
 
	gsfs_node_fûe›s
;

23 
	$lock_sö
(
sfs_öode
 *
sö
) {

24 
	`down
(&(
sö
->
£m
));

25 
	}
}

31 
	$u∆ock_sö
(
sfs_öode
 *
sö
) {

32 
	`up
(&(
sö
->
£m
));

33 
	}
}

38 c⁄° 
öode_›s
 *

39 
	$sfs_gë_›s
(
uöt16_t
 
ty≥
) {

40 
ty≥
) {

41 
SFS_TYPE_DIR
:

42  &
sfs_node_dú›s
;

43 
SFS_TYPE_FILE
:

44  &
sfs_node_fûe›s
;

46 
	`∑nic
("övÆid fûêty≥ %d.\n", 
ty≥
);

47 
	}
}

52 
li°_íåy_t
 *

53 
	$sfs_hash_li°
(
sfs_fs
 *
sfs
, 
uöt32_t
 
öo
) {

54  
sfs
->
hash_li°
 + 
	`sö_hash‚
(
öo
);

55 
	}
}

61 
	$sfs_£t_löks
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
) {

62 
	`li°_add
(&(
sfs
->
öode_li°
), &(
sö
->
öode_lök
));

63 
	`li°_add
(
	`sfs_hash_li°
(
sfs
, 
sö
->
öo
), &(sö->
hash_lök
));

64 
	}
}

70 
	$sfs_ªmove_löks
(
sfs_öode
 *
sö
) {

71 
	`li°_dñ
(&(
sö
->
öode_lök
));

72 
	`li°_dñ
(&(
sö
->
hash_lök
));

73 
	}
}

78 
boﬁ


79 
	$sfs_block_öu£
(
sfs_fs
 *
sfs
, 
uöt32_t
 
öo
) {

80 i‡(
öo
 !0 && inÿ< 
sfs
->
su≥r
.
blocks
) {

81  !
	`bôm≠_ã°
(
sfs
->
‰ìm≠
, 
öo
);

83 
	`∑nic
("sfs_block_öu£: cÆÀd ouào‡øngê(0, %uË%u.\n", 
sfs
->
su≥r
.
blocks
, 
öo
);

84 
	}
}

90 
	$sfs_block_Æloc
(
sfs_fs
 *
sfs
, 
uöt32_t
 *
öo_°‹e
) {

91 
ªt
;

92 i‡((
ªt
 = 
	`bôm≠_Æloc
(
sfs
->
‰ìm≠
, 
öo_°‹e
)) != 0) {

93  
ªt
;

95 
	`as£π
(
sfs
->
su≥r
.
unu£d_blocks
 > 0);

96 
sfs
->
su≥r
.
unu£d_blocks
 --, sfs->
su≥r_dúty
 = 1;

97 
	`as£π
(
	`sfs_block_öu£
(
sfs
, *
öo_°‹e
));

98  
	`sfs_˛ór_block
(
sfs
, *
öo_°‹e
, 1);

99 
	}
}

105 
	$sfs_block_‰ì
(
sfs_fs
 *
sfs
, 
uöt32_t
 
öo
) {

106 
	`as£π
(
	`sfs_block_öu£
(
sfs
, 
öo
));

107 
	`bôm≠_‰ì
(
sfs
->
‰ìm≠
, 
öo
);

108 
sfs
->
su≥r
.
unu£d_blocks
 ++, sfs->
su≥r_dúty
 = 1;

109 
	}
}

115 
	$sfs_¸óã_öode
(
sfs_fs
 *
sfs
, 
sfs_disk_öode
 *
dö
, 
uöt32_t
 
öo
, 
öode
 **
node_°‹e
) {

116 
öode
 *
node
;

117 i‡((
node
 = 
	`Æloc_öode
(
sfs_öode
)Ë!
NULL
) {

118 
	`v›_öô
(
node
, 
	`sfs_gë_›s
(
dö
->
ty≥
), 
	`öfo2fs
(
sfs
, sfs));

119 
sfs_öode
 *
sö
 = 
	`v›_öfo
(
node
, sfs_inode);

120 
sö
->
dö
 = dö, sö->
öo
 = ino, sö->
dúty
 = 0, sö->
ª˛aim_cou¡
 = 1;

121 
	`£m_öô
(&(
sö
->
£m
), 1);

122 *
node_°‹e
 = 
node
;

125  -
E_NO_MEM
;

126 
	}
}

133 
öode
 *

134 
	$lookup_sfs_nﬁock
(
sfs_fs
 *
sfs
, 
uöt32_t
 
öo
) {

135 
öode
 *
node
;

136 
li°_íåy_t
 *
li°
 = 
	`sfs_hash_li°
(
sfs
, 
öo
), *
À
 =Üist;

137 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

138 
sfs_öode
 *
sö
 = 
	`À2sö
(
À
, 
hash_lök
);

139 i‡(
sö
->
öo
 == ino) {

140 
node
 = 
	`öfo2node
(
sö
, 
sfs_öode
);

141 i‡(
	`v›_ªf_öc
(
node
) == 1) {

142 
sö
->
ª˛aim_cou¡
 ++;

144  
node
;

147  
NULL
;

148 
	}
}

155 
	$sfs_lﬂd_öode
(
sfs_fs
 *
sfs
, 
öode
 **
node_°‹e
, 
uöt32_t
 
öo
) {

156 
	`lock_sfs_fs
(
sfs
);

157 
öode
 *
node
;

158 i‡((
node
 = 
	`lookup_sfs_nﬁock
(
sfs
, 
öo
)Ë!
NULL
) {

159 
out_u∆ock
;

162 
ªt
 = -
E_NO_MEM
;

163 
sfs_disk_öode
 *
dö
;

164 i‡((
dö
 = 
	`kmÆloc
((
sfs_disk_öode
))Ë=
NULL
) {

165 
Áûed_u∆ock
;

168 
	`as£π
(
	`sfs_block_öu£
(
sfs
, 
öo
));

169 i‡((
ªt
 = 
	`sfs_rbuf
(
sfs
, 
dö
, (
sfs_disk_öode
), 
öo
, 0)) != 0) {

170 
Áûed_˛ónup_dö
;

173 
	`as£π
(
dö
->
∆öks
 != 0);

174 i‡((
ªt
 = 
	`sfs_¸óã_öode
(
sfs
, 
dö
, 
öo
, &
node
)) != 0) {

175 
Áûed_˛ónup_dö
;

177 
	`sfs_£t_löks
(
sfs
, 
	`v›_öfo
(
node
, 
sfs_öode
));

179 
out_u∆ock
:

180 
	`u∆ock_sfs_fs
(
sfs
);

181 *
node_°‹e
 = 
node
;

184 
Áûed_˛ónup_dö
:

185 
	`k‰ì
(
dö
);

186 
Áûed_u∆ock
:

187 
	`u∆ock_sfs_fs
(
sfs
);

188  
ªt
;

189 
	}
}

201 
	$sfs_bm≠_gë_sub_nﬁock
(
sfs_fs
 *
sfs
, 
uöt32_t
 *
íç
, uöt32_à
ödex
, 
boﬁ
 
¸óã
, uöt32_à*
öo_°‹e
) {

202 
	`as£π
(
ödex
 < 
SFS_BLK_NENTRY
);

203 
ªt
;

204 
uöt32_t
 
ít
, 
öo
 = 0;

205 
off_t
 
off£t
 = 
ödex
 * (
uöt32_t
);

207 i‡((
ít
 = *
íç
) != 0) {

208 i‡((
ªt
 = 
	`sfs_rbuf
(
sfs
, &
öo
, (
uöt32_t
), 
ít
, 
off£t
)) != 0) {

209  
ªt
;

211 i‡(
öo
 !0 || !
¸óã
) {

212 
out
;

216 i‡(!
¸óã
) {

217 
out
;

220 i‡((
ªt
 = 
	`sfs_block_Æloc
(
sfs
, &
ít
)) != 0) {

221  
ªt
;

225 i‡((
ªt
 = 
	`sfs_block_Æloc
(
sfs
, &
öo
)) != 0) {

226 
Áûed_˛ónup
;

228 i‡((
ªt
 = 
	`sfs_wbuf
(
sfs
, &
öo
, (
uöt32_t
), 
ít
, 
off£t
)) != 0) {

229 
	`sfs_block_‰ì
(
sfs
, 
öo
);

230 
Áûed_˛ónup
;

233 
out
:

234 i‡(
ít
 !*
íç
) {

235 *
íç
 = 
ít
;

237 *
öo_°‹e
 = 
öo
;

240 
Áûed_˛ónup
:

241 i‡(
ít
 !*
íç
) {

242 
	`sfs_block_‰ì
(
sfs
, 
ít
);

244  
ªt
;

245 
	}
}

257 
	$sfs_bm≠_gë_nﬁock
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
, 
uöt32_t
 
ödex
, 
boﬁ
 
¸óã
, uöt32_à*
öo_°‹e
) {

258 
sfs_disk_öode
 *
dö
 = 
sö
->din;

259 
ªt
;

260 
uöt32_t
 
ít
, 
öo
;

262 i‡(
ödex
 < 
SFS_NDIRECT
) {

263 i‡((
öo
 = 
dö
->
dúe˘
[
ödex
]Ë=0 && 
¸óã
) {

264 i‡((
ªt
 = 
	`sfs_block_Æloc
(
sfs
, &
öo
)) != 0) {

265  
ªt
;

267 
dö
->
dúe˘
[
ödex
] = 
öo
;

268 
sö
->
dúty
 = 1;

270 
out
;

273 
ödex
 -
SFS_NDIRECT
;

274 i‡(
ödex
 < 
SFS_BLK_NENTRY
) {

275 
ít
 = 
dö
->
ödúe˘
;

276 i‡((
ªt
 = 
	`sfs_bm≠_gë_sub_nﬁock
(
sfs
, &
ít
, 
ödex
, 
¸óã
, &
öo
)) != 0) {

277  
ªt
;

279 i‡(
ít
 !
dö
->
ödúe˘
) {

280 
	`as£π
(
dö
->
ödúe˘
 == 0);

281 
dö
->
ödúe˘
 = 
ít
;

282 
sö
->
dúty
 = 1;

284 
out
;

286 
	`∑nic
 ("sfs_bmap_get_nolock - index out ofÑange");

288 
out
:

289 
	`as£π
(
öo
 =0 || 
	`sfs_block_öu£
(
sfs
, ino));

290 *
öo_°‹e
 = 
öo
;

292 
	}
}

298 
	$sfs_bm≠_‰ì_sub_nﬁock
(
sfs_fs
 *
sfs
, 
uöt32_t
 
ít
, uöt32_à
ödex
) {

299 
	`as£π
(
	`sfs_block_öu£
(
sfs
, 
ít
Ë&& 
ödex
 < 
SFS_BLK_NENTRY
);

300 
ªt
;

301 
uöt32_t
 
öo
, 
zîo
 = 0;

302 
off_t
 
off£t
 = 
ödex
 * (
uöt32_t
);

303 i‡((
ªt
 = 
	`sfs_rbuf
(
sfs
, &
öo
, (
uöt32_t
), 
ít
, 
off£t
)) != 0) {

304  
ªt
;

306 i‡(
öo
 != 0) {

307 i‡((
ªt
 = 
	`sfs_wbuf
(
sfs
, &
zîo
, (
uöt32_t
), 
ít
, 
off£t
)) != 0) {

308  
ªt
;

310 
	`sfs_block_‰ì
(
sfs
, 
öo
);

313 
	}
}

319 
	$sfs_bm≠_‰ì_nﬁock
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
, 
uöt32_t
 
ödex
) {

320 
sfs_disk_öode
 *
dö
 = 
sö
->din;

321 
ªt
;

322 
uöt32_t
 
ít
, 
öo
;

323 i‡(
ödex
 < 
SFS_NDIRECT
) {

324 i‡((
öo
 = 
dö
->
dúe˘
[
ödex
]) != 0) {

326 
	`sfs_block_‰ì
(
sfs
, 
öo
);

327 
dö
->
dúe˘
[
ödex
] = 0;

328 
sö
->
dúty
 = 1;

333 
ödex
 -
SFS_NDIRECT
;

334 i‡(
ödex
 < 
SFS_BLK_NENTRY
) {

335 i‡((
ít
 = 
dö
->
ödúe˘
) != 0) {

337 i‡((
ªt
 = 
	`sfs_bm≠_‰ì_sub_nﬁock
(
sfs
, 
ít
, 
ödex
)) != 0) {

338  
ªt
;

344 
	}
}

354 
	$sfs_bm≠_lﬂd_nﬁock
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
, 
uöt32_t
 
ödex
, uöt32_à*
öo_°‹e
) {

355 
sfs_disk_öode
 *
dö
 = 
sö
->din;

356 
	`as£π
(
ödex
 <
dö
->
blocks
);

357 
ªt
;

358 
uöt32_t
 
öo
;

359 
boﬁ
 
¸óã
 = (
ödex
 =
dö
->
blocks
);

360 i‡((
ªt
 = 
	`sfs_bm≠_gë_nﬁock
(
sfs
, 
sö
, 
ödex
, 
¸óã
, &
öo
)) != 0) {

361  
ªt
;

363 
	`as£π
(
	`sfs_block_öu£
(
sfs
, 
öo
));

364 i‡(
¸óã
) {

365 
dö
->
blocks
 ++;

367 i‡(
öo_°‹e
 !
NULL
) {

368 *
öo_°‹e
 = 
öo
;

371 
	}
}

377 
	$sfs_bm≠_åunˇã_nﬁock
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
) {

378 
sfs_disk_öode
 *
dö
 = 
sö
->din;

379 
	`as£π
(
dö
->
blocks
 != 0);

380 
ªt
;

381 i‡((
ªt
 = 
	`sfs_bm≠_‰ì_nﬁock
(
sfs
, 
sö
, 
dö
->
blocks
 - 1)) != 0) {

382  
ªt
;

384 
dö
->
blocks
 --;

385 
sö
->
dúty
 = 1;

387 
	}
}

397 
	$sfs_dúít_ªad_nﬁock
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
, 
¶Ÿ
, 
sfs_disk_íåy
 *
íåy
) {

398 
	`as£π
(
sö
->
dö
->
ty≥
 =
SFS_TYPE_DIR
 && (
¶Ÿ
 >0 && slŸ < sö->dö->
blocks
));

399 
ªt
;

400 
uöt32_t
 
öo
;

402 i‡((
ªt
 = 
	`sfs_bm≠_lﬂd_nﬁock
(
sfs
, 
sö
, 
¶Ÿ
, &
öo
)) != 0) {

403  
ªt
;

405 
	`as£π
(
	`sfs_block_öu£
(
sfs
, 
öo
));

407 i‡((
ªt
 = 
	`sfs_rbuf
(
sfs
, 
íåy
, (
sfs_disk_íåy
), 
öo
, 0)) != 0) {

408  
ªt
;

410 
íåy
->
«me
[
SFS_MAX_FNAME_LEN
] = '\0';

412 
	}
}

414 
	#sfs_dúít_lök_nﬁock_check
(
sfs
, 
sö
, 
¶Ÿ
, 
 ksö
, 
«me
) \

416 
îr
; \

417 i‡((
îr
 = 
	`sfs_dúít_lök_nﬁock
(
sfs
, 
sö
, 
¶Ÿ
, 
 ksö
, 
«me
)) != 0) { \

418 
	`w¨n
("sfs_dúít_lökÉº‹: %e.\n", 
îr
); \

420 } 0)

	)

422 
	#sfs_dúít_u∆ök_nﬁock_check
(
sfs
, 
sö
, 
¶Ÿ
, 
 ksö
) \

424 
îr
; \

425 i‡((
îr
 = 
	`sfs_dúít_u∆ök_nﬁock
(
sfs
, 
sö
, 
¶Ÿ
, 
 ksö
)) != 0) { \

426 
	`w¨n
("sfs_dúít_u∆ökÉº‹: %e.\n", 
îr
); \

428 } 0)

	)

441 
	$sfs_dúít_£¨ch_nﬁock
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
, c⁄° *
«me
, 
uöt32_t
 *
öo_°‹e
, *
¶Ÿ
, *
em±y_¶Ÿ
) {

442 
	`as£π
(
	`°æí
(
«me
Ë<
SFS_MAX_FNAME_LEN
);

443 
sfs_disk_íåy
 *
íåy
;

444 i‡((
íåy
 = 
	`kmÆloc
((
sfs_disk_íåy
))Ë=
NULL
) {

445  -
E_NO_MEM
;

448 
	#£t_pvÆue
(
x
, 
v
Ëdÿ{ i‡((xË!
NULL
Ë{ *(xË(v); } } 0)

	)

449 
ªt
, 
i
, 
n¶Ÿs
 = 
sö
->
dö
->
blocks
;

450 
	`£t_pvÆue
(
em±y_¶Ÿ
, 
n¶Ÿs
);

451 
i
 = 0; i < 
n¶Ÿs
; i ++) {

452 i‡((
ªt
 = 
	`sfs_dúít_ªad_nﬁock
(
sfs
, 
sö
, 
i
, 
íåy
)) != 0) {

453 
out
;

455 i‡(
íåy
->
öo
 == 0) {

456 
	`£t_pvÆue
(
em±y_¶Ÿ
, 
i
);

459 i‡(
	`°rcmp
(
«me
, 
íåy
->name) == 0) {

460 
	`£t_pvÆue
(
¶Ÿ
, 
i
);

461 
	`£t_pvÆue
(
öo_°‹e
, 
íåy
->
öo
);

462 
out
;

465 #unde‡
£t_pvÆue


466 
ªt
 = -
E_NOENT
;

467 
out
:

468 
	`k‰ì
(
íåy
);

469  
ªt
;

470 
	}
}

477 
	$sfs_dúít_födöo_nﬁock
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
, 
uöt32_t
 
öo
, 
sfs_disk_íåy
 *
íåy
) {

478 
ªt
, 
i
, 
n¶Ÿs
 = 
sö
->
dö
->
blocks
;

479 
i
 = 0; i < 
n¶Ÿs
; i ++) {

480 i‡((
ªt
 = 
	`sfs_dúít_ªad_nﬁock
(
sfs
, 
sö
, 
i
, 
íåy
)) != 0) {

481  
ªt
;

483 i‡(
íåy
->
öo
 == ino) {

487  -
E_NOENT
;

488 
	}
}

499 
	$sfs_lookup_⁄˚
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
, c⁄° *
«me
, 
öode
 **
node_°‹e
, *
¶Ÿ
) {

500 
ªt
;

501 
uöt32_t
 
öo
;

502 
	`lock_sö
(
sö
);

504 
ªt
 = 
	`sfs_dúít_£¨ch_nﬁock
(
sfs
, 
sö
, 
«me
, &
öo
, 
¶Ÿ
, 
NULL
);

506 
	`u∆ock_sö
(
sö
);

507 i‡(
ªt
 == 0) {

509 
ªt
 = 
	`sfs_lﬂd_öode
(
sfs
, 
node_°‹e
, 
öo
);

511  
ªt
;

512 
	}
}

516 
	$sfs_›ídú
(
öode
 *
node
, 
uöt32_t
 
›í_Êags
) {

517 
›í_Êags
 & 
O_ACCMODE
) {

518 
O_RDONLY
:

520 
O_WRONLY
:

521 
O_RDWR
:

523  -
E_ISDIR
;

525 i‡(
›í_Êags
 & 
O_APPEND
) {

526  -
E_ISDIR
;

529 
	}
}

533 
	$sfs_›ífûe
(
öode
 *
node
, 
uöt32_t
 
›í_Êags
) {

535 
	}
}

539 
	$sfs_˛o£
(
öode
 *
node
) {

540  
	`v›_fsync
(
node
);

541 
	}
}

553 
	$sfs_io_nﬁock
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
, *
buf
, 
off_t
 
off£t
, 
size_t
 *
Æíp
, 
boﬁ
 
wrôe
) {

554 
sfs_disk_öode
 *
dö
 = 
sö
->din;

555 
	`as£π
(
dö
->
ty≥
 !
SFS_TYPE_DIR
);

556 
off_t
 
ídpos
 = 
off£t
 + *
Æíp
, 
blkoff
;

557 *
Æíp
 = 0;

559 i‡(
off£t
 < 0 || off£à>
SFS_MAX_FILE_SIZE
 || off£à> 
ídpos
) {

560  -
E_INVAL
;

562 i‡(
off£t
 =
ídpos
) {

565 i‡(
ídpos
 > 
SFS_MAX_FILE_SIZE
) {

566 
ídpos
 = 
SFS_MAX_FILE_SIZE
;

568 i‡(!
wrôe
) {

569 i‡(
off£t
 >
dö
->
size
) {

572 i‡(
ídpos
 > 
dö
->
size
) {

573 
ídpos
 = 
dö
->
size
;

577 (*
sfs_buf_›
)(
sfs_fs
 *
sfs
, *
buf
, 
size_t
 
Àn
, 
uöt32_t
 
blkno
, 
off_t
 
off£t
);

578 (*
sfs_block_›
)(
sfs_fs
 *
sfs
, *
buf
, 
uöt32_t
 
blkno
, uöt32_à
nblks
);

579 i‡(
wrôe
) {

580 
sfs_buf_›
 = 
sfs_wbuf
, 
sfs_block_›
 = 
sfs_wblock
;

583 
sfs_buf_›
 = 
sfs_rbuf
, 
sfs_block_›
 = 
sfs_rblock
;

586 
ªt
 = 0;

587 
size_t
 
size
, 
Æí
 = 0;

588 
uöt32_t
 
öo
;

589 
uöt32_t
 
blkno
 = 
off£t
 / 
SFS_BLKSIZE
;

590 
uöt32_t
 
nblks
 = 
ídpos
 / 
SFS_BLKSIZE
 - 
blkno
;

602 i‡((
blkoff
 = 
off£t
 % 
SFS_BLKSIZE
) != 0) {

603 
size
 = (
nblks
 !0Ë? (
SFS_BLKSIZE
 - 
blkoff
Ë: (
ídpos
 - 
off£t
);

604 i‡((
ªt
 = 
	`sfs_bm≠_lﬂd_nﬁock
(
sfs
, 
sö
, 
blkno
, &
öo
)) != 0) {

605 
out
;

607 i‡((
ªt
 = 
	`sfs_buf_›
(
sfs
, 
buf
, 
size
, 
öo
, 
blkoff
)) != 0) {

608 
out
;

610 
Æí
 +
size
;

611 i‡(
nblks
 == 0) {

612 
out
;

614 
buf
 +
size
, 
blkno
 ++, 
nblks
 --;

617 
size
 = 
SFS_BLKSIZE
;

618 
nblks
 != 0) {

619 i‡((
ªt
 = 
	`sfs_bm≠_lﬂd_nﬁock
(
sfs
, 
sö
, 
blkno
, &
öo
)) != 0) {

620 
out
;

622 i‡((
ªt
 = 
	`sfs_block_›
(
sfs
, 
buf
, 
öo
, 1)) != 0) {

623 
out
;

625 
Æí
 +
size
, 
buf
 +size, 
blkno
 ++, 
nblks
 --;

628 i‡((
size
 = 
ídpos
 % 
SFS_BLKSIZE
) != 0) {

629 i‡((
ªt
 = 
	`sfs_bm≠_lﬂd_nﬁock
(
sfs
, 
sö
, 
blkno
, &
öo
)) != 0) {

630 
out
;

632 i‡((
ªt
 = 
	`sfs_buf_›
(
sfs
, 
buf
, 
size
, 
öo
, 0)) != 0) {

633 
out
;

635 
Æí
 +
size
;

637 
out
:

638 *
Æíp
 = 
Æí
;

639 i‡(
off£t
 + 
Æí
 > 
sö
->
dö
->
size
) {

640 
sö
->
dö
->
size
 = 
off£t
 + 
Æí
;

641 
sö
->
dúty
 = 1;

643  
ªt
;

644 
	}
}

650 
ölöe
 

651 
	$sfs_io
(
öode
 *
node
, 
iobuf
 *
iob
, 
boﬁ
 
wrôe
) {

652 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
	`v›_fs
(
node
), sfs);

653 
sfs_öode
 *
sö
 = 
	`v›_öfo
(
node
, sfs_inode);

654 
ªt
;

655 
	`lock_sö
(
sö
);

657 
size_t
 
Æí
 = 
iob
->
io_ªsid
;

658 
ªt
 = 
	`sfs_io_nﬁock
(
sfs
, 
sö
, 
iob
->
io_ba£
, iob->
io_off£t
, &
Æí
, 
wrôe
);

659 i‡(
Æí
 != 0) {

660 
	`iobuf_skù
(
iob
, 
Æí
);

663 
	`u∆ock_sö
(
sö
);

664  
ªt
;

665 
	}
}

669 
	$sfs_ªad
(
öode
 *
node
, 
iobuf
 *
iob
) {

670  
	`sfs_io
(
node
, 
iob
, 0);

671 
	}
}

675 
	$sfs_wrôe
(
öode
 *
node
, 
iobuf
 *
iob
) {

676  
	`sfs_io
(
node
, 
iob
, 1);

677 
	}
}

683 
	$sfs_f°©
(
öode
 *
node
, 
°©
 *stat) {

684 
ªt
;

685 
	`mem£t
(
°©
, 0, (stat));

686 i‡((
ªt
 = 
	`v›_gëty≥
(
node
, &(
°©
->
°_mode
))) != 0) {

687  
ªt
;

689 
sfs_disk_öode
 *
dö
 = 
	`v›_öfo
(
node
, 
sfs_öode
)->din;

690 
°©
->
°_∆öks
 = 
dö
->
∆öks
;

691 
°©
->
°_blocks
 = 
dö
->
blocks
;

692 
°©
->
°_size
 = 
dö
->
size
;

694 
	}
}

700 
	$sfs_fsync
(
öode
 *
node
) {

701 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
	`v›_fs
(
node
), sfs);

702 
sfs_öode
 *
sö
 = 
	`v›_öfo
(
node
, sfs_inode);

703 
ªt
 = 0;

704 i‡(
sö
->
dúty
) {

705 
	`lock_sö
(
sö
);

707 i‡(
sö
->
dúty
) {

708 
sö
->
dúty
 = 0;

709 i‡((
ªt
 = 
	`sfs_wbuf
(
sfs
, 
sö
->
dö
, (
sfs_disk_öode
), sö->
öo
, 0)) != 0) {

710 
sö
->
dúty
 = 1;

714 
	`u∆ock_sö
(
sö
);

716  
ªt
;

717 
	}
}

724 
	$sfs_«mefûe
(
öode
 *
node
, 
iobuf
 *
iob
) {

725 
sfs_disk_íåy
 *
íåy
;

726 i‡(
iob
->
io_ªsid
 <2 || (
íåy
 = 
	`kmÆloc
((
sfs_disk_íåy
))Ë=
NULL
) {

727  -
E_NO_MEM
;

730 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
	`v›_fs
(
node
), sfs);

731 
sfs_öode
 *
sö
 = 
	`v›_öfo
(
node
, sfs_inode);

733 
ªt
;

734 *
±r
 = 
iob
->
io_ba£
 + iob->
io_ªsid
;

735 
size_t
 
Æí
, 
ªsid
 = 
iob
->
io_ªsid
 - 2;

736 
	`v›_ªf_öc
(
node
);

738 
öode
 *
∑ª¡
;

739 i‡((
ªt
 = 
	`sfs_lookup_⁄˚
(
sfs
, 
sö
, "..", &
∑ª¡
, 
NULL
)) != 0) {

740 
Áûed
;

743 
uöt32_t
 
öo
 = 
sö
->ino;

744 
	`v›_ªf_dec
(
node
);

745 i‡(
node
 =
∑ª¡
) {

746 
	`v›_ªf_dec
(
node
);

750 
node
 = 
∑ª¡
, 
sö
 = 
	`v›_öfo
“ode, 
sfs_öode
);

751 
	`as£π
(
öo
 !
sö
->öÿ&& sö->
dö
->
ty≥
 =
SFS_TYPE_DIR
);

753 
	`lock_sö
(
sö
);

755 
ªt
 = 
	`sfs_dúít_födöo_nﬁock
(
sfs
, 
sö
, 
öo
, 
íåy
);

757 
	`u∆ock_sö
(
sö
);

759 i‡(
ªt
 != 0) {

760 
Áûed
;

763 i‡((
Æí
 = 
	`°æí
(
íåy
->
«me
Ë+ 1Ë> 
ªsid
) {

764 
Áûed_nomem
;

766 
ªsid
 -
Æí
, 
±r
 -=álen;

767 
	`mem˝y
(
±r
, 
íåy
->
«me
, 
Æí
 - 1);

768 
±r
[
Æí
 - 1] = '/';

770 
Æí
 = 
iob
->
io_ªsid
 - 
ªsid
 - 2;

771 
±r
 = 
	`memmove
(
iob
->
io_ba£
 + 1,Öå, 
Æí
);

772 
±r
[-1] = '/',Öå[
Æí
] = '\0';

773 
	`iobuf_skù
(
iob
, 
Æí
);

774 
	`k‰ì
(
íåy
);

777 
Áûed_nomem
:

778 
ªt
 = -
E_NO_MEM
;

779 
Áûed
:

780 
	`v›_ªf_dec
(
node
);

781 
	`k‰ì
(
íåy
);

782  
ªt
;

783 
	}
}

789 
	$sfs_gëdúíåy_sub_nﬁock
(
sfs_fs
 *
sfs
, 
sfs_öode
 *
sö
, 
¶Ÿ
, 
sfs_disk_íåy
 *
íåy
) {

790 
ªt
, 
i
, 
n¶Ÿs
 = 
sö
->
dö
->
blocks
;

791 
i
 = 0; i < 
n¶Ÿs
; i ++) {

792 i‡((
ªt
 = 
	`sfs_dúít_ªad_nﬁock
(
sfs
, 
sö
, 
i
, 
íåy
)) != 0) {

793  
ªt
;

795 i‡(
íåy
->
öo
 != 0) {

796 i‡(
¶Ÿ
 == 0) {

799 
¶Ÿ
 --;

802  -
E_NOENT
;

803 
	}
}

810 
	$sfs_gëdúíåy
(
öode
 *
node
, 
iobuf
 *
iob
) {

811 
sfs_disk_íåy
 *
íåy
;

812 i‡((
íåy
 = 
	`kmÆloc
((
sfs_disk_íåy
))Ë=
NULL
) {

813  -
E_NO_MEM
;

816 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
	`v›_fs
(
node
), sfs);

817 
sfs_öode
 *
sö
 = 
	`v›_öfo
(
node
, sfs_inode);

819 
ªt
, 
¶Ÿ
;

820 
off_t
 
off£t
 = 
iob
->
io_off£t
;

821 i‡(
off£t
 < 0 || off£à% 
sfs_díåy_size
 != 0) {

822 
	`k‰ì
(
íåy
);

823  -
E_INVAL
;

825 i‡((
¶Ÿ
 = 
off£t
 / 
sfs_díåy_size
Ë> 
sö
->
dö
->
blocks
) {

826 
	`k‰ì
(
íåy
);

827  -
E_NOENT
;

829 
	`lock_sö
(
sö
);

830 i‡((
ªt
 = 
	`sfs_gëdúíåy_sub_nﬁock
(
sfs
, 
sö
, 
¶Ÿ
, 
íåy
)) != 0) {

831 
	`u∆ock_sö
(
sö
);

832 
out
;

834 
	`u∆ock_sö
(
sö
);

835 
ªt
 = 
	`iobuf_move
(
iob
, 
íåy
->
«me
, 
sfs_díåy_size
, 1, 
NULL
);

836 
out
:

837 
	`k‰ì
(
íåy
);

838  
ªt
;

839 
	}
}

845 
	$sfs_ª˛aim
(
öode
 *
node
) {

846 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
	`v›_fs
(
node
), sfs);

847 
sfs_öode
 *
sö
 = 
	`v›_öfo
(
node
, sfs_inode);

849 
ªt
 = -
E_BUSY
;

850 
uöt32_t
 
ít
;

851 
	`lock_sfs_fs
(
sfs
);

852 
	`as£π
(
sö
->
ª˛aim_cou¡
 > 0);

853 i‡((-- 
sö
->
ª˛aim_cou¡
Ë!0 || 
	`öode_ªf_cou¡
(
node
) != 0) {

854 
Áûed_u∆ock
;

856 i‡(
sö
->
dö
->
∆öks
 == 0) {

857 i‡((
ªt
 = 
	`v›_åunˇã
(
node
, 0)) != 0) {

858 
Áûed_u∆ock
;

861 i‡(
sö
->
dúty
) {

862 i‡((
ªt
 = 
	`v›_fsync
(
node
)) != 0) {

863 
Áûed_u∆ock
;

866 
	`sfs_ªmove_löks
(
sö
);

867 
	`u∆ock_sfs_fs
(
sfs
);

869 i‡(
sö
->
dö
->
∆öks
 == 0) {

870 
	`sfs_block_‰ì
(
sfs
, 
sö
->
öo
);

871 i‡((
ít
 = 
sö
->
dö
->
ödúe˘
) != 0) {

872 
	`sfs_block_‰ì
(
sfs
, 
ít
);

875 
	`k‰ì
(
sö
->
dö
);

876 
	`v›_kûl
(
node
);

879 
Áûed_u∆ock
:

880 
	`u∆ock_sfs_fs
(
sfs
);

881  
ªt
;

882 
	}
}

888 
	$sfs_gëty≥
(
öode
 *
node
, 
uöt32_t
 *
ty≥_°‹e
) {

889 
sfs_disk_öode
 *
dö
 = 
	`v›_öfo
(
node
, 
sfs_öode
)->din;

890 
dö
->
ty≥
) {

891 
SFS_TYPE_DIR
:

892 *
ty≥_°‹e
 = 
S_IFDIR
;

894 
SFS_TYPE_FILE
:

895 *
ty≥_°‹e
 = 
S_IFREG
;

897 
SFS_TYPE_LINK
:

898 *
ty≥_°‹e
 = 
S_IFLNK
;

901 
	`∑nic
("övÆid fûêty≥ %d.\n", 
dö
->
ty≥
);

902 
	}
}

908 
	$sfs_åy£ek
(
öode
 *
node
, 
off_t
 
pos
) {

909 i‡(
pos
 < 0 ||Öo†>
SFS_MAX_FILE_SIZE
) {

910  -
E_INVAL
;

912 
sfs_öode
 *
sö
 = 
	`v›_öfo
(
node
, sfs_inode);

913 i‡(
pos
 > 
sö
->
dö
->
size
) {

914  
	`v›_åunˇã
(
node
, 
pos
);

917 
	}
}

923 
	$sfs_åuncfûe
(
öode
 *
node
, 
off_t
 
Àn
) {

924 i‡(
Àn
 < 0 ||Üí > 
SFS_MAX_FILE_SIZE
) {

925  -
E_INVAL
;

927 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
	`v›_fs
(
node
), sfs);

928 
sfs_öode
 *
sö
 = 
	`v›_öfo
(
node
, sfs_inode);

929 
sfs_disk_öode
 *
dö
 = 
sö
->din;

931 
ªt
 = 0;

933 
uöt32_t
 
nblks
, 
tblks
 = 
	`ROUNDUP_DIV
(
Àn
, 
SFS_BLKSIZE
);

934 i‡(
dö
->
size
 =
Àn
) {

935 
	`as£π
(
tblks
 =
dö
->
blocks
);

939 
	`lock_sö
(
sö
);

941 
nblks
 = 
dö
->
blocks
;

942 i‡(
nblks
 < 
tblks
) {

944 
nblks
 !
tblks
) {

945 i‡((
ªt
 = 
	`sfs_bm≠_lﬂd_nﬁock
(
sfs
, 
sö
, 
nblks
, 
NULL
)) != 0) {

946 
out_u∆ock
;

948 
nblks
 ++;

951 i‡(
tblks
 < 
nblks
) {

953 
tblks
 !
nblks
) {

954 i‡((
ªt
 = 
	`sfs_bm≠_åunˇã_nﬁock
(
sfs
, 
sö
)) != 0) {

955 
out_u∆ock
;

957 
nblks
 --;

960 
	`as£π
(
dö
->
blocks
 =
tblks
);

961 
dö
->
size
 = 
Àn
;

962 
sö
->
dúty
 = 1;

964 
out_u∆ock
:

965 
	`u∆ock_sö
(
sö
);

966  
ªt
;

967 
	}
}

975 
	$sfs_lookup
(
öode
 *
node
, *
∑th
, öodê**
node_°‹e
) {

976 
sfs_fs
 *
sfs
 = 
	`fs›_öfo
(
	`v›_fs
(
node
), sfs);

977 
	`as£π
(*
∑th
 != '\0' && *path != '/');

978 
	`v›_ªf_öc
(
node
);

979 
sfs_öode
 *
sö
 = 
	`v›_öfo
(
node
, sfs_inode);

980 i‡(
sö
->
dö
->
ty≥
 !
SFS_TYPE_DIR
) {

981 
	`v›_ªf_dec
(
node
);

982  -
E_NOTDIR
;

984 
öode
 *
subnode
;

985 
ªt
 = 
	`sfs_lookup_⁄˚
(
sfs
, 
sö
, 
∑th
, &
subnode
, 
NULL
);

987 
	`v›_ªf_dec
(
node
);

988 i‡(
ªt
 != 0) {

989  
ªt
;

991 *
node_°‹e
 = 
subnode
;

993 
	}
}

996 c⁄° 
öode_›s
 
	gsfs_node_dú›s
 = {

997 .
v›_magic
 = 
VOP_MAGIC
,

998 .
	gv›_›í
 = 
sfs_›ídú
,

999 .
	gv›_˛o£
 = 
sfs_˛o£
,

1000 .
	gv›_f°©
 = 
sfs_f°©
,

1001 .
	gv›_fsync
 = 
sfs_fsync
,

1002 .
	gv›_«mefûe
 = 
sfs_«mefûe
,

1003 .
	gv›_gëdúíåy
 = 
sfs_gëdúíåy
,

1004 .
	gv›_ª˛aim
 = 
sfs_ª˛aim
,

1005 .
	gv›_gëty≥
 = 
sfs_gëty≥
,

1006 .
	gv›_lookup
 = 
sfs_lookup
,

1009 c⁄° 
öode_›s
 
	gsfs_node_fûe›s
 = {

1010 .
v›_magic
 = 
VOP_MAGIC
,

1011 .
	gv›_›í
 = 
sfs_›ífûe
,

1012 .
	gv›_˛o£
 = 
sfs_˛o£
,

1013 .
	gv›_ªad
 = 
sfs_ªad
,

1014 .
	gv›_wrôe
 = 
sfs_wrôe
,

1015 .
	gv›_f°©
 = 
sfs_f°©
,

1016 .
	gv›_fsync
 = 
sfs_fsync
,

1017 .
	gv›_ª˛aim
 = 
sfs_ª˛aim
,

1018 .
	gv›_gëty≥
 = 
sfs_gëty≥
,

1019 .
	gv›_åy£ek
 = 
sfs_åy£ek
,

1020 .
	gv›_åunˇã
 = 
sfs_åuncfûe
,

	@kern/fs/sfs/sfs_io.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<dev.h
>

4 
	~<sfs.h
>

5 
	~<iobuf.h
>

6 
	~<bôm≠.h
>

7 
	~<as£π.h
>

20 
	$sfs_rwblock_nﬁock
(
sfs_fs
 *
sfs
, *
buf
, 
uöt32_t
 
blkno
, 
boﬁ
 
wrôe
, boﬁ 
check
) {

21 
	`as£π
((
blkno
 !0 || !
check
Ë&& blknÿ< 
sfs
->
su≥r
.
blocks
);

22 
iobuf
 
__iob
, *
iob
 = 
	`iobuf_öô
(&__iob, 
buf
, 
SFS_BLKSIZE
, 
blkno
 * SFS_BLKSIZE);

23  
	`d›_io
(
sfs
->
dev
, 
iob
, 
wrôe
);

24 
	}
}

35 
	$sfs_rwblock
(
sfs_fs
 *
sfs
, *
buf
, 
uöt32_t
 
blkno
, uöt32_à
nblks
, 
boﬁ
 
wrôe
) {

36 
ªt
 = 0;

37 
	`lock_sfs_io
(
sfs
);

39 
nblks
 != 0) {

40 i‡((
ªt
 = 
	`sfs_rwblock_nﬁock
(
sfs
, 
buf
, 
blkno
, 
wrôe
, 1)) != 0) {

43 
blkno
 ++, 
nblks
 --;

44 
buf
 +
SFS_BLKSIZE
;

47 
	`u∆ock_sfs_io
(
sfs
);

48  
ªt
;

49 
	}
}

59 
	$sfs_rblock
(
sfs_fs
 *
sfs
, *
buf
, 
uöt32_t
 
blkno
, uöt32_à
nblks
) {

60  
	`sfs_rwblock
(
sfs
, 
buf
, 
blkno
, 
nblks
, 0);

61 
	}
}

71 
	$sfs_wblock
(
sfs_fs
 *
sfs
, *
buf
, 
uöt32_t
 
blkno
, uöt32_à
nblks
) {

72  
	`sfs_rwblock
(
sfs
, 
buf
, 
blkno
, 
nblks
, 1);

73 
	}
}

84 
	$sfs_rbuf
(
sfs_fs
 *
sfs
, *
buf
, 
size_t
 
Àn
, 
uöt32_t
 
blkno
, 
off_t
 
off£t
) {

85 
	`as£π
(
off£t
 >0 && off£à< 
SFS_BLKSIZE
 && off£à+ 
Àn
 <= SFS_BLKSIZE);

86 
ªt
;

87 
	`lock_sfs_io
(
sfs
);

89 i‡((
ªt
 = 
	`sfs_rwblock_nﬁock
(
sfs
, sfs->
sfs_buf„r
, 
blkno
, 0, 1)) == 0) {

90 
	`mem˝y
(
buf
, 
sfs
->
sfs_buf„r
 + 
off£t
, 
Àn
);

93 
	`u∆ock_sfs_io
(
sfs
);

94  
ªt
;

95 
	}
}

106 
	$sfs_wbuf
(
sfs_fs
 *
sfs
, *
buf
, 
size_t
 
Àn
, 
uöt32_t
 
blkno
, 
off_t
 
off£t
) {

107 
	`as£π
(
off£t
 >0 && off£à< 
SFS_BLKSIZE
 && off£à+ 
Àn
 <= SFS_BLKSIZE);

108 
ªt
;

109 
	`lock_sfs_io
(
sfs
);

111 i‡((
ªt
 = 
	`sfs_rwblock_nﬁock
(
sfs
, sfs->
sfs_buf„r
, 
blkno
, 0, 1)) == 0) {

112 
	`mem˝y
(
sfs
->
sfs_buf„r
 + 
off£t
, 
buf
, 
Àn
);

113 
ªt
 = 
	`sfs_rwblock_nﬁock
(
sfs
, sfs->
sfs_buf„r
, 
blkno
, 1, 1);

116 
	`u∆ock_sfs_io
(
sfs
);

117  
ªt
;

118 
	}
}

124 
	$sfs_sync_su≥r
(
sfs_fs
 *
sfs
) {

125 
ªt
;

126 
	`lock_sfs_io
(
sfs
);

128 
	`mem£t
(
sfs
->
sfs_buf„r
, 0, 
SFS_BLKSIZE
);

129 
	`mem˝y
(
sfs
->
sfs_buf„r
, &(sfs->
su≥r
), (sfs->super));

130 
ªt
 = 
	`sfs_rwblock_nﬁock
(
sfs
, sfs->
sfs_buf„r
, 
SFS_BLKN_SUPER
, 1, 0);

132 
	`u∆ock_sfs_io
(
sfs
);

133  
ªt
;

134 
	}
}

140 
	$sfs_sync_‰ìm≠
(
sfs_fs
 *
sfs
) {

141 
uöt32_t
 
nblks
 = 
	`sfs_‰ìm≠_blocks
(&(
sfs
->
su≥r
));

142  
	`sfs_wblock
(
sfs
, 
	`bôm≠_gëd©a
(sfs->
‰ìm≠
, 
NULL
), 
SFS_BLKN_FREEMAP
, 
nblks
);

143 
	}
}

152 
	$sfs_˛ór_block
(
sfs_fs
 *
sfs
, 
uöt32_t
 
blkno
, uöt32_à
nblks
) {

153 
ªt
;

154 
	`lock_sfs_io
(
sfs
);

156 
	`mem£t
(
sfs
->
sfs_buf„r
, 0, 
SFS_BLKSIZE
);

157 
nblks
 != 0) {

158 i‡((
ªt
 = 
	`sfs_rwblock_nﬁock
(
sfs
, sfs->
sfs_buf„r
, 
blkno
, 1, 1)) != 0) {

161 
blkno
 ++, 
nblks
 --;

164 
	`u∆ock_sfs_io
(
sfs
);

165  
ªt
;

166 
	}
}

	@kern/fs/sfs/sfs_lock.c

1 
	~<defs.h
>

2 
	~<£m.h
>

3 
	~<sfs.h
>

12 
	$lock_sfs_fs
(
sfs_fs
 *
sfs
) {

13 
	`down
(&(
sfs
->
fs_£m
));

14 
	}
}

22 
	$lock_sfs_io
(
sfs_fs
 *
sfs
) {

23 
	`down
(&(
sfs
->
io_£m
));

24 
	}
}

32 
	$u∆ock_sfs_fs
(
sfs_fs
 *
sfs
) {

33 
	`up
(&(
sfs
->
fs_£m
));

34 
	}
}

42 
	$u∆ock_sfs_io
(
sfs_fs
 *
sfs
) {

43 
	`up
(&(
sfs
->
io_£m
));

44 
	}
}

	@kern/fs/swap/swapfs.c

1 
	~<sw≠.h
>

2 
	~<sw≠fs.h
>

3 
	~<mmu.h
>

4 
	~<fs.h
>

5 
	~<ide.h
>

6 
	~<pmm.h
>

7 
	~<as£π.h
>

10 
	$sw≠fs_öô
() {

11 
	`°©ic_as£π
((
PGSIZE
 % 
SECTSIZE
) == 0);

12 i‡(!
	`ide_devi˚_vÆid
(
SWAP_DEV_NO
)) {

13 
	`∑nic
("swap fs isn'távailable.\n");

15 
max_sw≠_off£t
 = 
	`ide_devi˚_size
(
SWAP_DEV_NO
Ë/ (
PGSIZE
 / 
SECTSIZE
);

16 
	}
}

19 
	$sw≠fs_ªad
(
sw≠_íåy_t
 
íåy
, 
Page
 *
∑ge
) {

20  
	`ide_ªad_£cs
(
SWAP_DEV_NO
, 
	`sw≠_off£t
(
íåy
Ë* 
PAGE_NSECT
, 
	`∑ge2kva
(
∑ge
), PAGE_NSECT);

21 
	}
}

24 
	$sw≠fs_wrôe
(
sw≠_íåy_t
 
íåy
, 
Page
 *
∑ge
) {

25  
	`ide_wrôe_£cs
(
SWAP_DEV_NO
, 
	`sw≠_off£t
(
íåy
Ë* 
PAGE_NSECT
, 
	`∑ge2kva
(
∑ge
), PAGE_NSECT);

26 
	}
}

	@kern/fs/swap/swapfs.h

1 #i‚de‡
__KERN_FS_SWAP_SWAPFS_H__


2 
	#__KERN_FS_SWAP_SWAPFS_H__


	)

4 
	~<memœyout.h
>

5 
	~<sw≠.h
>

7 
sw≠fs_öô
();

8 
sw≠fs_ªad
(
sw≠_íåy_t
 
íåy
, 
Page
 *
∑ge
);

9 
sw≠fs_wrôe
(
sw≠_íåy_t
 
íåy
, 
Page
 *
∑ge
);

	@kern/fs/sysfile.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<vmm.h
>

4 
	~<¥oc.h
>

5 
	~<kmÆloc.h
>

6 
	~<vfs.h
>

7 
	~<fûe.h
>

8 
	~<iobuf.h
>

9 
	~<sysfûe.h
>

10 
	~<°©.h
>

11 
	~<dúít.h
>

12 
	~<uni°d.h
>

13 
	~<îr‹.h
>

14 
	~<as£π.h
>

16 
	#IOBUF_SIZE
 4096

	)

20 
	$c›y_∑th
(**
to
, c⁄° *
‰om
) {

21 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

22 *
buf„r
;

23 i‡((
buf„r
 = 
	`kmÆloc
(
FS_MAX_FPATH_LEN
 + 1)Ë=
NULL
) {

24  -
E_NO_MEM
;

26 
	`lock_mm
(
mm
);

27 i‡(!
	`c›y_°rög
(
mm
, 
buf„r
, 
‰om
, 
FS_MAX_FPATH_LEN
 + 1)) {

28 
	`u∆ock_mm
(
mm
);

29 
Áûed_˛ónup
;

31 
	`u∆ock_mm
(
mm
);

32 *
to
 = 
buf„r
;

35 
Áûed_˛ónup
:

36 
	`k‰ì
(
buf„r
);

37  -
E_INVAL
;

38 
	}
}

42 
	$sysfûe_›í
(c⁄° *
__∑th
, 
uöt32_t
 
›í_Êags
) {

43 
ªt
;

44 *
∑th
;

45 i‡((
ªt
 = 
	`c›y_∑th
(&
∑th
, 
__∑th
)) != 0) {

46  
ªt
;

48 
ªt
 = 
	`fûe_›í
(
∑th
, 
›í_Êags
);

49 
	`k‰ì
(
∑th
);

50  
ªt
;

51 
	}
}

55 
	$sysfûe_˛o£
(
fd
) {

56  
	`fûe_˛o£
(
fd
);

57 
	}
}

61 
	$sysfûe_ªad
(
fd
, *
ba£
, 
size_t
 
Àn
) {

62 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

63 i‡(
Àn
 == 0) {

66 i‡(!
	`fûe_ã°fd
(
fd
, 1, 0)) {

67  -
E_INVAL
;

69 *
buf„r
;

70 i‡((
buf„r
 = 
	`kmÆloc
(
IOBUF_SIZE
)Ë=
NULL
) {

71  -
E_NO_MEM
;

74 
ªt
 = 0;

75 
size_t
 
c›õd
 = 0, 
Æí
;

76 
Àn
 != 0) {

77 i‡((
Æí
 = 
IOBUF_SIZE
Ë> 
Àn
) {

78 
Æí
 = 
Àn
;

80 
ªt
 = 
	`fûe_ªad
(
fd
, 
buf„r
, 
Æí
, &alen);

81 i‡(
Æí
 != 0) {

82 
	`lock_mm
(
mm
);

84 i‡(
	`c›y_to_u£r
(
mm
, 
ba£
, 
buf„r
, 
Æí
)) {

85 
	`as£π
(
Àn
 >
Æí
);

86 
ba£
 +
Æí
, 
Àn
 -Æí, 
c›õd
 +=álen;

88 i‡(
ªt
 == 0) {

89 
ªt
 = -
E_INVAL
;

92 
	`u∆ock_mm
(
mm
);

94 i‡(
ªt
 !0 || 
Æí
 == 0) {

95 
out
;

99 
out
:

100 
	`k‰ì
(
buf„r
);

101 i‡(
c›õd
 != 0) {

102  
c›õd
;

104  
ªt
;

105 
	}
}

109 
	$sysfûe_wrôe
(
fd
, *
ba£
, 
size_t
 
Àn
) {

110 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

111 i‡(
Àn
 == 0) {

114 i‡(!
	`fûe_ã°fd
(
fd
, 0, 1)) {

115  -
E_INVAL
;

117 *
buf„r
;

118 i‡((
buf„r
 = 
	`kmÆloc
(
IOBUF_SIZE
)Ë=
NULL
) {

119  -
E_NO_MEM
;

122 
ªt
 = 0;

123 
size_t
 
c›õd
 = 0, 
Æí
;

124 
Àn
 != 0) {

125 i‡((
Æí
 = 
IOBUF_SIZE
Ë> 
Àn
) {

126 
Æí
 = 
Àn
;

128 
	`lock_mm
(
mm
);

130 i‡(!
	`c›y_‰om_u£r
(
mm
, 
buf„r
, 
ba£
, 
Æí
, 0)) {

131 
ªt
 = -
E_INVAL
;

134 
	`u∆ock_mm
(
mm
);

135 i‡(
ªt
 == 0) {

136 
ªt
 = 
	`fûe_wrôe
(
fd
, 
buf„r
, 
Æí
, &alen);

137 i‡(
Æí
 != 0) {

138 
	`as£π
(
Àn
 >
Æí
);

139 
ba£
 +
Æí
, 
Àn
 -Æí, 
c›õd
 +=álen;

142 i‡(
ªt
 !0 || 
Æí
 == 0) {

143 
out
;

147 
out
:

148 
	`k‰ì
(
buf„r
);

149 i‡(
c›õd
 != 0) {

150  
c›õd
;

152  
ªt
;

153 
	}
}

157 
	$sysfûe_£ek
(
fd
, 
off_t
 
pos
, 
whí˚
) {

158  
	`fûe_£ek
(
fd
, 
pos
, 
whí˚
);

159 
	}
}

163 
	$sysfûe_f°©
(
fd
, 
°©
 *
__°©
) {

164 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

165 
ªt
;

166 
°©
 
__loˇl_°©
, *stat = &__local_stat;

167 i‡((
ªt
 = 
	`fûe_f°©
(
fd
, 
°©
)) != 0) {

168  
ªt
;

171 
	`lock_mm
(
mm
);

173 i‡(!
	`c›y_to_u£r
(
mm
, 
__°©
, 
°©
, (stat))) {

174 
ªt
 = -
E_INVAL
;

177 
	`u∆ock_mm
(
mm
);

178  
ªt
;

179 
	}
}

183 
	$sysfûe_fsync
(
fd
) {

184  
	`fûe_fsync
(
fd
);

185 
	}
}

189 
	$sysfûe_chdú
(c⁄° *
__∑th
) {

190 
ªt
;

191 *
∑th
;

192 i‡((
ªt
 = 
	`c›y_∑th
(&
∑th
, 
__∑th
)) != 0) {

193  
ªt
;

195 
ªt
 = 
	`vfs_chdú
(
∑th
);

196 
	`k‰ì
(
∑th
);

197  
ªt
;

198 
	}
}

202 
	$sysfûe_lök
(c⁄° *
__∑th1
, c⁄° *
__∑th2
) {

203 
ªt
;

204 *
ﬁd_∑th
, *
√w_∑th
;

205 i‡((
ªt
 = 
	`c›y_∑th
(&
ﬁd_∑th
, 
__∑th1
)) != 0) {

206  
ªt
;

208 i‡((
ªt
 = 
	`c›y_∑th
(&
√w_∑th
, 
__∑th2
)) != 0) {

209 
	`k‰ì
(
ﬁd_∑th
);

210  
ªt
;

212 
ªt
 = 
	`vfs_lök
(
ﬁd_∑th
, 
√w_∑th
);

213 
	`k‰ì
(
ﬁd_∑th
), k‰ì(
√w_∑th
);

214  
ªt
;

215 
	}
}

219 
	$sysfûe_ª«me
(c⁄° *
__∑th1
, c⁄° *
__∑th2
) {

220 
ªt
;

221 *
ﬁd_∑th
, *
√w_∑th
;

222 i‡((
ªt
 = 
	`c›y_∑th
(&
ﬁd_∑th
, 
__∑th1
)) != 0) {

223  
ªt
;

225 i‡((
ªt
 = 
	`c›y_∑th
(&
√w_∑th
, 
__∑th2
)) != 0) {

226 
	`k‰ì
(
ﬁd_∑th
);

227  
ªt
;

229 
ªt
 = 
	`vfs_ª«me
(
ﬁd_∑th
, 
√w_∑th
);

230 
	`k‰ì
(
ﬁd_∑th
), k‰ì(
√w_∑th
);

231  
ªt
;

232 
	}
}

236 
	$sysfûe_u∆ök
(c⁄° *
__∑th
) {

237 
ªt
;

238 *
∑th
;

239 i‡((
ªt
 = 
	`c›y_∑th
(&
∑th
, 
__∑th
)) != 0) {

240  
ªt
;

242 
ªt
 = 
	`vfs_u∆ök
(
∑th
);

243 
	`k‰ì
(
∑th
);

244  
ªt
;

245 
	}
}

249 
	$sysfûe_gëcwd
(*
buf
, 
size_t
 
Àn
) {

250 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

251 i‡(
Àn
 == 0) {

252  -
E_INVAL
;

255 
ªt
 = -
E_INVAL
;

256 
	`lock_mm
(
mm
);

258 i‡(
	`u£r_mem_check
(
mm
, (
uöçå_t
)
buf
, 
Àn
, 1)) {

259 
iobuf
 
__iob
, *
iob
 = 
	`iobuf_öô
(&__iob, 
buf
, 
Àn
, 0);

260 
ªt
 = 
	`vfs_gëcwd
(
iob
);

263 
	`u∆ock_mm
(
mm
);

264  
ªt
;

265 
	}
}

269 
	$sysfûe_gëdúíåy
(
fd
, 
dúít
 *
__dúíç
) {

270 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

271 
dúít
 *
dúíç
;

272 i‡((
dúíç
 = 
	`kmÆloc
((
dúít
))Ë=
NULL
) {

273  -
E_NO_MEM
;

276 
ªt
 = 0;

277 
	`lock_mm
(
mm
);

279 i‡(!
	`c›y_‰om_u£r
(
mm
, &(
dúíç
->
off£t
), &(
__dúíç
->offset), (direntp->offset), 1)) {

280 
ªt
 = -
E_INVAL
;

283 
	`u∆ock_mm
(
mm
);

285 i‡(
ªt
 !0 || (ªà
	`fûe_gëdúíåy
(
fd
, 
dúíç
)) != 0) {

286 
out
;

289 
	`lock_mm
(
mm
);

291 i‡(!
	`c›y_to_u£r
(
mm
, 
__dúíç
, 
dúíç
, (
dúít
))) {

292 
ªt
 = -
E_INVAL
;

295 
	`u∆ock_mm
(
mm
);

297 
out
:

298 
	`k‰ì
(
dúíç
);

299  
ªt
;

300 
	}
}

304 
	$sysfûe_dup
(
fd1
, 
fd2
) {

305  
	`fûe_dup
(
fd1
, 
fd2
);

306 
	}
}

309 
	$sysfûe_pùe
(*
fd_°‹e
) {

310  -
E_UNIMP
;

311 
	}
}

314 
	$sysfûe_mkfifo
(c⁄° *
__«me
, 
uöt32_t
 
›í_Êags
) {

315  -
E_UNIMP
;

316 
	}
}

	@kern/fs/sysfile.h

1 #i‚de‡
__KERN_FS_SYSFILE_H__


2 
	#__KERN_FS_SYSFILE_H__


	)

4 
	~<defs.h
>

6 
	g°©
;

7 
	gdúít
;

9 
sysfûe_›í
(c⁄° *
∑th
, 
uöt32_t
 
›í_Êags
);

10 
sysfûe_˛o£
(
fd
);

11 
sysfûe_ªad
(
fd
, *
ba£
, 
size_t
 
Àn
);

12 
sysfûe_wrôe
(
fd
, *
ba£
, 
size_t
 
Àn
);

13 
sysfûe_£ek
(
fd
, 
off_t
 
pos
, 
whí˚
);

14 
sysfûe_f°©
(
fd
, 
°©
 *stat);

15 
sysfûe_fsync
(
fd
);

16 
sysfûe_chdú
(c⁄° *
∑th
);

17 
sysfûe_mkdú
(c⁄° *
∑th
);

18 
sysfûe_lök
(c⁄° *
∑th1
, c⁄° *
∑th2
);

19 
sysfûe_ª«me
(c⁄° *
∑th1
, c⁄° *
∑th2
);

20 
sysfûe_u∆ök
(c⁄° *
∑th
);

21 
sysfûe_gëcwd
(*
buf
, 
size_t
 
Àn
);

22 
sysfûe_gëdúíåy
(
fd
, 
dúít
 *
dúíç
);

23 
sysfûe_dup
(
fd1
, 
fd2
);

24 
sysfûe_pùe
(*
fd_°‹e
);

25 
sysfûe_mkfifo
(c⁄° *
«me
, 
uöt32_t
 
›í_Êags
);

	@kern/fs/vfs/inode.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<©omic.h
>

5 
	~<vfs.h
>

6 
	~<öode.h
>

7 
	~<îr‹.h
>

8 
	~<as£π.h
>

9 
	~<kmÆloc.h
>

14 
öode
 *

15 
	$__Æloc_öode
(
ty≥
) {

16 
öode
 *
node
;

17 i‡((
node
 = 
	`kmÆloc
((
öode
))Ë!
NULL
) {

18 
node
->
ö_ty≥
 = 
ty≥
;

20  
node
;

21 
	}
}

28 
	$öode_öô
(
öode
 *
node
, c⁄° 
öode_›s
 *
›s
, 
fs
 *fs) {

29 
node
->
ªf_cou¡
 = 0;

30 
node
->
›í_cou¡
 = 0;

31 
node
->
ö_›s
 = 
›s
,Çode->
ö_fs
 = 
fs
;

32 
	`v›_ªf_öc
(
node
);

33 
	}
}

40 
	$öode_kûl
(
öode
 *
node
) {

41 
	`as£π
(
	`öode_ªf_cou¡
(
node
) == 0);

42 
	`as£π
(
	`öode_›í_cou¡
(
node
) == 0);

43 
	`k‰ì
(
node
);

44 
	}
}

51 
	$öode_ªf_öc
(
öode
 *
node
) {

52 
node
->
ªf_cou¡
 += 1;

53  
node
->
ªf_cou¡
;

54 
	}
}

62 
	$öode_ªf_dec
(
öode
 *
node
) {

63 
	`as£π
(
	`öode_ªf_cou¡
(
node
) > 0);

64 
ªf_cou¡
, 
ªt
;

65 
node
->
ªf_cou¡
-= 1;

66 
ªf_cou¡
 = 
node
->ref_count;

67 i‡(
ªf_cou¡
 == 0) {

68 i‡((
ªt
 = 
	`v›_ª˛aim
(
node
)Ë!0 &&Ñë !-
E_BUSY
) {

69 
	`˝rötf
("vfs: w¨nög: v›_ª˛aim: %e.\n", 
ªt
);

72  
ªf_cou¡
;

73 
	}
}

80 
	$öode_›í_öc
(
öode
 *
node
) {

81 
node
->
›í_cou¡
 += 1;

82  
node
->
›í_cou¡
;

83 
	}
}

91 
	$öode_›í_dec
(
öode
 *
node
) {

92 
	`as£π
(
	`öode_›í_cou¡
(
node
) > 0);

93 
›í_cou¡
, 
ªt
;

94 
node
->
›í_cou¡
 -= 1;

95 
›í_cou¡
 = 
node
->open_count;

96 i‡(
›í_cou¡
 == 0) {

97 i‡((
ªt
 = 
	`v›_˛o£
(
node
)) != 0) {

98 
	`˝rötf
("vfs: w¨nög: v›_˛o£: %e.\n", 
ªt
);

101  
›í_cou¡
;

102 
	}
}

109 
	$öode_check
(
öode
 *
node
, c⁄° *
›°r
) {

110 
	`as£π
(
node
 !
NULL
 &&Çode->
ö_›s
 != NULL);

111 
	`as£π
(
node
->
ö_›s
->
v›_magic
 =
VOP_MAGIC
);

112 
ªf_cou¡
 = 
	`öode_ªf_cou¡
(
node
), 
›í_cou¡
 = 
	`öode_›í_cou¡
(node);

113 
	`as£π
(
ªf_cou¡
 >
›í_cou¡
 && open_count >= 0);

114 
	`as£π
(
ªf_cou¡
 < 
MAX_INODE_COUNT
 && 
›í_cou¡
 < MAX_INODE_COUNT);

115 
	}
}

	@kern/fs/vfs/inode.h

1 #i‚de‡
__KERN_FS_VFS_INODE_H__


2 
	#__KERN_FS_VFS_INODE_H__


	)

4 
	~<defs.h
>

5 
	~<dev.h
>

6 
	~<sfs.h
>

7 
	~<©omic.h
>

8 
	~<as£π.h
>

10 
	g°©
;

11 
	giobuf
;

29 
	söode
 {

31 
devi˚
 
	m__devi˚_öfo
;

32 
sfs_öode
 
	m__sfs_öode_öfo
;

33 } 
	mö_öfo
;

35 
	möode_ty≥_devi˚_öfo
 = 0x1234,

36 
	möode_ty≥_sfs_öode_öfo
,

37 } 
	mö_ty≥
;

38 
	mªf_cou¡
;

39 
	m›í_cou¡
;

40 
fs
 *
	mö_fs
;

41 c⁄° 
öode_›s
 *
	mö_›s
;

44 
	#__ö_ty≥
(
ty≥
Ë
öode_ty≥_
##ty≥##
_öfo


	)

46 
	#check_öode_ty≥
(
node
, 
ty≥
Ë(“ode)->
ö_ty≥
 =
	`__ö_ty≥
—y≥))

	)

48 
	#__v›_öfo
(
node
, 
ty≥
) \

50 
öode
 *
__node
 = (
node
); \

51 
	`as£π
(
__node
 !
NULL
 && 
	`check_öode_ty≥
(__node, 
ty≥
)); \

52 &(
__node
->
ö_öfo
.
__
##
ty≥
##
_öfo
); \

53 })

	)

55 
	#v›_öfo
(
node
, 
ty≥
Ë
	`__v›_öfo
“ode,Åy≥)

	)

57 
	#öfo2node
(
öfo
, 
ty≥
) \

58 
	`to_°ru˘
((
öfo
), 
öode
, 
ö_öfo
.
__
##
ty≥
##
_öfo
)

	)

60 
öode
 *
__Æloc_öode
(
ty≥
);

62 
	#Æloc_öode
(
ty≥
Ë
	`__Æloc_öode
(
	`__ö_ty≥
—y≥))

	)

64 
	#MAX_INODE_COUNT
 0x10000

	)

66 
öode_ªf_öc
(
öode
 *
node
);

67 
öode_ªf_dec
(
öode
 *
node
);

68 
öode_›í_öc
(
öode
 *
node
);

69 
öode_›í_dec
(
öode
 *
node
);

71 
öode_öô
(
öode
 *
node
, c⁄° 
öode_›s
 *
›s
, 
fs
 *fs);

72 
öode_kûl
(
öode
 *
node
);

74 
	#VOP_MAGIC
 0x8c4ba476

	)

169 
	söode_›s
 {

170 
	mv›_magic
;

171 (*
	mv›_›í
)(
öode
 *
	mnode
, 
uöt32_t
 
	m›í_Êags
);

172 (*
	mv›_˛o£
)(
öode
 *
	mnode
);

173 (*
	mv›_ªad
)(
öode
 *
	mnode
, 
iobuf
 *
	miob
);

174 (*
	mv›_wrôe
)(
öode
 *
	mnode
, 
iobuf
 *
	miob
);

175 (*
	mv›_f°©
)(
öode
 *
	mnode
, 
°©
 *
	m°©
);

176 (*
	mv›_fsync
)(
öode
 *
	mnode
);

177 (*
	mv›_«mefûe
)(
öode
 *
	mnode
, 
iobuf
 *
	miob
);

178 (*
	mv›_gëdúíåy
)(
öode
 *
	mnode
, 
iobuf
 *
	miob
);

179 (*
	mv›_ª˛aim
)(
öode
 *
	mnode
);

180 (*
	mv›_gëty≥
)(
öode
 *
	mnode
, 
uöt32_t
 *
	mty≥_°‹e
);

181 (*
	mv›_åy£ek
)(
öode
 *
	mnode
, 
off_t
 
	mpos
);

182 (*
	mv›_åunˇã
)(
öode
 *
	mnode
, 
off_t
 
	mÀn
);

183 (*
	mv›_¸óã
)(
öode
 *
	mnode
, c⁄° *
	m«me
, 
boﬁ
 
	mex˛
, öodê**
	mnode_°‹e
);

184 (*
	mv›_lookup
)(
öode
 *
	mnode
, *
	m∑th
, öodê**
	mnode_°‹e
);

185 (*
	mv›_io˘l
)(
öode
 *
	mnode
, 
	m›
, *
	md©a
);

191 
öode_check
(
öode
 *
node
, c⁄° *
›°r
);

193 
	#__v›_›
(
node
, 
sym
) \

195 
öode
 *
__node
 = (
node
); \

196 
	`as£π
(
__node
 !
NULL
 && __node->
ö_›s
 !NULL && __node->ö_›s->
v›_
##
sym
 != NULL); \

197 
	`öode_check
(
__node
, #sym); \

198 
__node
->
ö_›s
->
v›_
##
sym
; \

199 })

	)

201 
	#v›_›í
(
node
, 
›í_Êags
Ë(
	`__v›_›
“ode, 
›í
)“ode, o≥n_Êags))

	)

202 
	#v›_˛o£
(
node
Ë(
	`__v›_›
“ode, 
˛o£
)“ode))

	)

203 
	#v›_ªad
(
node
, 
iob
Ë(
	`__v›_›
“ode, 
ªad
)“ode, iob))

	)

204 
	#v›_wrôe
(
node
, 
iob
Ë(
	`__v›_›
“ode, 
wrôe
)“ode, iob))

	)

205 
	#v›_f°©
(
node
, 
°©
Ë(
	`__v›_›
“ode, 
f°©
)“ode, sèt))

	)

206 
	#v›_fsync
(
node
Ë(
	`__v›_›
“ode, 
fsync
)“ode))

	)

207 
	#v›_«mefûe
(
node
, 
iob
Ë(
	`__v›_›
“ode, 
«mefûe
)“ode, iob))

	)

208 
	#v›_gëdúíåy
(
node
, 
iob
Ë(
	`__v›_›
“ode, 
gëdúíåy
)“ode, iob))

	)

209 
	#v›_ª˛aim
(
node
Ë(
	`__v›_›
“ode, 
ª˛aim
)“ode))

	)

210 
	#v›_io˘l
(
node
, 
›
, 
d©a
Ë(
	`__v›_›
“ode, 
io˘l
)“ode, op, d©a))

	)

211 
	#v›_gëty≥
(
node
, 
ty≥_°‹e
Ë(
	`__v›_›
“ode, 
gëty≥
)“ode,Åy≥_°‹e))

	)

212 
	#v›_åy£ek
(
node
, 
pos
Ë(
	`__v›_›
“ode, 
åy£ek
)“ode,Öos))

	)

213 
	#v›_åunˇã
(
node
, 
Àn
Ë(
	`__v›_›
“ode, 
åunˇã
)“ode,Üí))

	)

214 
	#v›_¸óã
(
node
, 
«me
, 
ex˛
, 
node_°‹e
Ë(
	`__v›_›
“ode, 
¸óã
)“ode,Çame,Éx˛,Çode_°‹e))

	)

215 
	#v›_lookup
(
node
, 
∑th
, 
node_°‹e
Ë(
	`__v›_›
“ode, 
lookup
)“ode,Ö©h,Çode_°‹e))

	)

218 
	#v›_fs
(
node
Ë(“ode)->
ö_fs
)

	)

219 
	#v›_öô
(
node
, 
›s
, 
fs
Ë
	`öode_öô
“ode, ops, fs)

	)

220 
	#v›_kûl
(
node
Ë
	`öode_kûl
“ode)

	)

225 
	#v›_ªf_öc
(
node
Ë
	`öode_ªf_öc
“ode)

	)

226 
	#v›_ªf_dec
(
node
Ë
	`öode_ªf_dec
“ode)

	)

233 
	#v›_›í_öc
(
node
Ë
	`öode_›í_öc
“ode)

	)

234 
	#v›_›í_dec
(
node
Ë
	`öode_›í_dec
“ode)

	)

237 
ölöe
 

238 
	$öode_ªf_cou¡
(
öode
 *
node
) {

239  
node
->
ªf_cou¡
;

240 
	}
}

242 
ölöe
 

243 
	$öode_›í_cou¡
(
öode
 *
node
) {

244  
node
->
›í_cou¡
;

245 
	}
}

	@kern/fs/vfs/vfs.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<vfs.h
>

5 
	~<öode.h
>

6 
	~<£m.h
>

7 
	~<kmÆloc.h
>

8 
	~<îr‹.h
>

10 
£m≠h‹e_t
 
	gboŸfs_£m
;

11 
öode
 *
	gboŸfs_node
 = 
NULL
;

13 
vfs_devli°_öô
();

16 
fs
 *

17 
	$__Æloc_fs
(
ty≥
) {

18 
fs
 *fs;

19 i‡((
fs
 = 
	`kmÆloc
((fs))Ë!
NULL
) {

20 
fs
->
fs_ty≥
 = 
ty≥
;

22  
fs
;

23 
	}
}

27 
	$vfs_öô
() {

28 
	`£m_öô
(&
boŸfs_£m
, 1);

29 
	`vfs_devli°_öô
();

30 
	}
}

34 
	$lock_boŸfs
() {

35 
	`down
(&
boŸfs_£m
);

36 
	}
}

39 
	$u∆ock_boŸfs
() {

40 
	`up
(&
boŸfs_£m
);

41 
	}
}

45 
	$ch™ge_boŸfs
(
öode
 *
node
) {

46 
öode
 *
ﬁd
;

47 
	`lock_boŸfs
();

49 
ﬁd
 = 
boŸfs_node
, boŸfs_nodê
node
;

51 
	`u∆ock_boŸfs
();

52 i‡(
ﬁd
 !
NULL
) {

53 
	`v›_ªf_dec
(
ﬁd
);

55 
	}
}

59 
	$vfs_£t_boŸfs
(*
f¢ame
) {

60 
öode
 *
node
 = 
NULL
;

61 i‡(
f¢ame
 !
NULL
) {

62 *
s
;

63 i‡((
s
 = 
	`°rchr
(
f¢ame
, ':')Ë=
NULL
 || s[1] != '\0') {

64  -
E_INVAL
;

66 
ªt
;

67 i‡((
ªt
 = 
	`vfs_chdú
(
f¢ame
)) != 0) {

68  
ªt
;

70 i‡((
ªt
 = 
	`vfs_gë_curdú
(&
node
)) != 0) {

71  
ªt
;

74 
	`ch™ge_boŸfs
(
node
);

76 
	}
}

80 
	$vfs_gë_boŸfs
(
öode
 **
node_°‹e
) {

81 
öode
 *
node
 = 
NULL
;

82 i‡(
boŸfs_node
 !
NULL
) {

83 
	`lock_boŸfs
();

85 i‡((
node
 = 
boŸfs_node
Ë!
NULL
) {

86 
	`v›_ªf_öc
(
boŸfs_node
);

89 
	`u∆ock_boŸfs
();

91 i‡(
node
 =
NULL
) {

92  -
E_NOENT
;

94 *
node_°‹e
 = 
node
;

96 
	}
}

	@kern/fs/vfs/vfs.h

1 #i‚de‡
__KERN_FS_VFS_VFS_H__


2 
	#__KERN_FS_VFS_VFS_H__


	)

4 
	~<defs.h
>

5 
	~<fs.h
>

6 
	~<sfs.h
>

8 
	göode
;

9 
	gdevi˚
;

10 
	giobuf
;

35 
	sfs
 {

37 
sfs_fs
 
	m__sfs_öfo
;

38 } 
	mfs_öfo
;

40 
	mfs_ty≥_sfs_öfo
,

41 } 
	mfs_ty≥
;

42 (*
	mfs_sync
)(
fs
 *
	mfs
);

43 
	möode
 *(*
	mfs_gë_roŸ
)(
fs
 *
	mfs
);

44 (*
	mfs_unmou¡
)(
fs
 *
	mfs
);

45 (*
	mfs_˛ónup
)(
fs
 *
	mfs
);

48 
	#__fs_ty≥
(
ty≥
Ë
fs_ty≥_
##ty≥##
_öfo


	)

50 
	#check_fs_ty≥
(
fs
, 
ty≥
Ë((fs)->
fs_ty≥
 =
	`__fs_ty≥
—y≥))

	)

52 
	#__fs›_öfo
(
_fs
, 
ty≥
) ({ \

53 
fs
 *
__fs
 = (
_fs
); \

54 
	`as£π
(
__fs
 !
NULL
 && 
	`check_fs_ty≥
(__fs, 
ty≥
)); \

55 &(
__fs
->
fs_öfo
.
__
##
ty≥
##
_öfo
); \

56 })

	)

58 
	#fs›_öfo
(
fs
, 
ty≥
Ë
	`__fs›_öfo
(fs,Åy≥)

	)

60 
	#öfo2fs
(
öfo
, 
ty≥
) \

61 
	`to_°ru˘
((
öfo
), 
fs
, 
fs_öfo
.
__
##
ty≥
##
_öfo
)

	)

63 
fs
 *
__Æloc_fs
(
ty≥
);

65 
	#Æloc_fs
(
ty≥
Ë
	`__Æloc_fs
(
	`__fs_ty≥
—y≥))

	)

68 
	#fs›_sync
(
fs
Ë((fs)->
	`fs_sync
(fs))

	)

69 
	#fs›_gë_roŸ
(
fs
Ë((fs)->
	`fs_gë_roŸ
(fs))

	)

70 
	#fs›_unmou¡
(
fs
Ë((fs)->
	`fs_unmou¡
(fs))

	)

71 
	#fs›_˛ónup
(
fs
Ë((fs)->
	`fs_˛ónup
(fs))

	)

79 
vfs_öô
();

80 
vfs_˛ónup
();

81 
vfs_devli°_öô
();

93 
vfs_£t_curdú
(
öode
 *
dú
);

94 
vfs_gë_curdú
(
öode
 **
dú_°‹e
);

95 
vfs_gë_roŸ
(c⁄° *
dev«me
, 
öode
 **
roŸ_°‹e
);

96 c⁄° *
vfs_gë_dev«me
(
fs
 *fs);

116 
vfs_›í
(*
∑th
, 
uöt32_t
 
›í_Êags
, 
öode
 **
öode_°‹e
);

117 
vfs_˛o£
(
öode
 *
node
);

118 
vfs_lök
(*
ﬁd_∑th
, *
√w_∑th
);

119 
vfs_symlök
(*
ﬁd_∑th
, *
√w_∑th
);

120 
vfs_ªadlök
(*
∑th
, 
iobuf
 *
iob
);

121 
vfs_mkdú
(*
∑th
);

122 
vfs_u∆ök
(*
∑th
);

123 
vfs_ª«me
(*
ﬁd_∑th
, *
√w_∑th
);

124 
vfs_chdú
(*
∑th
);

125 
vfs_gëcwd
(
iobuf
 *
iob
);

138 
vfs_lookup
(*
∑th
, 
öode
 **
node_°‹e
);

139 
vfs_lookup_∑ª¡
(*
∑th
, 
öode
 **
node_°‹e
, **
ídp
);

180 
vfs_£t_boŸfs
(*
f¢ame
);

181 
vfs_gë_boŸfs
(
öode
 **
node_°‹e
);

183 
vfs_add_fs
(c⁄° *
dev«me
, 
fs
 *fs);

184 
vfs_add_dev
(c⁄° *
dev«me
, 
öode
 *
devnode
, 
boﬁ
 
mou¡abÀ
);

186 
vfs_mou¡
(c⁄° *
dev«me
, (*
mou¡func
)(
devi˚
 *
dev
, 
fs
 **
fs_°‹e
));

187 
	`vfs_unmou¡
(c⁄° *
dev«me
);

188 
	`vfs_unmou¡_Æl
();

	@kern/fs/vfs/vfsdev.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<vfs.h
>

5 
	~<dev.h
>

6 
	~<öode.h
>

7 
	~<£m.h
>

8 
	~<li°.h
>

9 
	~<kmÆloc.h
>

10 
	~<uni°d.h
>

11 
	~<îr‹.h
>

12 
	~<as£π.h
>

16 c⁄° *
	mdev«me
;

17 
öode
 *
	mdevnode
;

18 
fs
 *
	mfs
;

19 
boﬁ
 
	mmou¡abÀ
;

20 
li°_íåy_t
 
	mvdev_lök
;

21 } 
	tvfs_dev_t
;

23 
	#À2vdev
(
À
, 
membî
) \

24 
	`to_°ru˘
((
À
), 
vfs_dev_t
, 
membî
)

	)

26 
li°_íåy_t
 
	gvdev_li°
;

27 
£m≠h‹e_t
 
	gvdev_li°_£m
;

30 
	$lock_vdev_li°
() {

31 
	`down
(&
vdev_li°_£m
);

32 
	}
}

35 
	$u∆ock_vdev_li°
() {

36 
	`up
(&
vdev_li°_£m
);

37 
	}
}

40 
	$vfs_devli°_öô
() {

41 
	`li°_öô
(&
vdev_li°
);

42 
	`£m_öô
(&
vdev_li°_£m
, 1);

43 
	}
}

47 
	$vfs_˛ónup
() {

48 i‡(!
	`li°_em±y
(&
vdev_li°
)) {

49 
	`lock_vdev_li°
();

51 
li°_íåy_t
 *
li°
 = &
vdev_li°
, *
À
 =Üist;

52 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

53 
vfs_dev_t
 *
vdev
 = 
	`À2vdev
(
À
, 
vdev_lök
);

54 i‡(
vdev
->
fs
 !
NULL
) {

55 
	`fs›_˛ónup
(
vdev
->
fs
);

59 
	`u∆ock_vdev_li°
();

61 
	}
}

68 
	$vfs_gë_roŸ
(c⁄° *
dev«me
, 
öode
 **
node_°‹e
) {

69 
	`as£π
(
dev«me
 !
NULL
);

70 
ªt
 = -
E_NO_DEV
;

71 i‡(!
	`li°_em±y
(&
vdev_li°
)) {

72 
	`lock_vdev_li°
();

74 
li°_íåy_t
 *
li°
 = &
vdev_li°
, *
À
 =Üist;

75 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

76 
vfs_dev_t
 *
vdev
 = 
	`À2vdev
(
À
, 
vdev_lök
);

77 i‡(
	`°rcmp
(
dev«me
, 
vdev
->devname) == 0) {

78 
öode
 *
found
 = 
NULL
;

79 i‡(
vdev
->
fs
 !
NULL
) {

80 
found
 = 
	`fs›_gë_roŸ
(
vdev
->
fs
);

82 i‡(!
vdev
->
mou¡abÀ
) {

83 
	`v›_ªf_öc
(
vdev
->
devnode
);

84 
found
 = 
vdev
->
devnode
;

86 i‡(
found
 !
NULL
) {

87 
ªt
 = 0, *
node_°‹e
 = 
found
;

90 
ªt
 = -
E_NA_DEV
;

96 
	`u∆ock_vdev_li°
();

98  
ªt
;

99 
	}
}

105 
	$vfs_gë_dev«me
(
fs
 *fs) {

106 
	`as£π
(
fs
 !
NULL
);

107 
li°_íåy_t
 *
li°
 = &
vdev_li°
, *
À
 =Üist;

108 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

109 
vfs_dev_t
 *
vdev
 = 
	`À2vdev
(
À
, 
vdev_lök
);

110 i‡(
vdev
->
fs
 == fs) {

111  
vdev
->
dev«me
;

114  
NULL
;

115 
	}
}

120 
boﬁ


121 
	$check_dev«me_c⁄Êi˘
(c⁄° *
dev«me
) {

122 
li°_íåy_t
 *
li°
 = &
vdev_li°
, *
À
 =Üist;

123 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

124 
vfs_dev_t
 *
vdev
 = 
	`À2vdev
(
À
, 
vdev_lök
);

125 i‡(
	`°rcmp
(
vdev
->
dev«me
, devname) == 0) {

130 
	}
}

141 
	$vfs_do_add
(c⁄° *
dev«me
, 
öode
 *
devnode
, 
fs
 *fs, 
boﬁ
 
mou¡abÀ
) {

142 
	`as£π
(
dev«me
 !
NULL
);

143 
	`as£π
((
devnode
 =
NULL
 && !
mou¡abÀ
Ë|| (devnodê!NULL && 
	`check_öode_ty≥
(devnode, 
devi˚
)));

144 i‡(
	`°æí
(
dev«me
Ë> 
FS_MAX_DNAME_LEN
) {

145  -
E_TOO_BIG
;

148 
ªt
 = -
E_NO_MEM
;

149 *
s_dev«me
;

150 i‡((
s_dev«me
 = 
	`°rdup
(
dev«me
)Ë=
NULL
) {

151  
ªt
;

154 
vfs_dev_t
 *
vdev
;

155 i‡((
vdev
 = 
	`kmÆloc
((
vfs_dev_t
))Ë=
NULL
) {

156 
Áûed_˛ónup_«me
;

159 
ªt
 = -
E_EXISTS
;

160 
	`lock_vdev_li°
();

161 i‡(!
	`check_dev«me_c⁄Êi˘
(
s_dev«me
)) {

162 
	`u∆ock_vdev_li°
();

163 
Áûed_˛ónup_vdev
;

165 
vdev
->
dev«me
 = 
s_dev«me
;

166 
vdev
->
devnode
 = devnode;

167 
vdev
->
mou¡abÀ
 = mountable;

168 
vdev
->
fs
 = fs;

170 
	`li°_add
(&
vdev_li°
, &(
vdev
->
vdev_lök
));

171 
	`u∆ock_vdev_li°
();

174 
Áûed_˛ónup_vdev
:

175 
	`k‰ì
(
vdev
);

176 
Áûed_˛ónup_«me
:

177 
	`k‰ì
(
s_dev«me
);

178  
ªt
;

179 
	}
}

186 
	$vfs_add_fs
(c⁄° *
dev«me
, 
fs
 *fs) {

187  
	`vfs_do_add
(
dev«me
, 
NULL
, 
fs
, 0);

188 
	}
}

195 
	$vfs_add_dev
(c⁄° *
dev«me
, 
öode
 *
devnode
, 
boﬁ
 
mou¡abÀ
) {

196  
	`vfs_do_add
(
dev«me
, 
devnode
, 
NULL
, 
mou¡abÀ
);

197 
	}
}

204 
	$föd_mou¡
(c⁄° *
dev«me
, 
vfs_dev_t
 **
vdev_°‹e
) {

205 
	`as£π
(
dev«me
 !
NULL
);

206 
li°_íåy_t
 *
li°
 = &
vdev_li°
, *
À
 =Üist;

207 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

208 
vfs_dev_t
 *
vdev
 = 
	`À2vdev
(
À
, 
vdev_lök
);

209 i‡(
vdev
->
mou¡abÀ
 && 
	`°rcmp
(vdev->
dev«me
, devname) == 0) {

210 *
vdev_°‹e
 = 
vdev
;

214  -
E_NO_DEV
;

215 
	}
}

224 
vfs_mou¡
(c⁄° *
dev«me
, (*
mou¡func
)(
devi˚
 *
dev
, 
fs
 **
fs_°‹e
)) {

225 
ªt
;

226 
	`lock_vdev_li°
();

227 
vfs_dev_t
 *
vdev
;

228 i‡((
ªt
 = 
	`föd_mou¡
(
dev«me
, &
vdev
)) != 0) {

229 
out
;

231 i‡(
vdev
->
fs
 !
NULL
) {

232 
ªt
 = -
E_BUSY
;

233 
out
;

235 
	`as£π
(
vdev
->
dev«me
 !
NULL
 && vdev->
mou¡abÀ
);

237 
devi˚
 *
dev
 = 
	`v›_öfo
(
vdev
->
devnode
, device);

238 i‡((
ªt
 = 
	`mou¡func
(
dev
, &(
vdev
->
fs
))) == 0) {

239 
	`as£π
(
vdev
->
fs
 !
NULL
);

240 
	`˝rötf
("vfs: mou¡ %s.\n", 
vdev
->
dev«me
);

243 
out
:

244 
	`u∆ock_vdev_li°
();

245  
ªt
;

246 
	}
}

253 
	$vfs_unmou¡
(c⁄° *
dev«me
) {

254 
ªt
;

255 
	`lock_vdev_li°
();

256 
vfs_dev_t
 *
vdev
;

257 i‡((
ªt
 = 
	`föd_mou¡
(
dev«me
, &
vdev
)) != 0) {

258 
out
;

260 i‡(
vdev
->
fs
 =
NULL
) {

261 
ªt
 = -
E_INVAL
;

262 
out
;

264 
	`as£π
(
vdev
->
dev«me
 !
NULL
 && vdev->
mou¡abÀ
);

266 i‡((
ªt
 = 
	`fs›_sync
(
vdev
->
fs
)) != 0) {

267 
out
;

269 i‡((
ªt
 = 
	`fs›_unmou¡
(
vdev
->
fs
)) == 0) {

270 
vdev
->
fs
 = 
NULL
;

271 
	`˝rötf
("vfs: unmou¡ %s.\n", 
vdev
->
dev«me
);

274 
out
:

275 
	`u∆ock_vdev_li°
();

276  
ªt
;

277 
	}
}

283 
	$vfs_unmou¡_Æl
() {

284 i‡(!
	`li°_em±y
(&
vdev_li°
)) {

285 
	`lock_vdev_li°
();

287 
li°_íåy_t
 *
li°
 = &
vdev_li°
, *
À
 =Üist;

288 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

289 
vfs_dev_t
 *
vdev
 = 
	`À2vdev
(
À
, 
vdev_lök
);

290 i‡(
vdev
->
mou¡abÀ
 && vdev->
fs
 !
NULL
) {

291 
ªt
;

292 i‡((
ªt
 = 
	`fs›_sync
(
vdev
->
fs
)) != 0) {

293 
	`˝rötf
("vfs: w¨nög: syn¯Áûed f‹ %s: %e.\n", 
vdev
->
dev«me
, 
ªt
);

296 i‡((
ªt
 = 
	`fs›_unmou¡
(
vdev
->
fs
)) != 0) {

297 
	`˝rötf
("vfs: w¨nög: unmou¡ faûed f‹ %s: %e.\n", 
vdev
->
dev«me
, 
ªt
);

300 
vdev
->
fs
 = 
NULL
;

301 
	`˝rötf
("vfs: unmou¡ %s.\n", 
vdev
->
dev«me
);

305 
	`u∆ock_vdev_li°
();

308 
	}
}

	@kern/fs/vfs/vfsfile.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<vfs.h
>

4 
	~<öode.h
>

5 
	~<uni°d.h
>

6 
	~<îr‹.h
>

7 
	~<as£π.h
>

12 
	$vfs_›í
(*
∑th
, 
uöt32_t
 
›í_Êags
, 
öode
 **
node_°‹e
) {

13 
boﬁ
 
ˇn_wrôe
 = 0;

14 
›í_Êags
 & 
O_ACCMODE
) {

15 
O_RDONLY
:

17 
O_WRONLY
:

18 
O_RDWR
:

19 
ˇn_wrôe
 = 1;

22  -
E_INVAL
;

25 i‡(
›í_Êags
 & 
O_TRUNC
) {

26 i‡(!
ˇn_wrôe
) {

27  -
E_INVAL
;

31 
ªt
;

32 
öode
 *
node
;

33 
boﬁ
 
ex˛
 = (
›í_Êags
 & 
O_EXCL
) != 0;

34 
boﬁ
 
¸óã
 = (
›í_Êags
 & 
O_CREAT
) != 0;

35 
ªt
 = 
	`vfs_lookup
(
∑th
, &
node
);

37 i‡(
ªt
 != 0) {

38 i‡(
ªt
 =-16 && (
¸óã
)) {

39 *
«me
;

40 
öode
 *
dú
;

41 i‡((
ªt
 = 
	`vfs_lookup_∑ª¡
(
∑th
, &
dú
, &
«me
)) != 0) {

42  
ªt
;

44 
ªt
 = 
	`v›_¸óã
(
dú
, 
«me
, 
ex˛
, &
node
);

45 }  
ªt
;

46 } i‡(
ex˛
 && 
¸óã
) {

47  -
E_EXISTS
;

49 
	`as£π
(
node
 !
NULL
);

51 i‡((
ªt
 = 
	`v›_›í
(
node
, 
›í_Êags
)) != 0) {

52 
	`v›_ªf_dec
(
node
);

53  
ªt
;

56 
	`v›_›í_öc
(
node
);

57 i‡(
›í_Êags
 & 
O_TRUNC
 || 
¸óã
) {

58 i‡((
ªt
 = 
	`v›_åunˇã
(
node
, 0)) != 0) {

59 
	`v›_›í_dec
(
node
);

60 
	`v›_ªf_dec
(
node
);

61  
ªt
;

64 *
node_°‹e
 = 
node
;

66 
	}
}

70 
	$vfs_˛o£
(
öode
 *
node
) {

71 
	`v›_›í_dec
(
node
);

72 
	`v›_ªf_dec
(
node
);

74 
	}
}

78 
	$vfs_u∆ök
(*
∑th
) {

79  -
E_UNIMP
;

80 
	}
}

84 
	$vfs_ª«me
(*
ﬁd_∑th
, *
√w_∑th
) {

85  -
E_UNIMP
;

86 
	}
}

90 
	$vfs_lök
(*
ﬁd_∑th
, *
√w_∑th
) {

91  -
E_UNIMP
;

92 
	}
}

96 
	$vfs_symlök
(*
ﬁd_∑th
, *
√w_∑th
) {

97  -
E_UNIMP
;

98 
	}
}

102 
	$vfs_ªadlök
(*
∑th
, 
iobuf
 *
iob
) {

103  -
E_UNIMP
;

104 
	}
}

108 
	$vfs_mkdú
(*
∑th
){

109  -
E_UNIMP
;

110 
	}
}

	@kern/fs/vfs/vfslookup.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<vfs.h
>

4 
	~<öode.h
>

5 
	~<îr‹.h
>

6 
	~<as£π.h
>

14 
	$gë_devi˚
(*
∑th
, **
sub∑th
, 
öode
 **
node_°‹e
) {

15 
i
, 
¶ash
 = -1, 
cﬁ⁄
 = -1;

16 
i
 = 0; 
∑th
[i] != '\0'; i ++) {

17 i‡(
∑th
[
i
] =':'Ë{ 
cﬁ⁄
 = i; ; }

18 i‡(
∑th
[
i
] ='/'Ë{ 
¶ash
 = i; ; }

20 i‡(
cﬁ⁄
 < 0 && 
¶ash
 != 0) {

26 *
sub∑th
 = 
∑th
;

27  
	`vfs_gë_curdú
(
node_°‹e
);

29 i‡(
cﬁ⁄
 > 0) {

31 
∑th
[
cﬁ⁄
] = '\0';

34 
∑th
[++ 
cﬁ⁄
] == '/');

35 *
sub∑th
 = 
∑th
 + 
cﬁ⁄
;

36  
	`vfs_gë_roŸ
(
∑th
, 
node_°‹e
);

44 
ªt
;

45 i‡(*
∑th
 == '/') {

46 i‡((
ªt
 = 
	`vfs_gë_boŸfs
(
node_°‹e
)) != 0) {

47  
ªt
;

51 
	`as£π
(*
∑th
 == ':');

52 
öode
 *
node
;

53 i‡((
ªt
 = 
	`vfs_gë_curdú
(&
node
)) != 0) {

54  
ªt
;

57 
	`as£π
(
node
->
ö_fs
 !
NULL
);

58 *
node_°‹e
 = 
	`fs›_gë_roŸ
(
node
->
ö_fs
);

59 
	`v›_ªf_dec
(
node
);

63 *(++ 
∑th
) == '/');

64 *
sub∑th
 = 
∑th
;

66 
	}
}

72 
	$vfs_lookup
(*
∑th
, 
öode
 **
node_°‹e
) {

73 
ªt
;

74 
öode
 *
node
;

75 i‡((
ªt
 = 
	`gë_devi˚
(
∑th
, &∑th, &
node
)) != 0) {

76  
ªt
;

78 i‡(*
∑th
 != '\0') {

79 
ªt
 = 
	`v›_lookup
(
node
, 
∑th
, 
node_°‹e
);

80 
	`v›_ªf_dec
(
node
);

81  
ªt
;

83 *
node_°‹e
 = 
node
;

85 
	}
}

92 
	$vfs_lookup_∑ª¡
(*
∑th
, 
öode
 **
node_°‹e
, **
ídp
){

93 
ªt
;

94 
öode
 *
node
;

95 i‡((
ªt
 = 
	`gë_devi˚
(
∑th
, &∑th, &
node
)) != 0) {

96  
ªt
;

98 *
ídp
 = 
∑th
;

99 *
node_°‹e
 = 
node
;

101 
	}
}

	@kern/fs/vfs/vfspath.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<vfs.h
>

4 
	~<öode.h
>

5 
	~<iobuf.h
>

6 
	~<°©.h
>

7 
	~<¥oc.h
>

8 
	~<îr‹.h
>

9 
	~<as£π.h
>

14 
öode
 *

15 
	$gë_cwd_nﬁock
() {

16  
cuºít
->
fûe•
->
pwd
;

17 
	}
}

22 
	$£t_cwd_nﬁock
(
öode
 *
pwd
) {

23 
cuºít
->
fûe•
->
pwd
 =Öwd;

24 
	}
}

30 
	$lock_cfs
() {

31 
	`lock_fûes
(
cuºít
->
fûe•
);

32 
	}
}

37 
	$u∆ock_cfs
() {

38 
	`u∆ock_fûes
(
cuºít
->
fûe•
);

39 
	}
}

45 
	$vfs_gë_curdú
(
öode
 **
dú_°‹e
) {

46 
öode
 *
node
;

47 i‡((
node
 = 
	`gë_cwd_nﬁock
()Ë!
NULL
) {

48 
	`v›_ªf_öc
(
node
);

49 *
dú_°‹e
 = 
node
;

52  -
E_NOENT
;

53 
	}
}

60 
	$vfs_£t_curdú
(
öode
 *
dú
) {

61 
ªt
 = 0;

62 
	`lock_cfs
();

63 
öode
 *
ﬁd_dú
;

64 i‡((
ﬁd_dú
 = 
	`gë_cwd_nﬁock
()Ë!
dú
) {

65 i‡(
dú
 !
NULL
) {

66 
uöt32_t
 
ty≥
;

67 i‡((
ªt
 = 
	`v›_gëty≥
(
dú
, &
ty≥
)) != 0) {

68 
out
;

70 i‡(!
	`S_ISDIR
(
ty≥
)) {

71 
ªt
 = -
E_NOTDIR
;

72 
out
;

74 
	`v›_ªf_öc
(
dú
);

76 
	`£t_cwd_nﬁock
(
dú
);

77 i‡(
ﬁd_dú
 !
NULL
) {

78 
	`v›_ªf_dec
(
ﬁd_dú
);

81 
out
:

82 
	`u∆ock_cfs
();

83  
ªt
;

84 
	}
}

91 
	$vfs_chdú
(*
∑th
) {

92 
ªt
;

93 
öode
 *
node
;

94 i‡((
ªt
 = 
	`vfs_lookup
(
∑th
, &
node
)) == 0) {

95 
ªt
 = 
	`vfs_£t_curdú
(
node
);

96 
	`v›_ªf_dec
(
node
);

98  
ªt
;

99 
	}
}

104 
	$vfs_gëcwd
(
iobuf
 *
iob
) {

105 
ªt
;

106 
öode
 *
node
;

107 i‡((
ªt
 = 
	`vfs_gë_curdú
(&
node
)) != 0) {

108  
ªt
;

110 
	`as£π
(
node
->
ö_fs
 !
NULL
);

112 c⁄° *
dev«me
 = 
	`vfs_gë_dev«me
(
node
->
ö_fs
);

113 i‡((
ªt
 = 
	`iobuf_move
(
iob
, (*)
dev«me
, 
	`°æí
(dev«me), 1, 
NULL
)) != 0) {

114 
out
;

116 
cﬁ⁄
 = ':';

117 i‡((
ªt
 = 
	`iobuf_move
(
iob
, &
cﬁ⁄
, (cﬁ⁄), 1, 
NULL
)) != 0) {

118 
out
;

120 
ªt
 = 
	`v›_«mefûe
(
node
, 
iob
);

122 
out
:

123 
	`v›_ªf_dec
(
node
);

124  
ªt
;

125 
	}
}

	@kern/init/asm.h

5 
	#SEG_NULLASM
 \

6 .
w‹d
 0, 0; \

7 .
byã
 0, 0, 0, 0

	)

11 
	#SEG_ASM
(
ty≥
,
ba£
,
lim
) \

12 .
	`w‹d
 (((
lim
Ë>> 12Ë& 0xffff), ((
ba£
) & 0xffff); \

13 .
	`byã
 (((
ba£
Ë>> 16Ë& 0xff), (0x90 | (
ty≥
)), \

14 (0xC0 | (((
lim
Ë>> 28Ë& 0xf)), (((
ba£
Ë>> 24Ë& 0xff)

	)

16 
	#STA_X
 0x8

17 
	#STA_E
 0x4

18 
	#STA_C
 0x4

19 
	#STA_W
 0x2

20 
	#STA_R
 0x2

21 
	#STA_A
 0x1

22 

	)

	@kern/init/init.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<c⁄sﬁe.h
>

5 
	~<kdebug.h
>

6 
	~<picúq.h
>

7 
	~<å≠.h
>

8 
	~<˛ock.h
>

9 
	~<öå.h
>

10 
	~<pmm.h
>

11 
	~<vmm.h
>

12 
	~<ide.h
>

13 
	~<sw≠.h
>

14 
	~<¥oc.h
>

15 
	~<fs.h
>

16 
	~<mp.h
>

17 
	~<œpic.h
>

20 
	$kîn_öô
(Ë
	`__©åibuã__
((
n‹ëu∫
));

22 
	`œb1_swôch_ã°
();

24 
	`°¨tŸhîs
();

26 
	$mpmaö
(Ë
	`__©åibuã__
((
n‹ëu∫
));

28 
	`£göô
();

30 
	`c⁄sﬁeöô
();

34 
	$kîn_öô
() {

35 
ed©a
[], 
íd
[];

36 
	`mem£t
(
ed©a
, 0, 
íd
 -Édata);

39 
	`c⁄s_öô
();

41 c⁄° *
mesßge
 = "(THU.CST) os isÜoading ...";

42 
	`˝rötf
("%s\n\n", 
mesßge
);

44 
	`¥öt_kînöfo
();

46 
	`gøde_backåa˚
();

48 
	`pmm_öô
();

50 
	`mpöô
();

51 
	`œpicöô
();

53 
	`idt_öô
();

54 
	`˝rötf
("\n˝u%d: sèπög uc‹e\n\n", 
˝u
->
id
);

56 
	`pic_öô
();

57 
	`iﬂpicöô
();

61 
	`kbd_öô
();

65 
	`vmm_öô
();

66 
	`sched_öô
();

67 
	`¥oc_öô
();

69 
	`ide_öô
();

70 
	`sw≠_öô
();

71 
	`fs_öô
();

73 
	`˛ock_öô
();

74 
	`öå_íabÀ
();

79 
	`˝rötf
("start other cups\n");

80 
	`°¨tŸhîs
();

81 
	`˝rötf
("after startothers\n");

83 
	`˝u_sched
();

85 
	}
}

88 
	$swôchkvm
()

92 
	`l¸3
(
	`v2p
(
boŸ_pgdú
));

98 
	`˝rötf
("page ok \n");

99 
	`£göô
();

102 
	}
}

106 
	$c⁄sﬁeöô
()

116 
	`pic_íabÀ
(
IRQ_KBD
);

117 
	`iﬂpi˚«bÀ
(
IRQ_KBD
, 0);

118 
	}
}

122 
	$m≥¡î
()

124 
	`idt_öô
();

126 
	`swôchkvm
();

127 
	`˝rötf
("˝u id i† %lx\n",
˝u
->
id
);

128 
	`œpicöô
();

129 
	`˝rötf
("afterÜapicinit()\n");

130 
	`mpmaö
();

131 
	}
}

135 
	$mpmaö
()

137 
	`˝rötf
("˝u%d: sèπög\n", 
˝u
->
id
);

138 
	`idt_öô
();

139 
	`xchg
(&
˝u
->
°¨ãd
, 1);

141 
	`˝u_sched
();

144 
	}
}

148 
ölöe
 

149 
	$lgdt_xv6
(
£gdesc
 *
p
, 
size
)

151 vﬁ©ûê
ush‹t
 
pd
[3];

153 
pd
[0] = 
size
-1;

154 
pd
[1] = (
uöt
)
p
;

155 
pd
[2] = (
uöt
)
p
 >> 16;

157 
asm
 vﬁ©ûe("lgdà(%0)" : : "r" (
pd
));

158 
	}
}

161 
ölöe
 

162 
	$lﬂdgs_xv6
(
ush‹t
 
v
)

164 
asm
 vﬁ©ûe("movw %0, %%gs" : : "r" (
v
));

165 
	}
}

169 
èsk°©e
 
	gts
 = {0};

174 
	$£göô
()

176 
˝u
 *
c
;

179 
	`lﬂd_e•0
((
uöçå_t
)
boŸ°ackt›
);

180 
ts
.
ts_ss0
 = 
KERNEL_DS
;

185 
c
 = &
˝us
[
	`˝unum
()];

187 
c
->
gdt
[
SEG_KTEXT
] = 
	`SEG
(
STA_X
|
STA_R
, 0, 0xffffffff, 0);

188 
c
->
gdt
[
SEG_KDATA
] = 
	`SEG
(
STA_W
, 0, 0xffffffff, 0);

189 
c
->
gdt
[
SEG_UTEXT
] = 
	`SEG
(
STA_X
|
STA_R
, 0, 0xffffffff, 
DPL_USER
);

190 
c
->
gdt
[
SEG_UDATA
] = 
	`SEG
(
STA_W
, 0, 0xffffffff, 
DPL_USER
);

192 
c
->
gdt
[
SEG_TSS
] = 
	`SEGTSS
(
STS_T32A
, (
uöçå_t
)&
ts
, —s), 
DPL_KERNEL
);

195 
c
->
gdt
[
SEG_KCPU
] = 
	`SEG
(
STA_W
, (&c->
˝u
), 8, 0);

196 
	`˝rötf
("˝uádd∏%lx\n",&
c
->
˝u
);

197 
	`lgdt_xv6
(
c
->
gdt
, (c->gdt));

198 
	`lﬂdgs_xv6
(
SEG_KCPU
 << 3);

201 
˝u
 = 
c
;

203 
	}
}

204 
__©åibuã__
((
	$__Æig√d__
(
PGSIZE
)))

205 
pde_t
 
íåypgdú
[1024] = {

207 [0] = (0Ë| 
PTE_P
 | 
PTE_W
 | 
PTE_PS
,

209 [
KERNBASE
>>
PDXSHIFT
] = (0Ë| 
PTE_P
 | 
PTE_W
 | 
PTE_PS
,

210 
	}
};

216 
	$°¨tŸhîs
()

218 
uch¨
 
_bö¨y_íåyŸhî_°¨t
[], 
_bö¨y_íåyŸhî_size
[];

219 
uch¨
 *
code
;

220 
˝u
 *
c
;

221 *
°ack
;

226 
code
 = 
	`p2v
(0x7000);

227 
	`memmove
(
code
, 
_bö¨y_íåyŸhî_°¨t
, (
uöt
)
_bö¨y_íåyŸhî_size
);

229 
c
 = 
˝us
; c < cpus+
n˝u
; c++){

230 if(
c
 =
˝us
+
	`˝unum
())

236 
°ack
 = 
	`Æloc_∑ge
();

238 *(**)(
code
-4Ë
°ack
 + 
KSTACKSIZE
;

239 *(**)(
code
-8Ë
m≥¡î
;

240 *(**)(
code
-12Ë(*)
	`v2p
(
íåypgdú
);

242 
	`œpic°¨èp
(
c
->
id
, 
	`v2p
(
code
));

244 
c
->
°¨ãd
 == 0)

247 
	}
}

251 
__©åibuã__
((
noölöe
))

252 
	$gøde_backåa˚2
(
¨g0
, 
¨g1
, 
¨g2
, 
¨g3
) {

253 
	`m⁄_backåa˚
(0, 
NULL
, NULL);

254 
	}
}

256 
__©åibuã__
((
noölöe
))

257 
	$gøde_backåa˚1
(
¨g0
, 
¨g1
) {

258 
	`gøde_backåa˚2
(
¨g0
, ()&¨g0, 
¨g1
, ()&arg1);

259 
	}
}

261 
__©åibuã__
((
noölöe
))

262 
	$gøde_backåa˚0
(
¨g0
, 
¨g1
, 
¨g2
) {

263 
	`gøde_backåa˚1
(
¨g0
, 
¨g2
);

264 
	}
}

267 
	$gøde_backåa˚
() {

268 
	`gøde_backåa˚0
(0, ()
kîn_öô
, 0xffff0000);

269 
	}
}

272 
	$œb1_¥öt_cur_°©us
() {

273 
round
 = 0;

274 
uöt16_t
 
ªg1
, 
ªg2
, 
ªg3
, 
ªg4
;

275 
asm
 volatile (

280 : "=m"(
ªg1
), "=m"(
ªg2
), "=m"(
ªg3
), "=m"(
ªg4
));

281 
	`˝rötf
("%d: @rög %d\n", 
round
, 
ªg1
 & 3);

282 
	`˝rötf
("%d: c†%x\n", 
round
, 
ªg1
);

283 
	`˝rötf
("%d: d†%x\n", 
round
, 
ªg2
);

284 
	`˝rötf
("%d:É†%x\n", 
round
, 
ªg3
);

285 
	`˝rötf
("%d: s†%x\n", 
round
, 
ªg4
);

286 
round
 ++;

287 
	}
}

290 
	$œb1_swôch_to_u£r
() {

292 
	}
}

295 
	$œb1_swôch_to_kî√l
() {

297 
	}
}

300 
	$œb1_swôch_ã°
() {

301 
	`œb1_¥öt_cur_°©us
();

302 
	`˝rötf
("+++ switchÅo user mode +++\n");

303 
	`œb1_swôch_to_u£r
();

304 
	`œb1_¥öt_cur_°©us
();

305 
	`˝rötf
("+++ switchÅo kernel mode +++\n");

306 
	`œb1_swôch_to_kî√l
();

307 
	`œb1_¥öt_cur_°©us
();

308 
	}
}

	@kern/libs/readline.c

1 
	~<°dio.h
>

3 
	#BUFSIZE
 1024

	)

4 
	gbuf
[
BUFSIZE
];

25 
	$ªadlöe
(c⁄° *
¥om±
) {

26 i‡(
¥om±
 !
NULL
) {

27 
	`˝rötf
("%s", 
¥om±
);

29 
i
 = 0, 
c
;

31 
c
 = 
	`gëch¨
();

32 i‡(
c
 < 0) {

33  
NULL
;

35 i‡(
c
 >' ' && 
i
 < 
BUFSIZE
 - 1) {

36 
	`˝utch¨
(
c
);

37 
buf
[
i
 ++] = 
c
;

39 i‡(
c
 ='\b' && 
i
 > 0) {

40 
	`˝utch¨
(
c
);

41 
i
 --;

43 i‡(
c
 == '\n' || c == '\r') {

44 
	`˝utch¨
(
c
);

45 
buf
[
i
] = '\0';

46  
buf
;

49 
	}
}

	@kern/libs/stdio.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<c⁄sﬁe.h
>

4 
	~<uni°d.h
>

12 
	$˝utch
(
c
, *
˙t
) {

13 
	`c⁄s_putc
(
c
);

14 (*
˙t
) ++;

15 
	}
}

27 
	$v˝rötf
(c⁄° *
fmt
, 
va_li°
 
≠
) {

28 
˙t
 = 0;

29 
	`v¥ötfmt
((*)
˝utch
, 
NO_FD
, &
˙t
, 
fmt
, 
≠
);

30  
˙t
;

31 
	}
}

40 
	$˝rötf
(c⁄° *
fmt
, ...) {

41 
va_li°
 
≠
;

42 
˙t
;

43 
	`va_°¨t
(
≠
, 
fmt
);

44 
˙t
 = 
	`v˝rötf
(
fmt
, 
≠
);

45 
	`va_íd
(
≠
);

46  
˙t
;

47 
	}
}

51 
	$˝utch¨
(
c
) {

52 
	`c⁄s_putc
(
c
);

53 
	}
}

60 
	$˝uts
(c⁄° *
°r
) {

61 
˙t
 = 0;

62 
c
;

63 (
c
 = *
°r
 ++) != '\0') {

64 
	`˝utch
(
c
, &
˙t
);

66 
	`˝utch
('\n', &
˙t
);

67  
˙t
;

68 
	}
}

72 
	$gëch¨
() {

73 
c
;

74 (
c
 = 
	`c⁄s_gëc
()) == 0)

76  
c
;

77 
	}
}

	@kern/libs/string.c

1 
	~<°rög.h
>

2 
	~<kmÆloc.h
>

5 
	$°rdup
(c⁄° *
§c
) {

6 *
d°
;

7 
size_t
 
Àn
 = 
	`°æí
(
§c
);

8 i‡((
d°
 = 
	`kmÆloc
(
Àn
 + 1)Ë!
NULL
) {

9 
	`mem˝y
(
d°
, 
§c
, 
Àn
);

10 
d°
[
Àn
] = '\0';

12  
d°
;

13 
	}
}

16 
	$°ødd
(c⁄° *
§c1
, c⁄° *
§c2
) {

17 *
ªt
, *
d°
;

18 
size_t
 
Àn1
 = 
	`°æí
(
§c1
), 
Àn2
 = såÀn(
§c2
);

19 i‡((
ªt
 = 
d°
 = 
	`kmÆloc
(
Àn1
 + 
Àn2
 + 1)Ë!
NULL
) {

20 
	`mem˝y
(
d°
, 
§c1
, 
Àn1
), dst +=Üen1;

21 
	`mem˝y
(
d°
, 
§c2
, 
Àn2
), dst +=Üen2;

22 *
d°
 = '\0';

24  
ªt
;

25 
	}
}

	@kern/mm/default_pmm.c

1 
	~<pmm.h
>

2 
	~<li°.h
>

3 
	~<°rög.h
>

4 
	~<deÁu…_pmm.h
>

57 
‰ì_¨ó_t
 
	g‰ì_¨ó
;

59 
	#‰ì_li°
 (
‰ì_¨ó
.
‰ì_li°
)

	)

60 
	#ƒ_‰ì
 (
‰ì_¨ó
.
ƒ_‰ì
)

	)

63 
	$deÁu…_öô
() {

64 
	`li°_öô
(&
‰ì_li°
);

65 
ƒ_‰ì
 = 0;

66 
	}
}

69 
	$deÁu…_öô_memm≠
(
Page
 *
ba£
, 
size_t
 
n
) {

70 
	`as£π
(
n
 > 0);

71 
Page
 *
p
 = 
ba£
;

72 ; 
p
 !
ba£
 + 
n
;Ö ++) {

73 
	`as£π
(
	`PageRe£rved
(
p
));

74 
p
->
Êags
 = 0;

75 
	`SëPagePr›îty
(
p
);

76 
p
->
¥›îty
 = 0;

77 
	`£t_∑ge_ªf
(
p
, 0);

78 
	`li°_add_bef‹e
(&
‰ì_li°
, &(
p
->
∑ge_lök
));

80 
ƒ_‰ì
 +
n
;

82 
ba£
->
¥›îty
 = 
n
;

83 
	}
}

85 
Page
 *

86 
	$deÁu…_Æloc_∑ges
(
size_t
 
n
) {

87 
	`as£π
(
n
 > 0);

88 i‡(
n
 > 
ƒ_‰ì
) {

89  
NULL
;

91 
li°_íåy_t
 *
À
, *
Àn
;

92 
À
 = &
‰ì_li°
;

94 (
À
=
	`li°_√xt
÷e)Ë!&
‰ì_li°
) {

95 
Page
 *
p
 = 
	`À2∑ge
(
À
, 
∑ge_lök
);

96 if(
p
->
¥›îty
 >
n
){

97 
i
;

98 
i
=0;i<
n
;i++){

99 
Àn
 = 
	`li°_√xt
(
À
);

100 
Page
 *
µ
 = 
	`À2∑ge
(
À
, 
∑ge_lök
);

101 
	`SëPageRe£rved
(
µ
);

102 
	`CÀ¨PagePr›îty
(
µ
);

103 
	`li°_dñ
(
À
);

104 
À
 = 
Àn
;

106 if(
p
->
¥›îty
>
n
){

107 (
	`À2∑ge
(
À
,
∑ge_lök
))->
¥›îty
 = 
p
->¥›îty - 
n
;

109 
	`CÀ¨PagePr›îty
(
p
);

110 
	`SëPageRe£rved
(
p
);

111 
ƒ_‰ì
 -
n
;

112  
p
;

115  
NULL
;

116 
	}
}

119 
	$deÁu…_‰ì_∑ges
(
Page
 *
ba£
, 
size_t
 
n
) {

120 
	`as£π
(
n
 > 0);

121 
	`as£π
(
	`PageRe£rved
(
ba£
));

123 
li°_íåy_t
 *
À
 = &
‰ì_li°
;

124 
Page
 * 
p
;

125 (
À
=
	`li°_√xt
÷e)Ë!&
‰ì_li°
) {

126 
p
 = 
	`À2∑ge
(
À
, 
∑ge_lök
);

127 if(
p
>
ba£
){

132 
p
=
ba£
;p<ba£+
n
;p++){

133 
	`li°_add_bef‹e
(
À
, &(
p
->
∑ge_lök
));

135 
ba£
->
Êags
 = 0;

136 
	`£t_∑ge_ªf
(
ba£
, 0);

137 
	`CÀ¨PagePr›îty
(
ba£
);

138 
	`SëPagePr›îty
(
ba£
);

139 
ba£
->
¥›îty
 = 
n
;

141 
p
 = 
	`À2∑ge
(
À
,
∑ge_lök
) ;

142 if–
ba£
+
n
 =
p
 ){

143 
ba£
->
¥›îty
 +
p
->property;

144 
p
->
¥›îty
 = 0;

146 
À
 = 
	`li°_¥ev
(&(
ba£
->
∑ge_lök
));

147 
p
 = 
	`À2∑ge
(
À
, 
∑ge_lök
);

148 if(
À
!=&
‰ì_li°
 && 
p
==
ba£
-1){

149 
À
!=&
‰ì_li°
){

150 if(
p
->
¥›îty
){

151 
p
->
¥›îty
 +
ba£
->property;

152 
ba£
->
¥›îty
 = 0;

155 
À
 = 
	`li°_¥ev
(le);

156 
p
 = 
	`À2∑ge
(
À
,
∑ge_lök
);

160 
ƒ_‰ì
 +
n
;

162 
	}
}

164 
size_t


165 
	$deÁu…_ƒ_‰ì_∑ges
() {

166  
ƒ_‰ì
;

167 
	}
}

170 
	$basic_check
() {

171 
Page
 *
p0
, *
p1
, *
p2
;

172 
p0
 = 
p1
 = 
p2
 = 
NULL
;

173 
	`as£π
((
p0
 = 
	`Æloc_∑ge
()Ë!
NULL
);

174 
	`as£π
((
p1
 = 
	`Æloc_∑ge
()Ë!
NULL
);

175 
	`as£π
((
p2
 = 
	`Æloc_∑ge
()Ë!
NULL
);

177 
	`as£π
(
p0
 !
p1
 &&Ö0 !
p2
 &&Ö1 !=Ö2);

178 
	`as£π
(
	`∑ge_ªf
(
p0
Ë=0 &&Öage_ªf(
p1
Ë=0 &&Öage_ªf(
p2
) == 0);

180 
	`as£π
(
	`∑ge2∑
(
p0
Ë< 
≈age
 * 
PGSIZE
);

181 
	`as£π
(
	`∑ge2∑
(
p1
Ë< 
≈age
 * 
PGSIZE
);

182 
	`as£π
(
	`∑ge2∑
(
p2
Ë< 
≈age
 * 
PGSIZE
);

184 
li°_íåy_t
 
‰ì_li°_°‹e
 = 
‰ì_li°
;

185 
	`li°_öô
(&
‰ì_li°
);

186 
	`as£π
(
	`li°_em±y
(&
‰ì_li°
));

188 
ƒ_‰ì_°‹e
 = 
ƒ_‰ì
;

189 
ƒ_‰ì
 = 0;

191 
	`as£π
(
	`Æloc_∑ge
(Ë=
NULL
);

193 
	`‰ì_∑ge
(
p0
);

194 
	`‰ì_∑ge
(
p1
);

195 
	`‰ì_∑ge
(
p2
);

196 
	`as£π
(
ƒ_‰ì
 == 3);

198 
	`as£π
((
p0
 = 
	`Æloc_∑ge
()Ë!
NULL
);

199 
	`as£π
((
p1
 = 
	`Æloc_∑ge
()Ë!
NULL
);

200 
	`as£π
((
p2
 = 
	`Æloc_∑ge
()Ë!
NULL
);

202 
	`as£π
(
	`Æloc_∑ge
(Ë=
NULL
);

204 
	`‰ì_∑ge
(
p0
);

205 
	`as£π
(!
	`li°_em±y
(&
‰ì_li°
));

207 
Page
 *
p
;

208 
	`as£π
((
p
 = 
	`Æloc_∑ge
()Ë=
p0
);

209 
	`as£π
(
	`Æloc_∑ge
(Ë=
NULL
);

211 
	`as£π
(
ƒ_‰ì
 == 0);

212 
‰ì_li°
 = 
‰ì_li°_°‹e
;

213 
ƒ_‰ì
 = 
ƒ_‰ì_°‹e
;

215 
	`‰ì_∑ge
(
p
);

216 
	`‰ì_∑ge
(
p1
);

217 
	`‰ì_∑ge
(
p2
);

218 
	}
}

223 
	$deÁu…_check
() {

224 
cou¡
 = 0, 
tŸÆ
 = 0;

225 
li°_íåy_t
 *
À
 = &
‰ì_li°
;

226 (
À
 = 
	`li°_√xt
÷e)Ë!&
‰ì_li°
) {

227 
Page
 *
p
 = 
	`À2∑ge
(
À
, 
∑ge_lök
);

228 
	`as£π
(
	`PagePr›îty
(
p
));

229 
cou¡
 ++, 
tŸÆ
 +
p
->
¥›îty
;

231 
	`as£π
(
tŸÆ
 =
	`ƒ_‰ì_∑ges
());

233 
	`basic_check
();

235 
Page
 *
p0
 = 
	`Æloc_∑ges
(5), *
p1
, *
p2
;

236 
	`as£π
(
p0
 !
NULL
);

237 
	`as£π
(!
	`PagePr›îty
(
p0
));

239 
li°_íåy_t
 
‰ì_li°_°‹e
 = 
‰ì_li°
;

240 
	`li°_öô
(&
‰ì_li°
);

241 
	`as£π
(
	`li°_em±y
(&
‰ì_li°
));

242 
	`as£π
(
	`Æloc_∑ge
(Ë=
NULL
);

244 
ƒ_‰ì_°‹e
 = 
ƒ_‰ì
;

245 
ƒ_‰ì
 = 0;

247 
	`‰ì_∑ges
(
p0
 + 2, 3);

248 
	`as£π
(
	`Æloc_∑ges
(4Ë=
NULL
);

249 
	`as£π
(
	`PagePr›îty
(
p0
 + 2Ë&&Ö0[2].
¥›îty
 == 3);

250 
	`as£π
((
p1
 = 
	`Æloc_∑ges
(3)Ë!
NULL
);

251 
	`as£π
(
	`Æloc_∑ge
(Ë=
NULL
);

252 
	`as£π
(
p0
 + 2 =
p1
);

254 
p2
 = 
p0
 + 1;

255 
	`‰ì_∑ge
(
p0
);

256 
	`‰ì_∑ges
(
p1
, 3);

257 
	`as£π
(
	`PagePr›îty
(
p0
Ë&&Ö0->
¥›îty
 == 1);

258 
	`as£π
(
	`PagePr›îty
(
p1
Ë&&Ö1->
¥›îty
 == 3);

260 
	`as£π
((
p0
 = 
	`Æloc_∑ge
()Ë=
p2
 - 1);

261 
	`‰ì_∑ge
(
p0
);

262 
	`as£π
((
p0
 = 
	`Æloc_∑ges
(2)Ë=
p2
 + 1);

264 
	`‰ì_∑ges
(
p0
, 2);

265 
	`‰ì_∑ge
(
p2
);

267 
	`as£π
((
p0
 = 
	`Æloc_∑ges
(5)Ë!
NULL
);

268 
	`as£π
(
	`Æloc_∑ge
(Ë=
NULL
);

270 
	`as£π
(
ƒ_‰ì
 == 0);

271 
ƒ_‰ì
 = 
ƒ_‰ì_°‹e
;

273 
‰ì_li°
 = 
‰ì_li°_°‹e
;

274 
	`‰ì_∑ges
(
p0
, 5);

276 
À
 = &
‰ì_li°
;

277 (
À
 = 
	`li°_√xt
÷e)Ë!&
‰ì_li°
) {

278 
Page
 *
p
 = 
	`À2∑ge
(
À
, 
∑ge_lök
);

279 
cou¡
 --, 
tŸÆ
 -
p
->
¥›îty
;

281 
	`as£π
(
cou¡
 == 0);

282 
	`as£π
(
tŸÆ
 == 0);

283 
	}
}

285 c⁄° 
pmm_m™agî
 
	gdeÁu…_pmm_m™agî
 = {

286 .
«me
 = "default_pmm_manager",

287 .
	göô
 = 
deÁu…_öô
,

288 .
	göô_memm≠
 = 
deÁu…_öô_memm≠
,

289 .
	gÆloc_∑ges
 = 
deÁu…_Æloc_∑ges
,

290 .
	g‰ì_∑ges
 = 
deÁu…_‰ì_∑ges
,

291 .
	gƒ_‰ì_∑ges
 = 
deÁu…_ƒ_‰ì_∑ges
,

292 .
	gcheck
 = 
deÁu…_check
,

	@kern/mm/default_pmm.h

1 #i‚de‡
__KERN_MM_DEFAULT_PMM_H__


2 
	#__KERN_MM_DEFAULT_PMM_H__


	)

4 
	~<pmm.h
>

6 c⁄° 
pmm_m™agî
 
deÁu…_pmm_m™agî
;

7 
‰ì_¨ó_t
 
‰ì_¨ó
;

	@kern/mm/kmalloc.c

1 
	~<defs.h
>

2 
	~<li°.h
>

3 
	~<memœyout.h
>

4 
	~<as£π.h
>

5 
	~<kmÆloc.h
>

6 
	~<sync.h
>

7 
	~<pmm.h
>

8 
	~<°dio.h
>

43 
	#•ö_lock_úqßve
(
l
, 
f
Ë
	`loˇl_öå_ßve
(f)

	)

44 
	#•ö_u∆ock_úqª°‹e
(
l
, 
f
Ë
	`loˇl_öå_ª°‹e
(f)

	)

45 
	tgÂ_t
;

46 #i‚de‡
PAGE_SIZE


47 
	#PAGE_SIZE
 
PGSIZE


	)

50 #i‚de‡
L1_CACHE_BYTES


51 
	#L1_CACHE_BYTES
 64

	)

54 #i‚de‡
ALIGN


55 
	#ALIGN
(
addr
,
size
Ë((◊ddr)+(size)-1)&(~((size)-1)))

	)

59 
	s¶ob_block
 {

60 
	munôs
;

61 
¶ob_block
 *
	m√xt
;

63 
¶ob_block
 
	t¶ob_t
;

65 
	#SLOB_UNIT
 (
¶ob_t
)

	)

66 
	#SLOB_UNITS
(
size
Ë(((sizeË+ 
SLOB_UNIT
 - 1)/SLOB_UNIT)

	)

67 
	#SLOB_ALIGN
 
L1_CACHE_BYTES


	)

69 
	sbigblock
 {

70 
	m‹dî
;

71 *
	m∑ges
;

72 
bigblock
 *
	m√xt
;

74 
bigblock
 
	tbigblock_t
;

76 
¶ob_t
 
	g¨ía
 = { .
√xt
 = &
¨ía
, .
	gunôs
 = 1 };

77 
¶ob_t
 *
	g¶ob‰ì
 = &
¨ía
;

78 
bigblock_t
 *
	gbigblocks
;

81 * 
	$__¶ob_gë_‰ì_∑ges
(
gÂ_t
 
gÂ
, 
‹dî
)

83 
Page
 * 
∑ge
 = 
	`Æloc_∑ges
(1 << 
‹dî
);

84 if(!
∑ge
)

85  
NULL
;

86  
	`∑ge2kva
(
∑ge
);

87 
	}
}

89 
	#__¶ob_gë_‰ì_∑ge
(
gÂ
Ë
	`__¶ob_gë_‰ì_∑ges
(gÂ, 0)

	)

91 
ölöe
 
	$__¶ob_‰ì_∑ges
(
kva
, 
‹dî
)

93 
	`‰ì_∑ges
(
	`kva2∑ge
(
kva
), 1 << 
‹dî
);

94 
	}
}

96 
¶ob_‰ì
(*
b
, 
size
);

98 *
	$¶ob_Æloc
(
size_t
 
size
, 
gÂ_t
 
gÂ
, 
Æign
)

100 
	`as£π
–(
size
 + 
SLOB_UNIT
Ë< 
PAGE_SIZE
 );

102 
¶ob_t
 *
¥ev
, *
cur
, *
Æig√d
 = 0;

103 
dñè
 = 0, 
unôs
 = 
	`SLOB_UNITS
(
size
);

104 
Êags
;

106 
	`•ö_lock_úqßve
(&
¶ob_lock
, 
Êags
);

107 
¥ev
 = 
¶ob‰ì
;

108 
cur
 = 
¥ev
->
√xt
; ;Örev = cur, cur = cur->next) {

109 i‡(
Æign
) {

110 
Æig√d
 = (
¶ob_t
 *)
	`ALIGN
(()
cur
, 
Æign
);

111 
dñè
 = 
Æig√d
 - 
cur
;

113 i‡(
cur
->
unôs
 >unô†+ 
dñè
) {

114 i‡(
dñè
) {

115 
Æig√d
->
unôs
 = 
cur
->unô†- 
dñè
;

116 
Æig√d
->
√xt
 = 
cur
->next;

117 
cur
->
√xt
 = 
Æig√d
;

118 
cur
->
unôs
 = 
dñè
;

119 
¥ev
 = 
cur
;

120 
cur
 = 
Æig√d
;

123 i‡(
cur
->
unôs
 == units)

124 
¥ev
->
√xt
 = 
cur
->next;

126 
¥ev
->
√xt
 = 
cur
 + 
unôs
;

127 
¥ev
->
√xt
->
unôs
 = 
cur
->units - units;

128 
¥ev
->
√xt
->√xà
cur
->next;

129 
cur
->
unôs
 = units;

132 
¶ob‰ì
 = 
¥ev
;

133 
	`•ö_u∆ock_úqª°‹e
(&
¶ob_lock
, 
Êags
);

134  
cur
;

136 i‡(
cur
 =
¶ob‰ì
) {

137 
	`•ö_u∆ock_úqª°‹e
(&
¶ob_lock
, 
Êags
);

139 i‡(
size
 =
PAGE_SIZE
)

142 
cur
 = (
¶ob_t
 *)
	`__¶ob_gë_‰ì_∑ge
(
gÂ
);

143 i‡(!
cur
)

146 
	`¶ob_‰ì
(
cur
, 
PAGE_SIZE
);

147 
	`•ö_lock_úqßve
(&
¶ob_lock
, 
Êags
);

148 
cur
 = 
¶ob‰ì
;

151 
	}
}

153 
	$¶ob_‰ì
(*
block
, 
size
)

155 
¶ob_t
 *
cur
, *
b
 = (¶ob_à*)
block
;

156 
Êags
;

158 i‡(!
block
)

161 i‡(
size
)

162 
b
->
unôs
 = 
	`SLOB_UNITS
(
size
);

165 
	`•ö_lock_úqßve
(&
¶ob_lock
, 
Êags
);

166 
cur
 = 
¶ob‰ì
; !(
b
 > cu∏&& b < cur->
√xt
); cur = cur->next)

167 i‡(
cur
 >cur->
√xt
 && (
b
 > cur || b < cur->next))

170 i‡(
b
 + b->
unôs
 =
cur
->
√xt
) {

171 
b
->
unôs
 +
cur
->
√xt
->units;

172 
b
->
√xt
 = 
cur
->next->next;

174 
b
->
√xt
 = 
cur
->next;

176 i‡(
cur
 + cur->
unôs
 =
b
) {

177 
cur
->
unôs
 +
b
->units;

178 
cur
->
√xt
 = 
b
->next;

180 
cur
->
√xt
 = 
b
;

182 
¶ob‰ì
 = 
cur
;

184 
	`•ö_u∆ock_úqª°‹e
(&
¶ob_lock
, 
Êags
);

185 
	}
}

189 
	$check_¶ab
() {

190 
	`˝rötf
("check_slab() success\n");

191 
	}
}

194 
	$¶ab_öô
() {

195 
	`˝rötf
("use SLOBállocator\n");

196 
	`check_¶ab
();

197 
	}
}

199 
ölöe
 

200 
	$kmÆloc_öô
() {

201 
	`¶ab_öô
();

202 
	`˝rötf
("kmalloc_init() succeeded!\n");

203 
	}
}

205 
size_t


206 
	$¶ab_Æloˇãd
() {

208 
	}
}

210 
size_t


211 
	$kÆloˇãd
() {

212  
	`¶ab_Æloˇãd
();

213 
	}
}

215 
	$föd_‹dî
(
size
)

217 
‹dî
 = 0;

218  ; 
size
 > 4096 ; size >>=1)

219 
‹dî
++;

220  
‹dî
;

221 
	}
}

223 *
	$__kmÆloc
(
size_t
 
size
, 
gÂ_t
 
gÂ
)

225 
¶ob_t
 *
m
;

226 
bigblock_t
 *
bb
;

227 
Êags
;

229 i‡(
size
 < 
PAGE_SIZE
 - 
SLOB_UNIT
) {

230 
m
 = 
	`¶ob_Æloc
(
size
 + 
SLOB_UNIT
, 
gÂ
, 0);

231  
m
 ? (*)(m + 1) : 0;

234 
bb
 = 
	`¶ob_Æloc
((
bigblock_t
), 
gÂ
, 0);

235 i‡(!
bb
)

238 
bb
->
‹dî
 = 
	`föd_‹dî
(
size
);

239 
bb
->
∑ges
 = (*)
	`__¶ob_gë_‰ì_∑ges
(
gÂ
, bb->
‹dî
);

241 i‡(
bb
->
∑ges
) {

242 
	`•ö_lock_úqßve
(&
block_lock
, 
Êags
);

243 
bb
->
√xt
 = 
bigblocks
;

244 
bigblocks
 = 
bb
;

245 
	`•ö_u∆ock_úqª°‹e
(&
block_lock
, 
Êags
);

246  
bb
->
∑ges
;

249 
	`¶ob_‰ì
(
bb
, (
bigblock_t
));

251 
	}
}

254 
	$kmÆloc
(
size_t
 
size
)

256  
	`__kmÆloc
(
size
, 0);

257 
	}
}

260 
	$k‰ì
(*
block
)

262 
bigblock_t
 *
bb
, **
œ°
 = &
bigblocks
;

263 
Êags
;

265 i‡(!
block
)

268 i‡(!(()
block
 & (
PAGE_SIZE
-1))) {

270 
	`•ö_lock_úqßve
(&
block_lock
, 
Êags
);

271 
bb
 = 
bigblocks
; bb; 
œ°
 = &bb->
√xt
, bb = bb->next) {

272 i‡(
bb
->
∑ges
 =
block
) {

273 *
œ°
 = 
bb
->
√xt
;

274 
	`•ö_u∆ock_úqª°‹e
(&
block_lock
, 
Êags
);

275 
	`__¶ob_‰ì_∑ges
(()
block
, 
bb
->
‹dî
);

276 
	`¶ob_‰ì
(
bb
, (
bigblock_t
));

280 
	`•ö_u∆ock_úqª°‹e
(&
block_lock
, 
Êags
);

283 
	`¶ob_‰ì
((
¶ob_t
 *)
block
 - 1, 0);

285 
	}
}

288 
	$ksize
(c⁄° *
block
)

290 
bigblock_t
 *
bb
;

291 
Êags
;

293 i‡(!
block
)

296 i‡(!(()
block
 & (
PAGE_SIZE
-1))) {

297 
	`•ö_lock_úqßve
(&
block_lock
, 
Êags
);

298 
bb
 = 
bigblocks
; bb; bb = bb->
√xt
)

299 i‡(
bb
->
∑ges
 =
block
) {

300 
	`•ö_u∆ock_úqª°‹e
(&
¶ob_lock
, 
Êags
);

301  
PAGE_SIZE
 << 
bb
->
‹dî
;

303 
	`•ö_u∆ock_úqª°‹e
(&
block_lock
, 
Êags
);

306  ((
¶ob_t
 *)
block
 - 1)->
unôs
 * 
SLOB_UNIT
;

307 
	}
}

	@kern/mm/kmalloc.h

1 #i‚de‡
__KERN_MM_SLAB_H__


2 
	#__KERN_MM_SLAB_H__


	)

4 
	~<defs.h
>

6 
	#KMALLOC_MAX_ORDER
 10

	)

8 
kmÆloc_öô
();

10 *
kmÆloc
(
size_t
 
n
);

11 
k‰ì
(*
objp
);

13 
size_t
 
kÆloˇãd
();

	@kern/mm/memlayout.h

1 #i‚de‡
__KERN_MM_MEMLAYOUT_H__


2 
	#__KERN_MM_MEMLAYOUT_H__


	)

7 
	#SEG_KTEXT
 1

	)

8 
	#SEG_KDATA
 2

	)

9 
	#SEG_UTEXT
 3

	)

10 
	#SEG_UDATA
 4

	)

11 
	#SEG_TSS
 5

	)

12 
	#SEG_KCPU
 6

13 

	)

16 
	#GD_KTEXT
 ((
SEG_KTEXT
) << 3)

17 
	#GD_KDATA
 ((
SEG_KDATA
) << 3)

18 
	#GD_UTEXT
 ((
SEG_UTEXT
) << 3)

19 
	#GD_UDATA
 ((
SEG_UDATA
) << 3)

20 
	#GD_TSS
 ((
SEG_TSS
) << 3)

21 
	#GD_KCPU
 ((
SEG_KCPU
) << 3)

22 

	)

24 
	#DPL_KERNEL
 (0)

	)

25 
	#DPL_USER
 (3)

	)

27 
	#KERNEL_CS
 ((
GD_KTEXT
Ë| 
DPL_KERNEL
)

	)

28 
	#KERNEL_DS
 ((
GD_KDATA
Ë| 
DPL_KERNEL
)

	)

29 
	#USER_CS
 ((
GD_UTEXT
Ë| 
DPL_USER
)

	)

30 
	#USER_DS
 ((
GD_UDATA
Ë| 
DPL_USER
)

	)

74 
	#KERNBASE
 0xc0000000

	)

75 
	#KMEMSIZE
 0x38000000

76 
	#KERNTOP
 (
KERNBASE
 + 
KMEMSIZE
)

	)

78 
	#EXTMEM
 0x100000

79 
	#PHYSTOP
 0xE000000

80 
	#KERNLINK
 (
KERNBASE
+
EXTMEM
)

81 

	)

85 
	#DEVSPACE
 0xFE000000

86 

	)

87 #i‚de‡
__ASSEMBLER__


89 
ölöe
 
uöt
 
	$v2p
(*
a
Ë{  ((
uöt
Ë◊)Ë- 
KERNBASE
; 
	}
}

90 
ölöe
 *
	$p2v
(
uöt
 
a
Ë{  (*Ë(◊Ë+ 
KERNBASE
); 
	}
}

94 
	#V2P
(
a
Ë(((
uöt
Ë◊)Ë- 
KERNBASE
)

	)

95 
	#P2V
(
a
Ë(((*Ë◊)Ë+ 
KERNBASE
)

	)

97 
	#V2P_WO
(
x
Ë((xË- 
KERNBASE
)

98 
	#P2V_WO
(
x
Ë((xË+ 
KERNBASE
)

99 

	)

107 
	#VPT
 0xFAC00000

	)

109 
	#KSTACKPAGE
 2

110 
	#KSTACKSIZE
 (
KSTACKPAGE
 * 
PGSIZE
)

111 

	)

112 
	#USERTOP
 0xB0000000

	)

113 
	#USTACKTOP
 
USERTOP


	)

114 
	#USTACKPAGE
 256

115 
	#USTACKSIZE
 (
USTACKPAGE
 * 
PGSIZE
)

116 

	)

117 
	#USERBASE
 0x00200000

	)

118 
	#UTEXT
 0x00800000

119 
	#USTAB
 
USERBASE


120 

	)

121 
	#USER_ACCESS
(
°¨t
, 
íd
) \

122 (
USERBASE
 <(
°¨t
Ë&& (°¨tË< (
íd
Ë&& (ídË<
USERTOP
)

	)

124 
	#KERN_ACCESS
(
°¨t
, 
íd
) \

125 (
KERNBASE
 <(
°¨t
Ë&& (°¨tË< (
íd
Ë&& (ídË<
KERNTOP
)

	)

127 #i‚de‡
__ASSEMBLER__


129 
	~<defs.h
>

130 
	~<©omic.h
>

131 
	~<li°.h
>

133 
uöçå_t
 
	t±e_t
;

134 
uöçå_t
 
	tpde_t
;

135 
±e_t
 
	tsw≠_íåy_t
;

138 
	#E820MAX
 20

139 
	#E820_ARM
 1

140 
	#E820_ARR
 2

141 

	)

142 
	se820m≠
 {

143 
	mƒ_m≠
;

145 
uöt64_t
 
	maddr
;

146 
uöt64_t
 
	msize
;

147 
uöt32_t
 
	mty≥
;

148 } 
__©åibuã__
((
∑cked
)Ë
	mm≠
[
E820MAX
];

156 
	sPage
 {

157 
	mªf
;

158 
uöt32_t
 
	mÊags
;

159 
	m¥›îty
;

160 
	mz⁄e_num
;

161 
li°_íåy_t
 
	m∑ge_lök
;

162 
li°_íåy_t
 
	m¥a_∑ge_lök
;

163 
uöçå_t
 
	m¥a_vaddr
;

167 
	#PG_ª£rved
 0

168 
	#PG_¥›îty
 1

169 

	)

170 
	#SëPageRe£rved
(
∑ge
Ë
	`£t_bô
(
PG_ª£rved
, &(’age)->
Êags
))

	)

171 
	#CÀ¨PageRe£rved
(
∑ge
Ë
	`˛ór_bô
(
PG_ª£rved
, &(’age)->
Êags
))

	)

172 
	#PageRe£rved
(
∑ge
Ë
	`ã°_bô
(
PG_ª£rved
, &(’age)->
Êags
))

	)

173 
	#SëPagePr›îty
(
∑ge
Ë
	`£t_bô
(
PG_¥›îty
, &(’age)->
Êags
))

	)

174 
	#CÀ¨PagePr›îty
(
∑ge
Ë
	`˛ór_bô
(
PG_¥›îty
, &(’age)->
Êags
))

	)

175 
	#PagePr›îty
(
∑ge
Ë
	`ã°_bô
(
PG_¥›îty
, &(’age)->
Êags
))

	)

178 
	#À2∑ge
(
À
, 
membî
) \

179 
	`to_°ru˘
((
À
), 
Page
, 
membî
)

	)

183 
li°_íåy_t
 
	m‰ì_li°
;

184 
	mƒ_‰ì
;

185 } 
	t‰ì_¨ó_t
;

	@kern/mm/mmu.h

1 #i‚de‡
__KERN_MM_MMU_H__


2 
	#__KERN_MM_MMU_H__


	)

5 
	#FL_CF
 0x00000001

6 
	#FL_PF
 0x00000004

7 
	#FL_AF
 0x00000010

8 
	#FL_ZF
 0x00000040

9 
	#FL_SF
 0x00000080

10 
	#FL_TF
 0x00000100

11 
	#FL_IF
 0x00000200

12 
	#FL_DF
 0x00000400

13 
	#FL_OF
 0x00000800

14 
	#FL_IOPL_MASK
 0x00003000

15 
	#FL_IOPL_0
 0x00000000

16 
	#FL_IOPL_1
 0x00001000

17 
	#FL_IOPL_2
 0x00002000

18 
	#FL_IOPL_3
 0x00003000

19 
	#FL_NT
 0x00004000

20 
	#FL_RF
 0x00010000

21 
	#FL_VM
 0x00020000

22 
	#FL_AC
 0x00040000

23 
	#FL_VIF
 0x00080000

24 
	#FL_VIP
 0x00100000

25 
	#FL_ID
 0x00200000

26 

	)

28 
	#STA_X
 0x8

29 
	#STA_E
 0x4

30 
	#STA_C
 0x4

31 
	#STA_W
 0x2

32 
	#STA_R
 0x2

33 
	#STA_A
 0x1

34 

	)

36 
	#STS_T16A
 0x1

37 
	#STS_LDT
 0x2

38 
	#STS_T16B
 0x3

39 
	#STS_CG16
 0x4

40 
	#STS_TG
 0x5

41 
	#STS_IG16
 0x6

42 
	#STS_TG16
 0x7

43 
	#STS_T32A
 0x9

44 
	#STS_T32B
 0xB

45 
	#STS_CG32
 0xC

46 
	#STS_IG32
 0xE

47 
	#STS_TG32
 0xF

48 

	)

49 #ifde‡
__ASSEMBLER__


51 
	#SEG_NULL
 \

52 .
w‹d
 0, 0; \

53 .
byã
 0, 0, 0, 0

	)

55 
	#SEG_ASM
(
ty≥
,
ba£
,
lim
) \

56 .
	`w‹d
 (((
lim
Ë>> 12Ë& 0xffff), ((
ba£
) & 0xffff); \

57 .
	`byã
 (((
ba£
Ë>> 16Ë& 0xff), (0x90 | (
ty≥
)), \

58 (0xC0 | (((
lim
Ë>> 28Ë& 0xf)), (((
ba£
Ë>> 24Ë& 0xff)

	)

62 
	~<defs.h
>

65 
	sg©edesc
 {

66 
	mgd_off_15_0
 : 16;

67 
	mgd_ss
 : 16;

68 
	mgd_¨gs
 : 5;

69 
	mgd_rsv1
 : 3;

70 
	mgd_ty≥
 : 4;

71 
	mgd_s
 : 1;

72 
	mgd_d∂
 : 2;

73 
	mgd_p
 : 1;

74 
	mgd_off_31_16
 : 16;

86 
	#SETGATE
(
g©e
, 
i°øp
, 
£l
, 
off
, 
d∂
) { \

87 (
g©e
).
gd_off_15_0
 = (
uöt32_t
)(
off
) & 0xffff; \

88 (
g©e
).
gd_ss
 = (
£l
); \

89 (
g©e
).
gd_¨gs
 = 0; \

90 (
g©e
).
gd_rsv1
 = 0; \

91 (
g©e
).
gd_ty≥
 = (
i°øp
Ë? 
STS_TG32
 : 
STS_IG32
; \

92 (
g©e
).
gd_s
 = 0; \

93 (
g©e
).
gd_d∂
 = (
d∂
); \

94 (
g©e
).
gd_p
 = 1; \

95 (
g©e
).
gd_off_31_16
 = (
uöt32_t
)(
off
) >> 16; \

96 }

	)

99 
	#SETCALLGATE
(
g©e
, 
ss
, 
off
, 
d∂
) { \

100 (
g©e
).
gd_off_15_0
 = (
uöt32_t
)(
off
) & 0xffff; \

101 (
g©e
).
gd_ss
 = (
ss
); \

102 (
g©e
).
gd_¨gs
 = 0; \

103 (
g©e
).
gd_rsv1
 = 0; \

104 (
g©e
).
gd_ty≥
 = 
STS_CG32
; \

105 (
g©e
).
gd_s
 = 0; \

106 (
g©e
).
gd_d∂
 = (
d∂
); \

107 (
g©e
).
gd_p
 = 1; \

108 (
g©e
).
gd_off_31_16
 = (
uöt32_t
)(
off
) >> 16; \

109 }

	)

112 
	s£gdesc
 {

113 
	msd_lim_15_0
 : 16;

114 
	msd_ba£_15_0
 : 16;

115 
	msd_ba£_23_16
 : 8;

116 
	msd_ty≥
 : 4;

117 
	msd_s
 : 1;

118 
	msd_d∂
 : 2;

119 
	msd_p
 : 1;

120 
	msd_lim_19_16
 : 4;

121 
	msd_avl
 : 1;

122 
	msd_rsv1
 : 1;

123 
	msd_db
 : 1;

124 
	msd_g
 : 1;

125 
	msd_ba£_31_24
 : 8;

128 
	#SEG_NULL
 \

129 (
£gdesc
Ë{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}

	)

131 
	#SEG
(
ty≥
, 
ba£
, 
lim
, 
d∂
) \

132 (
£gdesc
) { \

133 ((
lim
Ë>> 12Ë& 0xffff, (
uöt
)(
ba£
) & 0xffff, \

134 ((
uöt
)(
ba£
Ë>> 16Ë& 0xff, 
ty≥
, 1, 
d∂
, 1, \

135 ()(
lim
) >> 28, 0, 0, 1, 1, \

136 (Ë(
ba£
) >> 24 \

137 }

	)

139 
	#SEGTSS
(
ty≥
, 
ba£
, 
lim
, 
d∂
) \

140 (
£gdesc
) { \

141 (
lim
Ë& 0xffff, (
uöt
)(
ba£
) & 0xffff, \

142 ((
uöt
)(
ba£
Ë>> 16Ë& 0xff, 
ty≥
, 0, 
d∂
, 1, \

143 (Ë(
lim
) >> 16, 0, 0, 1, 0, \

144 (Ë(
ba£
) >> 24 \

145 }

	)

148 
	sèsk°©e
 {

149 
uöt32_t
 
	mts_lök
;

150 
uöçå_t
 
	mts_e•0
;

151 
uöt16_t
 
	mts_ss0
;

152 
uöt16_t
 
	mts_∑ddög1
;

153 
uöçå_t
 
	mts_e•1
;

154 
uöt16_t
 
	mts_ss1
;

155 
uöt16_t
 
	mts_∑ddög2
;

156 
uöçå_t
 
	mts_e•2
;

157 
uöt16_t
 
	mts_ss2
;

158 
uöt16_t
 
	mts_∑ddög3
;

159 
uöçå_t
 
	mts_¸3
;

160 
uöçå_t
 
	mts_eù
;

161 
uöt32_t
 
	mts_eÊags
;

162 
uöt32_t
 
	mts_óx
;

163 
uöt32_t
 
	mts_ecx
;

164 
uöt32_t
 
	mts_edx
;

165 
uöt32_t
 
	mts_ebx
;

166 
uöçå_t
 
	mts_e•
;

167 
uöçå_t
 
	mts_ebp
;

168 
uöt32_t
 
	mts_esi
;

169 
uöt32_t
 
	mts_edi
;

170 
uöt16_t
 
	mts_es
;

171 
uöt16_t
 
	mts_∑ddög4
;

172 
uöt16_t
 
	mts_cs
;

173 
uöt16_t
 
	mts_∑ddög5
;

174 
uöt16_t
 
	mts_ss
;

175 
uöt16_t
 
	mts_∑ddög6
;

176 
uöt16_t
 
	mts_ds
;

177 
uöt16_t
 
	mts_∑ddög7
;

178 
uöt16_t
 
	mts_fs
;

179 
uöt16_t
 
	mts_∑ddög8
;

180 
uöt16_t
 
	mts_gs
;

181 
uöt16_t
 
	mts_∑ddög9
;

182 
uöt16_t
 
	mts_ldt
;

183 
uöt16_t
 
	mts_∑ddög10
;

184 
uöt16_t
 
	mts_t
;

185 
uöt16_t
 
	mts_iomb
;

186 } 
__©åibuã__
((
∑cked
));

204 
	#PDX
(
œ
Ë((((
uöçå_t
)÷a)Ë>> 
PDXSHIFT
Ë& 0x3FF)

	)

207 
	#PTX
(
œ
Ë((((
uöçå_t
)÷a)Ë>> 
PTXSHIFT
Ë& 0x3FF)

	)

210 
	#PPN
(
œ
Ë(((
uöçå_t
)÷a)Ë>> 
PTXSHIFT
)

	)

213 
	#PGOFF
(
œ
Ë(((
uöçå_t
)÷a)Ë& 0xFFF)

	)

216 
	#PGADDR
(
d
, 
t
, 
o
Ë((
uöçå_t
)((dË<< 
PDXSHIFT
 | (tË<< 
PTXSHIFT
 | (o)))

	)

219 
	#PTE_ADDR
(
±e
Ë((
uöçå_t
)’ãË& ~0xFFF)

	)

220 
	#PDE_ADDR
(
pde
Ë
	`PTE_ADDR
’de)

	)

223 
	#NPDEENTRY
 1024

224 
	#NPTEENTRY
 1024

225 

	)

226 
	#PGSIZE
 4096

227 
	#PGSHIFT
 12

228 
	#PTSIZE
 (
PGSIZE
 * 
NPTEENTRY
)

229 
	#PTSHIFT
 22

230 

	)

231 
	#PTXSHIFT
 12

232 
	#PDXSHIFT
 22

233 

	)

235 
	#PTE_P
 0x001

236 
	#PTE_W
 0x002

237 
	#PTE_U
 0x004

238 
	#PTE_PWT
 0x008

239 
	#PTE_PCD
 0x010

240 
	#PTE_A
 0x020

241 
	#PTE_D
 0x040

242 
	#PTE_PS
 0x080

243 
	#PTE_MBZ
 0x180

244 
	#PTE_AVAIL
 0xE00

247 

	)

248 
	#PTE_USER
 (
PTE_U
 | 
PTE_W
 | 
PTE_P
)

	)

251 
	#CR0_PE
 0x00000001

252 
	#CR0_MP
 0x00000002

253 
	#CR0_EM
 0x00000004

254 
	#CR0_TS
 0x00000008

255 
	#CR0_ET
 0x00000010

256 
	#CR0_NE
 0x00000020

257 
	#CR0_WP
 0x00010000

258 
	#CR0_AM
 0x00040000

259 
	#CR0_NW
 0x20000000

260 
	#CR0_CD
 0x40000000

261 
	#CR0_PG
 0x80000000

262 

	)

263 
	#CR4_PCE
 0x00000100

264 
	#CR4_MCE
 0x00000040

265 
	#CR4_PSE
 0x00000010

266 
	#CR4_DE
 0x00000008

267 
	#CR4_TSD
 0x00000004

268 
	#CR4_PVI
 0x00000002

269 
	#CR4_VME
 0x00000001

270 

	)

	@kern/mm/pmm.c

1 
	~<defs.h
>

2 
	~<x86.h
>

3 
	~<°dio.h
>

4 
	~<°rög.h
>

5 
	~<mmu.h
>

6 
	~<memœyout.h
>

7 
	~<pmm.h
>

8 
	~<deÁu…_pmm.h
>

9 
	~<sync.h
>

10 
	~<îr‹.h
>

11 
	~<sw≠.h
>

12 
	~<vmm.h
>

13 
	~<kmÆloc.h
>

14 
	~<œpic.h
>

16 
	#NELEM
(
x
Ë((x)/((x)[0]))

	)

37 
èsk°©e
 
	gts
 = {0};

41 
Page
 *
	g∑ges
;

43 
size_t
 
	g≈age
 = 0;

46 
pde_t
 *
boŸ_pgdú
 = 
NULL
;

48 
uöçå_t
 
	gboŸ_¸3
;

51 c⁄° 
pmm_m™agî
 *
	gpmm_m™agî
;

66 
±e_t
 * c⁄° 
	gv±
 = (±e_à*)
VPT
;

67 
pde_t
 * c⁄° 
	gvpd
 = (pde_à*)
PGADDR
(
PDX
(
VPT
), PDX(VPT), 0);

82 
£gdesc
 
	ggdt
[] = {

83 
SEG_NULL
,

84 [
SEG_KTEXT
] = 
SEG
(
STA_X
 | 
STA_R
, 0x0, 0xFFFFFFFF, 
DPL_KERNEL
),

85 [
SEG_KDATA
] = 
SEG
(
STA_W
, 0x0, 0xFFFFFFFF, 
DPL_KERNEL
),

86 [
SEG_UTEXT
] = 
SEG
(
STA_X
 | 
STA_R
, 0x0, 0xFFFFFFFF, 
DPL_USER
),

87 [
SEG_UDATA
] = 
SEG
(
STA_W
, 0x0, 0xFFFFFFFF, 
DPL_USER
),

88 [
SEG_KCPU
] = 
SEG_NULL
,

89 [
SEG_TSS
] = 
SEG_NULL
,

92 
p£udodesc
 
	ggdt_pd
 = {

93 (
gdt
Ë- 1, (
uöçå_t
)gdt

96 
check_Æloc_∑ge
();

97 
check_pgdú
();

98 
check_boŸ_pgdú
();

104 
ölöe
 

105 
	$lgdt
(
p£udodesc
 *
pd
) {

106 
asm
 vﬁ©ûê("lgdà(%0)" :: "r" (
pd
));

107 
asm
 vﬁ©ûê("movw %%ax, %%gs" :: "a" (
USER_DS
));

108 
asm
 vﬁ©ûê("movw %%ax, %%fs" :: "a" (
USER_DS
));

109 
asm
 vﬁ©ûê("movw %%ax, %%es" :: "a" (
KERNEL_DS
));

110 
asm
 vﬁ©ûê("movw %%ax, %%ds" :: "a" (
KERNEL_DS
));

111 
asm
 vﬁ©ûê("movw %%ax, %%ss" :: "a" (
KERNEL_DS
));

113 
asm
 vﬁ©ûê("ljm∞%0, $1f\¿1:\n" :: "i" (
KERNEL_CS
));

114 
	}
}

122 
	$lﬂd_e•0
(
uöçå_t
 
e•0
) {

123 
ts
.
ts_e•0
 = 
e•0
;

124 
	}
}

129 
	$gdt_öô
() {

131 
˝u
 *
c
;

133 
	`lﬂd_e•0
((
uöçå_t
)
boŸ°ackt›
);

134 
ts
.
ts_ss0
 = 
KERNEL_DS
;

137 
c
 = &
˝us
[
	`˝unum
()];

138 
	`˝rötf
("˝uÇum%d \n",
	`˝unum
());

141 
c
->
gdt
[
SEG_KTEXT
] = 
	`SEG
(
STA_X
|
STA_R
, 0, 0xffffffff, 0);

142 
c
->
gdt
[
SEG_KDATA
] = 
	`SEG
(
STA_W
, 0, 0xffffffff, 0);

143 
c
->
gdt
[
SEG_UTEXT
] = 
	`SEG
(
STA_X
|
STA_R
, 0, 0xffffffff, 
DPL_USER
);

144 
c
->
gdt
[
SEG_UDATA
] = 
	`SEG
(
STA_W
, 0, 0xffffffff, 
DPL_USER
);

145 
c
->
gdt
[
SEG_KCPU
] = 
	`SEG
(
STA_W
, &c->
˝u
, 8, 0);

147 
gdt
[
SEG_TSS
] = 
	`SEGTSS
(
STS_T32A
, (
uöçå_t
)&
ts
, —s), 
DPL_KERNEL
);

148 
c
->
gdt
[
SEG_TSS
] = gdt[SEG_TSS];

149 
gdt
[
SEG_KCPU
] = 
	`SEG
(
STA_W
, &
c
->
˝u
, 8, 0);

151 
	`lgdt
(&
gdt_pd
);

154 
	`…r
(
GD_TSS
);

155 
	`lﬂdgs
(
SEG_KCPU
 << 3);

156 
˝u
 =
c
 ;

157 
	}
}

161 
	$öô_pmm_m™agî
() {

162 
pmm_m™agî
 = &
deÁu…_pmm_m™agî
;

163 
	`˝rötf
("mem‹y m™agemít: %s\n", 
pmm_m™agî
->
«me
);

164 
pmm_m™agî
->
	`öô
();

165 
	}
}

169 
	$öô_memm≠
(
Page
 *
ba£
, 
size_t
 
n
) {

170 
pmm_m™agî
->
	`öô_memm≠
(
ba£
, 
n
);

171 
	}
}

174 
Page
 *

175 
	$Æloc_∑ges
(
size_t
 
n
) {

176 
Page
 *
∑ge
=
NULL
;

177 
boﬁ
 
öå_Êag
;

181 
	`loˇl_öå_ßve
(
öå_Êag
);

183 
∑ge
 = 
pmm_m™agî
->
	`Æloc_∑ges
(
n
);

185 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

187 i‡(
∑ge
 !
NULL
 || 
n
 > 1 || 
sw≠_öô_ok
 == 0) ;

189 
mm_°ru˘
 *
check_mm_°ru˘
;

191 
	`sw≠_out
(
check_mm_°ru˘
, 
n
, 0);

194  
∑ge
;

195 
	}
}

199 
	$‰ì_∑ges
(
Page
 *
ba£
, 
size_t
 
n
) {

200 
boﬁ
 
öå_Êag
;

201 
	`loˇl_öå_ßve
(
öå_Êag
);

203 
pmm_m™agî
->
	`‰ì_∑ges
(
ba£
, 
n
);

205 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

206 
	}
}

210 
size_t


211 
	$ƒ_‰ì_∑ges
() {

212 
size_t
 
ªt
;

213 
boﬁ
 
öå_Êag
;

214 
	`loˇl_öå_ßve
(
öå_Êag
);

216 
ªt
 = 
pmm_m™agî
->
	`ƒ_‰ì_∑ges
();

218 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

219  
ªt
;

220 
	}
}

222 
uöt
 
d©a
;

224 
	skm≠
 {

225 *
	mvút
;

226 
uöt
 
	mphys_°¨t
;

227 
uöt
 
	mphys_íd
;

228 
	m≥rm
;

229 } 
	gkm≠
[] = {

233 { (*)
KERNBASE
, 0, 
KMEMSIZE
,
PTE_W
},

234 { (*)
DEVSPACE
, DEVSPACE, 0, 
PTE_W
},

242 
	$∑ge_öô
() {

243 
e820m≠
 *
memm≠
 = (e820m≠ *)(0x8000 + 
KERNBASE
);

244 
uöt64_t
 
max∑
 = 0;

246 
	`˝rötf
("e820map:\n");

247 
i
;

248 
i
 = 0; i < 
memm≠
->
ƒ_m≠
; i ++) {

249 
uöt64_t
 
begö
 = 
memm≠
->
m≠
[
i
].
addr
, 
íd
 = begö + memm≠->m≠[i].
size
;

250 
	`˝rötf
(" memory: %08llx, [%08llx, %08llx],Åype = %d.\n",

251 
memm≠
->
m≠
[
i
].
size
, 
begö
, 
íd
 - 1, memm≠->m≠[i].
ty≥
);

252 i‡(
memm≠
->
m≠
[
i
].
ty≥
 =
E820_ARM
) {

253 i‡(
max∑
 < 
íd
 && 
begö
 < 
KMEMSIZE
) {

254 
max∑
 = 
íd
;

258 i‡(
max∑
 > 
KMEMSIZE
) {

259 
max∑
 = 
KMEMSIZE
;

262 
íd
[];

264 
≈age
 = 
max∑
 / 
PGSIZE
;

265 
∑ges
 = (
Page
 *)
	`ROUNDUP
((*)
íd
, 
PGSIZE
);

267 
i
 = 0; i < 
≈age
; i ++) {

268 
	`SëPageRe£rved
(
∑ges
 + 
i
);

271 
uöçå_t
 
‰ìmem
 = 
	`PADDR
((uöçå_t)
∑ges
 + (
Page
Ë* 
≈age
);

273 
i
 = 0; i < 
memm≠
->
ƒ_m≠
; i ++) {

274 
uöt64_t
 
begö
 = 
memm≠
->
m≠
[
i
].
addr
, 
íd
 = begö + memm≠->m≠[i].
size
;

275 i‡(
memm≠
->
m≠
[
i
].
ty≥
 =
E820_ARM
) {

276 i‡(
begö
 < 
‰ìmem
) {

277 
begö
 = 
‰ìmem
;

279 i‡(
íd
 > 
KMEMSIZE
) {

280 
íd
 = 
KMEMSIZE
;

282 i‡(
begö
 < 
íd
) {

283 
begö
 = 
	`ROUNDUP
(begö, 
PGSIZE
);

284 
íd
 = 
	`ROUNDDOWN
”nd, 
PGSIZE
);

285 i‡(
begö
 < 
íd
) {

286 
	`öô_memm≠
(
	`∑2∑ge
(
begö
), (
íd
 - begöË/ 
PGSIZE
);

291 
	}
}

295 
	$íabÀ_∑gög
() {

296 
	`l¸3
((
boŸ_¸3
));

298 
uöt32_t
 
¸0
 = 
	`r¸0
();

299 
¸0
 |
CR0_PE
 | 
CR0_PG
 | 
CR0_AM
 | 
CR0_WP
 | 
CR0_NE
 | 
CR0_TS
 | 
CR0_EM
 | 
CR0_MP
;

300 
¸0
 &~(
CR0_TS
 | 
CR0_EM
);

302 
	`l¸0
(
¸0
);

303 
	}
}

312 
	$boŸ_m≠_£gmít
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
, 
size_t
 
size
, uöçå_à
∑
, 
uöt32_t
 
≥rm
) {

313 
	`as£π
(
	`PGOFF
(
œ
Ë=PGOFF(
∑
));

314 
size_t
 
n
 = 
	`ROUNDUP
(
size
 + 
	`PGOFF
(
œ
), 
PGSIZE
) / PGSIZE;

315 
œ
 = 
	`ROUNDDOWN
÷a, 
PGSIZE
);

316 
∑
 = 
	`ROUNDDOWN
’a, 
PGSIZE
);

317 ; 
n
 > 0;Ç --, 
œ
 +
PGSIZE
, 
∑
 += PGSIZE) {

318 
±e_t
 *
±ï
 = 
	`gë_±e
(
pgdú
, 
œ
, 1);

319 
	`as£π
(
±ï
 !
NULL
);

320 *
±ï
 = 
∑
 | 
PTE_P
 | 
≥rm
;

322 
	}
}

328 
	$boŸ_Æloc_∑ge
() {

329 
Page
 *
p
 = 
	`Æloc_∑ge
();

330 i‡(
p
 =
NULL
) {

331 
	`∑nic
("boot_alloc_page failed.\n");

333  
	`∑ge2kva
(
p
);

334 
	}
}

340 
	$pmm_öô
() {

346 
	`öô_pmm_m™agî
();

348 
km≠
 *
k
 = kmap;

351 
	`∑ge_öô
();

354 
	`check_Æloc_∑ge
();

357 
boŸ_pgdú
 = 
	`boŸ_Æloc_∑ge
();

358 
	`mem£t
(
boŸ_pgdú
, 0, 
PGSIZE
);

359 
boŸ_¸3
 = 
	`PADDR
(
boŸ_pgdú
);

361 
	`check_pgdú
();

363 
	`°©ic_as£π
(
KERNBASE
 % 
PTSIZE
 =0 && 
KERNTOP
 % PTSIZE == 0);

367 
boŸ_pgdú
[
	`PDX
(
VPT
)] = 
	`PADDR
(boŸ_pgdúË| 
PTE_P
 | 
PTE_W
;

375 
k
 = 
km≠
; k < &km≠[
	`NELEM
(kmap)]; k++)

376 
	`boŸ_m≠_£gmít
(
boŸ_pgdú
, 
k
->
vút
, k->
phys_íd
 - k->
phys_°¨t
, (
uöt
)k->phys_°¨t, 
PTE_W
);

382 
boŸ_pgdú
[0] = boŸ_pgdú[
	`PDX
(
KERNBASE
)];

384 
	`íabÀ_∑gög
();

389 
	`gdt_öô
();

392 
boŸ_pgdú
[0] = 0;

396 
	`check_boŸ_pgdú
();

398 
	`¥öt_pgdú
();

400 
	`kmÆloc_öô
();

401 
	`˝rötf
("boŸ_¸3 = %lx\n",
boŸ_¸3
);

403 
	}
}

406 
	$pmm_öô2
()

408 
boŸ_pgdú
[0] = boŸ_pgdú[
	`PDX
(
KERNBASE
)];

409 
	`˝rötf
("boŸ_¸3 = %lx\n",
boŸ_¸3
);

410 
	`l¸3
(
boŸ_¸3
);

412 
uöt32_t
 
¸0
 = 
	`r¸0
();

413 
¸0
 |
CR0_PE
 | 
CR0_PG
 | 
CR0_AM
 | 
CR0_WP
 | 
CR0_NE
 | 
CR0_TS
 | 
CR0_EM
 | 
CR0_MP
;

414 
¸0
 &~(
CR0_TS
 | 
CR0_EM
);

416 
	`l¸0
(
¸0
);

417 
	`˝rötf
("ok \n");

419 
	`gdt_öô
();

420 
boŸ_pgdú
[0] = 0;

422 
	}
}

434 
±e_t
 *

435 
	$gë_±e
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
, 
boﬁ
 
¸óã
) {

458 
pde_t
 *
pdï
 = 
NULL
;

463 
uöçå_t
 
∑
 = 0;

467  
NULL
;

469 
pde_t
 *
pdï
 = &
pgdú
[
	`PDX
(
œ
)];

470 i‡(!(*
pdï
 & 
PTE_P
)) {

471 
Page
 *
∑ge
;

472 i‡(!
¸óã
 || (
∑ge
 = 
	`Æloc_∑ge
()Ë=
NULL
) {

473  
NULL
;

475 
	`£t_∑ge_ªf
(
∑ge
, 1);

476 
uöçå_t
 
∑
 = 
	`∑ge2∑
(
∑ge
);

477 
	`mem£t
(
	`KADDR
(
∑
), 0, 
PGSIZE
);

478 *
pdï
 = 
∑
 | 
PTE_U
 | 
PTE_W
 | 
PTE_P
;

480  &((
±e_t
 *)
	`KADDR
(
	`PDE_ADDR
(*
pdï
)))[
	`PTX
(
œ
)];

481 
	}
}

484 
Page
 *

485 
	$gë_∑ge
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
, 
±e_t
 **
±ï_°‹e
) {

486 
±e_t
 *
±ï
 = 
	`gë_±e
(
pgdú
, 
œ
, 0);

487 i‡(
±ï_°‹e
 !
NULL
) {

488 *
±ï_°‹e
 = 
±ï
;

490 i‡(
±ï
 !
NULL
 && *±ï & 
PTE_P
) {

491  
	`∑2∑ge
(*
±ï
);

493  
NULL
;

494 
	}
}

499 
ölöe
 

500 
	$∑ge_ªmove_±e
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
, 
±e_t
 *
±ï
) {

519 
Page
 *
∑ge
 = 
NULL
;

526 i‡(*
±ï
 & 
PTE_P
) {

527 
Page
 *
∑ge
 = 
	`±e2∑ge
(*
±ï
);

528 i‡(
	`∑ge_ªf_dec
(
∑ge
) == 0) {

529 
	`‰ì_∑ge
(
∑ge
);

531 *
±ï
 = 0;

532 
	`éb_övÆid©e
(
pgdú
, 
œ
);

534 
	}
}

537 
	$unm≠_ønge
(
pde_t
 *
pgdú
, 
uöçå_t
 
°¨t
, uöçå_à
íd
) {

538 
	`as£π
(
°¨t
 % 
PGSIZE
 =0 && 
íd
 % PGSIZE == 0);

539 
	`as£π
(
	`USER_ACCESS
(
°¨t
, 
íd
));

542 
±e_t
 *
±ï
 = 
	`gë_±e
(
pgdú
, 
°¨t
, 0);

543 i‡(
±ï
 =
NULL
) {

544 
°¨t
 = 
	`ROUNDDOWN
(°¨à+ 
PTSIZE
, PTSIZE);

547 i‡(*
±ï
 != 0) {

548 
	`∑ge_ªmove_±e
(
pgdú
, 
°¨t
, 
±ï
);

550 
°¨t
 +
PGSIZE
;

551 } 
°¨t
 !0 && sèπ < 
íd
);

552 
	}
}

555 
	$exô_ønge
(
pde_t
 *
pgdú
, 
uöçå_t
 
°¨t
, uöçå_à
íd
) {

556 
	`as£π
(
°¨t
 % 
PGSIZE
 =0 && 
íd
 % PGSIZE == 0);

557 
	`as£π
(
	`USER_ACCESS
(
°¨t
, 
íd
));

559 
°¨t
 = 
	`ROUNDDOWN
(°¨t, 
PTSIZE
);

561 
pde_idx
 = 
	`PDX
(
°¨t
);

562 i‡(
pgdú
[
pde_idx
] & 
PTE_P
) {

563 
	`‰ì_∑ge
(
	`pde2∑ge
(
pgdú
[
pde_idx
]));

564 
pgdú
[
pde_idx
] = 0;

566 
°¨t
 +
PTSIZE
;

567 } 
°¨t
 !0 && sèπ < 
íd
);

568 
	}
}

577 
	$c›y_ønge
(
pde_t
 *
to
,Öde_à*
‰om
, 
uöçå_t
 
°¨t
, uöçå_à
íd
, 
boﬁ
 
sh¨e
) {

578 
	`as£π
(
°¨t
 % 
PGSIZE
 =0 && 
íd
 % PGSIZE == 0);

579 
	`as£π
(
	`USER_ACCESS
(
°¨t
, 
íd
));

583 
±e_t
 *
±ï
 = 
	`gë_±e
(
‰om
, 
°¨t
, 0), *
≈ãp
;

584 i‡(
±ï
 =
NULL
) {

585 
°¨t
 = 
	`ROUNDDOWN
(°¨à+ 
PTSIZE
, PTSIZE);

589 i‡(*
±ï
 & 
PTE_P
) {

590 i‡((
≈ãp
 = 
	`gë_±e
(
to
, 
°¨t
, 1)Ë=
NULL
) {

591  -
E_NO_MEM
;

593 
uöt32_t
 
≥rm
 = (*
±ï
 & 
PTE_USER
);

595 
Page
 *
∑ge
 = 
	`±e2∑ge
(*
±ï
);

597 
Page
 *
≈age
=
	`Æloc_∑ge
();

598 
	`as£π
(
∑ge
!=
NULL
);

599 
	`as£π
(
≈age
!=
NULL
);

600 
ªt
=0;

615 * 
kva_§c
 = 
	`∑ge2kva
(
∑ge
);

616 * 
kva_d°
 = 
	`∑ge2kva
(
≈age
);

618 
	`mem˝y
(
kva_d°
, 
kva_§c
, 
PGSIZE
);

620 
ªt
 = 
	`∑ge_ö£π
(
to
, 
≈age
, 
°¨t
, 
≥rm
);

621 
	`as£π
(
ªt
 == 0);

623 
°¨t
 +
PGSIZE
;

624 } 
°¨t
 !0 && sèπ < 
íd
);

626 
	}
}

630 
	$∑ge_ªmove
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
) {

631 
±e_t
 *
±ï
 = 
	`gë_±e
(
pgdú
, 
œ
, 0);

632 i‡(
±ï
 !
NULL
) {

633 
	`∑ge_ªmove_±e
(
pgdú
, 
œ
, 
±ï
);

635 
	}
}

646 
	$∑ge_ö£π
(
pde_t
 *
pgdú
, 
Page
 *
∑ge
, 
uöçå_t
 
œ
, 
uöt32_t
 
≥rm
) {

647 
±e_t
 *
±ï
 = 
	`gë_±e
(
pgdú
, 
œ
, 1);

648 i‡(
±ï
 =
NULL
) {

649  -
E_NO_MEM
;

651 
	`∑ge_ªf_öc
(
∑ge
);

652 i‡(*
±ï
 & 
PTE_P
) {

653 
Page
 *
p
 = 
	`±e2∑ge
(*
±ï
);

654 i‡(
p
 =
∑ge
) {

655 
	`∑ge_ªf_dec
(
∑ge
);

658 
	`∑ge_ªmove_±e
(
pgdú
, 
œ
, 
±ï
);

661 *
±ï
 = 
	`∑ge2∑
(
∑ge
Ë| 
PTE_P
 | 
≥rm
;

662 
	`éb_övÆid©e
(
pgdú
, 
œ
);

664 
	}
}

669 
	$éb_övÆid©e
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
) {

670 i‡(
	`r¸3
(Ë=
	`PADDR
(
pgdú
)) {

671 
	`övÕg
((*)
œ
);

673 
	}
}

678 
Page
 *

679 
	$pgdú_Æloc_∑ge
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
, 
uöt32_t
 
≥rm
) {

680 
Page
 *
∑ge
 = 
	`Æloc_∑ge
();

681 i‡(
∑ge
 !
NULL
) {

682 i‡(
	`∑ge_ö£π
(
pgdú
, 
∑ge
, 
œ
, 
≥rm
) != 0) {

683 
	`‰ì_∑ge
(
∑ge
);

684  
NULL
;

686 i‡(
sw≠_öô_ok
){

687 if(
check_mm_°ru˘
!=
NULL
) {

688 
	`sw≠_m≠_sw≠∑bÀ
(
check_mm_°ru˘
, 
œ
, 
∑ge
, 0);

689 
∑ge
->
¥a_vaddr
=
œ
;

690 
	`as£π
(
	`∑ge_ªf
(
∑ge
) == 1);

703  
∑ge
;

704 
	}
}

707 
	$check_Æloc_∑ge
() {

708 
pmm_m™agî
->
	`check
();

709 
	`˝rötf
("check_alloc_page() succeeded!\n");

710 
	}
}

713 
	$check_pgdú
() {

714 
	`as£π
(
≈age
 <
KMEMSIZE
 / 
PGSIZE
);

715 
	`as£π
(
boŸ_pgdú
 !
NULL
 && (
uöt32_t
)
	`PGOFF
(boot_pgdir) == 0);

716 
	`as£π
(
	`gë_∑ge
(
boŸ_pgdú
, 0x0, 
NULL
) == NULL);

718 
Page
 *
p1
, *
p2
;

719 
p1
 = 
	`Æloc_∑ge
();

720 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
p1
, 0x0, 0) == 0);

722 
±e_t
 *
±ï
;

723 
	`as£π
((
±ï
 = 
	`gë_±e
(
boŸ_pgdú
, 0x0, 0)Ë!
NULL
);

724 
	`as£π
(
	`∑2∑ge
(*
±ï
Ë=
p1
);

725 
	`as£π
(
	`∑ge_ªf
(
p1
) == 1);

727 
±ï
 = &((
±e_t
 *)
	`KADDR
(
	`PDE_ADDR
(
boŸ_pgdú
[0])))[1];

728 
	`as£π
(
	`gë_±e
(
boŸ_pgdú
, 
PGSIZE
, 0Ë=
±ï
);

730 
p2
 = 
	`Æloc_∑ge
();

731 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
p2
, 
PGSIZE
, 
PTE_U
 | 
PTE_W
) == 0);

732 
	`as£π
((
±ï
 = 
	`gë_±e
(
boŸ_pgdú
, 
PGSIZE
, 0)Ë!
NULL
);

733 
	`as£π
(*
±ï
 & 
PTE_U
);

734 
	`as£π
(*
±ï
 & 
PTE_W
);

735 
	`as£π
(
boŸ_pgdú
[0] & 
PTE_U
);

736 
	`as£π
(
	`∑ge_ªf
(
p2
) == 1);

738 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
p1
, 
PGSIZE
, 0) == 0);

739 
	`as£π
(
	`∑ge_ªf
(
p1
) == 2);

740 
	`as£π
(
	`∑ge_ªf
(
p2
) == 0);

741 
	`as£π
((
±ï
 = 
	`gë_±e
(
boŸ_pgdú
, 
PGSIZE
, 0)Ë!
NULL
);

742 
	`as£π
(
	`∑2∑ge
(*
±ï
Ë=
p1
);

743 
	`as£π
((*
±ï
 & 
PTE_U
) == 0);

745 
	`∑ge_ªmove
(
boŸ_pgdú
, 0x0);

746 
	`as£π
(
	`∑ge_ªf
(
p1
) == 1);

747 
	`as£π
(
	`∑ge_ªf
(
p2
) == 0);

749 
	`∑ge_ªmove
(
boŸ_pgdú
, 
PGSIZE
);

750 
	`as£π
(
	`∑ge_ªf
(
p1
) == 0);

751 
	`as£π
(
	`∑ge_ªf
(
p2
) == 0);

753 
	`as£π
(
	`∑ge_ªf
(
	`∑2∑ge
(
boŸ_pgdú
[0])) == 1);

754 
	`‰ì_∑ge
(
	`∑2∑ge
(
boŸ_pgdú
[0]));

755 
boŸ_pgdú
[0] = 0;

757 
	`˝rötf
("check_pgdir() succeeded!\n");

758 
	}
}

761 
	$check_boŸ_pgdú
() {

762 
±e_t
 *
±ï
;

763 
i
;

764 
i
 = 0; i < 
≈age
; i +
PGSIZE
) {

765 
	`as£π
((
±ï
 = 
	`gë_±e
(
boŸ_pgdú
, (
uöçå_t
)
	`KADDR
(
i
), 0)Ë!
NULL
);

766 
	`as£π
(
	`PTE_ADDR
(*
±ï
Ë=
i
);

769 
	`as£π
(
	`PDE_ADDR
(
boŸ_pgdú
[
	`PDX
(
VPT
)]Ë=
	`PADDR
(boot_pgdir));

771 
	`as£π
(
boŸ_pgdú
[0] == 0);

773 
Page
 *
p
;

774 
p
 = 
	`Æloc_∑ge
();

775 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
p
, 0x100, 
PTE_W
) == 0);

776 
	`as£π
(
	`∑ge_ªf
(
p
) == 1);

777 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
p
, 0x100 + 
PGSIZE
, 
PTE_W
) == 0);

778 
	`as£π
(
	`∑ge_ªf
(
p
) == 2);

780 c⁄° *
°r
 = "ucore: Hello world!!";

781 
	`°r˝y
((*)0x100, 
°r
);

782 
	`as£π
(
	`°rcmp
((*)0x100, (*)(0x100 + 
PGSIZE
)) == 0);

784 *(*)(
	`∑ge2kva
(
p
) + 0x100) = '\0';

785 
	`as£π
(
	`°æí
((const *)0x100) == 0);

787 
	`‰ì_∑ge
(
p
);

788 
	`‰ì_∑ge
(
	`∑2∑ge
(
	`PDE_ADDR
(
boŸ_pgdú
[0])));

789 
boŸ_pgdú
[0] = 0;

791 
	`˝rötf
("check_boot_pgdir() succeeded!\n");

792 
	}
}

796 
	$≥rm2°r
(
≥rm
) {

797 
°r
[4];

798 
°r
[0] = (
≥rm
 & 
PTE_U
) ? 'u' : '-';

799 
°r
[1] = 'r';

800 
°r
[2] = (
≥rm
 & 
PTE_W
) ? 'w' : '-';

801 
°r
[3] = '\0';

802  
°r
;

803 
	}
}

817 
	$gë_pgèbÀ_ôems
(
size_t
 
À·
, size_à
right
, size_à
°¨t
, 
uöçå_t
 *
èbÀ
, size_à*
À·_°‹e
, size_à*
right_°‹e
) {

818 i‡(
°¨t
 >
right
) {

821 
°¨t
 < 
right
 && !(
èbÀ
[°¨t] & 
PTE_P
)) {

822 
°¨t
 ++;

824 i‡(
°¨t
 < 
right
) {

825 i‡(
À·_°‹e
 !
NULL
) {

826 *
À·_°‹e
 = 
°¨t
;

828 
≥rm
 = (
èbÀ
[
°¨t
 ++] & 
PTE_USER
);

829 
°¨t
 < 
right
 && (
èbÀ
[°¨t] & 
PTE_USER
Ë=
≥rm
) {

830 
°¨t
 ++;

832 i‡(
right_°‹e
 !
NULL
) {

833 *
right_°‹e
 = 
°¨t
;

835  
≥rm
;

838 
	}
}

842 
	$¥öt_pgdú
() {

843 
	`˝rötf
("-------------------- BEGIN --------------------\n");

844 
size_t
 
À·
, 
right
 = 0, 
≥rm
;

845 (
≥rm
 = 
	`gë_pgèbÀ_ôems
(0, 
NPDEENTRY
, 
right
, 
vpd
, &
À·
, &right)) != 0) {

846 
	`˝rötf
("PDE(%03xË%08x-%08x %08x %s\n", 
right
 - 
À·
,

847 
À·
 * 
PTSIZE
, 
right
 * PTSIZE, (righà-Üe·Ë* PTSIZE, 
	`≥rm2°r
(
≥rm
));

848 
size_t
 
l
, 
r
 = 
À·
 * 
NPTEENTRY
;

849 (
≥rm
 = 
	`gë_pgèbÀ_ôems
(
À·
 * 
NPTEENTRY
, 
right
 * NPTEENTRY, 
r
, 
v±
, &
l
, &r)) != 0) {

850 
	`˝rötf
(" |-- PTE(%05xË%08x-%08x %08x %s\n", 
r
 - 
l
,

851 
l
 * 
PGSIZE
, 
r
 * PGSIZE, (∏-ÜË* PGSIZE, 
	`≥rm2°r
(
≥rm
));

854 
	`˝rötf
("--------------------- END ---------------------\n");

855 
	}
}

	@kern/mm/pmm.h

1 #i‚de‡
__KERN_MM_PMM_H__


2 
	#__KERN_MM_PMM_H__


	)

4 
	~<defs.h
>

5 
	~<mmu.h
>

6 
	~<memœyout.h
>

7 
	~<©omic.h
>

8 
	~<as£π.h
>

13 
	spmm_m™agî
 {

14 c⁄° *
	m«me
;

15 (*
	möô
)();

17 (*
	möô_memm≠
)(
Page
 *
	mba£
, 
size_t
 
	mn
);

19 
	mPage
 *(*
	mÆloc_∑ges
)(
size_t
 
	mn
);

20 (*
	m‰ì_∑ges
)(
Page
 *
	mba£
, 
size_t
 
	mn
);

21 
size_t
 (*
ƒ_‰ì_∑ges
)();

22 (*
	mcheck
)();

25 c⁄° 
pmm_m™agî
 *pmm_manager;

26 
pde_t
 *
boŸ_pgdú
;

27 
uöçå_t
 
boŸ_¸3
;

29 
pmm_öô
();

31 
Page
 *
Æloc_∑ges
(
size_t
 
n
);

32 
‰ì_∑ges
(
Page
 *
ba£
, 
size_t
 
n
);

33 
size_t
 
ƒ_‰ì_∑ges
();

35 
	#Æloc_∑ge
(Ë
	`Æloc_∑ges
(1)

	)

36 
	#‰ì_∑ge
(
∑ge
Ë
	`‰ì_∑ges
’age, 1)

	)

38 
±e_t
 *
gë_±e
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
, 
boﬁ
 
¸óã
);

39 
Page
 *
gë_∑ge
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
, 
±e_t
 **
±ï_°‹e
);

40 
∑ge_ªmove
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
);

41 
∑ge_ö£π
(
pde_t
 *
pgdú
, 
Page
 *
∑ge
, 
uöçå_t
 
œ
, 
uöt32_t
 
≥rm
);

43 
lﬂd_e•0
(
uöçå_t
 
e•0
);

44 
éb_övÆid©e
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
);

45 
Page
 *
pgdú_Æloc_∑ge
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
, 
uöt32_t
 
≥rm
);

46 
unm≠_ønge
(
pde_t
 *
pgdú
, 
uöçå_t
 
°¨t
, uöçå_à
íd
);

47 
exô_ønge
(
pde_t
 *
pgdú
, 
uöçå_t
 
°¨t
, uöçå_à
íd
);

48 
c›y_ønge
(
pde_t
 *
to
,Öde_à*
‰om
, 
uöçå_t
 
°¨t
, uöçå_à
íd
, 
boﬁ
 
sh¨e
);

50 
¥öt_pgdú
();

57 
	#PADDR
(
kva
) ({ \

58 
uöçå_t
 
__m_kva
 = (uöçå_t)(
kva
); \

59 i‡(
__m_kva
 < 
KERNBASE
) { \

60 
	`∑nic
("PADDR cÆÀd wôh invÆid kv®%08lx", 
__m_kva
); \

62 
__m_kva
 - 
KERNBASE
; \

63 })

	)

69 
	#KADDR
(
∑
) ({ \

70 
uöçå_t
 
__m_∑
 = (
∑
); \

71 
size_t
 
__m_µn
 = 
	`PPN
(
__m_∑
); \

72 i‡(
__m_µn
 >
≈age
) { \

73 
	`∑nic
("KADDR cÆÀd wôh invÆidÖ®%08lx", 
__m_∑
); \

75 (*Ë(
__m_∑
 + 
KERNBASE
); \

76 })

	)

78 
Page
 *
∑ges
;

79 
size_t
 
≈age
;

81 
ölöe
 
µn_t


82 
	$∑ge2µn
(
Page
 *
∑ge
) {

83  
∑ge
 - 
∑ges
;

84 
	}
}

86 
ölöe
 
uöçå_t


87 
	$∑ge2∑
(
Page
 *
∑ge
) {

88  
	`∑ge2µn
(
∑ge
Ë<< 
PGSHIFT
;

89 
	}
}

91 
ölöe
 
Page
 *

92 
	$∑2∑ge
(
uöçå_t
 
∑
) {

93 i‡(
	`PPN
(
∑
Ë>
≈age
) {

94 
	`∑nic
("pa2page called with invalidÖa");

96  &
∑ges
[
	`PPN
(
∑
)];

97 
	}
}

99 
ölöe
 *

100 
	$∑ge2kva
(
Page
 *
∑ge
) {

101  
	`KADDR
(
	`∑ge2∑
(
∑ge
));

102 
	}
}

104 
ölöe
 
Page
 *

105 
	$kva2∑ge
(*
kva
) {

106  
	`∑2∑ge
(
	`PADDR
(
kva
));

107 
	}
}

109 
ölöe
 
Page
 *

110 
	$±e2∑ge
(
±e_t
 
±e
) {

111 i‡(!(
±e
 & 
PTE_P
)) {

112 
	`∑nic
("pte2page called with invalidÖte");

114  
	`∑2∑ge
(
	`PTE_ADDR
(
±e
));

115 
	}
}

117 
ölöe
 
Page
 *

118 
	$pde2∑ge
(
pde_t
 
pde
) {

119  
	`∑2∑ge
(
	`PDE_ADDR
(
pde
));

120 
	}
}

122 
ölöe
 

123 
	$∑ge_ªf
(
Page
 *
∑ge
) {

124  
∑ge
->
ªf
;

125 
	}
}

127 
ölöe
 

128 
	$£t_∑ge_ªf
(
Page
 *
∑ge
, 
vÆ
) {

129 
∑ge
->
ªf
 = 
vÆ
;

130 
	}
}

132 
ölöe
 

133 
	$∑ge_ªf_öc
(
Page
 *
∑ge
) {

134 
∑ge
->
ªf
 += 1;

135  
∑ge
->
ªf
;

136 
	}
}

138 
ölöe
 

139 
	$∑ge_ªf_dec
(
Page
 *
∑ge
) {

140 
∑ge
->
ªf
 -= 1;

141  
∑ge
->
ªf
;

142 
	}
}

144 
boŸ°ack
[], 
boŸ°ackt›
[];

	@kern/mm/swap.c

1 
	~<sw≠.h
>

2 
	~<sw≠fs.h
>

3 
	~<sw≠_fifo.h
>

4 
	~<°dio.h
>

5 
	~<°rög.h
>

6 
	~<memœyout.h
>

7 
	~<pmm.h
>

8 
	~<mmu.h
>

9 
	~<deÁu…_pmm.h
>

10 
	~<kdebug.h
>

13 
	#CHECK_VALID_VIR_PAGE_NUM
 5

	)

14 
	#BEING_CHECK_VALID_VADDR
 0X1000

	)

15 
	#CHECK_VALID_VADDR
 (
CHECK_VALID_VIR_PAGE_NUM
+1)*0x1000

	)

17 
	#CHECK_VALID_PHY_PAGE_NUM
 4

	)

19 
	#MAX_SEQ_NO
 10

	)

21 
sw≠_m™agî
 *
	gsm
;

22 
size_t
 
	gmax_sw≠_off£t
;

24 vﬁ©ûê
	gsw≠_öô_ok
 = 0;

26 
	gsw≠_∑ge
[
CHECK_VALID_VIR_PAGE_NUM
];

28 
	gsw≠_ö_£q_no
[
MAX_SEQ_NO
],
	gsw≠_out_£q_no
[MAX_SEQ_NO];

30 
check_sw≠
();

33 
	$sw≠_öô
()

35 
	`sw≠fs_öô
();

37 i‡(!(1024 <
max_sw≠_off£t
 && max_sw≠_off£à< 
MAX_SWAP_OFFSET_LIMIT
))

39 
	`∑nic
("bad max_sw≠_off£à%08x.\n", 
max_sw≠_off£t
);

43 
sm
 = &
sw≠_m™agî_fifo
;

44 
r
 = 
sm
->
	`öô
();

46 i‡(
r
 == 0)

48 
sw≠_öô_ok
 = 1;

49 
	`˝rötf
("SWAP: m™agî = %s\n", 
sm
->
«me
);

50 
	`check_sw≠
();

53  
r
;

54 
	}
}

57 
	$sw≠_öô_mm
(
mm_°ru˘
 *
mm
)

59  
sm
->
	`öô_mm
(
mm
);

60 
	}
}

63 
	$sw≠_tick_evít
(
mm_°ru˘
 *
mm
)

65  
sm
->
	`tick_evít
(
mm
);

66 
	}
}

69 
	$sw≠_m≠_sw≠∑bÀ
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
, 
Page
 *
∑ge
, 
sw≠_ö
)

71  
sm
->
	`m≠_sw≠∑bÀ
(
mm
, 
addr
, 
∑ge
, 
sw≠_ö
);

72 
	}
}

75 
	$sw≠_£t_unsw≠∑bÀ
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
)

77  
sm
->
	`£t_unsw≠∑bÀ
(
mm
, 
addr
);

78 
	}
}

80 vﬁ©ûê
	gsw≠_out_num
=0;

83 
	$sw≠_out
(
mm_°ru˘
 *
mm
, 
n
, 
ö_tick
)

85 
i
;

86 
i
 = 0; i !
n
; ++ i)

88 
uöçå_t
 
v
;

90 
Page
 *
∑ge
;

92 
r
 = 
sm
->
	`sw≠_out_vi˘im
(
mm
, &
∑ge
, 
ö_tick
);

93 i‡(
r
 != 0) {

94 
	`˝rötf
("ò%d, sw≠_out: cÆ»sw≠_out_vi˘im faûed\n",
i
);

101 
v
=
∑ge
->
¥a_vaddr
;

102 
±e_t
 *
±ï
 = 
	`gë_±e
(
mm
->
pgdú
, 
v
, 0);

103 
	`as£π
((*
±ï
 & 
PTE_P
) != 0);

105 i‡(
	`sw≠fs_wrôe
–(
∑ge
->
¥a_vaddr
/
PGSIZE
+1)<<8,Öage) != 0) {

106 
	`˝rötf
("SWAP: failedÅo save\n");

107 
sm
->
	`m≠_sw≠∑bÀ
(
mm
, 
v
, 
∑ge
, 0);

111 
	`˝rötf
("sw≠_out: i %d, st‹ê∑gêö vadd∏0x%xÅÿdisk sw≠É¡ry %d\n", 
i
, 
v
, 
∑ge
->
¥a_vaddr
/
PGSIZE
+1);

112 *
±ï
 = (
∑ge
->
¥a_vaddr
/
PGSIZE
+1)<<8;

113 
	`‰ì_∑ge
(
∑ge
);

116 
	`éb_övÆid©e
(
mm
->
pgdú
, 
v
);

118  
i
;

119 
	}
}

122 
	$sw≠_ö
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
, 
Page
 **
±r_ªsu…
)

124 
Page
 *
ªsu…
 = 
	`Æloc_∑ge
();

125 
	`as£π
(
ªsu…
!=
NULL
);

127 
±e_t
 *
±ï
 = 
	`gë_±e
(
mm
->
pgdú
, 
addr
, 0);

130 
r
;

131 i‡((
r
 = 
	`sw≠fs_ªad
((*
±ï
), 
ªsu…
)) != 0)

133 
	`as£π
(
r
!=0);

135 
	`˝rötf
("sw≠_ö:Üﬂd disk sw≠É¡ry %d wôh sw≠_∑gêö vad∏0x%x\n", (*
±ï
)>>8, 
addr
);

136 *
±r_ªsu…
=
ªsu…
;

138 
	}
}

142 
ölöe
 

143 
	$check_c⁄ã¡_£t
()

146 
	`as£π
(
pgÁu…_num
==1);

148 
	`as£π
(
pgÁu…_num
==1);

150 
	`as£π
(
pgÁu…_num
==2);

152 
	`as£π
(
pgÁu…_num
==2);

154 
	`as£π
(
pgÁu…_num
==3);

156 
	`as£π
(
pgÁu…_num
==3);

158 
	`as£π
(
pgÁu…_num
==4);

160 
	`as£π
(
pgÁu…_num
==4);

161 
	}
}

163 
ölöe
 

164 
	$check_c⁄ã¡_ac˚ss
()

166 
ªt
 = 
sm
->
	`check_sw≠
();

167  
ªt
;

168 
	}
}

170 
Page
 * 
	gcheck_Ω
[
CHECK_VALID_PHY_PAGE_NUM
];

171 
±e_t
 * 
	gcheck_±ï
[
CHECK_VALID_PHY_PAGE_NUM
];

172 
	gcheck_sw≠_addr
[
CHECK_VALID_VIR_PAGE_NUM
];

174 
‰ì_¨ó_t
 
‰ì_¨ó
;

176 
	#‰ì_li°
 (
‰ì_¨ó
.
‰ì_li°
)

	)

177 
	#ƒ_‰ì
 (
‰ì_¨ó
.
ƒ_‰ì
)

	)

180 
	$check_sw≠
()

183 
ªt
, 
cou¡
 = 0, 
tŸÆ
 = 0, 
i
;

184 
li°_íåy_t
 *
À
 = &
‰ì_li°
;

185 (
À
 = 
	`li°_√xt
÷e)Ë!&
‰ì_li°
) {

186 
Page
 *
p
 = 
	`À2∑ge
(
À
, 
∑ge_lök
);

187 
	`as£π
(
	`PagePr›îty
(
p
));

188 
cou¡
 ++, 
tŸÆ
 +
p
->
¥›îty
;

190 
	`as£π
(
tŸÆ
 =
	`ƒ_‰ì_∑ges
());

191 
	`˝rötf
("BEGIN check_sw≠: cou¡ %d,ÅŸÆ %d\n",
cou¡
,
tŸÆ
);

194 
mm_°ru˘
 *
mm
 = 
	`mm_¸óã
();

195 
	`as£π
(
mm
 !
NULL
);

197 
mm_°ru˘
 *
check_mm_°ru˘
;

198 
	`as£π
(
check_mm_°ru˘
 =
NULL
);

200 
check_mm_°ru˘
 = 
mm
;

202 
pde_t
 *
pgdú
 = 
mm
->pgdú = 
boŸ_pgdú
;

203 
	`as£π
(
pgdú
[0] == 0);

205 
vma_°ru˘
 *
vma
 = 
	`vma_¸óã
(
BEING_CHECK_VALID_VADDR
, 
CHECK_VALID_VADDR
, 
VM_WRITE
 | 
VM_READ
);

206 
	`as£π
(
vma
 !
NULL
);

208 
	`ö£π_vma_°ru˘
(
mm
, 
vma
);

211 
	`˝rötf
("setup Page Table for vaddr 0X1000, soállocáÖage\n");

212 
±e_t
 *
ãmp_±ï
=
NULL
;

213 
ãmp_±ï
 = 
	`gë_±e
(
mm
->
pgdú
, 
BEING_CHECK_VALID_VADDR
, 1);

214 
	`as£π
(
ãmp_±ï
!
NULL
);

215 
	`˝rötf
("setup Page Table vaddr 0~4MB OVER!\n");

217 
i
=0;i<
CHECK_VALID_PHY_PAGE_NUM
;i++) {

218 
check_Ω
[
i
] = 
	`Æloc_∑ge
();

219 
	`as£π
(
check_Ω
[
i
] !
NULL
 );

220 
	`as£π
(!
	`PagePr›îty
(
check_Ω
[
i
]));

222 
li°_íåy_t
 
‰ì_li°_°‹e
 = 
‰ì_li°
;

223 
	`li°_öô
(&
‰ì_li°
);

224 
	`as£π
(
	`li°_em±y
(&
‰ì_li°
));

228 
ƒ_‰ì_°‹e
 = 
ƒ_‰ì
;

229 
ƒ_‰ì
 = 0;

230 
i
=0;i<
CHECK_VALID_PHY_PAGE_NUM
;i++) {

231 
	`‰ì_∑ges
(
check_Ω
[
i
],1);

233 
	`as£π
(
ƒ_‰ì
==
CHECK_VALID_PHY_PAGE_NUM
);

235 
	`˝rötf
("set up initÉnv for check_swap begin!\n");

239 
pgÁu…_num
=0;

241 
	`check_c⁄ã¡_£t
();

242 
	`as£π
–
ƒ_‰ì
 == 0);

243 
i
 = 0; i<
MAX_SEQ_NO
 ; i++)

244 
sw≠_out_£q_no
[
i
]=
sw≠_ö_£q_no
[i]=-1;

246 
i
0;i<
CHECK_VALID_PHY_PAGE_NUM
;i++) {

247 
check_±ï
[
i
]=0;

248 
check_±ï
[
i
] = 
	`gë_±e
(
pgdú
, (i+1)*0x1000, 0);

250 
	`as£π
(
check_±ï
[
i
] !
NULL
);

251 
	`as£π
(
	`±e2∑ge
(*
check_±ï
[
i
]Ë=
check_Ω
[i]);

252 
	`as£π
((*
check_±ï
[
i
] & 
PTE_P
));

254 
	`˝rötf
("set up initÉnv for check_swap over!\n");

256 
ªt
=
	`check_c⁄ã¡_ac˚ss
();

257 
	`as£π
(
ªt
==0);

260 
i
=0;i<
CHECK_VALID_PHY_PAGE_NUM
;i++) {

261 
	`‰ì_∑ges
(
check_Ω
[
i
],1);

265 
	`‰ì_∑ge
(
	`∑2∑ge
(
pgdú
[0]));

266 
pgdú
[0] = 0;

267 
mm
->
pgdú
 = 
NULL
;

268 
	`mm_de°roy
(
mm
);

269 
check_mm_°ru˘
 = 
NULL
;

271 
ƒ_‰ì
 = 
ƒ_‰ì_°‹e
;

272 
‰ì_li°
 = 
‰ì_li°_°‹e
;

275 
À
 = &
‰ì_li°
;

276 (
À
 = 
	`li°_√xt
÷e)Ë!&
‰ì_li°
) {

277 
Page
 *
p
 = 
	`À2∑ge
(
À
, 
∑ge_lök
);

278 
cou¡
 --, 
tŸÆ
 -
p
->
¥›îty
;

280 
	`˝rötf
("cou¡ i†%d,ÅŸÆ i†%d\n",
cou¡
,
tŸÆ
);

283 
	`˝rötf
("check_swap() succeeded!\n");

284 
	}
}

	@kern/mm/swap.h

1 #i‚de‡
__KERN_MM_SWAP_H__


2 
	#__KERN_MM_SWAP_H__


	)

4 
	~<defs.h
>

5 
	~<memœyout.h
>

6 
	~<pmm.h
>

7 
	~<vmm.h
>

17 
	#MAX_SWAP_OFFSET_LIMIT
 (1 << 24)

	)

19 
size_t
 
max_sw≠_off£t
;

25 
	#sw≠_off£t
(
íåy
) ({ \

26 
size_t
 
__off£t
 = (
íåy
 >> 8); \

27 i‡(!(
__off£t
 > 0 && __off£à< 
max_sw≠_off£t
)) { \

28 
	`∑nic
("övÆid sw≠_íåy_à%08x.\n", 
íåy
); \

30 
__off£t
; \

31 })

	)

33 
	ssw≠_m™agî


35 c⁄° *
	m«me
;

37 (*
	möô
) ();

39 (*
	möô_mm
Ë(
mm_°ru˘
 *
	mmm
);

41 (*
	mtick_evít
Ë(
mm_°ru˘
 *
	mmm
);

43 (*
	mm≠_sw≠∑bÀ
Ë(
mm_°ru˘
 *
	mmm
, 
uöçå_t
 
	maddr
, 
Page
 *
	m∑ge
, 
	msw≠_ö
);

46 (*
	m£t_unsw≠∑bÀ
Ë(
mm_°ru˘
 *
	mmm
, 
uöçå_t
 
	maddr
);

48 (*
	msw≠_out_vi˘im
Ë(
mm_°ru˘
 *
	mmm
, 
Page
 **
	m±r_∑ge
, 
	mö_tick
);

50 (*
	mcheck_sw≠
)();

53 vﬁ©ûê
sw≠_öô_ok
;

54 
sw≠_öô
();

55 
sw≠_öô_mm
(
mm_°ru˘
 *
mm
);

56 
sw≠_tick_evít
(
mm_°ru˘
 *
mm
);

57 
sw≠_m≠_sw≠∑bÀ
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
, 
Page
 *
∑ge
, 
sw≠_ö
);

58 
sw≠_£t_unsw≠∑bÀ
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
);

59 
sw≠_out
(
mm_°ru˘
 *
mm
, 
n
, 
ö_tick
);

60 
sw≠_ö
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
, 
Page
 **
±r_ªsu…
);

	@kern/mm/swap_fifo.c

1 
	~<defs.h
>

2 
	~<x86.h
>

3 
	~<°dio.h
>

4 
	~<°rög.h
>

5 
	~<sw≠.h
>

6 
	~<sw≠_fifo.h
>

7 
	~<li°.h
>

28 
li°_íåy_t
 
	g¥a_li°_hód
;

34 
	$_fifo_öô_mm
(
mm_°ru˘
 *
mm
)

36 
	`li°_öô
(&
¥a_li°_hód
);

37 
mm
->
sm_¥iv
 = &
¥a_li°_hód
;

40 
	}
}

45 
	$_fifo_m≠_sw≠∑bÀ
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
, 
Page
 *
∑ge
, 
sw≠_ö
)

47 
li°_íåy_t
 *
hód
=÷i°_íåy_t*Ë
mm
->
sm_¥iv
;

48 
li°_íåy_t
 *
íåy
=&(
∑ge
->
¥a_∑ge_lök
);

50 
	`as£π
(
íåy
 !
NULL
 && 
hód
 != NULL);

54 
	`li°_add
(
hód
, 
íåy
);

56 
	}
}

62 
	$_fifo_sw≠_out_vi˘im
(
mm_°ru˘
 *
mm
, 
Page
 ** 
±r_∑ge
, 
ö_tick
)

64 
li°_íåy_t
 *
hód
=÷i°_íåy_t*Ë
mm
->
sm_¥iv
;

65 
	`as£π
(
hód
 !
NULL
);

66 
	`as£π
(
ö_tick
==0);

72 
li°_íåy_t
 *
À
 = 
hód
->
¥ev
;

73 
	`as£π
(
hód
!=
À
);

74 
Page
 *
p
 = 
	`À2∑ge
(
À
, 
¥a_∑ge_lök
);

75 
	`li°_dñ
(
À
);

76 
	`as£π
(
p
 !=
NULL
);

77 *
±r_∑ge
 = 
p
;

79 
	}
}

82 
	$_fifo_check_sw≠
() {

83 
	`˝rötf
("write Virt Page c in fifo_check_swap\n");

85 
	`as£π
(
pgÁu…_num
==4);

86 
	`˝rötf
("write Virt Pageá in fifo_check_swap\n");

88 
	`as£π
(
pgÁu…_num
==4);

89 
	`˝rötf
("write Virt Page d in fifo_check_swap\n");

91 
	`as£π
(
pgÁu…_num
==4);

92 
	`˝rötf
("write Virt Page b in fifo_check_swap\n");

94 
	`as£π
(
pgÁu…_num
==4);

95 
	`˝rötf
("write Virt PageÉ in fifo_check_swap\n");

97 
	`as£π
(
pgÁu…_num
==5);

98 
	`˝rötf
("write Virt Page b in fifo_check_swap\n");

100 
	`as£π
(
pgÁu…_num
==5);

101 
	`˝rötf
("write Virt Pageá in fifo_check_swap\n");

103 
	`as£π
(
pgÁu…_num
==6);

104 
	`˝rötf
("write Virt Page b in fifo_check_swap\n");

106 
	`as£π
(
pgÁu…_num
==7);

107 
	`˝rötf
("write Virt Page c in fifo_check_swap\n");

109 
	`as£π
(
pgÁu…_num
==8);

110 
	`˝rötf
("write Virt Page d in fifo_check_swap\n");

112 
	`as£π
(
pgÁu…_num
==9);

114 
	}
}

118 
	$_fifo_öô
()

121 
	}
}

124 
	$_fifo_£t_unsw≠∑bÀ
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
)

127 
	}
}

130 
	$_fifo_tick_evít
(
mm_°ru˘
 *
mm
)

131 {  0; 
	}
}

134 
sw≠_m™agî
 
	gsw≠_m™agî_fifo
 =

136 .
«me
 = "fifo swap manager",

137 .
	göô
 = &
_fifo_öô
,

138 .
	göô_mm
 = &
_fifo_öô_mm
,

139 .
	gtick_evít
 = &
_fifo_tick_evít
,

140 .
	gm≠_sw≠∑bÀ
 = &
_fifo_m≠_sw≠∑bÀ
,

141 .
	g£t_unsw≠∑bÀ
 = &
_fifo_£t_unsw≠∑bÀ
,

142 .
	gsw≠_out_vi˘im
 = &
_fifo_sw≠_out_vi˘im
,

143 .
	gcheck_sw≠
 = &
_fifo_check_sw≠
,

	@kern/mm/swap_fifo.h

1 #i‚de‡
__KERN_MM_SWAP_FIFO_H__


2 
	#__KERN_MM_SWAP_FIFO_H__


	)

4 
	~<sw≠.h
>

5 
sw≠_m™agî
 
sw≠_m™agî_fifo
;

	@kern/mm/vmm.c

1 
	~<vmm.h
>

2 
	~<sync.h
>

3 
	~<°rög.h
>

4 
	~<as£π.h
>

5 
	~<°dio.h
>

6 
	~<îr‹.h
>

7 
	~<pmm.h
>

8 
	~<x86.h
>

9 
	~<sw≠.h
>

10 
	~<kmÆloc.h
>

38 
check_vmm
();

39 
check_vma_°ru˘
();

40 
check_pgÁu…
();

43 
mm_°ru˘
 *

44 
	$mm_¸óã
() {

45 
mm_°ru˘
 *
mm
 = 
	`kmÆloc
((mm_struct));

47 i‡(
mm
 !
NULL
) {

48 
	`li°_öô
(&(
mm
->
mm≠_li°
));

49 
mm
->
mm≠_ˇche
 = 
NULL
;

50 
mm
->
pgdú
 = 
NULL
;

51 
mm
->
m≠_cou¡
 = 0;

53 i‡(
sw≠_öô_ok
Ë
	`sw≠_öô_mm
(
mm
);

54 
mm
->
sm_¥iv
 = 
NULL
;

56 
	`£t_mm_cou¡
(
mm
, 0);

57 
	`£m_öô
(&(
mm
->
mm_£m
), 1);

59  
mm
;

60 
	}
}

63 
vma_°ru˘
 *

64 
	$vma_¸óã
(
uöçå_t
 
vm_°¨t
, uöçå_à
vm_íd
, 
uöt32_t
 
vm_Êags
) {

65 
vma_°ru˘
 *
vma
 = 
	`kmÆloc
((vma_struct));

67 i‡(
vma
 !
NULL
) {

68 
vma
->
vm_°¨t
 = vm_start;

69 
vma
->
vm_íd
 = vm_end;

70 
vma
->
vm_Êags
 = vm_flags;

72  
vma
;

73 
	}
}

77 
vma_°ru˘
 *

78 
	$föd_vma
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
) {

79 
vma_°ru˘
 *
vma
 = 
NULL
;

80 i‡(
mm
 !
NULL
) {

81 
vma
 = 
mm
->
mm≠_ˇche
;

82 i‡(!(
vma
 !
NULL
 && vma->
vm_°¨t
 <
addr
 && vma->
vm_íd
 >áddr)) {

83 
boﬁ
 
found
 = 0;

84 
li°_íåy_t
 *
li°
 = &(
mm
->
mm≠_li°
), *
À
 =Üist;

85 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

86 
vma
 = 
	`À2vma
(
À
, 
li°_lök
);

87 i‡(
vma
->
vm_°¨t
<=
addr
 &&ádd∏< vma->
vm_íd
) {

88 
found
 = 1;

92 i‡(!
found
) {

93 
vma
 = 
NULL
;

96 i‡(
vma
 !
NULL
) {

97 
mm
->
mm≠_ˇche
 = 
vma
;

100  
vma
;

101 
	}
}

105 
ölöe
 

106 
	$check_vma_ovîœp
(
vma_°ru˘
 *
¥ev
, vma_°ru˘ *
√xt
) {

107 
	`as£π
(
¥ev
->
vm_°¨t
 <Öªv->
vm_íd
);

108 
	`as£π
(
¥ev
->
vm_íd
 <
√xt
->
vm_°¨t
);

109 
	`as£π
(
√xt
->
vm_°¨t
 <Çext->
vm_íd
);

110 
	}
}

115 
	$ö£π_vma_°ru˘
(
mm_°ru˘
 *
mm
, 
vma_°ru˘
 *
vma
) {

116 
	`as£π
(
vma
->
vm_°¨t
 < vma->
vm_íd
);

117 
li°_íåy_t
 *
li°
 = &(
mm
->
mm≠_li°
);

118 
li°_íåy_t
 *
À_¥ev
 = 
li°
, *
À_√xt
;

120 
li°_íåy_t
 *
À
 = 
li°
;

121 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

122 
vma_°ru˘
 *
mm≠_¥ev
 = 
	`À2vma
(
À
, 
li°_lök
);

123 i‡(
mm≠_¥ev
->
vm_°¨t
 > 
vma
->vm_start) {

126 
À_¥ev
 = 
À
;

129 
À_√xt
 = 
	`li°_√xt
(
À_¥ev
);

132 i‡(
À_¥ev
 !
li°
) {

133 
	`check_vma_ovîœp
(
	`À2vma
(
À_¥ev
, 
li°_lök
), 
vma
);

135 i‡(
À_√xt
 !
li°
) {

136 
	`check_vma_ovîœp
(
vma
, 
	`À2vma
(
À_√xt
, 
li°_lök
));

139 
vma
->
vm_mm
 = 
mm
;

140 
	`li°_add_a·î
(
À_¥ev
, &(
vma
->
li°_lök
));

142 
mm
->
m≠_cou¡
 ++;

143 
	}
}

147 
	$mm_de°roy
(
mm_°ru˘
 *
mm
) {

148 
	`as£π
(
	`mm_cou¡
(
mm
) == 0);

150 
li°_íåy_t
 *
li°
 = &(
mm
->
mm≠_li°
), *
À
;

151 (
À
 = 
	`li°_√xt
(
li°
)) !=Üist) {

152 
	`li°_dñ
(
À
);

153 
	`k‰ì
(
	`À2vma
(
À
, 
li°_lök
));

155 
	`k‰ì
(
mm
);

156 
mm
=
NULL
;

157 
	}
}

160 
	$mm_m≠
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
, 
size_t
 
Àn
, 
uöt32_t
 
vm_Êags
,

161 
vma_°ru˘
 **
vma_°‹e
) {

162 
uöçå_t
 
°¨t
 = 
	`ROUNDDOWN
(
addr
, 
PGSIZE
), 
íd
 = 
	`ROUNDUP
◊dd∏+ 
Àn
, PGSIZE);

163 i‡(!
	`USER_ACCESS
(
°¨t
, 
íd
)) {

164  -
E_INVAL
;

167 
	`as£π
(
mm
 !
NULL
);

169 
ªt
 = -
E_INVAL
;

171 
vma_°ru˘
 *
vma
;

172 i‡((
vma
 = 
	`föd_vma
(
mm
, 
°¨t
)Ë!
NULL
 && 
íd
 > vma->
vm_°¨t
) {

173 
out
;

175 
ªt
 = -
E_NO_MEM
;

177 i‡((
vma
 = 
	`vma_¸óã
(
°¨t
, 
íd
, 
vm_Êags
)Ë=
NULL
) {

178 
out
;

180 
	`ö£π_vma_°ru˘
(
mm
, 
vma
);

181 i‡(
vma_°‹e
 !
NULL
) {

182 *
vma_°‹e
 = 
vma
;

184 
ªt
 = 0;

186 
out
:

187  
ªt
;

188 
	}
}

191 
	$dup_mm≠
(
mm_°ru˘
 *
to
, mm_°ru˘ *
‰om
) {

192 
	`as£π
(
to
 !
NULL
 && 
‰om
 != NULL);

193 
li°_íåy_t
 *
li°
 = &(
‰om
->
mm≠_li°
), *
À
 =Üist;

194 (
À
 = 
	`li°_¥ev
÷e)Ë!
li°
) {

195 
vma_°ru˘
 *
vma
, *
nvma
;

196 
vma
 = 
	`À2vma
(
À
, 
li°_lök
);

197 
nvma
 = 
	`vma_¸óã
(
vma
->
vm_°¨t
, vma->
vm_íd
, vma->
vm_Êags
);

198 i‡(
nvma
 =
NULL
) {

199  -
E_NO_MEM
;

202 
	`ö£π_vma_°ru˘
(
to
, 
nvma
);

204 
boﬁ
 
sh¨e
 = 0;

205 i‡(
	`c›y_ønge
(
to
->
pgdú
, 
‰om
->pgdú, 
vma
->
vm_°¨t
, vma->
vm_íd
, 
sh¨e
) != 0) {

206  -
E_NO_MEM
;

210 
	}
}

213 
	$exô_mm≠
(
mm_°ru˘
 *
mm
) {

214 
	`as£π
(
mm
 !
NULL
 && 
	`mm_cou¡
(mm) == 0);

215 
pde_t
 *
pgdú
 = 
mm
->pgdir;

216 
li°_íåy_t
 *
li°
 = &(
mm
->
mm≠_li°
), *
À
 =Üist;

217 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

218 
vma_°ru˘
 *
vma
 = 
	`À2vma
(
À
, 
li°_lök
);

219 
	`unm≠_ønge
(
pgdú
, 
vma
->
vm_°¨t
, vma->
vm_íd
);

221 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

222 
vma_°ru˘
 *
vma
 = 
	`À2vma
(
À
, 
li°_lök
);

223 
	`exô_ønge
(
pgdú
, 
vma
->
vm_°¨t
, vma->
vm_íd
);

225 
	}
}

227 
boﬁ


228 
	$c›y_‰om_u£r
(
mm_°ru˘
 *
mm
, *
d°
, c⁄° *
§c
, 
size_t
 
Àn
, 
boﬁ
 
wrôabÀ
) {

229 i‡(!
	`u£r_mem_check
(
mm
, (
uöçå_t
)
§c
, 
Àn
, 
wrôabÀ
)) {

232 
	`mem˝y
(
d°
, 
§c
, 
Àn
);

234 
	}
}

236 
boﬁ


237 
	$c›y_to_u£r
(
mm_°ru˘
 *
mm
, *
d°
, c⁄° *
§c
, 
size_t
 
Àn
) {

238 i‡(!
	`u£r_mem_check
(
mm
, (
uöçå_t
)
d°
, 
Àn
, 1)) {

241 
	`mem˝y
(
d°
, 
§c
, 
Àn
);

243 
	}
}

248 
	$vmm_öô
() {

249 
	`check_vmm
();

250 
	}
}

254 
	$check_vmm
() {

255 
size_t
 
ƒ_‰ì_∑ges_°‹e
 = 
	`ƒ_‰ì_∑ges
();

257 
	`check_vma_°ru˘
();

258 
	`check_pgÁu…
();

262 
	`˝rötf
("check_vmm() succeeded.\n");

263 
	}
}

266 
	$check_vma_°ru˘
() {

267 
size_t
 
ƒ_‰ì_∑ges_°‹e
 = 
	`ƒ_‰ì_∑ges
();

269 
mm_°ru˘
 *
mm
 = 
	`mm_¸óã
();

270 
	`as£π
(
mm
 !
NULL
);

272 
°ï1
 = 10, 
°ï2
 = step1 * 10;

274 
i
;

275 
i
 = 
°ï1
; i >= 1; i --) {

276 
vma_°ru˘
 *
vma
 = 
	`vma_¸óã
(
i
 * 5, i * 5 + 2, 0);

277 
	`as£π
(
vma
 !
NULL
);

278 
	`ö£π_vma_°ru˘
(
mm
, 
vma
);

281 
i
 = 
°ï1
 + 1; i <
°ï2
; i ++) {

282 
vma_°ru˘
 *
vma
 = 
	`vma_¸óã
(
i
 * 5, i * 5 + 2, 0);

283 
	`as£π
(
vma
 !
NULL
);

284 
	`ö£π_vma_°ru˘
(
mm
, 
vma
);

287 
li°_íåy_t
 *
À
 = 
	`li°_√xt
(&(
mm
->
mm≠_li°
));

289 
i
 = 1; i <
°ï2
; i ++) {

290 
	`as£π
(
À
 !&(
mm
->
mm≠_li°
));

291 
vma_°ru˘
 *
mm≠
 = 
	`À2vma
(
À
, 
li°_lök
);

292 
	`as£π
(
mm≠
->
vm_°¨t
 =
i
 * 5 && mm≠->
vm_íd
 == i * 5 + 2);

293 
À
 = 
	`li°_√xt
(le);

296 
i
 = 5; i <5 * 
°ï2
; i +=5) {

297 
vma_°ru˘
 *
vma1
 = 
	`föd_vma
(
mm
, 
i
);

298 
	`as£π
(
vma1
 !
NULL
);

299 
vma_°ru˘
 *
vma2
 = 
	`föd_vma
(
mm
, 
i
+1);

300 
	`as£π
(
vma2
 !
NULL
);

301 
vma_°ru˘
 *
vma3
 = 
	`föd_vma
(
mm
, 
i
+2);

302 
	`as£π
(
vma3
 =
NULL
);

303 
vma_°ru˘
 *
vma4
 = 
	`föd_vma
(
mm
, 
i
+3);

304 
	`as£π
(
vma4
 =
NULL
);

305 
vma_°ru˘
 *
vma5
 = 
	`föd_vma
(
mm
, 
i
+4);

306 
	`as£π
(
vma5
 =
NULL
);

308 
	`as£π
(
vma1
->
vm_°¨t
 =
i
 && vma1->
vm_íd
 == i + 2);

309 
	`as£π
(
vma2
->
vm_°¨t
 =
i
 && vma2->
vm_íd
 == i + 2);

312 
i
 =4; i>=0; i--) {

313 
vma_°ru˘
 *
vma_bñow_5

	`föd_vma
(
mm
,
i
);

314 i‡(
vma_bñow_5
 !
NULL
 ) {

315 
	`˝rötf
("vma_bñow_5: i %x, sèπ %x,Énd %x\n",
i
, 
vma_bñow_5
->
vm_°¨t
, vma_bñow_5->
vm_íd
);

317 
	`as£π
(
vma_bñow_5
 =
NULL
);

320 
	`mm_de°roy
(
mm
);

324 
	`˝rötf
("check_vma_struct() succeeded!\n");

325 
	}
}

327 
mm_°ru˘
 *
	gcheck_mm_°ru˘
;

331 
	$check_pgÁu…
() {

332 
size_t
 
ƒ_‰ì_∑ges_°‹e
 = 
	`ƒ_‰ì_∑ges
();

334 
check_mm_°ru˘
 = 
	`mm_¸óã
();

335 
	`as£π
(
check_mm_°ru˘
 !
NULL
);

337 
mm_°ru˘
 *
mm
 = 
check_mm_°ru˘
;

338 
pde_t
 *
pgdú
 = 
mm
->pgdú = 
boŸ_pgdú
;

339 
	`as£π
(
pgdú
[0] == 0);

341 
vma_°ru˘
 *
vma
 = 
	`vma_¸óã
(0, 
PTSIZE
, 
VM_WRITE
);

342 
	`as£π
(
vma
 !
NULL
);

344 
	`ö£π_vma_°ru˘
(
mm
, 
vma
);

346 
uöçå_t
 
addr
 = 0x100;

347 
	`as£π
(
	`föd_vma
(
mm
, 
addr
Ë=
vma
);

349 
i
, 
sum
 = 0;

350 
i
 = 0; i < 100; i ++) {

351 *(*)(
addr
 + 
i
) = i;

352 
sum
 +
i
;

354 
i
 = 0; i < 100; i ++) {

355 
sum
 -*(*)(
addr
 + 
i
);

357 
	`as£π
(
sum
 == 0);

359 
	`∑ge_ªmove
(
pgdú
, 
	`ROUNDDOWN
(
addr
, 
PGSIZE
));

360 
	`‰ì_∑ge
(
	`∑2∑ge
(
pgdú
[0]));

361 
pgdú
[0] = 0;

363 
mm
->
pgdú
 = 
NULL
;

364 
	`mm_de°roy
(
mm
);

365 
check_mm_°ru˘
 = 
NULL
;

367 
	`as£π
(
ƒ_‰ì_∑ges_°‹e
 =
	`ƒ_‰ì_∑ges
());

369 
	`˝rötf
("check_pgfault() succeeded!\n");

370 
	}
}

372 vﬁ©ûê
	gpgÁu…_num
=0;

396 
	$do_pgÁu…
(
mm_°ru˘
 *
mm
, 
uöt32_t
 
îr‹_code
, 
uöçå_t
 
addr
) {

397 
ªt
 = -
E_INVAL
;

399 
vma_°ru˘
 *
vma
 = 
	`föd_vma
(
mm
, 
addr
);

401 
pgÁu…_num
++;

403 i‡(
vma
 =
NULL
 || vma->
vm_°¨t
 > 
addr
) {

404 
	`˝rötf
("nŸ vÆidádd∏%x,ánd c™ÇŸ föd iàö vma\n", 
addr
);

405 
Áûed
;

408 
îr‹_code
 & 3) {

412 i‡(!(
vma
->
vm_Êags
 & 
VM_WRITE
)) {

413 
	`˝rötf
("do_pgfault failed:Érror code flag = write ANDÇotÖresent, butÅheáddr's vma cannot write\n");

414 
Áûed
;

418 
	`˝rötf
("do_pgfault failed:Érror code flag =Ñead ANDÖresent\n");

419 
Áûed
;

421 i‡(!(
vma
->
vm_Êags
 & (
VM_READ
 | 
VM_EXEC
))) {

422 
	`˝rötf
("do_pgfault failed:Érror code flag =Ñead ANDÇotÖresent, butÅheáddr's vma cannotÑead orÉxec\n");

423 
Áûed
;

432 
uöt32_t
 
≥rm
 = 
PTE_U
;

433 i‡(
vma
->
vm_Êags
 & 
VM_WRITE
) {

434 
≥rm
 |
PTE_W
;

436 
addr
 = 
	`ROUNDDOWN
◊ddr, 
PGSIZE
);

438 
ªt
 = -
E_NO_MEM
;

440 
±e_t
 *
±ï
=
NULL
;

460 
±ï
 = ???

461 i‡(*
±ï
 == 0) {

486 if(
sw≠_öô_ok
) {

487 
Page
 *
∑ge
=
NULL
;

495 
	`˝rötf
("nÿsw≠_öô_ok buà±ï i†%x, faûed\n",*
±ï
);

496 
Áûed
;

502 i‡((
±ï
 = 
	`gë_±e
(
mm
->
pgdú
, 
addr
, 1)Ë=
NULL
) {

503 
	`˝rötf
("get_pte in do_pgfault failed\n");

504 
Áûed
;

507 i‡(*
±ï
 == 0) {

508 i‡(
	`pgdú_Æloc_∑ge
(
mm
->
pgdú
, 
addr
, 
≥rm
Ë=
NULL
) {

509 
	`˝rötf
("pgdir_alloc_page in do_pgfault failed\n");

510 
Áûed
;

514 
Page
 *
∑ge
=
NULL
;

515 
	`˝rötf
("dÿpgÁu…:Öã∞%x,Öã %x\n",
±ï
, *ptep);

516 i‡(*
±ï
 & 
PTE_P
) {

520 
	`∑nic
("error writeáÇon-writableÖte");

525 if(
sw≠_öô_ok
) {

526 i‡((
ªt
 = 
	`sw≠_ö
(
mm
, 
addr
, &
∑ge
)) != 0) {

527 
	`˝rötf
("swap_in in do_pgfault failed\n");

528 
Áûed
;

533 
	`˝rötf
("nÿsw≠_öô_ok buà±ï i†%x, faûed\n",*
±ï
);

534 
Áûed
;

537 
	`∑ge_ö£π
(
mm
->
pgdú
, 
∑ge
, 
addr
, 
≥rm
);

538 
	`sw≠_m≠_sw≠∑bÀ
(
mm
, 
addr
, 
∑ge
, 1);

540 
ªt
 = 0;

541 
Áûed
:

542  
ªt
;

543 
	}
}

545 
boﬁ


546 
	$u£r_mem_check
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
, 
size_t
 
Àn
, 
boﬁ
 
wrôe
) {

547 i‡(
mm
 !
NULL
) {

548 i‡(!
	`USER_ACCESS
(
addr
,ádd∏+ 
Àn
)) {

551 
vma_°ru˘
 *
vma
;

552 
uöçå_t
 
°¨t
 = 
addr
, 
íd
 =ádd∏+ 
Àn
;

553 
°¨t
 < 
íd
) {

554 i‡((
vma
 = 
	`föd_vma
(
mm
, 
°¨t
)Ë=
NULL
 || sèπ < vma->
vm_°¨t
) {

557 i‡(!(
vma
->
vm_Êags
 & ((
wrôe
Ë? 
VM_WRITE
 : 
VM_READ
))) {

560 i‡(
wrôe
 && (
vma
->
vm_Êags
 & 
VM_STACK
)) {

561 i‡(
°¨t
 < 
vma
->
vm_°¨t
 + 
PGSIZE
) {

565 
°¨t
 = 
vma
->
vm_íd
;

569  
	`KERN_ACCESS
(
addr
,ádd∏+ 
Àn
);

570 
	}
}

572 
boﬁ


573 
	$c›y_°rög
(
mm_°ru˘
 *
mm
, *
d°
, c⁄° *
§c
, 
size_t
 
maxn
) {

574 
size_t
 
Æí
, 
∑π
 = 
	`ROUNDDOWN
((
uöçå_t
)
§c
 + 
PGSIZE
, PGSIZE) - (uintptr_t)src;

576 i‡(
∑π
 > 
maxn
) {

577 
∑π
 = 
maxn
;

579 i‡(!
	`u£r_mem_check
(
mm
, (
uöçå_t
)
§c
, 
∑π
, 0)) {

582 i‡((
Æí
 = 
	`°∫Àn
(
§c
, 
∑π
)) <Öart) {

583 
	`mem˝y
(
d°
, 
§c
, 
Æí
 + 1);

586 i‡(
∑π
 =
maxn
) {

589 
	`mem˝y
(
d°
, 
§c
, 
∑π
);

590 
d°
 +
∑π
, 
§c
 +∑π, 
maxn
 -=Öart;

591 
∑π
 = 
PGSIZE
;

593 
	}
}

	@kern/mm/vmm.h

1 #i‚de‡
__KERN_MM_VMM_H__


2 
	#__KERN_MM_VMM_H__


	)

4 
	~<defs.h
>

5 
	~<li°.h
>

6 
	~<memœyout.h
>

7 
	~<sync.h
>

8 
	~<¥oc.h
>

9 
	~<£m.h
>

12 
	gmm_°ru˘
;

15 
	svma_°ru˘
 {

16 
mm_°ru˘
 *
	mvm_mm
;

17 
uöçå_t
 
	mvm_°¨t
;

18 
uöçå_t
 
	mvm_íd
;

19 
uöt32_t
 
	mvm_Êags
;

20 
li°_íåy_t
 
	mli°_lök
;

23 
	#À2vma
(
À
, 
membî
) \

24 
	`to_°ru˘
((
À
), 
vma_°ru˘
, 
membî
)

	)

26 
	#VM_READ
 0x00000001

	)

27 
	#VM_WRITE
 0x00000002

	)

28 
	#VM_EXEC
 0x00000004

	)

29 
	#VM_STACK
 0x00000008

	)

32 
	smm_°ru˘
 {

33 
li°_íåy_t
 
	mmm≠_li°
;

34 
vma_°ru˘
 *
	mmm≠_ˇche
;

35 
pde_t
 *
	mpgdú
;

36 
	mm≠_cou¡
;

37 *
	msm_¥iv
;

38 
	mmm_cou¡
;

39 
£m≠h‹e_t
 
	mmm_£m
;

40 
	mlocked_by
;

44 
vma_°ru˘
 *
föd_vma
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
);

45 
vma_°ru˘
 *
vma_¸óã
(
uöçå_t
 
vm_°¨t
, uöçå_à
vm_íd
, 
uöt32_t
 
vm_Êags
);

46 
ö£π_vma_°ru˘
(
mm_°ru˘
 *
mm
, 
vma_°ru˘
 *
vma
);

48 
mm_°ru˘
 *
mm_¸óã
();

49 
mm_de°roy
(
mm_°ru˘
 *
mm
);

51 
vmm_öô
();

52 
mm_m≠
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
, 
size_t
 
Àn
, 
uöt32_t
 
vm_Êags
,

53 
vma_°ru˘
 **
vma_°‹e
);

54 
do_pgÁu…
(
mm_°ru˘
 *
mm
, 
uöt32_t
 
îr‹_code
, 
uöçå_t
 
addr
);

56 
mm_unm≠
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
, 
size_t
 
Àn
);

57 
dup_mm≠
(
mm_°ru˘
 *
to
, mm_°ru˘ *
‰om
);

58 
exô_mm≠
(
mm_°ru˘
 *
mm
);

59 
uöçå_t
 
gë_unm≠≥d_¨ó
(
mm_°ru˘
 *
mm
, 
size_t
 
Àn
);

60 
mm_brk
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
addr
, 
size_t
 
Àn
);

62 vﬁ©ûê
pgÁu…_num
;

63 
mm_°ru˘
 *
check_mm_°ru˘
;

65 
boﬁ
 
u£r_mem_check
(
mm_°ru˘
 *
mm
, 
uöçå_t
 
°¨t
, 
size_t
 
Àn
, boﬁ 
wrôe
);

66 
boﬁ
 
c›y_‰om_u£r
(
mm_°ru˘
 *
mm
, *
d°
, c⁄° *
§c
, 
size_t
 
Àn
, boﬁ 
wrôabÀ
);

67 
boﬁ
 
c›y_to_u£r
(
mm_°ru˘
 *
mm
, *
d°
, c⁄° *
§c
, 
size_t
 
Àn
);

68 
boﬁ
 
c›y_°rög
(
mm_°ru˘
 *
mm
, *
d°
, c⁄° *
§c
, 
size_t
 
maxn
);

70 
ölöe
 

71 
	$mm_cou¡
(
mm_°ru˘
 *
mm
) {

72  
mm
->
mm_cou¡
;

73 
	}
}

75 
ölöe
 

76 
	$£t_mm_cou¡
(
mm_°ru˘
 *
mm
, 
vÆ
) {

77 
mm
->
mm_cou¡
 = 
vÆ
;

78 
	}
}

80 
ölöe
 

81 
	$mm_cou¡_öc
(
mm_°ru˘
 *
mm
) {

82 
mm
->
mm_cou¡
 += 1;

83  
mm
->
mm_cou¡
;

84 
	}
}

86 
ölöe
 

87 
	$mm_cou¡_dec
(
mm_°ru˘
 *
mm
) {

88 
mm
->
mm_cou¡
 -= 1;

89  
mm
->
mm_cou¡
;

90 
	}
}

92 
ölöe
 

93 
	$lock_mm
(
mm_°ru˘
 *
mm
) {

94 i‡(
mm
 !
NULL
) {

95 
	`down
(&(
mm
->
mm_£m
));

96 i‡(
cuºít
 !
NULL
) {

97 
mm
->
locked_by
 = 
cuºít
->
pid
;

100 
	}
}

102 
ölöe
 

103 
	$u∆ock_mm
(
mm_°ru˘
 *
mm
) {

104 i‡(
mm
 !
NULL
) {

105 
	`up
(&(
mm
->
mm_£m
));

106 
mm
->
locked_by
 = 0;

108 
	}
}

	@kern/process/proc.c

1 
	~<¥oc.h
>

2 
	~<kmÆloc.h
>

3 
	~<°rög.h
>

4 
	~<sync.h
>

5 
	~<pmm.h
>

6 
	~<îr‹.h
>

7 
	~<sched.h
>

8 
	~<ñf.h
>

9 
	~<vmm.h
>

10 
	~<å≠.h
>

11 
	~<°dio.h
>

12 
	~<°dlib.h
>

13 
	~<as£π.h
>

14 
	~<uni°d.h
>

15 
	~<fs.h
>

16 
	~<vfs.h
>

17 
	~<sysfûe.h
>

66 
li°_íåy_t
 
	g¥oc_li°
;

68 
	#HASH_SHIFT
 10

	)

69 
	#HASH_LIST_SIZE
 (1 << 
HASH_SHIFT
)

	)

70 
	#pid_hash‚
(
x
Ë(
	`hash32
(x, 
HASH_SHIFT
))

	)

73 
li°_íåy_t
 
	ghash_li°
[
HASH_LIST_SIZE
];

76 
¥oc_°ru˘
 *
	gidÀ¥oc
 = 
NULL
;

78 
¥oc_°ru˘
 *
	göô¥oc
 = 
NULL
;

80 
¥oc_°ru˘
 *
	gcuºít
 = 
NULL
;

82 
	gƒ_¥o˚ss
 = 0;

84 
kî√l_thªad_íåy
();

85 
f‹kªts
(
å≠‰ame
 *
tf
);

86 
swôch_to
(
c⁄ãxt
 *
‰om
, c⁄ãxà*
to
);

89 
¥oc_°ru˘
 *

90 
	$Æloc_¥oc
() {

91 
¥oc_°ru˘
 *
¥oc
 = 
	`kmÆloc
((proc_struct));

92 i‡(
¥oc
 !
NULL
) {

116 
¥oc
->
°©e
 = 
PROC_UNINIT
;

117 
¥oc
->
pid
 = -1;

118 
¥oc
->
runs
 = 0;

119 
¥oc
->
k°ack
 = 0;

120 
¥oc
->
√ed_ªsched
 = 0;

121 
¥oc
->
∑ª¡
 = 
NULL
;

122 
¥oc
->
mm
 = 
NULL
;

123 
	`mem£t
(&(
¥oc
->
c⁄ãxt
), 0, (context));

124 
¥oc
->
tf
 = 
NULL
;

125 
¥oc
->
¸3
 = 
boŸ_¸3
;

126 
¥oc
->
Êags
 = 0;

127 
	`mem£t
(
¥oc
->
«me
, 0, 
PROC_NAME_LEN
);

128 
¥oc
->
waô_°©e
 = 0;

129 
¥oc
->
˝å
 =Öroc->
›å
 =Öroc->
y±r
 = 
NULL
;

130 
¥oc
->
rq
 = 
NULL
;

131 
¥oc
->
run_lök
.
¥ev
 =Öroc->run_lök.
√xt
 = 
NULL
;

132 
¥oc
->
time_¶i˚
 = 0;

133 
¥oc
->
œb6_run_poﬁ
.
À·
 =Öroc->œb6_run_poﬁ.
right
 =Öroc->œb6_run_poﬁ.
∑ª¡
 = 
NULL
;

134 
¥oc
->
œb6_°ride
 = 0;

135 
¥oc
->
œb6_¥i‹ôy
 = 0;

136 
¥oc
->
fûe•
 = 
NULL
;

138  
¥oc
;

139 
	}
}

143 
	$£t_¥oc_«me
(
¥oc_°ru˘
 *
¥oc
, c⁄° *
«me
) {

144 
	`mem£t
(
¥oc
->
«me
, 0, (proc->name));

145  
	`mem˝y
(
¥oc
->
«me
,Çame, 
PROC_NAME_LEN
);

146 
	}
}

150 
	$gë_¥oc_«me
(
¥oc_°ru˘
 *
¥oc
) {

151 
«me
[
PROC_NAME_LEN
 + 1];

152 
	`mem£t
(
«me
, 0, (name));

153  
	`mem˝y
(
«me
, 
¥oc
->«me, 
PROC_NAME_LEN
);

154 
	}
}

158 
	$£t_löks
(
¥oc_°ru˘
 *
¥oc
) {

159 
	`li°_add
(&
¥oc_li°
, &(
¥oc
->
li°_lök
));

160 
¥oc
->
y±r
 = 
NULL
;

161 i‡((
¥oc
->
›å
 =Öroc->
∑ª¡
->
˝å
Ë!
NULL
) {

162 
¥oc
->
›å
->
y±r
 =Öroc;

164 
¥oc
->
∑ª¡
->
˝å
 =Öroc;

165 
ƒ_¥o˚ss
 ++;

166 
	}
}

170 
	$ªmove_löks
(
¥oc_°ru˘
 *
¥oc
) {

171 
	`li°_dñ
(&(
¥oc
->
li°_lök
));

172 i‡(
¥oc
->
›å
 !
NULL
) {

173 
¥oc
->
›å
->
y±r
 =Öroc->yptr;

175 i‡(
¥oc
->
y±r
 !
NULL
) {

176 
¥oc
->
y±r
->
›å
 =Öroc->optr;

179 
¥oc
->
∑ª¡
->
˝å
 =Öroc->
›å
;

181 
ƒ_¥o˚ss
 --;

182 
	}
}

186 
	$gë_pid
() {

187 
	`°©ic_as£π
(
MAX_PID
 > 
MAX_PROCESS
);

188 
¥oc_°ru˘
 *
¥oc
;

189 
li°_íåy_t
 *
li°
 = &
¥oc_li°
, *
À
;

190 
√xt_ß„
 = 
MAX_PID
, 
œ°_pid
 = MAX_PID;

191 i‡(++ 
œ°_pid
 >
MAX_PID
) {

192 
œ°_pid
 = 1;

193 
öside
;

195 i‡(
œ°_pid
 >
√xt_ß„
) {

196 
öside
:

197 
√xt_ß„
 = 
MAX_PID
;

198 
ª≥©
:

199 
À
 = 
li°
;

200 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

201 
¥oc
 = 
	`À2¥oc
(
À
, 
li°_lök
);

202 i‡(
¥oc
->
pid
 =
œ°_pid
) {

203 i‡(++ 
œ°_pid
 >
√xt_ß„
) {

204 i‡(
œ°_pid
 >
MAX_PID
) {

205 
œ°_pid
 = 1;

207 
√xt_ß„
 = 
MAX_PID
;

208 
ª≥©
;

211 i‡(
¥oc
->
pid
 > 
œ°_pid
 && 
√xt_ß„
 >Öroc->pid) {

212 
√xt_ß„
 = 
¥oc
->
pid
;

216  
œ°_pid
;

217 
	}
}

222 
	$¥oc_run
(
¥oc_°ru˘
 *
¥oc
) {

223 i‡(
¥oc
 !
cuºít
) {

224 
boﬁ
 
öå_Êag
;

225 
¥oc_°ru˘
 *
¥ev
 = 
cuºít
, *
√xt
 = 
¥oc
;

226 
	`loˇl_öå_ßve
(
öå_Êag
);

228 
cuºít
 = 
¥oc
;

229 
	`lﬂd_e•0
(
√xt
->
k°ack
 + 
KSTACKSIZE
);

230 
	`l¸3
(
√xt
->
¸3
);

231 
	`swôch_to
(&(
¥ev
->
c⁄ãxt
), &(
√xt
->context));

233 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

235 
	}
}

241 
	$f‹kªt
() {

242 
	`f‹kªts
(
cuºít
->
tf
);

243 
	}
}

247 
	$hash_¥oc
(
¥oc_°ru˘
 *
¥oc
) {

248 
	`li°_add
(
hash_li°
 + 
	`pid_hash‚
(
¥oc
->
pid
), &’roc->
hash_lök
));

249 
	}
}

253 
	$unhash_¥oc
(
¥oc_°ru˘
 *
¥oc
) {

254 
	`li°_dñ
(&(
¥oc
->
hash_lök
));

255 
	}
}

258 
¥oc_°ru˘
 *

259 
	$föd_¥oc
(
pid
) {

260 i‡(0 < 
pid
 &&Öid < 
MAX_PID
) {

261 
li°_íåy_t
 *
li°
 = 
hash_li°
 + 
	`pid_hash‚
(
pid
), *
À
 =Üist;

262 (
À
 = 
	`li°_√xt
÷e)Ë!
li°
) {

263 
¥oc_°ru˘
 *
¥oc
 = 
	`À2¥oc
(
À
, 
hash_lök
);

264 i‡(
¥oc
->
pid
 ==Öid) {

265  
¥oc
;

269  
NULL
;

270 
	}
}

276 
kî√l_thªad
((*
‚
)(*), *
¨g
, 
uöt32_t
 
˛⁄e_Êags
) {

277 
å≠‰ame
 
tf
;

278 
	`mem£t
(&
tf
, 0, (
å≠‰ame
));

279 
tf
.
tf_cs
 = 
KERNEL_CS
;

280 
tf
.
tf_ds
 =Åf.
tf_es
 =Åf.
tf_ss
 = 
KERNEL_DS
;

281 
tf
.
tf_ªgs
.
ªg_ebx
 = (
uöt32_t
)
‚
;

282 
tf
.
tf_ªgs
.
ªg_edx
 = (
uöt32_t
)
¨g
;

283 
tf
.
tf_eù
 = (
uöt32_t
)
kî√l_thªad_íåy
;

284  
	`do_f‹k
(
˛⁄e_Êags
 | 
CLONE_VM
, 0, &
tf
);

285 
	}
}

289 
	$£tup_k°ack
(
¥oc_°ru˘
 *
¥oc
) {

290 
Page
 *
∑ge
 = 
	`Æloc_∑ges
(
KSTACKPAGE
);

291 i‡(
∑ge
 !
NULL
) {

292 
¥oc
->
k°ack
 = (
uöçå_t
)
	`∑ge2kva
(
∑ge
);

295  -
E_NO_MEM
;

296 
	}
}

300 
	$put_k°ack
(
¥oc_°ru˘
 *
¥oc
) {

301 
	`‰ì_∑ges
(
	`kva2∑ge
((*)(
¥oc
->
k°ack
)), 
KSTACKPAGE
);

302 
	}
}

306 
	$£tup_pgdú
(
mm_°ru˘
 *
mm
) {

307 
Page
 *
∑ge
;

308 i‡((
∑ge
 = 
	`Æloc_∑ge
()Ë=
NULL
) {

309  -
E_NO_MEM
;

311 
pde_t
 *
pgdú
 = 
	`∑ge2kva
(
∑ge
);

312 
	`mem˝y
(
pgdú
, 
boŸ_pgdú
, 
PGSIZE
);

313 
pgdú
[
	`PDX
(
VPT
)] = 
	`PADDR
’gdúË| 
PTE_P
 | 
PTE_W
;

314 
mm
->
pgdú
 =Ögdir;

316 
	}
}

320 
	$put_pgdú
(
mm_°ru˘
 *
mm
) {

321 
	`‰ì_∑ge
(
	`kva2∑ge
(
mm
->
pgdú
));

322 
	}
}

327 
	$c›y_mm
(
uöt32_t
 
˛⁄e_Êags
, 
¥oc_°ru˘
 *
¥oc
) {

328 
mm_°ru˘
 *
mm
, *
ﬁdmm
 = 
cuºít
->mm;

331 i‡(
ﬁdmm
 =
NULL
) {

334 i‡(
˛⁄e_Êags
 & 
CLONE_VM
) {

335 
mm
 = 
ﬁdmm
;

336 
good_mm
;

339 
ªt
 = -
E_NO_MEM
;

340 i‡((
mm
 = 
	`mm_¸óã
()Ë=
NULL
) {

341 
bad_mm
;

343 i‡(
	`£tup_pgdú
(
mm
) != 0) {

344 
bad_pgdú_˛ónup_mm
;

347 
	`lock_mm
(
ﬁdmm
);

349 
ªt
 = 
	`dup_mm≠
(
mm
, 
ﬁdmm
);

351 
	`u∆ock_mm
(
ﬁdmm
);

353 i‡(
ªt
 != 0) {

354 
bad_dup_˛ónup_mm≠
;

357 
good_mm
:

358 
	`mm_cou¡_öc
(
mm
);

359 
¥oc
->
mm
 = mm;

360 
¥oc
->
¸3
 = 
	`PADDR
(
mm
->
pgdú
);

362 
bad_dup_˛ónup_mm≠
:

363 
	`exô_mm≠
(
mm
);

364 
	`put_pgdú
(
mm
);

365 
bad_pgdú_˛ónup_mm
:

366 
	`mm_de°roy
(
mm
);

367 
bad_mm
:

368  
ªt
;

369 
	}
}

374 
	$c›y_thªad
(
¥oc_°ru˘
 *
¥oc
, 
uöçå_t
 
e•
, 
å≠‰ame
 *
tf
) {

375 
¥oc
->
tf
 = (
å≠‰ame
 *)’roc->
k°ack
 + 
KSTACKSIZE
) - 1;

376 *(
¥oc
->
tf
) = *tf;

377 
¥oc
->
tf
->
tf_ªgs
.
ªg_óx
 = 0;

378 
¥oc
->
tf
->
tf_e•
 = 
e•
;

379 
¥oc
->
tf
->
tf_eÊags
 |
FL_IF
;

381 
¥oc
->
c⁄ãxt
.
eù
 = (
uöçå_t
)
f‹kªt
;

382 
¥oc
->
c⁄ãxt
.
e•
 = (
uöçå_t
)’roc->
tf
);

383 
	}
}

387 
	$c›y_fs
(
uöt32_t
 
˛⁄e_Êags
, 
¥oc_°ru˘
 *
¥oc
) {

388 
fûes_°ru˘
 *
fûe•
, *
ﬁd_fûe•
 = 
cuºít
->filesp;

389 
	`as£π
(
ﬁd_fûe•
 !
NULL
);

391 i‡(
˛⁄e_Êags
 & 
CLONE_FS
) {

392 
fûe•
 = 
ﬁd_fûe•
;

393 
good_fûes_°ru˘
;

396 
ªt
 = -
E_NO_MEM
;

397 i‡((
fûe•
 = 
	`fûes_¸óã
()Ë=
NULL
) {

398 
bad_fûes_°ru˘
;

401 i‡((
ªt
 = 
	`dup_fs
(
fûe•
, 
ﬁd_fûe•
)) != 0) {

402 
bad_dup_˛ónup_fs
;

405 
good_fûes_°ru˘
:

406 
	`fûes_cou¡_öc
(
fûe•
);

407 
¥oc
->
fûe•
 = filesp;

410 
bad_dup_˛ónup_fs
:

411 
	`fûes_de°roy
(
fûe•
);

412 
bad_fûes_°ru˘
:

413  
ªt
;

414 
	}
}

417 
	$put_fs
(
¥oc_°ru˘
 *
¥oc
) {

418 
fûes_°ru˘
 *
fûe•
 = 
¥oc
->filesp;

419 i‡(
fûe•
 !
NULL
) {

420 i‡(
	`fûes_cou¡_dec
(
fûe•
) == 0) {

421 
	`fûes_de°roy
(
fûe•
);

424 
	}
}

432 
	$do_f‹k
(
uöt32_t
 
˛⁄e_Êags
, 
uöçå_t
 
°ack
, 
å≠‰ame
 *
tf
) {

433 
ªt
 = -
E_NO_FREE_PROC
;

434 
¥oc_°ru˘
 *
¥oc
;

435 i‡(
ƒ_¥o˚ss
 >
MAX_PROCESS
) {

436 
f‹k_out
;

438 
ªt
 = -
E_NO_MEM
;

473 i‡((
¥oc
 = 
	`Æloc_¥oc
()Ë=
NULL
) {

474 
f‹k_out
;

477 
¥oc
->
∑ª¡
 = 
cuºít
;

478 
	`as£π
(
cuºít
->
waô_°©e
 == 0);

480 i‡(
	`£tup_k°ack
(
¥oc
) != 0) {

481 
bad_f‹k_˛ónup_¥oc
;

483 i‡(
	`c›y_fs
(
˛⁄e_Êags
, 
¥oc
) != 0) {

484 
bad_f‹k_˛ónup_k°ack
;

486 i‡(
	`c›y_mm
(
˛⁄e_Êags
, 
¥oc
) != 0) {

487 
bad_f‹k_˛ónup_k°ack
;

489 
	`c›y_thªad
(
¥oc
, 
°ack
, 
tf
);

491 
boﬁ
 
öå_Êag
;

492 
	`loˇl_öå_ßve
(
öå_Êag
);

494 
¥oc
->
pid
 = 
	`gë_pid
();

495 
	`hash_¥oc
(
¥oc
);

496 
	`£t_löks
(
¥oc
);

499 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

501 
	`wakeup_¥oc
(
¥oc
);

503 
ªt
 = 
¥oc
->
pid
;

504 
f‹k_out
:

505  
ªt
;

507 
bad_f‹k_˛ónup_fs
:

508 
	`put_fs
(
¥oc
);

509 
bad_f‹k_˛ónup_k°ack
:

510 
	`put_k°ack
(
¥oc
);

511 
bad_f‹k_˛ónup_¥oc
:

512 
	`k‰ì
(
¥oc
);

513 
f‹k_out
;

514 
	}
}

521 
	$do_exô
(
îr‹_code
) {

522 i‡(
cuºít
 =
idÀ¥oc
) {

523 
	`∑nic
("idleprocÉxit.\n");

525 i‡(
cuºít
 =
öô¥oc
) {

526 
	`∑nic
("initprocÉxit.\n");

529 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

530 i‡(
mm
 !
NULL
) {

531 
	`l¸3
(
boŸ_¸3
);

532 i‡(
	`mm_cou¡_dec
(
mm
) == 0) {

533 
	`exô_mm≠
(
mm
);

534 
	`put_pgdú
(
mm
);

535 
	`mm_de°roy
(
mm
);

537 
cuºít
->
mm
 = 
NULL
;

539 
	`put_fs
(
cuºít
);

540 
cuºít
->
°©e
 = 
PROC_ZOMBIE
;

541 
cuºít
->
exô_code
 = 
îr‹_code
;

543 
boﬁ
 
öå_Êag
;

544 
¥oc_°ru˘
 *
¥oc
;

545 
	`loˇl_öå_ßve
(
öå_Êag
);

547 
¥oc
 = 
cuºít
->
∑ª¡
;

548 i‡(
¥oc
->
waô_°©e
 =
WT_CHILD
) {

549 
	`wakeup_¥oc
(
¥oc
);

551 
cuºít
->
˝å
 !
NULL
) {

552 
¥oc
 = 
cuºít
->
˝å
;

553 
cuºít
->
˝å
 = 
¥oc
->
›å
;

555 
¥oc
->
y±r
 = 
NULL
;

556 i‡((
¥oc
->
›å
 = 
öô¥oc
->
˝å
Ë!
NULL
) {

557 
öô¥oc
->
˝å
->
y±r
 = 
¥oc
;

559 
¥oc
->
∑ª¡
 = 
öô¥oc
;

560 
öô¥oc
->
˝å
 = 
¥oc
;

561 i‡(
¥oc
->
°©e
 =
PROC_ZOMBIE
) {

562 i‡(
öô¥oc
->
waô_°©e
 =
WT_CHILD
) {

563 
	`wakeup_¥oc
(
öô¥oc
);

568 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

570 
	`scheduÀ
();

571 
	`∑nic
("do_exô wû»nŸÑëu∫!! %d.\n", 
cuºít
->
pid
);

572 
	}
}

576 
	$lﬂd_icode_ªad
(
fd
, *
buf
, 
size_t
 
Àn
, 
off_t
 
off£t
) {

577 
ªt
;

578 i‡((
ªt
 = 
	`sysfûe_£ek
(
fd
, 
off£t
, 
LSEEK_SET
)) != 0) {

579  
ªt
;

581 i‡((
ªt
 = 
	`sysfûe_ªad
(
fd
, 
buf
, 
Àn
)) !=Üen) {

582  (
ªt
 < 0) ?Ñet : -1;

585 
	}
}

590 
	$lﬂd_icode
(
fd
, 
¨gc
, **
k¨gv
) {

615 
	`as£π
(
¨gc
 >0 &&árg¯<
EXEC_MAX_ARG_NUM
);

617 i‡(
cuºít
->
mm
 !
NULL
) {

618 
	`∑nic
("load_icode: current->mm must beÉmpty.\n");

621 
ªt
 = -
E_NO_MEM
;

622 
mm_°ru˘
 *
mm
;

623 i‡((
mm
 = 
	`mm_¸óã
()Ë=
NULL
) {

624 
bad_mm
;

626 i‡(
	`£tup_pgdú
(
mm
) != 0) {

627 
bad_pgdú_˛ónup_mm
;

630 
Page
 *
∑ge
;

632 
ñfhdr
 
__ñf
, *
ñf
 = &__elf;

633 i‡((
ªt
 = 
	`lﬂd_icode_ªad
(
fd
, 
ñf
, (
ñfhdr
), 0)) != 0) {

634 
bad_ñf_˛ónup_pgdú
;

637 i‡(
ñf
->
e_magic
 !
ELF_MAGIC
) {

638 
ªt
 = -
E_INVAL_ELF
;

639 
bad_ñf_˛ónup_pgdú
;

642 
¥oghdr
 
__ph
, *
ph
 = &__ph;

643 
uöt32_t
 
vm_Êags
, 
≥rm
, 
phnum
;

644 
phnum
 = 0;Öhnum < 
ñf
->
e_phnum
;Öhnum ++) {

645 
off_t
 
phoff
 = 
ñf
->
e_phoff
 + (
¥oghdr
Ë* 
phnum
;

646 i‡((
ªt
 = 
	`lﬂd_icode_ªad
(
fd
, 
ph
, (
¥oghdr
), 
phoff
)) != 0) {

647 
bad_˛ónup_mm≠
;

649 i‡(
ph
->
p_ty≥
 !
ELF_PT_LOAD
) {

652 i‡(
ph
->
p_fûesz
 >Öh->
p_memsz
) {

653 
ªt
 = -
E_INVAL_ELF
;

654 
bad_˛ónup_mm≠
;

656 i‡(
ph
->
p_fûesz
 == 0) {

659 
vm_Êags
 = 0, 
≥rm
 = 
PTE_U
;

660 i‡(
ph
->
p_Êags
 & 
ELF_PF_X
Ë
vm_Êags
 |
VM_EXEC
;

661 i‡(
ph
->
p_Êags
 & 
ELF_PF_W
Ë
vm_Êags
 |
VM_WRITE
;

662 i‡(
ph
->
p_Êags
 & 
ELF_PF_R
Ë
vm_Êags
 |
VM_READ
;

663 i‡(
vm_Êags
 & 
VM_WRITE
Ë
≥rm
 |
PTE_W
;

664 i‡((
ªt
 = 
	`mm_m≠
(
mm
, 
ph
->
p_va
,Öh->
p_memsz
, 
vm_Êags
, 
NULL
)) != 0) {

665 
bad_˛ónup_mm≠
;

667 
off_t
 
off£t
 = 
ph
->
p_off£t
;

668 
size_t
 
off
, 
size
;

669 
uöçå_t
 
°¨t
 = 
ph
->
p_va
, 
íd
, 
œ
 = 
	`ROUNDDOWN
(°¨t, 
PGSIZE
);

671 
ªt
 = -
E_NO_MEM
;

673 
íd
 = 
ph
->
p_va
 +Öh->
p_fûesz
;

674 
°¨t
 < 
íd
) {

675 i‡((
∑ge
 = 
	`pgdú_Æloc_∑ge
(
mm
->
pgdú
, 
œ
, 
≥rm
)Ë=
NULL
) {

676 
ªt
 = -
E_NO_MEM
;

677 
bad_˛ónup_mm≠
;

679 
off
 = 
°¨t
 - 
œ
, 
size
 = 
PGSIZE
 - off,Üa += PGSIZE;

680 i‡(
íd
 < 
œ
) {

681 
size
 -
œ
 - 
íd
;

683 i‡((
ªt
 = 
	`lﬂd_icode_ªad
(
fd
, 
	`∑ge2kva
(
∑ge
Ë+ 
off
, 
size
, 
off£t
)) != 0) {

684 
bad_˛ónup_mm≠
;

686 
°¨t
 +
size
, 
off£t
 += size;

688 
íd
 = 
ph
->
p_va
 +Öh->
p_memsz
;

690 i‡(
°¨t
 < 
œ
) {

692 i‡(
°¨t
 =
íd
) {

695 
off
 = 
°¨t
 + 
PGSIZE
 - 
œ
, 
size
 = PGSIZE - off;

696 i‡(
íd
 < 
œ
) {

697 
size
 -
œ
 - 
íd
;

699 
	`mem£t
(
	`∑ge2kva
(
∑ge
Ë+ 
off
, 0, 
size
);

700 
°¨t
 +
size
;

701 
	`as£π
((
íd
 < 
œ
 && 
°¨t
 ==Énd) || (end >=Üa && start ==Üa));

703 
°¨t
 < 
íd
) {

704 i‡((
∑ge
 = 
	`pgdú_Æloc_∑ge
(
mm
->
pgdú
, 
œ
, 
≥rm
)Ë=
NULL
) {

705 
ªt
 = -
E_NO_MEM
;

706 
bad_˛ónup_mm≠
;

708 
off
 = 
°¨t
 - 
œ
, 
size
 = 
PGSIZE
 - off,Üa += PGSIZE;

709 i‡(
íd
 < 
œ
) {

710 
size
 -
œ
 - 
íd
;

712 
	`mem£t
(
	`∑ge2kva
(
∑ge
Ë+ 
off
, 0, 
size
);

713 
°¨t
 +
size
;

716 
	`sysfûe_˛o£
(
fd
);

718 
vm_Êags
 = 
VM_READ
 | 
VM_WRITE
 | 
VM_STACK
;

719 i‡((
ªt
 = 
	`mm_m≠
(
mm
, 
USTACKTOP
 - 
USTACKSIZE
, USTACKSIZE, 
vm_Êags
, 
NULL
)) != 0) {

720 
bad_˛ónup_mm≠
;

722 
	`as£π
(
	`pgdú_Æloc_∑ge
(
mm
->
pgdú
, 
USTACKTOP
-
PGSIZE
 , 
PTE_USER
Ë!
NULL
);

723 
	`as£π
(
	`pgdú_Æloc_∑ge
(
mm
->
pgdú
, 
USTACKTOP
-2*
PGSIZE
 , 
PTE_USER
Ë!
NULL
);

724 
	`as£π
(
	`pgdú_Æloc_∑ge
(
mm
->
pgdú
, 
USTACKTOP
-3*
PGSIZE
 , 
PTE_USER
Ë!
NULL
);

725 
	`as£π
(
	`pgdú_Æloc_∑ge
(
mm
->
pgdú
, 
USTACKTOP
-4*
PGSIZE
 , 
PTE_USER
Ë!
NULL
);

727 
	`mm_cou¡_öc
(
mm
);

728 
cuºít
->
mm
 = mm;

729 
cuºít
->
¸3
 = 
	`PADDR
(
mm
->
pgdú
);

730 
	`l¸3
(
	`PADDR
(
mm
->
pgdú
));

733 
uöt32_t
 
¨gv_size
=0, 
i
;

734 
i
 = 0; i < 
¨gc
; i ++) {

735 
¨gv_size
 +
	`°∫Àn
(
k¨gv
[
i
],
EXEC_MAX_ARG_LEN
 + 1)+1;

738 
uöçå_t
 
°ackt›
 = 
USTACKTOP
 - (
¨gv_size
/()+1)*();

739 ** 
u¨gv
=(**)(
°ackt›
 - 
¨gc
 * (*));

741 
¨gv_size
 = 0;

742 
i
 = 0; i < 
¨gc
; i ++) {

743 
u¨gv
[
i
] = 
	`°r˝y
((*)(
°ackt›
 + 
¨gv_size
 ), 
k¨gv
[i]);

744 
¨gv_size
 +
	`°∫Àn
(
k¨gv
[
i
],
EXEC_MAX_ARG_LEN
 + 1)+1;

747 
°ackt›
 = (
uöçå_t
)
u¨gv
 - ();

748 *(*)
°ackt›
 = 
¨gc
;

750 
å≠‰ame
 *
tf
 = 
cuºít
->tf;

751 
	`mem£t
(
tf
, 0, (
å≠‰ame
));

752 
tf
->
tf_cs
 = 
USER_CS
;

753 
tf
->
tf_ds
 =Åf->
tf_es
 =Åf->
tf_ss
 = 
USER_DS
;

754 
tf
->
tf_e•
 = 
°ackt›
;

755 
tf
->
tf_eù
 = 
ñf
->
e_íåy
;

756 
tf
->
tf_eÊags
 = 
FL_IF
;

757 
ªt
 = 0;

758 
out
:

759  
ªt
;

760 
bad_˛ónup_mm≠
:

761 
	`exô_mm≠
(
mm
);

762 
bad_ñf_˛ónup_pgdú
:

763 
	`put_pgdú
(
mm
);

764 
bad_pgdú_˛ónup_mm
:

765 
	`mm_de°roy
(
mm
);

766 
bad_mm
:

767 
out
;

768 
	}
}

772 
	$put_k¨gv
(
¨gc
, **
k¨gv
) {

773 
¨gc
 > 0) {

774 
	`k‰ì
(
k¨gv
[-- 
¨gc
]);

776 
	}
}

779 
	$c›y_k¨gv
(
mm_°ru˘
 *
mm
, 
¨gc
, **
k¨gv
, c⁄° **
¨gv
) {

780 
i
, 
ªt
 = -
E_INVAL
;

781 i‡(!
	`u£r_mem_check
(
mm
, (
uöçå_t
)
¨gv
, (c⁄° *Ë* 
¨gc
, 0)) {

782  
ªt
;

784 
i
 = 0; i < 
¨gc
; i ++) {

785 *
buf„r
;

786 i‡((
buf„r
 = 
	`kmÆloc
(
EXEC_MAX_ARG_LEN
 + 1)Ë=
NULL
) {

787 
Áûed_nomem
;

789 i‡(!
	`c›y_°rög
(
mm
, 
buf„r
, 
¨gv
[
i
], 
EXEC_MAX_ARG_LEN
 + 1)) {

790 
	`k‰ì
(
buf„r
);

791 
Áûed_˛ónup
;

793 
k¨gv
[
i
] = 
buf„r
;

797 
Áûed_nomem
:

798 
ªt
 = -
E_NO_MEM
;

799 
Áûed_˛ónup
:

800 
	`put_k¨gv
(
i
, 
k¨gv
);

801  
ªt
;

802 
	}
}

807 
	$do_execve
(c⁄° *
«me
, 
¨gc
, c⁄° **
¨gv
) {

808 
	`°©ic_as£π
(
EXEC_MAX_ARG_LEN
 >
FS_MAX_FPATH_LEN
);

809 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

810 i‡(!(
¨gc
 >1 &&árg¯<
EXEC_MAX_ARG_NUM
)) {

811  -
E_INVAL
;

814 
loˇl_«me
[
PROC_NAME_LEN
 + 1];

815 
	`mem£t
(
loˇl_«me
, 0, (local_name));

817 *
k¨gv
[
EXEC_MAX_ARG_NUM
];

818 c⁄° *
∑th
;

820 
ªt
 = -
E_INVAL
;

822 
	`lock_mm
(
mm
);

823 i‡(
«me
 =
NULL
) {

824 
	`¢¥ötf
(
loˇl_«me
, ÷oˇl_«me), "<nuŒ> %d", 
cuºít
->
pid
);

827 i‡(!
	`c›y_°rög
(
mm
, 
loˇl_«me
, 
«me
, (local_name))) {

828 
	`u∆ock_mm
(
mm
);

829  
ªt
;

832 i‡((
ªt
 = 
	`c›y_k¨gv
(
mm
, 
¨gc
, 
k¨gv
, 
¨gv
)) != 0) {

833 
	`u∆ock_mm
(
mm
);

834  
ªt
;

836 
∑th
 = 
¨gv
[0];

837 
	`u∆ock_mm
(
mm
);

838 
	`fûes_˛o£Æl
(
cuºít
->
fûe•
);

841 
fd
;

842 i‡((
ªt
 = 
fd
 = 
	`sysfûe_›í
(
∑th
, 
O_RDONLY
)) < 0) {

843 
execve_exô
;

845 i‡(
mm
 !
NULL
) {

846 
	`l¸3
(
boŸ_¸3
);

847 i‡(
	`mm_cou¡_dec
(
mm
) == 0) {

848 
	`exô_mm≠
(
mm
);

849 
	`put_pgdú
(
mm
);

850 
	`mm_de°roy
(
mm
);

852 
cuºít
->
mm
 = 
NULL
;

854 
ªt
-
E_NO_MEM
;;

855 i‡((
ªt
 = 
	`lﬂd_icode
(
fd
, 
¨gc
, 
k¨gv
)) != 0) {

856 
execve_exô
;

858 
	`put_k¨gv
(
¨gc
, 
k¨gv
);

859 
	`£t_¥oc_«me
(
cuºít
, 
loˇl_«me
);

862 
execve_exô
:

863 
	`put_k¨gv
(
¨gc
, 
k¨gv
);

864 
	`do_exô
(
ªt
);

865 
	`∑nic
("ÆªadyÉxô: %e.\n", 
ªt
);

866 
	}
}

870 
	$do_yõld
() {

871 
cuºít
->
√ed_ªsched
 = 1;

873 
	}
}

879 
	$do_waô
(
pid
, *
code_°‹e
) {

880 
mm_°ru˘
 *
mm
 = 
cuºít
->mm;

881 i‡(
code_°‹e
 !
NULL
) {

882 i‡(!
	`u£r_mem_check
(
mm
, (
uöçå_t
)
code_°‹e
, (), 1)) {

883  -
E_INVAL
;

887 
¥oc_°ru˘
 *
¥oc
;

888 
boﬁ
 
öå_Êag
, 
haskid
;

889 
ª≥©
:

890 
haskid
 = 0;

891 i‡(
pid
 != 0) {

892 
¥oc
 = 
	`föd_¥oc
(
pid
);

893 i‡(
¥oc
 !
NULL
 &&Öroc->
∑ª¡
 =
cuºít
) {

894 
haskid
 = 1;

895 i‡(
¥oc
->
°©e
 =
PROC_ZOMBIE
) {

896 
found
;

901 
¥oc
 = 
cuºít
->
˝å
;

902 ; 
¥oc
 !
NULL
;Öro¯¥oc->
›å
) {

903 
haskid
 = 1;

904 i‡(
¥oc
->
°©e
 =
PROC_ZOMBIE
) {

905 
found
;

909 i‡(
haskid
) {

910 
cuºít
->
°©e
 = 
PROC_SLEEPING
;

911 
cuºít
->
waô_°©e
 = 
WT_CHILD
;

912 
	`scheduÀ
();

913 i‡(
cuºít
->
Êags
 & 
PF_EXITING
) {

914 
	`do_exô
(-
E_KILLED
);

916 
ª≥©
;

918  -
E_BAD_PROC
;

920 
found
:

921 i‡(
¥oc
 =
idÀ¥oc
 ||Öro¯=
öô¥oc
) {

922 
	`∑nic
("wait idleproc or initproc.\n");

924 i‡(
code_°‹e
 !
NULL
) {

925 *
code_°‹e
 = 
¥oc
->
exô_code
;

927 
	`loˇl_öå_ßve
(
öå_Êag
);

929 
	`unhash_¥oc
(
¥oc
);

930 
	`ªmove_löks
(
¥oc
);

932 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

933 
	`put_k°ack
(
¥oc
);

934 
	`k‰ì
(
¥oc
);

936 
	}
}

940 
	$do_kûl
(
pid
) {

941 
¥oc_°ru˘
 *
¥oc
;

942 i‡((
¥oc
 = 
	`föd_¥oc
(
pid
)Ë!
NULL
) {

943 i‡(!(
¥oc
->
Êags
 & 
PF_EXITING
)) {

944 
¥oc
->
Êags
 |
PF_EXITING
;

945 i‡(
¥oc
->
waô_°©e
 & 
WT_INTERRUPTED
) {

946 
	`wakeup_¥oc
(
¥oc
);

950  -
E_KILLED
;

952  -
E_INVAL
;

953 
	}
}

957 
	$kî√l_execve
(c⁄° *
«me
, c⁄° **
¨gv
) {

958 
¨gc
 = 0, 
ªt
;

959 
¨gv
[
¨gc
] !
NULL
) {

960 
¨gc
 ++;

962 
asm
 volatile (

964 : "˜" (
ªt
)

965 : "i" (
T_SYSCALL
), "0" (
SYS_exec
), "d" (
«me
), "c" (
¨gc
), "b" (
¨gv
)

967  
ªt
;

968 
	}
}

970 
	#__KERNEL_EXECVE
(
«me
, 
∑th
, ...) ({ \

971 c⁄° *
¨gv
[] = {
∑th
, ##
__VA_ARGS__
, 
NULL
}; \

972 
	`˝rötf
("kernel_execve:Öid = %d,Çame = \"%s\".\n", \

973 
cuºít
->
pid
, 
«me
); \

974 
	`kî√l_execve
(
«me
, 
¨gv
); \

975 })

	)

977 
	#KERNEL_EXECVE
(
x
, ...Ë
	`__KERNEL_EXECVE
(#x, #x, ##
__VA_ARGS__
)

	)

979 
	#KERNEL_EXECVE2
(
x
, ...Ë
	`KERNEL_EXECVE
(x, ##
__VA_ARGS__
)

	)

981 
	#__KERNEL_EXECVE3
(
x
, 
s
, ...Ë
	`KERNEL_EXECVE
(x, #s, ##
__VA_ARGS__
)

	)

983 
	#KERNEL_EXECVE3
(
x
, 
s
, ...Ë
	`__KERNEL_EXECVE3
(x, s, ##
__VA_ARGS__
)

	)

987 
	$u£r_maö
(*
¨g
) {

988 #ifde‡
TEST


989 #ifde‡
TESTSCRIPT


990 
	`KERNEL_EXECVE3
(
TEST
, 
TESTSCRIPT
);

992 
	`KERNEL_EXECVE2
(
TEST
);

995 
	`KERNEL_EXECVE
(
sh
);

997 
	`∑nic
("user_mainÉxecve failed.\n");

998 
	}
}

1002 
	$öô_maö
(*
¨g
) {

1003 
ªt
;

1004 i‡((
ªt
 = 
	`vfs_£t_boŸfs
("disk0:")) != 0) {

1005 
	`∑nic
("£àboŸ f†Áûed: %e.\n", 
ªt
);

1008 
size_t
 
ƒ_‰ì_∑ges_°‹e
 = 
	`ƒ_‰ì_∑ges
();

1009 
size_t
 
kî√l_Æloˇãd_°‹e
 = 
	`kÆloˇãd
();

1011 
pid
 = 
	`kî√l_thªad
(
u£r_maö
, 
NULL
, 0);

1012 i‡(
pid
 <= 0) {

1013 
	`∑nic
("create user_main failed.\n");

1015 
	`check_sync
();

1016 
	`check_sync
();

1018 
	`do_waô
(0, 
NULL
) == 0) {

1019 
	`scheduÀ
();

1022 
	`fs_˛ónup
();

1024 
	`˝rötf
("all user-modeÖrocesses have quit.\n");

1025 
	`as£π
(
öô¥oc
->
˝å
 =
NULL
 && inô¥oc->
y±r
 =NULL && inô¥oc->
›å
 == NULL);

1026 
	`as£π
(
ƒ_¥o˚ss
 == 2);

1027 
	`as£π
(
	`li°_√xt
(&
¥oc_li°
Ë=&(
öô¥oc
->
li°_lök
));

1028 
	`as£π
(
	`li°_¥ev
(&
¥oc_li°
Ë=&(
öô¥oc
->
li°_lök
));

1029 
	`as£π
(
ƒ_‰ì_∑ges_°‹e
 =
	`ƒ_‰ì_∑ges
());

1030 
	`as£π
(
kî√l_Æloˇãd_°‹e
 =
	`kÆloˇãd
());

1031 
	`˝rötf
("init check memoryÖass.\n");

1033 
	}
}

1038 
	$¥oc_öô
() {

1039 
i
;

1041 
	`li°_öô
(&
¥oc_li°
);

1042 
i
 = 0; i < 
HASH_LIST_SIZE
; i ++) {

1043 
	`li°_öô
(
hash_li°
 + 
i
);

1046 i‡((
idÀ¥oc
 = 
	`Æloc_¥oc
()Ë=
NULL
) {

1047 
	`∑nic
("cannotálloc idleproc.\n");

1050 
idÀ¥oc
->
pid
 = 0;

1051 
idÀ¥oc
->
°©e
 = 
PROC_RUNNABLE
;

1052 
idÀ¥oc
->
k°ack
 = (
uöçå_t
)
boŸ°ack
;

1053 
idÀ¥oc
->
√ed_ªsched
 = 1;

1055 i‡((
idÀ¥oc
->
fûe•
 = 
	`fûes_¸óã
()Ë=
NULL
) {

1056 
	`∑nic
("create filesp (idleproc) failed.\n");

1058 
	`fûes_cou¡_öc
(
idÀ¥oc
->
fûe•
);

1060 
	`£t_¥oc_«me
(
idÀ¥oc
, "idle");

1061 
ƒ_¥o˚ss
 ++;

1063 
cuºít
 = 
idÀ¥oc
;

1065 
pid
 = 
	`kî√l_thªad
(
öô_maö
, 
NULL
, 0);

1066 i‡(
pid
 <= 0) {

1067 
	`∑nic
("create init_main failed.\n");

1070 
öô¥oc
 = 
	`föd_¥oc
(
pid
);

1071 
	`£t_¥oc_«me
(
öô¥oc
, "init");

1073 
	`as£π
(
idÀ¥oc
 !
NULL
 && idÀ¥oc->
pid
 == 0);

1074 
	`as£π
(
öô¥oc
 !
NULL
 && inô¥oc->
pid
 == 1);

1075 
	}
}

1079 
	$˝u_idÀ
() {

1081 i‡(
cuºít
->
√ed_ªsched
) {

1082 
	`scheduÀ
();

1085 
	}
}

1089 
	$˝u_sched
()

1093 
	`°i
();

1095 i‡(
cuºít
->
√ed_ªsched
){

1100 
	}
}

1104 
	$œb6_£t_¥i‹ôy
(
uöt32_t
 
¥i‹ôy
)

1106 i‡(
¥i‹ôy
 == 0)

1107 
cuºít
->
œb6_¥i‹ôy
 = 1;

1108 
cuºít
->
œb6_¥i‹ôy
 = 
¥i‹ôy
;

1109 
	}
}

1114 
	$do_¶ìp
(
time
) {

1115 i‡(
time
 == 0) {

1118 
boﬁ
 
öå_Êag
;

1119 
	`loˇl_öå_ßve
(
öå_Êag
);

1120 
timî_t
 
__timî
, *
timî
 = 
	`timî_öô
(&__timî, 
cuºít
, 
time
);

1121 
cuºít
->
°©e
 = 
PROC_SLEEPING
;

1122 
cuºít
->
waô_°©e
 = 
WT_TIMER
;

1123 
	`add_timî
(
timî
);

1124 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

1126 
	`scheduÀ
();

1128 
	`dñ_timî
(
timî
);

1130 
	}
}

	@kern/process/proc.h

1 #i‚de‡
__KERN_PROCESS_PROC_H__


2 
	#__KERN_PROCESS_PROC_H__


	)

4 
	~<defs.h
>

5 
	~<li°.h
>

6 
	~<å≠.h
>

7 
	~<memœyout.h
>

8 
	~<skew_hóp.h
>

9 
	~<mmu.h
>

10 
	~<∑øm.h
>

13 
	#NSEGS
 7

	)

16 
	s˝u
 {

17 
uch¨
 
	mid
;

18 
c⁄ãxt
 *
	mscheduÀr
;

19 
èsk°©e
 
	mts
;

20 
£gdesc
 
	mgdt
[
NSEGS
];

21 vﬁ©ûê
uöt
 
	m°¨ãd
;

22 
	mn˛i
;

23 
	möã«
;

26 
˝u
 *
	m˝u
;

27 
¥oc_°ru˘
 *
	m¥oc
;

30 
˝u
 
˝us
[
NCPU
];

31 
n˝u
;

43 
˝u
 *˝u 
asm
("%gs:0");

44 
¥oc_°ru˘
 *
¥oc
 
asm
("%gs:4");

50 
	e¥oc_°©e
 {

51 
	mPROC_UNINIT
 = 0,

52 
	mPROC_SLEEPING
,

53 
	mPROC_RUNNABLE
,

54 
	mPROC_ZOMBIE
,

64 
	sc⁄ãxt
 {

65 
uöt32_t
 
	meù
;

66 
uöt32_t
 
	me•
;

67 
uöt32_t
 
	mebx
;

68 
uöt32_t
 
	mecx
;

69 
uöt32_t
 
	medx
;

70 
uöt32_t
 
	mesi
;

71 
uöt32_t
 
	medi
;

72 
uöt32_t
 
	mebp
;

75 
	#PROC_NAME_LEN
 50

	)

76 
	#MAX_PROCESS
 4096

	)

77 
	#MAX_PID
 (
MAX_PROCESS
 * 2)

	)

79 
li°_íåy_t
 
¥oc_li°
;

81 
	göode
;

82 
	gfs_°ru˘
;

84 
	s¥oc_°ru˘
 {

85 
¥oc_°©e
 
	m°©e
;

86 
	mpid
;

87 
	mruns
;

88 
uöçå_t
 
	mk°ack
;

89 vﬁ©ûê
boﬁ
 
	m√ed_ªsched
;

90 
¥oc_°ru˘
 *
	m∑ª¡
;

91 
mm_°ru˘
 *
	mmm
;

92 
c⁄ãxt
 
	mc⁄ãxt
;

93 
å≠‰ame
 *
	mtf
;

94 
uöçå_t
 
	m¸3
;

95 
uöt32_t
 
	mÊags
;

96 
	m«me
[
PROC_NAME_LEN
 + 1];

97 
li°_íåy_t
 
	mli°_lök
;

98 
li°_íåy_t
 
	mhash_lök
;

99 
	mexô_code
;

100 
uöt32_t
 
	mwaô_°©e
;

101 
¥oc_°ru˘
 *
	m˝å
, *
	my±r
, *
	m›å
;

102 
run_queue
 *
	mrq
;

103 
li°_íåy_t
 
	mrun_lök
;

104 
	mtime_¶i˚
;

105 
skew_hóp_íåy_t
 
	mœb6_run_poﬁ
;

106 
uöt32_t
 
	mœb6_°ride
;

107 
uöt32_t
 
	mœb6_¥i‹ôy
;

108 
fûes_°ru˘
 *
	mfûe•
;

111 
	#PF_EXITING
 0x00000001

112 

	)

113 
	#WT_INTERRUPTED
 0x80000000

114 
	#WT_CHILD
 (0x00000001 | 
WT_INTERRUPTED
)

115 
	#WT_KSEM
 0x00000100

116 
	#WT_TIMER
 (0x00000002 | 
WT_INTERRUPTED
)

117 
	#WT_KBD
 (0x00000004 | 
WT_INTERRUPTED
)

118 

	)

119 
	#À2¥oc
(
À
, 
membî
) \

120 
	`to_°ru˘
((
À
), 
¥oc_°ru˘
, 
membî
)

	)

122 
¥oc_°ru˘
 *
idÀ¥oc
, *
öô¥oc
, *
cuºít
;

124 
¥oc_öô
();

125 
¥oc_run
(
¥oc_°ru˘
 *
¥oc
);

126 
kî√l_thªad
((*
‚
)(*), *
¨g
, 
uöt32_t
 
˛⁄e_Êags
);

128 *
	`£t_¥oc_«me
(
¥oc_°ru˘
 *
¥oc
, c⁄° *
«me
);

129 *
	`gë_¥oc_«me
(
¥oc_°ru˘
 *
¥oc
);

130 
	$˝u_idÀ
(Ë
	`__©åibuã__
((
n‹ëu∫
));

133 
	`˝u_sched
();

136 
¥oc_°ru˘
 *
	`föd_¥oc
(
pid
);

137 
	`do_f‹k
(
uöt32_t
 
˛⁄e_Êags
, 
uöçå_t
 
°ack
, 
å≠‰ame
 *
tf
);

138 
	`do_exô
(
îr‹_code
);

139 
	`do_yõld
();

140 
	`do_execve
(c⁄° *
«me
, 
¨gc
, c⁄° **
¨gv
);

141 
	`do_waô
(
pid
, *
code_°‹e
);

142 
	`do_kûl
(
pid
);

144 
	`œb6_£t_¥i‹ôy
(
uöt32_t
 
¥i‹ôy
);

145 
	`do_¶ìp
(
time
);

	@kern/schedule/default_sched.c

1 
	~<defs.h
>

2 
	~<li°.h
>

3 
	~<¥oc.h
>

4 
	~<as£π.h
>

5 
	~<deÁu…_sched.h
>

7 
	#USE_SKEW_HEAP
 1

	)

11 
	#BIG_STRIDE
 0x7FFFFFFF

	)

16 
	$¥oc_°ride_comp_f
(*
a
, *
b
)

18 
¥oc_°ru˘
 *
p
 = 
	`À2¥oc
(
a
, 
œb6_run_poﬁ
);

19 
¥oc_°ru˘
 *
q
 = 
	`À2¥oc
(
b
, 
œb6_run_poﬁ
);

20 
öt32_t
 
c
 = 
p
->
œb6_°ride
 - 
q
->lab6_stride;

21 i‡(
c
 > 0)  1;

22 i‡(
c
 == 0)  0;

24 
	}
}

38 
	$°ride_öô
(
run_queue
 *
rq
) {

40 
	`li°_öô
(&(
rq
->
run_li°
));

41 
rq
->
œb6_run_poﬁ
 = 
NULL
;

42 
rq
->
¥oc_num
 = 0;

43 
	}
}

59 
	$°ride_íqueue
(
run_queue
 *
rq
, 
¥oc_°ru˘
 *
¥oc
) {

61 #i‡
USE_SKEW_HEAP


62 
rq
->
œb6_run_poﬁ
 =

63 
	`skew_hóp_ö£π
(
rq
->
œb6_run_poﬁ
, &(
¥oc
->œb6_run_poﬁ), 
¥oc_°ride_comp_f
);

65 
	`as£π
(
	`li°_em±y
(&(
¥oc
->
run_lök
)));

66 
	`li°_add_bef‹e
(&(
rq
->
run_li°
), &(
¥oc
->
run_lök
));

68 i‡(
¥oc
->
time_¶i˚
 =0 ||Öroc->time_¶i˚ > 
rq
->
max_time_¶i˚
) {

69 
¥oc
->
time_¶i˚
 = 
rq
->
max_time_¶i˚
;

71 
¥oc
->
rq
 =Ñq;

72 
rq
->
¥oc_num
 ++;

73 
	}
}

84 
	$°ride_dequeue
(
run_queue
 *
rq
, 
¥oc_°ru˘
 *
¥oc
) {

86 #i‡
USE_SKEW_HEAP


87 
rq
->
œb6_run_poﬁ
 =

88 
	`skew_hóp_ªmove
(
rq
->
œb6_run_poﬁ
, &(
¥oc
->œb6_run_poﬁ), 
¥oc_°ride_comp_f
);

90 
	`as£π
(!
	`li°_em±y
(&(
¥oc
->
run_lök
)Ë&&Öroc->
rq
 ==Ñq);

91 
	`li°_dñ_öô
(&(
¥oc
->
run_lök
));

93 
rq
->
¥oc_num
 --;

94 
	}
}

108 
¥oc_°ru˘
 *

109 
	$°ride_pick_√xt
(
run_queue
 *
rq
) {

111 #i‡
USE_SKEW_HEAP


112 i‡(
rq
->
œb6_run_poﬁ
 =
NULL
)  NULL;

113 
¥oc_°ru˘
 *
p
 = 
	`À2¥oc
(
rq
->
œb6_run_poﬁ
,Üab6_run_pool);

115 
li°_íåy_t
 *
À
 = 
	`li°_√xt
(&(
rq
->
run_li°
));

117 i‡(
À
 =&
rq
->
run_li°
)

118  
NULL
;

120 
¥oc_°ru˘
 *
p
 = 
	`À2¥oc
(
À
, 
run_lök
);

121 
À
 = 
	`li°_√xt
(le);

122 
À
 !&
rq
->
run_li°
)

124 
¥oc_°ru˘
 *
q
 = 
	`À2¥oc
(
À
, 
run_lök
);

125 i‡((
öt32_t
)(
p
->
œb6_°ride
 - 
q
->lab6_stride) > 0)

126 
p
 = 
q
;

127 
À
 = 
	`li°_√xt
(le);

130 i‡(
p
->
œb6_¥i‹ôy
 == 0)

131 
p
->
œb6_°ride
 +
BIG_STRIDE
;

132 
p
->
œb6_°ride
 +
BIG_STRIDE
 /Ö->
œb6_¥i‹ôy
;

133  
p
;

134 
	}
}

145 
	$°ride_¥oc_tick
(
run_queue
 *
rq
, 
¥oc_°ru˘
 *
¥oc
) {

147 i‡(
¥oc
->
time_¶i˚
 > 0) {

148 
¥oc
->
time_¶i˚
 --;

150 i‡(
¥oc
->
time_¶i˚
 == 0) {

151 
¥oc
->
√ed_ªsched
 = 1;

153 
	}
}

155 
sched_˛ass
 
	gdeÁu…_sched_˛ass
 = {

156 .
«me
 = "stride_scheduler",

157 .
	göô
 = 
°ride_öô
,

158 .
	gíqueue
 = 
°ride_íqueue
,

159 .
	gdequeue
 = 
°ride_dequeue
,

160 .
	gpick_√xt
 = 
°ride_pick_√xt
,

161 .
	g¥oc_tick
 = 
°ride_¥oc_tick
,

	@kern/schedule/default_sched.h

1 #i‚de‡
__KERN_SCHEDULE_SCHED_RR_H__


2 
	#__KERN_SCHEDULE_SCHED_RR_H__


	)

4 
	~<sched.h
>

6 
sched_˛ass
 
deÁu…_sched_˛ass
;

	@kern/schedule/sched.c

1 
	~<li°.h
>

2 
	~<sync.h
>

3 
	~<¥oc.h
>

4 
	~<sched.h
>

5 
	~<°dio.h
>

6 
	~<as£π.h
>

7 
	~<deÁu…_sched.h
>

9 
li°_íåy_t
 
	gtimî_li°
;

11 
sched_˛ass
 *
	gsched_˛ass
;

13 
run_queue
 *
	grq
;

15 
ölöe
 

16 
	$sched_˛ass_íqueue
(
¥oc_°ru˘
 *
¥oc
) {

17 i‡(
¥oc
 !
idÀ¥oc
) {

18 
sched_˛ass
->
	`íqueue
(
rq
, 
¥oc
);

20 
	}
}

22 
ölöe
 

23 
	$sched_˛ass_dequeue
(
¥oc_°ru˘
 *
¥oc
) {

24 
sched_˛ass
->
	`dequeue
(
rq
, 
¥oc
);

25 
	}
}

27 
ölöe
 
¥oc_°ru˘
 *

28 
	$sched_˛ass_pick_√xt
() {

29  
sched_˛ass
->
	`pick_√xt
(
rq
);

30 
	}
}

33 
	$sched_˛ass_¥oc_tick
(
¥oc_°ru˘
 *
¥oc
) {

34 i‡(
¥oc
 !
idÀ¥oc
) {

35 
sched_˛ass
->
	`¥oc_tick
(
rq
, 
¥oc
);

38 
¥oc
->
√ed_ªsched
 = 1;

40 
	}
}

42 
run_queue
 
	g__rq
;

45 
	$sched_öô
() {

46 
	`li°_öô
(&
timî_li°
);

48 
sched_˛ass
 = &
deÁu…_sched_˛ass
;

50 
rq
 = &
__rq
;

51 
rq
->
max_time_¶i˚
 = 20;

52 
sched_˛ass
->
	`öô
(
rq
);

54 
	`˝rötf
("sched cœss: %s\n", 
sched_˛ass
->
«me
);

55 
	}
}

58 
	$wakeup_¥oc
(
¥oc_°ru˘
 *
¥oc
) {

59 
	`as£π
(
¥oc
->
°©e
 !
PROC_ZOMBIE
);

60 
boﬁ
 
öå_Êag
;

61 
	`loˇl_öå_ßve
(
öå_Êag
);

63 i‡(
¥oc
->
°©e
 !
PROC_RUNNABLE
) {

64 
¥oc
->
°©e
 = 
PROC_RUNNABLE
;

65 
¥oc
->
waô_°©e
 = 0;

66 i‡(
¥oc
 !
cuºít
) {

67 
	`sched_˛ass_íqueue
(
¥oc
);

71 
	`w¨n
("wakeupÑunnableÖrocess.\n");

74 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

75 
	}
}

78 
	$scheduÀ
() {

79 
boﬁ
 
öå_Êag
;

80 
¥oc_°ru˘
 *
√xt
;

81 
	`loˇl_öå_ßve
(
öå_Êag
);

83 
cuºít
->
√ed_ªsched
 = 0;

84 i‡(
cuºít
->
°©e
 =
PROC_RUNNABLE
) {

85 
	`sched_˛ass_íqueue
(
cuºít
);

87 i‡((
√xt
 = 
	`sched_˛ass_pick_√xt
()Ë!
NULL
) {

88 
	`sched_˛ass_dequeue
(
√xt
);

90 i‡(
√xt
 =
NULL
) {

91 
√xt
 = 
idÀ¥oc
;

93 
√xt
->
runs
 ++;

94 i‡(
√xt
 !
cuºít
) {

95 
	`¥oc_run
(
√xt
);

98 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

99 
	}
}

102 
	$scheduÀ_xv6
(){

104 
	}
}

109 
	$add_timî
(
timî_t
 *
timî
) {

110 
boﬁ
 
öå_Êag
;

111 
	`loˇl_öå_ßve
(
öå_Êag
);

113 
	`as£π
(
timî
->
expúes
 > 0 &&Åimî->
¥oc
 !
NULL
);

114 
	`as£π
(
	`li°_em±y
(&(
timî
->
timî_lök
)));

115 
li°_íåy_t
 *
À
 = 
	`li°_√xt
(&
timî_li°
);

116 
À
 !&
timî_li°
) {

117 
timî_t
 *
√xt
 = 
	`À2timî
(
À
, 
timî_lök
);

118 i‡(
timî
->
expúes
 < 
√xt
->expires) {

119 
√xt
->
expúes
 -
timî
->expires;

122 
timî
->
expúes
 -
√xt
->expires;

123 
À
 = 
	`li°_√xt
(le);

125 
	`li°_add_bef‹e
(
À
, &(
timî
->
timî_lök
));

127 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

128 
	}
}

131 
	$dñ_timî
(
timî_t
 *
timî
) {

132 
boﬁ
 
öå_Êag
;

133 
	`loˇl_öå_ßve
(
öå_Êag
);

135 i‡(!
	`li°_em±y
(&(
timî
->
timî_lök
))) {

136 i‡(
timî
->
expúes
 != 0) {

137 
li°_íåy_t
 *
À
 = 
	`li°_√xt
(&(
timî
->
timî_lök
));

138 i‡(
À
 !&
timî_li°
) {

139 
timî_t
 *
√xt
 = 
	`À2timî
(
À
, 
timî_lök
);

140 
√xt
->
expúes
 +
timî
->expires;

143 
	`li°_dñ_öô
(&(
timî
->
timî_lök
));

146 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

147 
	}
}

150 
	$run_timî_li°
() {

151 
boﬁ
 
öå_Êag
;

152 
	`loˇl_öå_ßve
(
öå_Êag
);

154 
li°_íåy_t
 *
À
 = 
	`li°_√xt
(&
timî_li°
);

155 i‡(
À
 !&
timî_li°
) {

156 
timî_t
 *
timî
 = 
	`À2timî
(
À
, 
timî_lök
);

157 
	`as£π
(
timî
->
expúes
 != 0);

158 
timî
->
expúes
 --;

159 
timî
->
expúes
 == 0) {

160 
À
 = 
	`li°_√xt
(le);

161 
¥oc_°ru˘
 *
¥oc
 = 
timî
->proc;

162 i‡(
¥oc
->
waô_°©e
 != 0) {

163 
	`as£π
(
¥oc
->
waô_°©e
 & 
WT_INTERRUPTED
);

166 
	`w¨n
("¥o˚s†%d'†waô_°©ê=0.\n", 
¥oc
->
pid
);

168 
	`wakeup_¥oc
(
¥oc
);

169 
	`dñ_timî
(
timî
);

170 i‡(
À
 =&
timî_li°
) {

173 
timî
 = 
	`À2timî
(
À
, 
timî_lök
);

176 
	`sched_˛ass_¥oc_tick
(
cuºít
);

178 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

179 
	}
}

	@kern/schedule/sched.h

1 #i‚de‡
__KERN_SCHEDULE_SCHED_H__


2 
	#__KERN_SCHEDULE_SCHED_H__


	)

4 
	~<defs.h
>

5 
	~<li°.h
>

6 
	~<skew_hóp.h
>

8 
	g¥oc_°ru˘
;

11 
	mexpúes
;

12 
¥oc_°ru˘
 *
	m¥oc
;

13 
li°_íåy_t
 
	mtimî_lök
;

14 } 
	ttimî_t
;

16 
	#À2timî
(
À
, 
membî
) \

17 
	`to_°ru˘
((
À
), 
timî_t
, 
membî
)

	)

19 
ölöe
 
timî_t
 *

20 
	$timî_öô
(
timî_t
 *
timî
, 
¥oc_°ru˘
 *
¥oc
, 
expúes
) {

21 
timî
->
expúes
 =Éxpires;

22 
timî
->
¥oc
 =Öroc;

23 
	`li°_öô
(&(
timî
->
timî_lök
));

24  
timî
;

25 
	}
}

27 
	grun_queue
;

32 
	ssched_˛ass
 {

34 c⁄° *
	m«me
;

36 (*
	möô
)(
run_queue
 *
	mrq
);

38 (*
	míqueue
)(
run_queue
 *
	mrq
, 
¥oc_°ru˘
 *
	m¥oc
);

40 (*
	mdequeue
)(
run_queue
 *
	mrq
, 
¥oc_°ru˘
 *
	m¥oc
);

42 
	m¥oc_°ru˘
 *(*
	mpick_√xt
)(
run_queue
 *
	mrq
);

44 (*
	m¥oc_tick
)(
run_queue
 *
	mrq
, 
¥oc_°ru˘
 *
	m¥oc
);

54 
	srun_queue
 {

55 
li°_íåy_t
 
	mrun_li°
;

56 
	m¥oc_num
;

57 
	mmax_time_¶i˚
;

59 
skew_hóp_íåy_t
 *
	mœb6_run_poﬁ
;

62 
sched_öô
();

63 
wakeup_¥oc
(
¥oc_°ru˘
 *
¥oc
);

64 
scheduÀ
();

65 
add_timî
(
timî_t
 *
timî
);

66 
dñ_timî
(
timî_t
 *
timî
);

67 
run_timî_li°
();

69 
scheduÀr_xv6
();

	@kern/smp/ioapic.c

5 
	~"∑øm.h
"

6 
	~"defs.h
"

7 
	~"å≠.h
"

8 
	~"iﬂpic.h
"

9 
	~"mp.h
"

11 
uöt


12 
	$iﬂpi¸ód
(
ªg
)

14 
iﬂpic
->
ªg
 =Ñeg;

15  
iﬂpic
->
d©a
;

16 
	}
}

19 
	$iﬂpicwrôe
(
ªg
, 
uöt
 
d©a
)

21 
iﬂpic
->
ªg
 =Ñeg;

22 
iﬂpic
->
d©a
 = data;

23 
	}
}

26 
	$iﬂpicöô
()

28 
i
, 
id
, 
maxöå
;

30 if(!
ismp
)

33 
iﬂpic
 = (vﬁ©ûêiﬂpic*)
IOAPIC
;

34 
maxöå
 = (
	`iﬂpi¸ód
(
REG_VER
) >> 16) & 0xFF;

35 
id
 = 
	`iﬂpi¸ód
(
REG_ID
) >> 24;

36 if(
id
 !
iﬂpicid
)

37 
	`˝rötf
("ioapicinit: id isn'tÉqualÅo ioapicid;Çotá MP\n");

41 
i
 = 0; i <
maxöå
; i++){

42 
	`iﬂpicwrôe
(
REG_TABLE
+2*
i
, 
INT_DISABLED
 | (
IRQ_OFFSET
 + i));

43 
	`iﬂpicwrôe
(
REG_TABLE
+2*
i
+1, 0);

45 
	}
}

48 
	$iﬂpi˚«bÀ
(
úq
, 
˝unum
)

50 if(!
ismp
)

56 
	`iﬂpicwrôe
(
REG_TABLE
+2*
úq
, 
IRQ_OFFSET
 + irq);

57 
	`iﬂpicwrôe
(
REG_TABLE
+2*
úq
+1, 
˝unum
 << 24);

58 
	}
}

	@kern/smp/ioapic.h

1 #i‚de‡
__KERN_SMP_IOAPIC_H__


2 
	#__KERN_SMP_IOAPIC_H__


	)

4 
	~"defs.h
"

5 
	~"å≠.h
"

7 
	#IOAPIC
 0xFEC00000

8 

	)

9 
	#REG_ID
 0x00

10 
	#REG_VER
 0x01

11 
	#REG_TABLE
 0x10

12 

	)

18 
	#INT_DISABLED
 0x00010000

19 
	#INT_LEVEL
 0x00008000

20 
	#INT_ACTIVELOW
 0x00002000

21 
	#INT_LOGICAL
 0x00000800

22 

	)

23 vﬁ©ûê
iﬂpic
 *
	giﬂpic
;

26 
	siﬂpic
 {

27 
uöt
 
	mªg
;

28 
uöt
 
	m∑d
[3];

29 
uöt
 
	md©a
;

33 
iﬂpicöô
();

36 
iﬂpi˚«bÀ
(
úq
, 
˝unum
);

	@kern/smp/lapic.c

5 
	~"defs.h
"

7 
	~"memœyout.h
"

8 
	~"å≠.h
"

9 
	~"mmu.h
"

10 
	~"x86.h
"

11 
	~"œpic.h
"

48 
	$œpicw
(
ödex
, 
vÆue
)

50 
œpic
[
ödex
] = 
vÆue
;

51 
œpic
[
ID
];

52 
	}
}

56 
	$œpicöô
()

58 if(!
œpic
)

62 
	`œpicw
(
SVR
, 
ENABLE
 | (
IRQ_OFFSET
 + 
IRQ_SPURIOUS
));

68 
	`œpicw
(
TDCR
, 
X1
);

69 
	`œpicw
(
TIMER
, 
PERIODIC
 | (
IRQ_OFFSET
 + 
IRQ_TIMER
));

70 
	`œpicw
(
TICR
, 10000000);

73 
	`œpicw
(
LINT0
, 
MASKED
);

74 
	`œpicw
(
LINT1
, 
MASKED
);

78 if(((
œpic
[
VER
]>>16) & 0xFF) >= 4)

79 
	`œpicw
(
PCINT
, 
MASKED
);

82 
	`œpicw
(
ERROR
, 
IRQ_OFFSET
 + 
IRQ_ERROR
);

85 
	`œpicw
(
ESR
, 0);

86 
	`œpicw
(
ESR
, 0);

89 
	`œpicw
(
EOI
, 0);

92 
	`œpicw
(
ICRHI
, 0);

93 
	`œpicw
(
ICRLO
, 
BCAST
 | 
INIT
 | 
LEVEL
);

94 
œpic
[
ICRLO
] & 
DELIVS
)

98 
	`œpicw
(
TPR
, 0);

99 
	}
}

102 
	$˝unum
()

109 if(
	`ªadeÊags
()&
FL_IF
){

110 
n
;

111 if(
n
++ == 0)

112 
	`˝rötf
("cpu called from %x with interruptsÉnabled\n",

113 
	`__buûtö_ªtu∫_addªss
(0));

115 if(
œpic
)

116  
œpic
[
ID
]>>24;

118 
	}
}

121 
	$˝unum_v
()

128 if(
	`ªadeÊags
()&
FL_IF
){

129 
n
;

130 if(
n
++ == 0)

131 
	`˝rötf
("cpu called from %x with interruptsÉnabled\n",

132 
	`__buûtö_ªtu∫_addªss
(0));

134 if(
œpic
) {

135 
uöt
 *
vœpic
 = 
	`p2v
(
œpic
);

136  
vœpic
[
ID
]>>24;

139 
	}
}

145 
	$œpi˚oi
()

147 if(
œpic
)

148 
	`œpicw
(
EOI
, 0);

149 
	}
}

154 
	$mi¸odñay
(
us
)

156 
	}
}

158 
	#CMOS_PORT
 0x70

	)

159 
	#CMOS_RETURN
 0x71

	)

164 
	$œpic°¨èp
(
uch¨
 
≠icid
, 
uöt
 
addr
)

166 
i
;

167 
ush‹t
 *
wrv
;

172 
	`outb
(
CMOS_PORT
, 0xF);

173 
	`outb
(
CMOS_PORT
+1, 0x0A);

174 
wrv
 = (
ush‹t
*)
	`P2V
((0x40<<4 | 0x67));

175 
wrv
[0] = 0;

176 
wrv
[1] = 
addr
 >> 4;

180 
	`œpicw
(
ICRHI
, 
≠icid
<<24);

181 
	`œpicw
(
ICRLO
, 
INIT
 | 
LEVEL
 | 
ASSERT
);

182 
	`mi¸odñay
(200);

183 
	`œpicw
(
ICRLO
, 
INIT
 | 
LEVEL
);

184 
	`mi¸odñay
(100);

191 
i
 = 0; i < 2; i++){

192 
	`œpicw
(
ICRHI
, 
≠icid
<<24);

193 
	`œpicw
(
ICRLO
, 
STARTUP
 | (
addr
>>12));

194 
	`mi¸odñay
(200);

196 
	}
}

198 
	#CMOS_STATA
 0x0a

	)

199 
	#CMOS_STATB
 0x0b

	)

200 
	#CMOS_UIP
 (1 << 7)

201 

	)

202 
	#SECS
 0x00

	)

203 
	#MINS
 0x02

	)

204 
	#HOURS
 0x04

	)

205 
	#DAY
 0x07

	)

206 
	#MONTH
 0x08

	)

207 
	#YEAR
 0x09

	)

209 
uöt
 
	$cmos_ªad
(
uöt
 
ªg
)

211 
	`outb
(
CMOS_PORT
, 
ªg
);

212 
	`mi¸odñay
(200);

214  
	`öb
(
CMOS_RETURN
);

215 
	}
}

217 
	$fûl_πcd©e
(
πcd©e
 *
r
)

219 
r
->
£c⁄d
 = 
	`cmos_ªad
(
SECS
);

220 
r
->
möuã
 = 
	`cmos_ªad
(
MINS
);

221 
r
->
hour
 = 
	`cmos_ªad
(
HOURS
);

222 
r
->
day
 = 
	`cmos_ªad
(
DAY
);

223 
r
->
m⁄th
 = 
	`cmos_ªad
(
MONTH
);

224 
r
->
yór
 = 
	`cmos_ªad
(
YEAR
);

225 
	}
}

228 
	$cmo°ime
(
πcd©e
 *
r
)

230 
πcd©e
 
t1
, 
t2
;

231 
sb
, 
bcd
;

233 
sb
 = 
	`cmos_ªad
(
CMOS_STATB
);

235 
bcd
 = (
sb
 & (1 << 2)) == 0;

239 
	`fûl_πcd©e
(&
t1
);

240 i‡(
	`cmos_ªad
(
CMOS_STATA
Ë& 
CMOS_UIP
)

242 
	`fûl_πcd©e
(&
t2
);

243 i‡(
	`memcmp
(&
t1
, &
t2
, (t1)) == 0)

248 i‡(
bcd
) {

249 
	#CONV
(
x
Ë(
t1
.x = (—1.x >> 4Ë* 10Ë+ (t1.x & 0xf))

	)

250 
	`CONV
(
£c⁄d
);

251 
	`CONV
(
möuã
);

252 
	`CONV
(
hour
 );

253 
	`CONV
(
day
 );

254 
	`CONV
(
m⁄th
 );

255 
	`CONV
(
yór
 );

256 #unde‡
CONV


259 *
r
 = 
t1
;

260 
r
->
yór
 += 2000;

261 
	}
}

	@kern/smp/lapic.h

1 #i‚de‡
__KERN_SMP_LAPIC_H__


2 
	#__KERN_SMP_LAPIC_H__


	)

5 
	~"defs.h
"

7 
	~"memœyout.h
"

8 
	~"å≠.h
"

9 
	~"mmu.h
"

10 
	~"x86.h
"

11 
	~"œpic.h
"

13 
	#ID
 (0x0020/4)

14 
	#VER
 (0x0030/4)

15 
	#TPR
 (0x0080/4)

16 
	#EOI
 (0x00B0/4)

17 
	#SVR
 (0x00F0/4)

18 
	#ENABLE
 0x00000100

19 
	#ESR
 (0x0280/4)

20 
	#ICRLO
 (0x0300/4)

21 
	#INIT
 0x00000500

22 
	#STARTUP
 0x00000600

23 
	#DELIVS
 0x00001000

24 
	#ASSERT
 0x00004000

25 
	#DEASSERT
 0x00000000

	)

26 
	#LEVEL
 0x00008000

27 
	#BCAST
 0x00080000

28 
	#BUSY
 0x00001000

	)

29 
	#FIXED
 0x00000000

	)

30 
	#ICRHI
 (0x0310/4)

31 
	#TIMER
 (0x0320/4)

32 
	#X1
 0x0000000B

33 
	#PERIODIC
 0x00020000

34 
	#PCINT
 (0x0340/4)

35 
	#LINT0
 (0x0350/4)

36 
	#LINT1
 (0x0360/4)

37 
	#ERROR
 (0x0370/4)

38 
	#MASKED
 0x00010000

39 
	#TICR
 (0x0380/4)

40 
	#TCCR
 (0x0390/4)

41 
	#TDCR
 (0x03E0/4)

42 

	)

43 vﬁ©ûê
uöt
 *
	gœpic
;

46 
œpicöô
();

49 
˝unum
();

52 
œpi˚oi
();

55 
mi¸odñay
(
us
);

58 
œpic°¨èp
(
uch¨
 
≠icid
, 
uöt
 
addr
);

60 
cmo°ime
(
πcd©e
 *
r
);

	@kern/smp/mp.c

1 
	~"defs.h
"

2 
	~"memœyout.h
"

3 
	~"mp.h
"

4 
	~"x86.h
"

5 
	~"mmu.h
"

6 
	~"¥oc.h
"

7 
	~"∑øm.h
"

8 
	~"œpic.h
"

11 
˝u
 *
	gb˝u
;

14 
	$mpb˝u
()

16  
b˝u
-
˝us
;

17 
	}
}

19 
uch¨


20 
	$sum
(
uch¨
 *
addr
, 
Àn
)

22 
i
, 
sum
;

24 
sum
 = 0;

25 
i
=0; i<
Àn
; i++)

26 
sum
 +
addr
[
i
];

27  
sum
;

28 
	}
}

32 
mp
*

33 
	$mp£¨ch1
(
uöt
 
a
, 
Àn
)

35 
uch¨
 *
e
, *
p
, *
addr
;

37 
addr
 = 
	`p2v
(
a
);

38 
e
 = 
addr
+
Àn
;

39 
p
 = 
addr
;Ö < 
e
;Ö +(
mp
))

40 if(
	`memcmp
(
p
, "_MP_", 4Ë=0 && 
	`sum
’, (
mp
)) == 0)

41  (
mp
*)
p
;

43 
	}
}

52 
mp
*

53 
	$mp£¨ch
()

55 
uch¨
 *
bda
;

56 
uöt
 
p
;

57 
mp
 *mp;

59 
bda
 = (
uch¨
 *Ë
	`P2V
(0x400);

60 if((
p
 = ((
bda
[0x0F]<<8)| bda[0x0E]) << 4)){

61 if((
mp
 = 
	`mp£¨ch1
(
p
, 1024)))

62  
mp
;

64 
p
 = ((
bda
[0x14]<<8)|bda[0x13])*1024;

65 if((
mp
 = 
	`mp£¨ch1
(
p
-1024, 1024)))

66  
mp
;

68  
	`mp£¨ch1
(0xF0000, 0x10000);

69 
	}
}

77 
mpc⁄f
*

78 
	$mpc⁄fig
(
mp
 **
pmp
)

80 
mpc⁄f
 *
c⁄f
;

81 
mp
 *mp;

83 if((
mp
 = 
	`mp£¨ch
()Ë=0 || mp->
phyßddr
 == 0)

85 
c⁄f
 = (
mpc⁄f
*Ë
	`p2v
((
uöt
Ë
mp
->
phyßddr
);

86 if(
	`memcmp
(
c⁄f
, "PCMP", 4) != 0)

88 if(
c⁄f
->
vîsi⁄
 != 1 && conf->version != 4)

90 if(
	`sum
((
uch¨
*)
c⁄f
, c⁄f->
Àngth
) != 0)

92 *
pmp
 = 
mp
;

93  
c⁄f
;

94 
	}
}

97 
	$mpöô
()

99 
uch¨
 *
p
, *
e
;

100 
mp
 *mp;

101 
mpc⁄f
 *
c⁄f
;

102 
mµroc
 *
¥oc
;

103 
mpiﬂpic
 *
iﬂpic
;

105 
b˝u
 = &
˝us
[0];

106 if((
c⁄f
 = 
	`mpc⁄fig
(&
mp
)) == 0)

108 
ismp
 = 1;

109 
œpic
 = (
uöt
*)
c⁄f
->
œpiˇddr
;

110 
p
=(
uch¨
*)(
c⁄f
+1), 
e
=(uch¨*)c⁄f+c⁄f->
Àngth
;Ö<e; ){

111 *
p
){

112 
MPPROC
:

113 
¥oc
 = (
mµroc
*)
p
;

114 if(
n˝u
 !
¥oc
->
≠icid
){

115 
	`˝rötf
("mpöô:Ç˝u=%dápicid=%d\n", 
n˝u
, 
¥oc
->
≠icid
);

116 
ismp
 = 0;

118 if(
¥oc
->
Êags
 & 
MPBOOT
)

119 
b˝u
 = &
˝us
[
n˝u
];

120 
˝us
[
n˝u
].
id
 =Çcpu;

121 
n˝u
++;

122 
p
 +(
mµroc
);

124 
MPIOAPIC
:

125 
iﬂpic
 = (
mpiﬂpic
*)
p
;

126 
iﬂpicid
 = 
iﬂpic
->
≠i˙o
;

127 
p
 +(
mpiﬂpic
);

129 
MPBUS
:

130 
MPIOINTR
:

131 
MPLINTR
:

132 
p
 += 8;

135 
	`˝rötf
("mpöô: unknow¿c⁄figÅy≥ %x\n", *
p
);

136 
ismp
 = 0;

140 if(!
ismp
){

142 
n˝u
 = 1;

143 
œpic
 = 0;

144 
iﬂpicid
 = 0;

148 if(
mp
->
im¸p
){

151 
	`outb
(0x22, 0x70);

152 
	`outb
(0x23, 
	`öb
(0x23) | 1);

154 
	}
}

	@kern/smp/mp.h

1 #i‚de‡
__KERN_SMP_MP_H__


2 
	#__KERN_SMP_MP_H__


	)

5 
	~"defs.h
"

6 
	~"memœyout.h
"

7 
	~"x86.h
"

8 
	~"mmu.h
"

9 
	~"¥oc.h
"

10 
	~"defs.h
"

11 
	~"∑øm.h
"

15 
˝u
 
	g˝us
[
NCPU
];

16 
	gismp
;

17 
	gn˝u
;

18 
uch¨
 
	giﬂpicid
;

21 
	smp
 {

22 
uch¨
 
	msig«tuª
[4];

23 *
	mphyßddr
;

24 
uch¨
 
	mÀngth
;

25 
uch¨
 
	m•e¸ev
;

26 
uch¨
 
	mchecksum
;

27 
uch¨
 
	mty≥
;

28 
uch¨
 
	mim¸p
;

29 
uch¨
 
	mª£rved
[3];

32 
	smpc⁄f
 {

33 
uch¨
 
	msig«tuª
[4];

34 
ush‹t
 
	mÀngth
;

35 
uch¨
 
	mvîsi⁄
;

36 
uch¨
 
	mchecksum
;

37 
uch¨
 
	m¥odu˘
[20];

38 
uöt
 *
	m€mèbÀ
;

39 
ush‹t
 
	m€mÀngth
;

40 
ush‹t
 
	míåy
;

41 
uöt
 *
	mœpiˇddr
;

42 
ush‹t
 
	mxÀngth
;

43 
uch¨
 
	mxchecksum
;

44 
uch¨
 
	mª£rved
;

48 
	smµroc
 {

49 
uch¨
 
	mty≥
;

50 
uch¨
 
	m≠icid
;

51 
uch¨
 
	mvîsi⁄
;

52 
uch¨
 
	mÊags
;

53 
	#MPBOOT
 0x02

54 
uch¨
 
sig«tuª
[4];

55 
uöt
 
„©uª
;

56 
uch¨
 
ª£rved
[8];

	)

60 
	smpiﬂpic
 {

61 
uch¨
 
	mty≥
;

62 
uch¨
 
	m≠i˙o
;

63 
uch¨
 
	mvîsi⁄
;

64 
uch¨
 
	mÊags
;

65 
uöt
 *
	maddr
;

70 
	#MPPROC
 0x00

71 
	#MPBUS
 0x01

72 
	#MPIOAPIC
 0x02

73 
	#MPIOINTR
 0x03

74 
	#MPLINTR
 0x04

75 

	)

	@kern/sync/check_sync.c

1 
	~<°dio.h
>

2 
	~<¥oc.h
>

3 
	~<£m.h
>

4 
	~<m⁄ô‹.h
>

5 
	~<as£π.h
>

7 
	#N
 5

	)

8 
	#LEFT
 (
i
-1+
N
)%N

	)

9 
	#RIGHT
 (
i
+1)%
N


	)

10 
	#THINKING
 0

	)

11 
	#HUNGRY
 1

	)

12 
	#EATING
 2

	)

13 
	#TIMES
 4

	)

14 
	#SLEEP_TIME
 10

	)

17 
	g°©e_£ma
[
N
];

19 
£m≠h‹e_t
 
	gmuãx
;

20 
£m≠h‹e_t
 
	gs
[
N
];

22 
¥oc_°ru˘
 *
	gphûos›hî_¥oc_£ma
[
N
];

24 
	$phi_ã°_£ma
(
i
)

26 if(
°©e_£ma
[
i
]==
HUNGRY
&&°©e_£ma[
LEFT
]!=
EATING


27 &&
°©e_£ma
[
RIGHT
]!=
EATING
)

29 
°©e_£ma
[
i
]=
EATING
;

30 
	`up
(&
s
[
i
]);

32 
	}
}

34 
	$phi_èke_f‹ks_£ma
(
i
)

36 
	`down
(&
muãx
);

37 
°©e_£ma
[
i
]=
HUNGRY
;

38 
	`phi_ã°_£ma
(
i
);

39 
	`up
(&
muãx
);

40 
	`down
(&
s
[
i
]);

41 
	}
}

43 
	$phi_put_f‹ks_£ma
(
i
)

45 
	`down
(&
muãx
);

46 
°©e_£ma
[
i
]=
THINKING
;

47 
	`phi_ã°_£ma
(
LEFT
);

48 
	`phi_ã°_£ma
(
RIGHT
);

49 
	`up
(&
muãx
);

50 
	}
}

52 
	$phûos›hî_usög_£m≠h‹e
(* 
¨g
)

54 
i
, 
ôî
=0;

55 
i
=()
¨g
;

56 
	`˝rötf
("Iám No.%dÖhûos›hî_£ma\n",
i
);

57 
ôî
++<
TIMES
)

59 
	`˝rötf
("Iã∏%d, No.%dÖhûos›hî_£m®i†thökög\n",
ôî
,
i
);

60 
	`do_¶ìp
(
SLEEP_TIME
);

61 
	`phi_èke_f‹ks_£ma
(
i
);

63 
	`˝rötf
("Iã∏%d, No.%dÖhûos›hî_£m®i†ótög\n",
ôî
,
i
);

64 
	`do_¶ìp
(
SLEEP_TIME
);

65 
	`phi_put_f‹ks_£ma
(
i
);

68 
	`˝rötf
("No.%dÖhûos›hî_£m®quô\n",
i
);

70 
	}
}

106 
¥oc_°ru˘
 *
	gphûos›hî_¥oc_c⁄dv¨
[
N
];

107 
	g°©e_c⁄dv¨
[
N
];

108 
m⁄ô‹_t
 
	gmt
, *
	gmç
=&
mt
;

110 
	$phi_ã°_c⁄dv¨
 (
i
) {

111 if(
°©e_c⁄dv¨
[
i
]==
HUNGRY
&&°©e_c⁄dv¨[
LEFT
]!=
EATING


112 &&
°©e_c⁄dv¨
[
RIGHT
]!=
EATING
) {

113 
	`˝rötf
("phi_ã°_c⁄dv¨: sèã_c⁄dv¨[%d] wû»ótög\n",
i
);

114 
°©e_c⁄dv¨
[
i
] = 
EATING
 ;

115 
	`˝rötf
("phi_ã°_c⁄dv¨: sig«»£lf_cv[%d] \n",
i
);

116 
	`c⁄d_sig«l
(&
mç
->
cv
[
i
]) ;

118 
	}
}

121 
	$phi_èke_f‹ks_c⁄dv¨
(
i
) {

122 
	`down
(&(
mç
->
muãx
));

128 
°©e_c⁄dv¨
[
i
]=
HUNGRY
;

130 
	`phi_ã°_c⁄dv¨
(
i
);

131 
°©e_c⁄dv¨
[
i
] !
EATING
) {

132 
	`˝rötf
("phi_èke_f‹ks_c⁄dv¨: %d didn'àgë f‹kánd wû»waô\n",
i
);

133 
	`c⁄d_waô
(&
mç
->
cv
[
i
]);

136 if(
mç
->
√xt_cou¡
>0)

137 
	`up
(&(
mç
->
√xt
));

139 
	`up
(&(
mç
->
muãx
));

140 
	}
}

142 
	$phi_put_f‹ks_c⁄dv¨
(
i
) {

143 
	`down
(&(
mç
->
muãx
));

150 
°©e_c⁄dv¨
[
i
]=
THINKING
;

152 
	`phi_ã°_c⁄dv¨
(
LEFT
);

153 
	`phi_ã°_c⁄dv¨
(
RIGHT
);

155 if(
mç
->
√xt_cou¡
>0)

156 
	`up
(&(
mç
->
√xt
));

158 
	`up
(&(
mç
->
muãx
));

159 
	}
}

162 
	$phûos›hî_usög_c⁄dv¨
(* 
¨g
) {

164 
i
, 
ôî
=0;

165 
i
=()
¨g
;

166 
	`˝rötf
("Iám No.%dÖhûos›hî_c⁄dv¨\n",
i
);

167 
ôî
++<
TIMES
)

169 
	`˝rötf
("Iã∏%d, No.%dÖhûos›hî_c⁄dv¨ i†thökög\n",
ôî
,
i
);

170 
	`do_¶ìp
(
SLEEP_TIME
);

171 
	`phi_èke_f‹ks_c⁄dv¨
(
i
);

173 
	`˝rötf
("Iã∏%d, No.%dÖhûos›hî_c⁄dv¨ i†ótög\n",
ôî
,
i
);

174 
	`do_¶ìp
(
SLEEP_TIME
);

175 
	`phi_put_f‹ks_c⁄dv¨
(
i
);

178 
	`˝rötf
("No.%dÖhûos›hî_c⁄dv¨ quô\n",
i
);

180 
	}
}

182 
	$check_sync
(){

184 
i
;

187 
	`£m_öô
(&
muãx
, 1);

188 
i
=0;i<
N
;i++){

189 
	`£m_öô
(&
s
[
i
], 0);

190 
pid
 = 
	`kî√l_thªad
(
phûos›hî_usög_£m≠h‹e
, (*)
i
, 0);

191 i‡(
pid
 <= 0) {

192 
	`∑nic
("create No.%dÖhilosopher_using_semaphore failed.\n");

194 
phûos›hî_¥oc_£ma
[
i
] = 
	`föd_¥oc
(
pid
);

195 
	`£t_¥oc_«me
(
phûos›hî_¥oc_£ma
[
i
], "philosopher_sema_proc");

199 
	`m⁄ô‹_öô
(&
mt
, 
N
);

200 
i
=0;i<
N
;i++){

201 
°©e_c⁄dv¨
[
i
]=
THINKING
;

202 
pid
 = 
	`kî√l_thªad
(
phûos›hî_usög_c⁄dv¨
, (*)
i
, 0);

203 i‡(
pid
 <= 0) {

204 
	`∑nic
("create No.%dÖhilosopher_using_condvar failed.\n");

206 
phûos›hî_¥oc_c⁄dv¨
[
i
] = 
	`föd_¥oc
(
pid
);

207 
	`£t_¥oc_«me
(
phûos›hî_¥oc_c⁄dv¨
[
i
], "philosopher_condvar_proc");

209 
	}
}

	@kern/sync/monitor.c

1 
	~<°dio.h
>

2 
	~<m⁄ô‹.h
>

3 
	~<kmÆloc.h
>

4 
	~<as£π.h
>

9 
	$m⁄ô‹_öô
 (
m⁄ô‹_t
 * 
mç
, 
size_t
 
num_cv
) {

10 
i
;

11 
	`as£π
(
num_cv
>0);

12 
mç
->
√xt_cou¡
 = 0;

13 
mç
->
cv
 = 
NULL
;

14 
	`£m_öô
(&(
mç
->
muãx
), 1);

15 
	`£m_öô
(&(
mç
->
√xt
), 0);

16 
mç
->
cv
 =(
c⁄dv¨_t
 *Ë
	`kmÆloc
((c⁄dv¨_t)*
num_cv
);

17 
	`as£π
(
mç
->
cv
!=
NULL
);

18 
i
=0; i<
num_cv
; i++){

19 
mç
->
cv
[
i
].
cou¡
=0;

20 
	`£m_öô
(&(
mç
->
cv
[
i
].
£m
),0);

21 
mç
->
cv
[
i
].
ow√r
=mtp;

23 
	}
}

27 
	$c⁄d_sig«l
 (
c⁄dv¨_t
 *
cvp
) {

29 
	`˝rötf
("c⁄d_sig«»begö: cv∞%x, cvp->cou¡ %d, cvp->ow√r->√xt_cou¡ %d\n", 
cvp
, cvp->
cou¡
, cvp->
ow√r
->
√xt_cou¡
);

40 if(
cvp
->
cou¡
>0) {

41 
cvp
->
ow√r
->
√xt_cou¡
 ++;

42 
	`up
(&(
cvp
->
£m
));

43 
	`down
(&(
cvp
->
ow√r
->
√xt
));

44 
cvp
->
ow√r
->
√xt_cou¡
 --;

46 
	`˝rötf
("c⁄d_sig«»íd: cv∞%x, cvp->cou¡ %d, cvp->ow√r->√xt_cou¡ %d\n", 
cvp
, cvp->
cou¡
, cvp->
ow√r
->
√xt_cou¡
);

47 
	}
}

52 
	$c⁄d_waô
 (
c⁄dv¨_t
 *
cvp
) {

54 
	`˝rötf
("c⁄d_waô begö: cv∞%x, cvp->cou¡ %d, cvp->ow√r->√xt_cou¡ %d\n", 
cvp
, cvp->
cou¡
, cvp->
ow√r
->
√xt_cou¡
);

64 
cvp
->
cou¡
++;

65 if(
cvp
->
ow√r
->
√xt_cou¡
 > 0)

66 
	`up
(&(
cvp
->
ow√r
->
√xt
));

68 
	`up
(&(
cvp
->
ow√r
->
muãx
));

69 
	`down
(&(
cvp
->
£m
));

70 
cvp
->
cou¡
 --;

71 
	`˝rötf
("c⁄d_waôÉnd: cv∞%x, cvp->cou¡ %d, cvp->ow√r->√xt_cou¡ %d\n", 
cvp
, cvp->
cou¡
, cvp->
ow√r
->
√xt_cou¡
);

72 
	}
}

	@kern/sync/monitor.h

1 #i‚de‡
__KERN_SYNC_MONITOR_CONDVAR_H__


2 
	#__KERN_SYNC_MOINTOR_CONDVAR_H__


	)

4 
	~<£m.h
>

67 
m⁄ô‹
 
	tm⁄ô‹_t
;

69 
	sc⁄dv¨
{

70 
£m≠h‹e_t
 
	m£m
;

71 
	mcou¡
;

72 
m⁄ô‹_t
 * 
	mow√r
;

73 } 
	tc⁄dv¨_t
;

75 
	sm⁄ô‹
{

76 
£m≠h‹e_t
 
	mmuãx
;

77 
£m≠h‹e_t
 
	m√xt
;

78 
	m√xt_cou¡
;

79 
c⁄dv¨_t
 *
	mcv
;

80 } 
	tm⁄ô‹_t
;

83 
m⁄ô‹_öô
 (
m⁄ô‹_t
 *
cvp
, 
size_t
 
num_cv
);

85 
c⁄d_sig«l
 (
c⁄dv¨_t
 *
cvp
);

88 
c⁄d_waô
 (
c⁄dv¨_t
 *
cvp
);

	@kern/sync/sem.c

1 
	~<defs.h
>

2 
	~<waô.h
>

3 
	~<©omic.h
>

4 
	~<kmÆloc.h
>

5 
	~<£m.h
>

6 
	~<¥oc.h
>

7 
	~<sync.h
>

8 
	~<as£π.h
>

11 
	$£m_öô
(
£m≠h‹e_t
 *
£m
, 
vÆue
) {

12 
£m
->
vÆue
 = value;

13 
	`waô_queue_öô
(&(
£m
->
waô_queue
));

14 
	}
}

16 
__noölöe
 
	$__up
(
£m≠h‹e_t
 *
£m
, 
uöt32_t
 
waô_°©e
) {

17 
boﬁ
 
öå_Êag
;

18 
	`loˇl_öå_ßve
(
öå_Êag
);

20 
waô_t
 *
waô
;

21 i‡((
waô
 = 
	`waô_queue_fú°
(&(
£m
->
waô_queue
))Ë=
NULL
) {

22 
£m
->
vÆue
 ++;

25 
	`as£π
(
waô
->
¥oc
->
waô_°©e
 == wait_state);

26 
	`wakeup_waô
(&(
£m
->
waô_queue
), 
waô
, 
waô_°©e
, 1);

29 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

30 
	}
}

32 
__noölöe
 
uöt32_t
 
	$__down
(
£m≠h‹e_t
 *
£m
, 
uöt32_t
 
waô_°©e
) {

33 
boﬁ
 
öå_Êag
;

34 
	`loˇl_öå_ßve
(
öå_Êag
);

35 i‡(
£m
->
vÆue
 > 0) {

36 
£m
->
vÆue
 --;

37 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

40 
waô_t
 
__waô
, *
waô
 = &__wait;

41 
	`waô_cuºít_£t
(&(
£m
->
waô_queue
), 
waô
, 
waô_°©e
);

42 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

44 
	`scheduÀ
();

46 
	`loˇl_öå_ßve
(
öå_Êag
);

47 
	`waô_cuºít_dñ
(&(
£m
->
waô_queue
), 
waô
);

48 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

50 i‡(
waô
->
wakeup_Êags
 !
waô_°©e
) {

51  
waô
->
wakeup_Êags
;

54 
	}
}

57 
	$up
(
£m≠h‹e_t
 *
£m
) {

58 
	`__up
(
£m
, 
WT_KSEM
);

59 
	}
}

62 
	$down
(
£m≠h‹e_t
 *
£m
) {

63 
uöt32_t
 
Êags
 = 
	`__down
(
£m
, 
WT_KSEM
);

64 
	`as£π
(
Êags
 == 0);

65 
	}
}

67 
boﬁ


68 
	$åy_down
(
£m≠h‹e_t
 *
£m
) {

69 
boﬁ
 
öå_Êag
, 
ªt
 = 0;

70 
	`loˇl_öå_ßve
(
öå_Êag
);

71 i‡(
£m
->
vÆue
 > 0) {

72 
£m
->
vÆue
 --, 
ªt
 = 1;

74 
	`loˇl_öå_ª°‹e
(
öå_Êag
);

75  
ªt
;

76 
	}
}

	@kern/sync/sem.h

1 #i‚de‡
__KERN_SYNC_SEM_H__


2 
	#__KERN_SYNC_SEM_H__


	)

4 
	~<defs.h
>

5 
	~<©omic.h
>

6 
	~<waô.h
>

9 
	mvÆue
;

10 
waô_queue_t
 
	mwaô_queue
;

11 } 
	t£m≠h‹e_t
;

13 
£m_öô
(
£m≠h‹e_t
 *
£m
, 
vÆue
);

14 
up
(
£m≠h‹e_t
 *
£m
);

15 
down
(
£m≠h‹e_t
 *
£m
);

16 
boﬁ
 
åy_down
(
£m≠h‹e_t
 *
£m
);

	@kern/sync/sync.h

1 #i‚de‡
__KERN_SYNC_SYNC_H__


2 
	#__KERN_SYNC_SYNC_H__


	)

4 
	~<x86.h
>

5 
	~<öå.h
>

6 
	~<mmu.h
>

7 
	~<as£π.h
>

8 
	~<©omic.h
>

9 
	~<sched.h
>

11 
ölöe
 
boﬁ


12 
	$__öå_ßve
() {

13 i‡(
	`ªad_eÊags
(Ë& 
FL_IF
) {

14 
	`öå_dißbÀ
();

18 
	}
}

20 
ölöe
 

21 
	$__öå_ª°‹e
(
boﬁ
 
Êag
) {

22 i‡(
Êag
) {

23 
	`öå_íabÀ
();

25 
	}
}

27 
	#loˇl_öå_ßve
(
x
Ëdÿ{ x = 
	`__öå_ßve
(); } 0)

	)

28 
	#loˇl_öå_ª°‹e
(
x
Ë
	`__öå_ª°‹e
(x);

	)

	@kern/sync/wait.c

1 
	~<defs.h
>

2 
	~<li°.h
>

3 
	~<sync.h
>

4 
	~<waô.h
>

5 
	~<¥oc.h
>

8 
	$waô_öô
(
waô_t
 *
waô
, 
¥oc_°ru˘
 *
¥oc
) {

9 
waô
->
¥oc
 =Öroc;

10 
waô
->
wakeup_Êags
 = 
WT_INTERRUPTED
;

11 
	`li°_öô
(&(
waô
->
waô_lök
));

12 
	}
}

15 
	$waô_queue_öô
(
waô_queue_t
 *
queue
) {

16 
	`li°_öô
(&(
queue
->
waô_hód
));

17 
	}
}

20 
	$waô_queue_add
(
waô_queue_t
 *
queue
, 
waô_t
 *
waô
) {

21 
	`as£π
(
	`li°_em±y
(&(
waô
->
waô_lök
)Ë&& waô->
¥oc
 !
NULL
);

22 
waô
->
waô_queue
 = 
queue
;

23 
	`li°_add_bef‹e
(&(
queue
->
waô_hód
), &(
waô
->
waô_lök
));

24 
	}
}

27 
	$waô_queue_dñ
(
waô_queue_t
 *
queue
, 
waô_t
 *
waô
) {

28 
	`as£π
(!
	`li°_em±y
(&(
waô
->
waô_lök
)Ë&& waô->
waô_queue
 =
queue
);

29 
	`li°_dñ_öô
(&(
waô
->
waô_lök
));

30 
	}
}

32 
waô_t
 *

33 
	$waô_queue_√xt
(
waô_queue_t
 *
queue
, 
waô_t
 *
waô
) {

34 
	`as£π
(!
	`li°_em±y
(&(
waô
->
waô_lök
)Ë&& waô->
waô_queue
 =
queue
);

35 
li°_íåy_t
 *
À
 = 
	`li°_√xt
(&(
waô
->
waô_lök
));

36 i‡(
À
 !&(
queue
->
waô_hód
)) {

37  
	`À2waô
(
À
, 
waô_lök
);

39  
NULL
;

40 
	}
}

42 
waô_t
 *

43 
	$waô_queue_¥ev
(
waô_queue_t
 *
queue
, 
waô_t
 *
waô
) {

44 
	`as£π
(!
	`li°_em±y
(&(
waô
->
waô_lök
)Ë&& waô->
waô_queue
 =
queue
);

45 
li°_íåy_t
 *
À
 = 
	`li°_¥ev
(&(
waô
->
waô_lök
));

46 i‡(
À
 !&(
queue
->
waô_hód
)) {

47  
	`À2waô
(
À
, 
waô_lök
);

49  
NULL
;

50 
	}
}

52 
waô_t
 *

53 
	$waô_queue_fú°
(
waô_queue_t
 *
queue
) {

54 
li°_íåy_t
 *
À
 = 
	`li°_√xt
(&(
queue
->
waô_hód
));

55 i‡(
À
 !&(
queue
->
waô_hód
)) {

56  
	`À2waô
(
À
, 
waô_lök
);

58  
NULL
;

59 
	}
}

61 
waô_t
 *

62 
	$waô_queue_œ°
(
waô_queue_t
 *
queue
) {

63 
li°_íåy_t
 *
À
 = 
	`li°_¥ev
(&(
queue
->
waô_hód
));

64 i‡(
À
 !&(
queue
->
waô_hód
)) {

65  
	`À2waô
(
À
, 
waô_lök
);

67  
NULL
;

68 
	}
}

70 
boﬁ


71 
	$waô_queue_em±y
(
waô_queue_t
 *
queue
) {

72  
	`li°_em±y
(&(
queue
->
waô_hód
));

73 
	}
}

75 
boﬁ


76 
	$waô_ö_queue
(
waô_t
 *
waô
) {

77  !
	`li°_em±y
(&(
waô
->
waô_lök
));

78 
	}
}

81 
	$wakeup_waô
(
waô_queue_t
 *
queue
, 
waô_t
 *
waô
, 
uöt32_t
 
wakeup_Êags
, 
boﬁ
 
dñ
) {

82 i‡(
dñ
) {

83 
	`waô_queue_dñ
(
queue
, 
waô
);

85 
waô
->
wakeup_Êags
 = wakeup_flags;

86 
	`wakeup_¥oc
(
waô
->
¥oc
);

87 
	}
}

90 
	$wakeup_fú°
(
waô_queue_t
 *
queue
, 
uöt32_t
 
wakeup_Êags
, 
boﬁ
 
dñ
) {

91 
waô_t
 *
waô
;

92 i‡((
waô
 = 
	`waô_queue_fú°
(
queue
)Ë!
NULL
) {

93 
	`wakeup_waô
(
queue
, 
waô
, 
wakeup_Êags
, 
dñ
);

95 
	}
}

98 
	$wakeup_queue
(
waô_queue_t
 *
queue
, 
uöt32_t
 
wakeup_Êags
, 
boﬁ
 
dñ
) {

99 
waô_t
 *
waô
;

100 i‡((
waô
 = 
	`waô_queue_fú°
(
queue
)Ë!
NULL
) {

101 i‡(
dñ
) {

103 
	`wakeup_waô
(
queue
, 
waô
, 
wakeup_Êags
, 1);

104 } (
waô
 = 
	`waô_queue_fú°
(
queue
)Ë!
NULL
);

108 
	`wakeup_waô
(
queue
, 
waô
, 
wakeup_Êags
, 0);

109 } (
waô
 = 
	`waô_queue_√xt
(
queue
, waô)Ë!
NULL
);

112 
	}
}

115 
	$waô_cuºít_£t
(
waô_queue_t
 *
queue
, 
waô_t
 *
waô
, 
uöt32_t
 
waô_°©e
) {

116 
	`as£π
(
cuºít
 !
NULL
);

117 
	`waô_öô
(
waô
, 
cuºít
);

118 
cuºít
->
°©e
 = 
PROC_SLEEPING
;

119 
cuºít
->
waô_°©e
 = wait_state;

120 
	`waô_queue_add
(
queue
, 
waô
);

121 
	}
}

	@kern/sync/wait.h

1 #i‚de‡
__KERN_SYNC_WAIT_H__


2 
	#__KERN_SYNC_WAIT_H__


	)

4 
	~<li°.h
>

7 
li°_íåy_t
 
	mwaô_hód
;

8 } 
	twaô_queue_t
;

10 
	g¥oc_°ru˘
;

13 
¥oc_°ru˘
 *
	m¥oc
;

14 
uöt32_t
 
	mwakeup_Êags
;

15 
waô_queue_t
 *
	mwaô_queue
;

16 
li°_íåy_t
 
	mwaô_lök
;

17 } 
	twaô_t
;

19 
	#À2waô
(
À
, 
membî
) \

20 
	`to_°ru˘
((
À
), 
waô_t
, 
membî
)

	)

22 
waô_öô
(
waô_t
 *
waô
, 
¥oc_°ru˘
 *
¥oc
);

23 
waô_queue_öô
(
waô_queue_t
 *
queue
);

24 
waô_queue_add
(
waô_queue_t
 *
queue
, 
waô_t
 *
waô
);

25 
waô_queue_dñ
(
waô_queue_t
 *
queue
, 
waô_t
 *
waô
);

27 
waô_t
 *
waô_queue_√xt
(
waô_queue_t
 *
queue
, waô_à*
waô
);

28 
waô_t
 *
waô_queue_¥ev
(
waô_queue_t
 *
queue
, waô_à*
waô
);

29 
waô_t
 *
waô_queue_fú°
(
waô_queue_t
 *
queue
);

30 
waô_t
 *
waô_queue_œ°
(
waô_queue_t
 *
queue
);

32 
boﬁ
 
waô_queue_em±y
(
waô_queue_t
 *
queue
);

33 
boﬁ
 
waô_ö_queue
(
waô_t
 *
waô
);

34 
wakeup_waô
(
waô_queue_t
 *
queue
, 
waô_t
 *
waô
, 
uöt32_t
 
wakeup_Êags
, 
boﬁ
 
dñ
);

35 
wakeup_fú°
(
waô_queue_t
 *
queue
, 
uöt32_t
 
wakeup_Êags
, 
boﬁ
 
dñ
);

36 
wakeup_queue
(
waô_queue_t
 *
queue
, 
uöt32_t
 
wakeup_Êags
, 
boﬁ
 
dñ
);

38 
waô_cuºít_£t
(
waô_queue_t
 *
queue
, 
waô_t
 *
waô
, 
uöt32_t
 
waô_°©e
);

40 
	#waô_cuºít_dñ
(
queue
, 
waô
) \

42 i‡(
	`waô_ö_queue
(
waô
)) { \

43 
	`waô_queue_dñ
(
queue
, 
waô
); \

45 } 0)

	)

	@kern/syscall/syscall.c

1 
	~<defs.h
>

2 
	~<uni°d.h
>

3 
	~<¥oc.h
>

4 
	~<sysˇŒ.h
>

5 
	~<å≠.h
>

6 
	~<°dio.h
>

7 
	~<pmm.h
>

8 
	~<as£π.h
>

9 
	~<˛ock.h
>

10 
	~<°©.h
>

11 
	~<dúít.h
>

12 
	~<sysfûe.h
>

15 
	$sys_exô
(
uöt32_t
 
¨g
[]) {

16 
îr‹_code
 = ()
¨g
[0];

17  
	`do_exô
(
îr‹_code
);

18 
	}
}

21 
	$sys_f‹k
(
uöt32_t
 
¨g
[]) {

22 
å≠‰ame
 *
tf
 = 
cuºít
->tf;

23 
uöçå_t
 
°ack
 = 
tf
->
tf_e•
;

24  
	`do_f‹k
(0, 
°ack
, 
tf
);

25 
	}
}

28 
	$sys_waô
(
uöt32_t
 
¨g
[]) {

29 
pid
 = ()
¨g
[0];

30 *
°‹e
 = (*)
¨g
[1];

31  
	`do_waô
(
pid
, 
°‹e
);

32 
	}
}

35 
	$sys_exec
(
uöt32_t
 
¨g
[]) {

36 c⁄° *
«me
 = (c⁄° *)
¨g
[0];

37 
¨gc
 = ()
¨g
[1];

38 c⁄° **
¨gv
 = (c⁄° **)
¨g
[2];

39  
	`do_execve
(
«me
, 
¨gc
, 
¨gv
);

40 
	}
}

43 
	$sys_yõld
(
uöt32_t
 
¨g
[]) {

44  
	`do_yõld
();

45 
	}
}

48 
	$sys_kûl
(
uöt32_t
 
¨g
[]) {

49 
pid
 = ()
¨g
[0];

50  
	`do_kûl
(
pid
);

51 
	}
}

54 
	$sys_gëpid
(
uöt32_t
 
¨g
[]) {

55  
cuºít
->
pid
;

56 
	}
}

59 
	$sys_putc
(
uöt32_t
 
¨g
[]) {

60 
c
 = ()
¨g
[0];

61 
	`˝utch¨
(
c
);

63 
	}
}

66 
	$sys_pgdú
(
uöt32_t
 
¨g
[]) {

67 
	`¥öt_pgdú
();

69 
	}
}

71 
uöt32_t


72 
	$sys_gëtime
(
uöt32_t
 
¨g
[]) {

73  ()
ticks
;

74 
	}
}

75 
uöt32_t


76 
	$sys_œb6_£t_¥i‹ôy
(
uöt32_t
 
¨g
[])

78 
uöt32_t
 
¥i‹ôy
 = (uöt32_t)
¨g
[0];

79 
	`œb6_£t_¥i‹ôy
(
¥i‹ôy
);

81 
	}
}

84 
	$sys_¶ìp
(
uöt32_t
 
¨g
[]) {

85 
time
 = ()
¨g
[0];

86  
	`do_¶ìp
(
time
);

87 
	}
}

90 
	$sys_›í
(
uöt32_t
 
¨g
[]) {

91 c⁄° *
∑th
 = (c⁄° *)
¨g
[0];

92 
uöt32_t
 
›í_Êags
 = (uöt32_t)
¨g
[1];

93  
	`sysfûe_›í
(
∑th
, 
›í_Êags
);

94 
	}
}

97 
	$sys_˛o£
(
uöt32_t
 
¨g
[]) {

98 
fd
 = ()
¨g
[0];

99  
	`sysfûe_˛o£
(
fd
);

100 
	}
}

103 
	$sys_ªad
(
uöt32_t
 
¨g
[]) {

104 
fd
 = ()
¨g
[0];

105 *
ba£
 = (*)
¨g
[1];

106 
size_t
 
Àn
 = (size_t)
¨g
[2];

107  
	`sysfûe_ªad
(
fd
, 
ba£
, 
Àn
);

108 
	}
}

111 
	$sys_wrôe
(
uöt32_t
 
¨g
[]) {

112 
fd
 = ()
¨g
[0];

113 *
ba£
 = (*)
¨g
[1];

114 
size_t
 
Àn
 = (size_t)
¨g
[2];

115  
	`sysfûe_wrôe
(
fd
, 
ba£
, 
Àn
);

116 
	}
}

119 
	$sys_£ek
(
uöt32_t
 
¨g
[]) {

120 
fd
 = ()
¨g
[0];

121 
off_t
 
pos
 = (off_t)
¨g
[1];

122 
whí˚
 = ()
¨g
[2];

123  
	`sysfûe_£ek
(
fd
, 
pos
, 
whí˚
);

124 
	}
}

127 
	$sys_f°©
(
uöt32_t
 
¨g
[]) {

128 
fd
 = ()
¨g
[0];

129 
°©
 *°© = (°© *)
¨g
[1];

130  
	`sysfûe_f°©
(
fd
, 
°©
);

131 
	}
}

134 
	$sys_fsync
(
uöt32_t
 
¨g
[]) {

135 
fd
 = ()
¨g
[0];

136  
	`sysfûe_fsync
(
fd
);

137 
	}
}

140 
	$sys_gëcwd
(
uöt32_t
 
¨g
[]) {

141 *
buf
 = (*)
¨g
[0];

142 
size_t
 
Àn
 = (size_t)
¨g
[1];

143  
	`sysfûe_gëcwd
(
buf
, 
Àn
);

144 
	}
}

147 
	$sys_gëdúíåy
(
uöt32_t
 
¨g
[]) {

148 
fd
 = ()
¨g
[0];

149 
dúít
 *
dúíç
 = (dúíà*)
¨g
[1];

150  
	`sysfûe_gëdúíåy
(
fd
, 
dúíç
);

151 
	}
}

154 
	$sys_dup
(
uöt32_t
 
¨g
[]) {

155 
fd1
 = ()
¨g
[0];

156 
fd2
 = ()
¨g
[1];

157  
	`sysfûe_dup
(
fd1
, 
fd2
);

158 
	}
}

160 (*
sysˇŒs
[])(
uöt32_t
 
¨g
[]) = {

161 [
SYS_exô
] 
sys_exô
,

162 [
SYS_f‹k
] 
sys_f‹k
,

163 [
SYS_waô
] 
sys_waô
,

164 [
SYS_exec
] 
sys_exec
,

165 [
SYS_yõld
] 
sys_yõld
,

166 [
SYS_kûl
] 
sys_kûl
,

167 [
SYS_gëpid
] 
sys_gëpid
,

168 [
SYS_putc
] 
sys_putc
,

169 [
SYS_pgdú
] 
sys_pgdú
,

170 [
SYS_gëtime
] 
sys_gëtime
,

171 [
SYS_œb6_£t_¥i‹ôy
] 
sys_œb6_£t_¥i‹ôy
,

172 [
SYS_¶ìp
] 
sys_¶ìp
,

173 [
SYS_›í
] 
sys_›í
,

174 [
SYS_˛o£
] 
sys_˛o£
,

175 [
SYS_ªad
] 
sys_ªad
,

176 [
SYS_wrôe
] 
sys_wrôe
,

177 [
SYS_£ek
] 
sys_£ek
,

178 [
SYS_f°©
] 
sys_f°©
,

179 [
SYS_fsync
] 
sys_fsync
,

180 [
SYS_gëcwd
] 
sys_gëcwd
,

181 [
SYS_gëdúíåy
] 
sys_gëdúíåy
,

182 [
SYS_dup
] 
sys_dup
,

183 
	}
};

185 
	#NUM_SYSCALLS
 (((
sysˇŒs
)Ë/ ((sysˇŒs[0])))

	)

188 
	$sysˇŒ
() {

189 
å≠‰ame
 *
tf
 = 
cuºít
->tf;

190 
uöt32_t
 
¨g
[5];

191 
num
 = 
tf
->
tf_ªgs
.
ªg_óx
;

192 i‡(
num
 >0 &&Çum < 
NUM_SYSCALLS
) {

193 i‡(
sysˇŒs
[
num
] !
NULL
) {

194 
¨g
[0] = 
tf
->
tf_ªgs
.
ªg_edx
;

195 
¨g
[1] = 
tf
->
tf_ªgs
.
ªg_ecx
;

196 
¨g
[2] = 
tf
->
tf_ªgs
.
ªg_ebx
;

197 
¨g
[3] = 
tf
->
tf_ªgs
.
ªg_edi
;

198 
¨g
[4] = 
tf
->
tf_ªgs
.
ªg_esi
;

199 
tf
->
tf_ªgs
.
ªg_óx
 = 
sysˇŒs
[
num
](
¨g
);

203 
	`¥öt_å≠‰ame
(
tf
);

204 
	`∑nic
("undefined syscall %d,Öid = %d,Çame = %s.\n",

205 
num
, 
cuºít
->
pid
, cuºít->
«me
);

206 
	}
}

	@kern/syscall/syscall.h

1 #i‚de‡
__KERN_SYSCALL_SYSCALL_H__


2 
	#__KERN_SYSCALL_SYSCALL_H__


	)

4 
sysˇŒ
();

	@kern/trap/trap.c

1 
	~<defs.h
>

2 
	~<mmu.h
>

3 
	~<memœyout.h
>

4 
	~<˛ock.h
>

5 
	~<å≠.h
>

6 
	~<x86.h
>

7 
	~<°dio.h
>

8 
	~<as£π.h
>

9 
	~<c⁄sﬁe.h
>

10 
	~<vmm.h
>

11 
	~<sw≠.h
>

12 
	~<kdebug.h
>

13 
	~<uni°d.h
>

14 
	~<sysˇŒ.h
>

15 
	~<îr‹.h
>

16 
	~<sched.h
>

17 
	~<sync.h
>

18 
	~<¥oc.h
>

19 
	~<iﬂpic.h
>

20 
	~<œpic.h
>

22 
	#TICK_NUM
 100

	)

24 
	$¥öt_ticks
() {

25 
	`˝rötf
("%dÅicks\n",
TICK_NUM
);

26 #ifde‡
DEBUG_GRADE


27 
	`˝rötf
("End of Test.\n");

28 
	`∑nic
("EOT: kernel seems ok.");

30 
	}
}

38 
g©edesc
 
	gidt
[256] = {{0}};

40 
p£udodesc
 
	gidt_pd
 = {

41 (
idt
Ë- 1, (
uöçå_t
)idt

46 
	$idt_öô
() {

62 
uöçå_t
 
__ve˘‹s
[];

63 
i
;

64 
i
 = 0; i < (
idt
Ë/ (
g©edesc
); i ++) {

65 
	`SETGATE
(
idt
[
i
], 0, 
GD_KTEXT
, 
__ve˘‹s
[i], 
DPL_KERNEL
);

67 
	`SETGATE
(
idt
[
T_SYSCALL
], 1, 
GD_KTEXT
, 
__ve˘‹s
[T_SYSCALL], 
DPL_USER
);

69 
	`lidt
(&
idt_pd
);

70 
	}
}

73 
	$å≠«me
(
å≠no
) {

74 c⁄° * c⁄° 
ex˙ames
[] = {

97 i‡(
å≠no
 < (
ex˙ames
)/(const * const)) {

98  
ex˙ames
[
å≠no
];

100 i‡(
å≠no
 >
IRQ_OFFSET
 &&Årapno < IRQ_OFFSET + 16) {

104 
	}
}

107 
boﬁ


108 
	$å≠_ö_kî√l
(
å≠‰ame
 *
tf
) {

109  (
tf
->
tf_cs
 =(
uöt16_t
)
KERNEL_CS
);

110 
	}
}

112 c⁄° *
	gIA32Êags
[] = {

113 "CF", 
NULL
, "PF", NULL, "AF", NULL, "ZF", "SF",

114 "TF", "IF", "DF", "OF", 
NULL
, NULL, "NT", NULL,

115 "RF", "VM", "AC", "VIF", "VIP", "ID", 
NULL
, NULL,

119 
	$¥öt_å≠‰ame
(
å≠‰ame
 *
tf
) {

120 
	`˝rötf
("å≠‰amê© %p\n", 
tf
);

121 
	`¥öt_ªgs
(&
tf
->
tf_ªgs
);

122 
	`˝rötf
(" d† 0x----%04x\n", 
tf
->
tf_ds
);

123 
	`˝rötf
("É† 0x----%04x\n", 
tf
->
tf_es
);

124 
	`˝rötf
(" f† 0x----%04x\n", 
tf
->
tf_fs
);

125 
	`˝rötf
(" g† 0x----%04x\n", 
tf
->
tf_gs
);

126 
	`˝rötf
("Åø∞0x%08x %s\n", 
tf
->
tf_å≠no
, 
	`å≠«me
(tf->tf_trapno));

127 
	`˝rötf
("Éº 0x%08x\n", 
tf
->
tf_îr
);

128 
	`˝rötf
("Éù 0x%08x\n", 
tf
->
tf_eù
);

129 
	`˝rötf
(" c† 0x----%04x\n", 
tf
->
tf_cs
);

130 
	`˝rötf
(" fœg 0x%08x ", 
tf
->
tf_eÊags
);

132 
i
, 
j
;

133 
i
 = 0, 
j
 = 1; i < (
IA32Êags
) / (IA32flags[0]); i ++, j <<= 1) {

134 i‡((
tf
->
tf_eÊags
 & 
j
Ë&& 
IA32Êags
[
i
] !
NULL
) {

135 
	`˝rötf
("%s,", 
IA32Êags
[
i
]);

138 
	`˝rötf
("IOPL=%d\n", (
tf
->
tf_eÊags
 & 
FL_IOPL_MASK
) >> 12);

140 i‡(!
	`å≠_ö_kî√l
(
tf
)) {

141 
	`˝rötf
("É• 0x%08x\n", 
tf
->
tf_e•
);

142 
	`˝rötf
(" s† 0x----%04x\n", 
tf
->
tf_ss
);

144 
	}
}

147 
	$¥öt_ªgs
(
pushªgs
 *
ªgs
) {

148 
	`˝rötf
("Édò 0x%08x\n", 
ªgs
->
ªg_edi
);

149 
	`˝rötf
("Ésò 0x%08x\n", 
ªgs
->
ªg_esi
);

150 
	`˝rötf
("Éb∞ 0x%08x\n", 
ªgs
->
ªg_ebp
);

151 
	`˝rötf
(" oe• 0x%08x\n", 
ªgs
->
ªg_€•
);

152 
	`˝rötf
("Ébx 0x%08x\n", 
ªgs
->
ªg_ebx
);

153 
	`˝rötf
("Édx 0x%08x\n", 
ªgs
->
ªg_edx
);

154 
	`˝rötf
("Écx 0x%08x\n", 
ªgs
->
ªg_ecx
);

155 
	`˝rötf
("Éax 0x%08x\n", 
ªgs
->
ªg_óx
);

156 
	}
}

158 
ölöe
 

159 
	$¥öt_pgÁu…
(
å≠‰ame
 *
tf
) {

165 
	`˝rötf
("∑gêÁu…áà0x%08x: %c/%¯[%s].\n", 
	`r¸2
(),

166 (
tf
->
tf_îr
 & 4) ? 'U' : 'K',

167 (
tf
->
tf_îr
 & 2) ? 'W' : 'R',

168 (
tf
->
tf_îr
 & 1) ? "protection fault" : "noÖage found");

169 
	}
}

172 
	$pgÁu…_h™dÀr
(
å≠‰ame
 *
tf
) {

173 
mm_°ru˘
 *
check_mm_°ru˘
;

174 if(
check_mm_°ru˘
 !=
NULL
) {

175 
	`¥öt_pgÁu…
(
tf
);

177 
mm_°ru˘
 *
mm
;

178 i‡(
check_mm_°ru˘
 !
NULL
) {

179 
	`as£π
(
cuºít
 =
idÀ¥oc
);

180 
mm
 = 
check_mm_°ru˘
;

183 i‡(
cuºít
 =
NULL
) {

184 
	`¥öt_å≠‰ame
(
tf
);

185 
	`¥öt_pgÁu…
(
tf
);

186 
	`∑nic
("unhandledÖage fault.\n");

188 
mm
 = 
cuºít
->mm;

190  
	`do_pgÁu…
(
mm
, 
tf
->
tf_îr
, 
	`r¸2
());

191 
	}
}

193 vﬁ©ûê
	gö_sw≠_tick_evít
 = 0;

194 
mm_°ru˘
 *
check_mm_°ru˘
;

197 
	$å≠_di•©ch
(
å≠‰ame
 *
tf
) {

198 
c
;

199 
ªt
=0;

201 
tf
->
tf_å≠no
) {

202 
T_PGFLT
:

203 i‡((
ªt
 = 
	`pgÁu…_h™dÀr
(
tf
)) != 0) {

204 
	`¥öt_å≠‰ame
(
tf
);

205 i‡(
cuºít
 =
NULL
) {

206 
	`∑nic
("h™dÀÖgÁu… faûed.Ñë=%d\n", 
ªt
);

209 i‡(
	`å≠_ö_kî√l
(
tf
)) {

210 
	`∑nic
("h™dÀÖgÁu… faûed i¿kî√»mode.Ñë=%d\n", 
ªt
);

212 
	`˝rötf
("killed by kernel.\n");

213 
	`∑nic
("h™dÀ u£∏modêpgÁu… faûed.Ñë=%d\n", 
ªt
);

214 
	`do_exô
(-
E_KILLED
);

218 
T_SYSCALL
:

219 
	`sysˇŒ
();

221 
IRQ_OFFSET
 + 
IRQ_TIMER
:

223 
LAB3
 : 
If
 
some
 
∑ge
 
ª∂a˚mít
 
	`Æg‹ôhm
(
such
 
as
 
CLOCK
 
PRA
Ë
√ed
 
tick
 
to
 
ch™ge
 
the
 
¥i‹ôy
 
of
 
∑ges
,

224 
thí
 
you
 
ˇn
 
add
 
code
 
hîe
.

244 
ticks
++;

245 
	`as£π
(
cuºít
 !
NULL
);

246 
	`run_timî_li°
();

247 
	`œpi˚oi
();

249 
IRQ_OFFSET
 + 
IRQ_COM1
:

253 
IRQ_OFFSET
 + 
IRQ_KBD
:

254 
c
 = 
	`c⁄s_gëc
();

257 
	`dev_°dö_wrôe
(
c
);

258 
	`dev_°dö_wrôe
(
c
);

260 
	`œpi˚oi
();

263 
T_SWITCH_TOU
:

264 
T_SWITCH_TOK
:

265 
	`∑nic
("T_SWITCH_** ??\n");

267 
IRQ_OFFSET
 + 
IRQ_IDE1
:

268 
IRQ_OFFSET
 + 
IRQ_IDE2
:

272 
IRQ_OFFSET
 + 
IRQ_SPURIOUS
:

273 
	`˝rötf
("cpu%d: spurious interruptát %x:%x\n",

274 
˝u
->
id
, 
tf
->
tf_cs
,Åf->
tf_eù
);

275 
	`œpi˚oi
();

279 
	`¥öt_å≠‰ame
(
tf
);

280 i‡(
cuºít
 !
NULL
) {

281 
	`˝rötf
("unhandledÅrap.\n");

282 
	`do_exô
(-
E_KILLED
);

285 
	`∑nic
("unexpectedÅrap in kernel.\n");

288 
	}
}

296 
	$å≠
(
å≠‰ame
 *
tf
) {

299 i‡(
cuºít
 =
NULL
) {

300 
	`å≠_di•©ch
(
tf
);

304 
å≠‰ame
 *
Ÿf
 = 
cuºít
->
tf
;

305 
cuºít
->
tf
 =Åf;

307 
boﬁ
 
ö_kî√l
 = 
	`å≠_ö_kî√l
(
tf
);

309 
	`å≠_di•©ch
(
tf
);

311 
cuºít
->
tf
 = 
Ÿf
;

312 i‡(!
ö_kî√l
) {

313 i‡(
cuºít
->
Êags
 & 
PF_EXITING
) {

314 
	`do_exô
(-
E_KILLED
);

316 i‡(
cuºít
->
√ed_ªsched
) {

317 
	`scheduÀ
();

321 
	}
}

	@kern/trap/trap.h

1 #i‚de‡
__KERN_TRAP_TRAP_H__


2 
	#__KERN_TRAP_TRAP_H__


	)

4 
	~<defs.h
>

9 
	#T_DIVIDE
 0

10 
	#T_DEBUG
 1

11 
	#T_NMI
 2

12 
	#T_BRKPT
 3

13 
	#T_OFLOW
 4

14 
	#T_BOUND
 5

15 
	#T_ILLOP
 6

16 
	#T_DEVICE
 7

17 
	#T_DBLFLT
 8

19 
	#T_TSS
 10

20 
	#T_SEGNP
 11

21 
	#T_STACK
 12

22 
	#T_GPFLT
 13

23 
	#T_PGFLT
 14

25 
	#T_FPERR
 16

26 
	#T_ALIGN
 17

27 
	#T_MCHK
 18

28 
	#T_SIMDERR
 19

29 

	)

31 
	#IRQ_OFFSET
 32

32 

	)

33 
	#IRQ_TIMER
 0

	)

34 
	#IRQ_KBD
 1

	)

35 
	#IRQ_COM1
 4

	)

36 
	#IRQ_IDE1
 14

	)

37 
	#IRQ_IDE2
 15

	)

38 
	#IRQ_ERROR
 19

	)

39 
	#IRQ_SPURIOUS
 31

	)

45 
	#T_SWITCH_TOU
 120

46 
	#T_SWITCH_TOK
 121

47 

	)

49 
	spushªgs
 {

50 
uöt32_t
 
	mªg_edi
;

51 
uöt32_t
 
	mªg_esi
;

52 
uöt32_t
 
	mªg_ebp
;

53 
uöt32_t
 
	mªg_€•
;

54 
uöt32_t
 
	mªg_ebx
;

55 
uöt32_t
 
	mªg_edx
;

56 
uöt32_t
 
	mªg_ecx
;

57 
uöt32_t
 
	mªg_óx
;

60 
	så≠‰ame
 {

61 
pushªgs
 
	mtf_ªgs
;

62 
uöt16_t
 
	mtf_gs
;

63 
uöt16_t
 
	mtf_∑ddög0
;

64 
uöt16_t
 
	mtf_fs
;

65 
uöt16_t
 
	mtf_∑ddög1
;

66 
uöt16_t
 
	mtf_es
;

67 
uöt16_t
 
	mtf_∑ddög2
;

68 
uöt16_t
 
	mtf_ds
;

69 
uöt16_t
 
	mtf_∑ddög3
;

70 
uöt32_t
 
	mtf_å≠no
;

72 
uöt32_t
 
	mtf_îr
;

73 
uöçå_t
 
	mtf_eù
;

74 
uöt16_t
 
	mtf_cs
;

75 
uöt16_t
 
	mtf_∑ddög4
;

76 
uöt32_t
 
	mtf_eÊags
;

78 
uöçå_t
 
	mtf_e•
;

79 
uöt16_t
 
	mtf_ss
;

80 
uöt16_t
 
	mtf_∑ddög5
;

81 } 
__©åibuã__
((
∑cked
));

83 
idt_öô
();

84 
¥öt_å≠‰ame
(
å≠‰ame
 *
tf
);

85 
¥öt_ªgs
(
pushªgs
 *
ªgs
);

86 
boﬁ
 
å≠_ö_kî√l
(
å≠‰ame
 *
tf
);

	@libs/atomic.h

1 #i‚de‡
__LIBS_ATOMIC_H__


2 
	#__LIBS_ATOMIC_H__


	)

6 
ölöe
 
	$£t_bô
(
ƒ
, vﬁ©ûê*
addr
Ë
	`__©åibuã__
((
Æways_ölöe
));

7 
ölöe
 
	$˛ór_bô
(
ƒ
, vﬁ©ûê*
addr
Ë
	`__©åibuã__
((
Æways_ölöe
));

8 
ölöe
 
	$ch™ge_bô
(
ƒ
, vﬁ©ûê*
addr
Ë
	`__©åibuã__
((
Æways_ölöe
));

9 
ölöe
 
boﬁ
 
	$ã°_™d_£t_bô
(
ƒ
, vﬁ©ûê*
addr
Ë
	`__©åibuã__
((
Æways_ölöe
));

10 
ölöe
 
boﬁ
 
	$ã°_™d_˛ór_bô
(
ƒ
, vﬁ©ûê*
addr
Ë
	`__©åibuã__
((
Æways_ölöe
));

11 
ölöe
 
boﬁ
 
	$ã°_bô
(
ƒ
, vﬁ©ûê*
addr
Ë
	`__©åibuã__
((
Æways_ölöe
));

21 
ölöe
 

22 
	$£t_bô
(
ƒ
, vﬁ©ûê*
addr
) {

23 
asm
 vﬁ©ûê("bt¶ %1, %0" :"=m" (*(vﬁ©ûê*)
addr
Ë: "Ir" (
ƒ
));

24 
	}
}

31 
ölöe
 

32 
	$˛ór_bô
(
ƒ
, vﬁ©ûê*
addr
) {

33 
asm
 vﬁ©ûê("bå»%1, %0" :"=m" (*(vﬁ©ûê*)
addr
Ë: "Ir" (
ƒ
));

34 
	}
}

41 
ölöe
 

42 
	$ch™ge_bô
(
ƒ
, vﬁ©ûê*
addr
) {

43 
asm
 vﬁ©ûê("bt˛ %1, %0" :"=m" (*(vﬁ©ûê*)
addr
Ë: "Ir" (
ƒ
));

44 
	}
}

51 
ölöe
 
boﬁ


52 
	$ã°_bô
(
ƒ
, vﬁ©ûê*
addr
) {

53 
ﬁdbô
;

54 
asm
 vﬁ©ûê("bé %2, %1; sbb»%0,%0" : "Ù" (
ﬁdbô
Ë: "m" (*(vﬁ©ûê*)
addr
), "Ir" (
ƒ
));

55  
ﬁdbô
 != 0;

56 
	}
}

63 
ölöe
 
boﬁ


64 
	$ã°_™d_£t_bô
(
ƒ
, vﬁ©ûê*
addr
) {

65 
ﬁdbô
;

66 
asm
 vﬁ©ûê("bt¶ %2, %1; sbb»%0, %0" : "Ù" (
ﬁdbô
), "=m" (*(vﬁ©ûê*)
addr
Ë: "Ir" (
ƒ
) : "memory");

67  
ﬁdbô
 != 0;

68 
	}
}

75 
ölöe
 
boﬁ


76 
	$ã°_™d_˛ór_bô
(
ƒ
, vﬁ©ûê*
addr
) {

77 
ﬁdbô
;

78 
asm
 vﬁ©ûê("bå»%2, %1; sbb»%0, %0" : "Ù" (
ﬁdbô
), "=m" (*(vﬁ©ûê*)
addr
Ë: "Ir" (
ƒ
) : "memory");

79  
ﬁdbô
 != 0;

80 
	}
}

	@libs/defs.h

1 #i‚de‡
__LIBS_DEFS_H__


2 
	#__LIBS_DEFS_H__


	)

4 #i‚de‡
NULL


5 
	#NULL
 ((*)0)

	)

8 
	#__Æways_ölöe
 
ölöe
 
	`__©åibuã__
((
Æways_ölöe
))

	)

9 
	#__noölöe
 
	`__©åibuã__
((
noölöe
))

	)

10 
	#__n‹ëu∫
 
	`__©åibuã__
((
n‹ëu∫
))

	)

12 
	#CHAR_BIT
 8

	)

15 
	tboﬁ
;

18 
	töt8_t
;

19 
	tuöt8_t
;

20 
	töt16_t
;

21 
	tuöt16_t
;

22 
	töt32_t
;

23 
	tuöt32_t
;

24 
	töt64_t
;

25 
	tuöt64_t
;

30 
	tuöt
;

31 
	tush‹t
;

32 
	tuch¨
;

33 
uöt
 
	tpde_t
;

36 
	sπcd©e
 {

37 
uöt
 
	m£c⁄d
;

38 
uöt
 
	mmöuã
;

39 
uöt
 
	mhour
;

40 
uöt
 
	mday
;

41 
uöt
 
	mm⁄th
;

42 
uöt
 
	myór
;

51 
öt32_t
 
	töçå_t
;

52 
uöt32_t
 
	tuöçå_t
;

55 
uöçå_t
 
	tsize_t
;

58 
öçå_t
 
	toff_t
;

61 
size_t
 
	tµn_t
;

67 
	#ROUNDDOWN
(
a
, 
n
) ({ \

68 
size_t
 
__a
 = (size_t)(
a
); \

69 (
	`ty≥of
(
a
))(
__a
 - __®% (
n
)); \

70 })

	)

73 
	#ROUNDUP
(
a
, 
n
) ({ \

74 
size_t
 
__n
 = (size_t)(
n
); \

75 (
	`ty≥of
(
a
))(
	`ROUNDDOWN
((
size_t
)◊Ë+ 
__n
 - 1, __n)); \

76 })

	)

79 
	#ROUNDUP_DIV
(
a
, 
n
) ({ \

80 
uöt32_t
 
__n
 = (uöt32_t)(
n
); \

81 (
	`ty≥of
(
a
))((◊Ë+ 
__n
 - 1) / __n); \

82 })

	)

85 
	#off£tof
(
ty≥
, 
membî
) \

86 ((
size_t
)(&((
ty≥
 *)0)->
membî
))

	)

94 
	#to_°ru˘
(
±r
, 
ty≥
, 
membî
) \

95 ((
ty≥
 *)((*)(
±r
Ë- 
	`off£tof
—y≥, 
membî
)))

	)

	@libs/dirent.h

1 #i‚de‡
__LIBS_DIRENT_H__


2 
	#__LIBS_DIRENT_H__


	)

4 
	~<defs.h
>

5 
	~<uni°d.h
>

7 
	sdúít
 {

8 
off_t
 
	moff£t
;

9 
	m«me
[
FS_MAX_FNAME_LEN
 + 1];

	@libs/elf.h

1 #i‚de‡
__LIBS_ELF_H__


2 
	#__LIBS_ELF_H__


	)

4 
	~<defs.h
>

6 
	#ELF_MAGIC
 0x464C457FU

7 

	)

9 
	sñfhdr
 {

10 
uöt32_t
 
	me_magic
;

11 
uöt8_t
 
	me_ñf
[12];

12 
uöt16_t
 
	me_ty≥
;

13 
uöt16_t
 
	me_machöe
;

14 
uöt32_t
 
	me_vîsi⁄
;

15 
uöt32_t
 
	me_íåy
;

16 
uöt32_t
 
	me_phoff
;

17 
uöt32_t
 
	me_shoff
;

18 
uöt32_t
 
	me_Êags
;

19 
uöt16_t
 
	me_ehsize
;

20 
uöt16_t
 
	me_phítsize
;

21 
uöt16_t
 
	me_phnum
;

22 
uöt16_t
 
	me_shítsize
;

23 
uöt16_t
 
	me_shnum
;

24 
uöt16_t
 
	me_sh°∫dx
;

28 
	s¥oghdr
 {

29 
uöt32_t
 
	mp_ty≥
;

30 
uöt32_t
 
	mp_off£t
;

31 
uöt32_t
 
	mp_va
;

32 
uöt32_t
 
	mp_∑
;

33 
uöt32_t
 
	mp_fûesz
;

34 
uöt32_t
 
	mp_memsz
;

35 
uöt32_t
 
	mp_Êags
;

36 
uöt32_t
 
	mp_Æign
;

40 
	#ELF_PT_LOAD
 1

	)

43 
	#ELF_PF_X
 1

	)

44 
	#ELF_PF_W
 2

	)

45 
	#ELF_PF_R
 4

	)

	@libs/error.h

1 #i‚de‡
__LIBS_ERROR_H__


2 
	#__LIBS_ERROR_H__


	)

5 
	#E_UNSPECIFIED
 1

6 
	#E_BAD_PROC
 2

7 
	#E_INVAL
 3

8 
	#E_NO_MEM
 4

9 
	#E_NO_FREE_PROC
 5

10 
	#E_FAULT
 6

11 
	#E_SWAP_FAULT
 7

12 
	#E_INVAL_ELF
 8

13 
	#E_KILLED
 9

14 
	#E_PANIC
 10

15 
	#E_TIMEOUT
 11

16 
	#E_TOO_BIG
 12

17 
	#E_NO_DEV
 13

18 
	#E_NA_DEV
 14

19 
	#E_BUSY
 15

20 
	#E_NOENT
 16

21 
	#E_ISDIR
 17

22 
	#E_NOTDIR
 18

23 
	#E_XDEV
 19

24 
	#E_UNIMP
 20

25 
	#E_SEEK
 21

26 
	#E_MAX_OPEN
 22

27 
	#E_EXISTS
 23

28 
	#E_NOTEMPTY
 24

29 

	)

30 
	#MAXERROR
 24

	)

	@libs/hash.c

1 
	~<°dlib.h
>

4 
	#GOLDEN_RATIO_PRIME_32
 0x9e370001UL

	)

13 
uöt32_t


14 
	$hash32
(
uöt32_t
 
vÆ
, 
bôs
) {

15 
uöt32_t
 
hash
 = 
vÆ
 * 
GOLDEN_RATIO_PRIME_32
;

16  (
hash
 >> (32 - 
bôs
));

17 
	}
}

	@libs/list.h

1 #i‚de‡
__LIBS_LIST_H__


2 
	#__LIBS_LIST_H__


	)

4 #i‚de‡
__ASSEMBLER__


6 
	~<defs.h
>

17 
	sli°_íåy
 {

18 
li°_íåy
 *
	m¥ev
, *
	m√xt
;

21 
li°_íåy
 
	tli°_íåy_t
;

23 
ölöe
 
	$li°_öô
(
li°_íåy_t
 *
ñm
Ë
	`__©åibuã__
((
Æways_ölöe
));

24 
ölöe
 
	$li°_add
(
li°_íåy_t
 *
li°ñm
,Üi°_íåy_à*
ñm
Ë
	`__©åibuã__
((
Æways_ölöe
));

25 
ölöe
 
	$li°_add_bef‹e
(
li°_íåy_t
 *
li°ñm
,Üi°_íåy_à*
ñm
Ë
	`__©åibuã__
((
Æways_ölöe
));

26 
ölöe
 
	$li°_add_a·î
(
li°_íåy_t
 *
li°ñm
,Üi°_íåy_à*
ñm
Ë
	`__©åibuã__
((
Æways_ölöe
));

27 
ölöe
 
	$li°_dñ
(
li°_íåy_t
 *
li°ñm
Ë
	`__©åibuã__
((
Æways_ölöe
));

28 
ölöe
 
	$li°_dñ_öô
(
li°_íåy_t
 *
li°ñm
Ë
	`__©åibuã__
((
Æways_ölöe
));

29 
ölöe
 
boﬁ
 
	$li°_em±y
(
li°_íåy_t
 *
li°
Ë
	`__©åibuã__
((
Æways_ölöe
));

30 
ölöe
 
li°_íåy_t
 *
	$li°_√xt
(
li°_íåy_t
 *
li°ñm
Ë
	`__©åibuã__
((
Æways_ölöe
));

31 
ölöe
 
li°_íåy_t
 *
	$li°_¥ev
(
li°_íåy_t
 *
li°ñm
Ë
	`__©åibuã__
((
Æways_ölöe
));

33 
ölöe
 
	$__li°_add
(
li°_íåy_t
 *
ñm
,Üi°_íåy_à*
¥ev
,Üi°_íåy_à*
√xt
Ë
	`__©åibuã__
((
Æways_ölöe
));

34 
ölöe
 
	$__li°_dñ
(
li°_íåy_t
 *
¥ev
,Üi°_íåy_à*
√xt
Ë
	`__©åibuã__
((
Æways_ölöe
));

40 
ölöe
 

41 
	$li°_öô
(
li°_íåy_t
 *
ñm
) {

42 
ñm
->
¥ev
 =Élm->
√xt
 =Élm;

43 
	}
}

53 
ölöe
 

54 
	$li°_add
(
li°_íåy_t
 *
li°ñm
,Üi°_íåy_à*
ñm
) {

55 
	`li°_add_a·î
(
li°ñm
, 
ñm
);

56 
	}
}

66 
ölöe
 

67 
	$li°_add_bef‹e
(
li°_íåy_t
 *
li°ñm
,Üi°_íåy_à*
ñm
) {

68 
	`__li°_add
(
ñm
, 
li°ñm
->
¥ev
,Üistelm);

69 
	}
}

79 
ölöe
 

80 
	$li°_add_a·î
(
li°_íåy_t
 *
li°ñm
,Üi°_íåy_à*
ñm
) {

81 
	`__li°_add
(
ñm
, 
li°ñm
,Üi°ñm->
√xt
);

82 
	}
}

91 
ölöe
 

92 
	$li°_dñ
(
li°_íåy_t
 *
li°ñm
) {

93 
	`__li°_dñ
(
li°ñm
->
¥ev
,Üi°ñm->
√xt
);

94 
	}
}

102 
ölöe
 

103 
	$li°_dñ_öô
(
li°_íåy_t
 *
li°ñm
) {

104 
	`li°_dñ
(
li°ñm
);

105 
	`li°_öô
(
li°ñm
);

106 
	}
}

112 
ölöe
 
boﬁ


113 
	$li°_em±y
(
li°_íåy_t
 *
li°
) {

114  
li°
->
√xt
 ==Üist;

115 
	}
}

121 
ölöe
 
li°_íåy_t
 *

122 
	$li°_√xt
(
li°_íåy_t
 *
li°ñm
) {

123  
li°ñm
->
√xt
;

124 
	}
}

130 
ölöe
 
li°_íåy_t
 *

131 
	$li°_¥ev
(
li°_íåy_t
 *
li°ñm
) {

132  
li°ñm
->
¥ev
;

133 
	}
}

141 
ölöe
 

142 
	$__li°_add
(
li°_íåy_t
 *
ñm
,Üi°_íåy_à*
¥ev
,Üi°_íåy_à*
√xt
) {

143 
¥ev
->
√xt
 =Çext->¥ev = 
ñm
;

144 
ñm
->
√xt
 =Çext;

145 
ñm
->
¥ev
 =Örev;

146 
	}
}

154 
ölöe
 

155 
	$__li°_dñ
(
li°_íåy_t
 *
¥ev
,Üi°_íåy_à*
√xt
) {

156 
¥ev
->
√xt
 =Çext;

157 
√xt
->
¥ev
 =Örev;

158 
	}
}

	@libs/param.h

1 
	#NPROC
 64

3 
	#NCPU
 8

4 
	#NOFILE
 16

5 
	#NFILE
 100

6 
	#NINODE
 50

7 
	#NDEV
 10

8 
	#ROOTDEV
 1

9 
	#MAXARG
 32

10 
	#MAXOPBLOCKS
 10

11 
	#LOGSIZE
 (
MAXOPBLOCKS
*3)

12 
	#NBUF
 (
MAXOPBLOCKS
*3)

13 

	)

	@libs/printfmt.c

1 
	~<defs.h
>

2 
	~<x86.h
>

3 
	~<îr‹.h
>

4 
	~<°dio.h
>

5 
	~<°rög.h
>

6 
	~<uni°d.h
>

18 c⁄° * c⁄° 
	gîr‹_°rög
[
MAXERROR
 + 1] = {

19 [0] 
NULL
,

20 [
E_UNSPECIFIED
] "unspecifiedÉrror",

21 [
E_BAD_PROC
] "badÖrocess",

22 [
E_INVAL
] "invalidÖarameter",

23 [
E_NO_MEM
] "out of memory",

24 [
E_NO_FREE_PROC
] "out ofÖrocesses",

25 [
E_FAULT
] "segmentation fault",

26 [
E_INVAL_ELF
] "invalidÉlf file",

27 [
E_KILLED
] "process is killed",

28 [
E_PANIC
] "panic failure",

29 [
E_NO_DEV
] "no such device",

30 [
E_NA_DEV
] "deviceÇotávailable",

31 [
E_BUSY
] "device/file is busy",

32 [
E_NOENT
] "no such file or directory",

33 [
E_ISDIR
] "isá directory",

34 [
E_NOTDIR
] "notá directory",

35 [
E_XDEV
] "cross deviceÜink",

36 [
E_UNIMP
] "unimplemented feature",

37 [
E_SEEK
] "illegal seek",

38 [
E_MAX_OPEN
] "too many filesáre open",

39 [
E_EXISTS
] "file or directoryálreadyÉxists",

40 [
E_NOTEMPTY
] "directory isÇotÉmpty",

54 
¥öäum
((*
putch
)(, *, ), 
fd
, *
putd©
,

55 
num
, 
ba£
, 
width
, 
∑dc
) {

56 
ªsu…
 = 
num
;

57 
mod
 = 
	`do_div
(
ªsu…
, 
ba£
);

60 i‡(
num
 >
ba£
) {

61 
	`¥öäum
(
putch
, 
fd
, 
putd©
, 
ªsu…
, 
ba£
, 
width
 - 1, 
∑dc
);

64 -- 
width
 > 0)

65 
	`putch
(
∑dc
, 
putd©
, 
fd
);

68 
	`putch
("0123456789abcdef"[
mod
], 
putd©
, 
fd
);

69 
	}
}

77 
	$gëuöt
(
va_li°
 *
≠
, 
lÊag
) {

78 i‡(
lÊag
 >= 2) {

79  
	`va_¨g
(*
≠
, );

81 i‡(
lÊag
) {

82  
	`va_¨g
(*
≠
, );

85  
	`va_¨g
(*
≠
, );

87 
	}
}

95 
	$gëöt
(
va_li°
 *
≠
, 
lÊag
) {

96 i‡(
lÊag
 >= 2) {

97  
	`va_¨g
(*
≠
, );

99 i‡(
lÊag
) {

100  
	`va_¨g
(*
≠
, );

103  
	`va_¨g
(*
≠
, );

105 
	}
}

115 
¥ötfmt
((*
putch
)(, *, ), 
fd
, *
putd©
, c⁄° *
fmt
, ...) {

116 
va_li°
 
≠
;

118 
	`va_°¨t
(
≠
, 
fmt
);

119 
	`v¥ötfmt
(
putch
, 
fd
, 
putd©
, 
fmt
, 
≠
);

120 
	`va_íd
(
≠
);

121 
	}
}

136 
v¥ötfmt
((*
putch
)(, *, ), 
fd
, *
putd©
, c⁄° *
fmt
, 
va_li°
 
≠
) {

137 c⁄° *
p
;

138 
ch
, 
îr
;

139 
num
;

140 
ba£
, 
width
, 
¥ecisi⁄
, 
lÊag
, 
ÆtÊag
;

143 (
ch
 = *(*)
fmt
 ++) != '%') {

144 i‡(
ch
 == '\0') {

147 
	`putch
(
ch
, 
putd©
, 
fd
);

151 
∑dc
 = ' ';

152 
width
 = 
¥ecisi⁄
 = -1;

153 
lÊag
 = 
ÆtÊag
 = 0;

155 
ªswôch
:

156 
ch
 = *(*)
fmt
 ++) {

160 
∑dc
 = '-';

161 
ªswôch
;

165 
∑dc
 = '0';

166 
ªswôch
;

170 
¥ecisi⁄
 = 0; ; ++ 
fmt
) {

171 
¥ecisi⁄
 =Öªcisi⁄ * 10 + 
ch
 - '0';

172 
ch
 = *
fmt
;

173 i‡(
ch
 < '0' || ch > '9') {

177 
¥o˚ss_¥ecisi⁄
;

180 
¥ecisi⁄
 = 
	`va_¨g
(
≠
, );

181 
¥o˚ss_¥ecisi⁄
;

184 i‡(
width
 < 0)

185 
width
 = 0;

186 
ªswôch
;

189 
ÆtÊag
 = 1;

190 
ªswôch
;

192 
¥o˚ss_¥ecisi⁄
:

193 i‡(
width
 < 0)

194 
width
 = 
¥ecisi⁄
,Örecision = -1;

195 
ªswôch
;

199 
lÊag
 ++;

200 
ªswôch
;

204 
	`putch
(
	`va_¨g
(
≠
, ), 
putd©
, 
fd
);

209 
îr
 = 
	`va_¨g
(
≠
, );

210 i‡(
îr
 < 0) {

211 
îr
 = -err;

213 i‡(
îr
 > 
MAXERROR
 || (
p
 = 
îr‹_°rög
[îr]Ë=
NULL
) {

214 
	`¥ötfmt
(
putch
, 
fd
, 
putd©
, "îr‹ %d", 
îr
);

217 
	`¥ötfmt
(
putch
, 
fd
, 
putd©
, "%s", 
p
);

223 i‡((
p
 = 
	`va_¨g
(
≠
, *)Ë=
NULL
) {

224 
p
 = "(null)";

226 i‡(
width
 > 0 && 
∑dc
 != '-') {

227 
width
 -
	`°∫Àn
(
p
, 
¥ecisi⁄
); width > 0; width --) {

228 
	`putch
(
∑dc
, 
putd©
, 
fd
);

231 ; (
ch
 = *
p
 ++Ë!'\0' && (
¥ecisi⁄
 < 0 || --Öªcisi⁄ >0); 
width
 --) {

232 i‡(
ÆtÊag
 && (
ch
 < ' ' || ch > '~')) {

233 
	`putch
('?', 
putd©
, 
fd
);

236 
	`putch
(
ch
, 
putd©
, 
fd
);

239 ; 
width
 > 0; width --) {

240 
	`putch
(' ', 
putd©
, 
fd
);

246 
num
 = 
	`gëöt
(&
≠
, 
lÊag
);

247 i‡(()
num
 < 0) {

248 
	`putch
('-', 
putd©
, 
fd
);

249 
num
 = -()num;

251 
ba£
 = 10;

252 
numbî
;

256 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

257 
ba£
 = 10;

258 
numbî
;

262 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

263 
ba£
 = 8;

264 
numbî
;

268 
	`putch
('0', 
putd©
, 
fd
);

269 
	`putch
('x', 
putd©
, 
fd
);

270 
num
 = ()(
uöçå_t
)
	`va_¨g
(
≠
, *);

271 
ba£
 = 16;

272 
numbî
;

276 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

277 
ba£
 = 16;

278 
numbî
:

279 
	`¥öäum
(
putch
, 
fd
, 
putd©
, 
num
, 
ba£
, 
width
, 
∑dc
);

284 
	`putch
(
ch
, 
putd©
, 
fd
);

289 
	`putch
('%', 
putd©
, 
fd
);

290 
fmt
 --; fmt[-1] != '%'; fmt --)

295 
	}
}

298 
	s•rötbuf
 {

299 *
	mbuf
;

300 *
	mebuf
;

301 
	m˙t
;

310 
	$•röçutch
(
ch
, 
•rötbuf
 *
b
) {

311 
b
->
˙t
 ++;

312 i‡(
b
->
buf
 < b->
ebuf
) {

313 *
b
->
buf
 ++ = 
ch
;

315 
	}
}

324 
	$¢¥ötf
(*
°r
, 
size_t
 
size
, c⁄° *
fmt
, ...) {

325 
va_li°
 
≠
;

326 
˙t
;

327 
	`va_°¨t
(
≠
, 
fmt
);

328 
˙t
 = 
	`v¢¥ötf
(
°r
, 
size
, 
fmt
, 
≠
);

329 
	`va_íd
(
≠
);

330  
˙t
;

331 
	}
}

348 
	$v¢¥ötf
(*
°r
, 
size_t
 
size
, c⁄° *
fmt
, 
va_li°
 
≠
) {

349 
•rötbuf
 
b
 = {
°r
, så + 
size
 - 1, 0};

350 i‡(
°r
 =
NULL
 || 
b
.
buf
 > b.
ebuf
) {

351  -
E_INVAL
;

354 
	`v¥ötfmt
((*)
•röçutch
, 
NO_FD
, &
b
, 
fmt
, 
≠
);

356 *
b
.
buf
 = '\0';

357  
b
.
˙t
;

358 
	}
}

	@libs/rand.c

1 
	~<x86.h
>

2 
	~<°dlib.h
>

4 
	g√xt
 = 1;

12 
	$ønd
() {

13 
√xt
 = (next * 0x5DEECE66DLL + 0xBLL) & ((1LL << 48) - 1);

14 
ªsu…
 = (
√xt
 >> 12);

15  ()
	`do_div
(
ªsu…
, 
RAND_MAX
 + 1);

16 
	}
}

23 
	$§™d
(
£ed
) {

24 
√xt
 = 
£ed
;

25 
	}
}

	@libs/skew_heap.h

1 #i‚de‡
__LIBS_SKEW_HEAP_H__


2 
	#__LIBS_SKEW_HEAP_H__


	)

4 
	sskew_hóp_íåy
 {

5 
skew_hóp_íåy
 *
	m∑ª¡
, *
	mÀ·
, *
	mright
;

8 
skew_hóp_íåy
 
	tskew_hóp_íåy_t
;

10 (*
	tcom∑ª_f
)(*
	ta
, *
	tb
);

12 
ölöe
 
	$skew_hóp_öô
(
skew_hóp_íåy_t
 *
a
Ë
	`__©åibuã__
((
Æways_ölöe
));

13 
ölöe
 
skew_hóp_íåy_t
 *
	`skew_hóp_mîge
(

14 
skew_hóp_íåy_t
 *
a
, skew_hóp_íåy_à*
b
,

15 
com∑ª_f
 
comp
);

16 
ölöe
 
skew_hóp_íåy_t
 *
	$skew_hóp_ö£π
(

17 
skew_hóp_íåy_t
 *
a
, skew_hóp_íåy_à*
b
,

18 
com∑ª_f
 
comp
Ë
	`__©åibuã__
((
Æways_ölöe
));

19 
ölöe
 
skew_hóp_íåy_t
 *
	$skew_hóp_ªmove
(

20 
skew_hóp_íåy_t
 *
a
, skew_hóp_íåy_à*
b
,

21 
com∑ª_f
 
comp
Ë
	`__©åibuã__
((
Æways_ölöe
));

23 
ölöe
 

24 
	$skew_hóp_öô
(
skew_hóp_íåy_t
 *
a
)

26 
a
->
À·
 =á->
right
 =á->
∑ª¡
 = 
NULL
;

27 
	}
}

29 
ölöe
 
skew_hóp_íåy_t
 *

30 
	$skew_hóp_mîge
(
skew_hóp_íåy_t
 *
a
, skew_hóp_íåy_à*
b
,

31 
com∑ª_f
 
comp
)

33 i‡(
a
 =
NULL
Ë 
b
;

34 i‡(
b
 =
NULL
Ë 
a
;

36 
skew_hóp_íåy_t
 *
l
, *
r
;

37 i‡(
	`comp
(
a
, 
b
) == -1)

39 
r
 = 
a
->
À·
;

40 
l
 = 
	`skew_hóp_mîge
(
a
->
right
, 
b
, 
comp
);

42 
a
->
À·
 = 
l
;

43 
a
->
right
 = 
r
;

44 i‡(
l
Ël->
∑ª¡
 = 
a
;

46  
a
;

50 
r
 = 
b
->
À·
;

51 
l
 = 
	`skew_hóp_mîge
(
a
, 
b
->
right
, 
comp
);

53 
b
->
À·
 = 
l
;

54 
b
->
right
 = 
r
;

55 i‡(
l
Ël->
∑ª¡
 = 
b
;

57  
b
;

59 
	}
}

61 
ölöe
 
skew_hóp_íåy_t
 *

62 
	$skew_hóp_ö£π
(
skew_hóp_íåy_t
 *
a
, skew_hóp_íåy_à*
b
,

63 
com∑ª_f
 
comp
)

65 
	`skew_hóp_öô
(
b
);

66  
	`skew_hóp_mîge
(
a
, 
b
, 
comp
);

67 
	}
}

69 
ölöe
 
skew_hóp_íåy_t
 *

70 
	$skew_hóp_ªmove
(
skew_hóp_íåy_t
 *
a
, skew_hóp_íåy_à*
b
,

71 
com∑ª_f
 
comp
)

73 
skew_hóp_íåy_t
 *
p
 = 
b
->
∑ª¡
;

74 
skew_hóp_íåy_t
 *
ªp
 = 
	`skew_hóp_mîge
(
b
->
À·
, b->
right
, 
comp
);

75 i‡(
ªp
Ëªp->
∑ª¡
 = 
p
;

77 i‡(
p
)

79 i‡(
p
->
À·
 =
b
)

80 
p
->
À·
 = 
ªp
;

81 
p
->
right
 = 
ªp
;

82  
a
;

84  
ªp
;

85 
	}
}

	@libs/stat.h

1 #i‚de‡
__LIBS_STAT_H__


2 
	#__LIBS_STAT_H__


	)

4 
	~<defs.h
>

6 
	s°©
 {

7 
uöt32_t
 
	m°_mode
;

8 
size_t
 
	m°_∆öks
;

9 
size_t
 
	m°_blocks
;

10 
size_t
 
	m°_size
;

13 
	#S_IFMT
 070000

14 
	#S_IFREG
 010000

15 
	#S_IFDIR
 020000

16 
	#S_IFLNK
 030000

17 
	#S_IFCHR
 040000

18 
	#S_IFBLK
 050000

19 

	)

20 
	#S_ISREG
(
mode
Ë(((modeË& 
S_IFMT
Ë=
S_IFREG
)

21 
	#S_ISDIR
(
mode
Ë(((modeË& 
S_IFMT
Ë=
S_IFDIR
)

22 
	#S_ISLNK
(
mode
Ë(((modeË& 
S_IFMT
Ë=
S_IFLNK
)

23 
	#S_ISCHR
(
mode
Ë(((modeË& 
S_IFMT
Ë=
S_IFCHR
)

24 
	#S_ISBLK
(
mode
Ë(((modeË& 
S_IFMT
Ë=
S_IFBLK
)

25 

	)

	@libs/stdarg.h

1 #i‚de‡
__LIBS_STDARG_H__


2 
	#__LIBS_STDARG_H__


	)

5 
__buûtö_va_li°
 
	tva_li°
;

7 
	#va_°¨t
(
≠
, 
œ°
Ë(
	`__buûtö_va_°¨t
◊p,Üa°))

	)

8 
	#va_¨g
(
≠
, 
ty≥
Ë(
	`__buûtö_va_¨g
◊p,Åy≥))

	)

9 
	#va_íd
(
≠
Ë

	)

	@libs/stdio.h

1 #i‚de‡
__LIBS_STDIO_H__


2 
	#__LIBS_STDIO_H__


	)

4 
	~<defs.h
>

5 
	~<°d¨g.h
>

8 
˝rötf
(c⁄° *
fmt
, ...);

9 
v˝rötf
(c⁄° *
fmt
, 
va_li°
 
≠
);

10 
˝utch¨
(
c
);

11 
˝uts
(c⁄° *
°r
);

12 
gëch¨
();

15 *
ªadlöe
(c⁄° *
¥om±
);

18 
¥ötfmt
((*
putch
)(, *, ), 
fd
, *
putd©
, c⁄° *
fmt
, ...);

19 
	`v¥ötfmt
((*
putch
)(, *, ), 
fd
, *
putd©
, c⁄° *
fmt
, 
va_li°
 
≠
);

20 
	`¢¥ötf
(*
°r
, 
size_t
 
size
, c⁄° *
fmt
, ...);

21 
	`v¢¥ötf
(*
°r
, 
size_t
 
size
, c⁄° *
fmt
, 
va_li°
 
≠
);

	@libs/stdlib.h

1 #i‚de‡
__LIBS_STDLIB_H__


2 
	#__LIBS_STDLIB_H__


	)

4 
	~<defs.h
>

7 
	#RAND_MAX
 2147483647UL

	)

10 
ønd
();

11 
§™d
(
£ed
);

14 
uöt32_t
 
hash32
(uöt32_à
vÆ
, 
bôs
);

	@libs/string.c

1 
	~<°rög.h
>

2 
	~<x86.h
>

11 
size_t


12 
	$°æí
(c⁄° *
s
) {

13 
size_t
 
˙t
 = 0;

14 *
s
 ++ != '\0') {

15 
˙t
 ++;

17  
˙t
;

18 
	}
}

33 
size_t


34 
	$°∫Àn
(c⁄° *
s
, 
size_t
 
Àn
) {

35 
size_t
 
˙t
 = 0;

36 
˙t
 < 
Àn
 && *
s
 ++ != '\0') {

37 
˙t
 ++;

39  
˙t
;

40 
	}
}

51 
	$°rˇt
(*
d°
, c⁄° *
§c
) {

52  
	`°r˝y
(
d°
 + 
	`°æí
(d°), 
§c
);

53 
	}
}

68 
	$°r˝y
(*
d°
, c⁄° *
§c
) {

69 #ifde‡
__HAVE_ARCH_STRCPY


70  
	`__°r˝y
(
d°
, 
§c
);

72 *
p
 = 
d°
;

73 (*
p
 ++ = *
§c
 ++) != '\0')

75  
d°
;

77 
	}
}

90 
	$°∫˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
Àn
) {

91 *
p
 = 
d°
;

92 
Àn
 > 0) {

93 i‡((*
p
 = *
§c
) != '\0') {

94 
§c
 ++;

96 
p
 ++, 
Àn
 --;

98  
d°
;

99 
	}
}

117 
	$°rcmp
(c⁄° *
s1
, c⁄° *
s2
) {

118 #ifde‡
__HAVE_ARCH_STRCMP


119  
	`__°rcmp
(
s1
, 
s2
);

121 *
s1
 !'\0' && *s1 =*
s2
) {

122 
s1
 ++, 
s2
 ++;

124  ()(()*
s1
 - ()*
s2
);

126 
	}
}

140 
	$°∫cmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
n
) {

141 
n
 > 0 && *
s1
 !'\0' && *s1 =*
s2
) {

142 
n
 --, 
s1
 ++, 
s2
 ++;

144  (
n
 =0Ë? 0 : ()(()*
s1
 - ()*
s2
);

145 
	}
}

156 
	$°rchr
(c⁄° *
s
, 
c
) {

157 *
s
 != '\0') {

158 i‡(*
s
 =
c
) {

159  (*)
s
;

161 
s
 ++;

163  
NULL
;

164 
	}
}

176 
	$°rföd
(c⁄° *
s
, 
c
) {

177 *
s
 != '\0') {

178 i‡(*
s
 =
c
) {

181 
s
 ++;

183  (*)
s
;

184 
	}
}

217 
	$°πﬁ
(c⁄° *
s
, **
íd±r
, 
ba£
) {

218 
√g
 = 0;

219 
vÆ
 = 0;

222 *
s
 == ' ' || *s == '\t') {

223 
s
 ++;

227 i‡(*
s
 == '+') {

228 
s
 ++;

230 i‡(*
s
 == '-') {

231 
s
 ++, 
√g
 = 1;

235 i‡((
ba£
 =0 || ba£ =16Ë&& (
s
[0] == '0' && s[1] == 'x')) {

236 
s
 +2, 
ba£
 = 16;

238 i‡(
ba£
 =0 && 
s
[0] == '0') {

239 
s
 ++, 
ba£
 = 8;

241 i‡(
ba£
 == 0) {

242 
ba£
 = 10;

247 
dig
;

249 i‡(*
s
 >= '0' && *s <= '9') {

250 
dig
 = *
s
 - '0';

252 i‡(*
s
 >= 'a' && *s <= 'z') {

253 
dig
 = *
s
 - 'a' + 10;

255 i‡(*
s
 >= 'A' && *s <= 'Z') {

256 
dig
 = *
s
 - 'A' + 10;

261 i‡(
dig
 >
ba£
) {

264 
s
 ++, 
vÆ
 = (vÆ * 
ba£
Ë+ 
dig
;

268 i‡(
íd±r
) {

269 *
íd±r
 = (*Ë
s
;

271  (
√g
 ? -
vÆ
 : val);

272 
	}
}

284 
	$mem£t
(*
s
, 
c
, 
size_t
 
n
) {

285 #ifde‡
__HAVE_ARCH_MEMSET


286  
	`__mem£t
(
s
, 
c
, 
n
);

288 *
p
 = 
s
;

289 
n
 -- > 0) {

290 *
p
 ++ = 
c
;

292  
s
;

294 
	}
}

306 
	$memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
n
) {

307 #ifde‡
__HAVE_ARCH_MEMMOVE


308  
	`__memmove
(
d°
, 
§c
, 
n
);

310 c⁄° *
s
 = 
§c
;

311 *
d
 = 
d°
;

312 i‡(
s
 < 
d
 && s + 
n
 > d) {

313 
s
 +
n
, 
d
 +=Ç;

314 
n
 -- > 0) {

315 *-- 
d
 = *-- 
s
;

318 
n
 -- > 0) {

319 *
d
 ++ = *
s
 ++;

322  
d°
;

324 
	}
}

341 
	$mem˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
n
) {

342 #ifde‡
__HAVE_ARCH_MEMCPY


343  
	`__mem˝y
(
d°
, 
§c
, 
n
);

345 c⁄° *
s
 = 
§c
;

346 *
d
 = 
d°
;

347 
n
 -- > 0) {

348 *
d
 ++ = *
s
 ++;

350  
d°
;

352 
	}
}

369 
	$memcmp
(c⁄° *
v1
, c⁄° *
v2
, 
size_t
 
n
) {

370 c⁄° *
s1
 = (c⁄° *)
v1
;

371 c⁄° *
s2
 = (c⁄° *)
v2
;

372 
n
 -- > 0) {

373 i‡(*
s1
 !*
s2
) {

374  ()(()*
s1
 - ()*
s2
);

376 
s1
 ++, 
s2
 ++;

379 
	}
}

	@libs/string.h

1 #i‚de‡
__LIBS_STRING_H__


2 
	#__LIBS_STRING_H__


	)

4 
	~<defs.h
>

6 
size_t
 
°æí
(c⁄° *
s
);

7 
size_t
 
°∫Àn
(c⁄° *
s
, size_à
Àn
);

9 *
°r˝y
(*
d°
, c⁄° *
§c
);

10 *
°∫˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
Àn
);

11 *
°rˇt
(*
d°
, c⁄° *
§c
);

12 *
°rdup
(c⁄° *
§c
);

13 *
°ødd
(c⁄° *
§c1
, c⁄° *
§c2
);

15 
°rcmp
(c⁄° *
s1
, c⁄° *
s2
);

16 
°∫cmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
n
);

18 *
°rchr
(c⁄° *
s
, 
c
);

19 *
°rföd
(c⁄° *
s
, 
c
);

20 
°πﬁ
(c⁄° *
s
, **
íd±r
, 
ba£
);

22 *
mem£t
(*
s
, 
c
, 
size_t
 
n
);

23 *
memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
n
);

24 *
mem˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
n
);

25 
memcmp
(c⁄° *
v1
, c⁄° *
v2
, 
size_t
 
n
);

	@libs/unistd.h

1 #i‚de‡
__LIBS_UNISTD_H__


2 
	#__LIBS_UNISTD_H__


	)

4 
	#T_SYSCALL
 0x80

	)

7 
	#SYS_exô
 1

	)

8 
	#SYS_f‹k
 2

	)

9 
	#SYS_waô
 3

	)

10 
	#SYS_exec
 4

	)

11 
	#SYS_˛⁄e
 5

	)

12 
	#SYS_yõld
 10

	)

13 
	#SYS_¶ìp
 11

	)

14 
	#SYS_kûl
 12

	)

15 
	#SYS_gëtime
 17

	)

16 
	#SYS_gëpid
 18

	)

17 
	#SYS_mm≠
 20

	)

18 
	#SYS_munm≠
 21

	)

19 
	#SYS_shmem
 22

	)

20 
	#SYS_putc
 30

	)

21 
	#SYS_pgdú
 31

	)

22 
	#SYS_›í
 100

	)

23 
	#SYS_˛o£
 101

	)

24 
	#SYS_ªad
 102

	)

25 
	#SYS_wrôe
 103

	)

26 
	#SYS_£ek
 104

	)

27 
	#SYS_f°©
 110

	)

28 
	#SYS_fsync
 111

	)

29 
	#SYS_gëcwd
 121

	)

30 
	#SYS_gëdúíåy
 128

	)

31 
	#SYS_dup
 130

	)

33 
	#SYS_œb6_£t_¥i‹ôy
 255

	)

36 
	#CLONE_VM
 0x00000100

37 
	#CLONE_THREAD
 0x00000200

38 
	#CLONE_FS
 0x00000800

39 

	)

42 
	#O_RDONLY
 0

43 
	#O_WRONLY
 1

44 
	#O_RDWR
 2

46 
	#O_CREAT
 0x00000004

47 
	#O_EXCL
 0x00000008

48 
	#O_TRUNC
 0x00000010

49 
	#O_APPEND
 0x00000020

51 
	#O_ACCMODE
 3

52 

	)

53 
	#NO_FD
 -0x9527

54 

	)

56 
	#LSEEK_SET
 0

57 
	#LSEEK_CUR
 1

58 
	#LSEEK_END
 2

59 

	)

60 
	#FS_MAX_DNAME_LEN
 31

	)

61 
	#FS_MAX_FNAME_LEN
 255

	)

62 
	#FS_MAX_FPATH_LEN
 4095

	)

64 
	#EXEC_MAX_ARG_NUM
 32

	)

65 
	#EXEC_MAX_ARG_LEN
 4095

	)

	@libs/x86.h

1 #i‚de‡
__LIBS_X86_H__


2 
	#__LIBS_X86_H__


	)

4 
	~<defs.h
>

6 
	#do_div
(
n
, 
ba£
) ({ \

7 
__uµî
, 
__low
, 
__high
, 
__mod
, 
__ba£
; \

8 
__ba£
 = (
ba£
); \

9 
	`asm
 ("" : "˜" (
__low
), "=d" (
__high
Ë: "A" (
n
)); \

10 
__uµî
 = 
__high
; \

11 i‡(
__high
 != 0) { \

12 
__uµî
 = 
__high
 % 
__ba£
; \

13 
__high
 = __high / 
__ba£
; \

15 
	`asm
 ("div»%2" : "˜" (
__low
), "=d" (
__mod
) \

16 : "rm" (
__ba£
), "0" (
__low
), "1" (
__uµî
)); \

17 
	`asm
 ("" : "=A" (
n
Ë: "a" (
__low
), "d" (
__high
)); \

18 
__mod
; \

19 })

	)

21 
	#b¨rõr
(Ë
__asm__
 
	`__vﬁ©ûe__
 ("" ::: "mem‹y")

	)

23 
ölöe
 
uöt8_t
 
	$öb
(
uöt16_t
 
p‹t
Ë
	`__©åibuã__
((
Æways_ölöe
));

24 
ölöe
 
uöt16_t
 
	$öw
(
uöt16_t
 
p‹t
Ë
	`__©åibuã__
((
Æways_ölöe
));

25 
ölöe
 
	$ö¶
(
uöt32_t
 
p‹t
, *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

26 
ölöe
 
	$outb
(
uöt16_t
 
p‹t
, 
uöt8_t
 
d©a
Ë
	`__©åibuã__
((
Æways_ölöe
));

27 
ölöe
 
	$outw
(
uöt16_t
 
p‹t
, uöt16_à
d©a
Ë
	`__©åibuã__
((
Æways_ölöe
));

28 
ölöe
 
	$out¶
(
uöt32_t
 
p‹t
, c⁄° *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

29 
ölöe
 
uöt32_t
 
	$ªad_ebp
(Ë
	`__©åibuã__
((
Æways_ölöe
));

30 
ölöe
 
	$bªakpoöt
(Ë
	`__©åibuã__
((
Æways_ölöe
));

31 
ölöe
 
uöt32_t
 
	$ªad_dr
(
ªgnum
Ë
	`__©åibuã__
((
Æways_ölöe
));

32 
ölöe
 
	$wrôe_dr
(
ªgnum
, 
uöt32_t
 
vÆue
Ë
	`__©åibuã__
((
Æways_ölöe
));

35 
	sp£udodesc
 {

36 
uöt16_t
 
pd_lim
;

37 
uöçå_t
 
pd_ba£
;

38 } 
	`__©åibuã__
 ((
∑cked
));

40 
ölöe
 
	$lidt
(
p£udodesc
 *
pd
Ë
	`__©åibuã__
((
Æways_ölöe
));

41 
ölöe
 
	$°i
(Ë
	`__©åibuã__
((
Æways_ölöe
));

42 
ölöe
 
	$˛i
(Ë
	`__©åibuã__
((
Æways_ölöe
));

43 
ölöe
 
	$…r
(
uöt16_t
 
£l
Ë
	`__©åibuã__
((
Æways_ölöe
));

44 
ölöe
 
uöt32_t
 
	$ªad_eÊags
(Ë
	`__©åibuã__
((
Æways_ölöe
));

45 
ölöe
 
	$wrôe_eÊags
(
uöt32_t
 
eÊags
Ë
	`__©åibuã__
((
Æways_ölöe
));

46 
ölöe
 
	$l¸0
(
uöçå_t
 
¸0
Ë
	`__©åibuã__
((
Æways_ölöe
));

47 
ölöe
 
	$l¸3
(
uöçå_t
 
¸3
Ë
	`__©åibuã__
((
Æways_ölöe
));

48 
ölöe
 
uöçå_t
 
	$r¸0
(Ë
	`__©åibuã__
((
Æways_ölöe
));

49 
ölöe
 
uöçå_t
 
	$r¸1
(Ë
	`__©åibuã__
((
Æways_ölöe
));

50 
ölöe
 
uöçå_t
 
	$r¸2
(Ë
	`__©åibuã__
((
Æways_ölöe
));

51 
ölöe
 
uöçå_t
 
	$r¸3
(Ë
	`__©åibuã__
((
Æways_ölöe
));

52 
ölöe
 
	$övÕg
(*
addr
Ë
	`__©åibuã__
((
Æways_ölöe
));

54 
ölöe
 
uöt8_t


55 
	$öb
(
uöt16_t
 
p‹t
) {

56 
uöt8_t
 
d©a
;

57 
asm
 vﬁ©ûê("öb %1, %0" : "˜" (
d©a
Ë: "d" (
p‹t
) : "memory");

58  
d©a
;

59 
	}
}

61 
ölöe
 
uöt16_t


62 
	$öw
(
uöt16_t
 
p‹t
) {

63 
uöt16_t
 
d©a
;

64 
asm
 vﬁ©ûê("öw %1, %0" : "˜" (
d©a
Ë: "d" (
p‹t
));

65  
d©a
;

66 
	}
}

68 
ölöe
 

69 
	$ö¶
(
uöt32_t
 
p‹t
, *
addr
, 
˙t
) {

70 
asm
 volatile (

73 : "=D" (
addr
), "=c" (
˙t
)

74 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

76 
	}
}

79 
ölöe
 

80 
	$lﬂdgs
(
ush‹t
 
v
)

82 
asm
 vﬁ©ûe("movw %0, %%gs" : : "r" (
v
));

83 
	}
}

87 
ölöe
 

88 
	$outb
(
uöt16_t
 
p‹t
, 
uöt8_t
 
d©a
) {

89 
asm
 vﬁ©ûê("outb %0, %1" :: "a" (
d©a
), "d" (
p‹t
) : "memory");

90 
	}
}

92 
ölöe
 

93 
	$outw
(
uöt16_t
 
p‹t
, uöt16_à
d©a
) {

94 
asm
 vﬁ©ûê("outw %0, %1" :: "a" (
d©a
), "d" (
p‹t
) : "memory");

95 
	}
}

97 
ölöe
 

98 
	$out¶
(
uöt32_t
 
p‹t
, c⁄° *
addr
, 
˙t
) {

99 
asm
 volatile (

102 : "=S" (
addr
), "=c" (
˙t
)

103 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

105 
	}
}

107 
ölöe
 
uöt32_t


108 
	$ªad_ebp
() {

109 
uöt32_t
 
ebp
;

110 
asm
 vﬁ©ûê("mov»%%ebp, %0" : "Ù" (
ebp
));

111  
ebp
;

112 
	}
}

114 
ölöe
 
uöt


115 
	$ªadeÊags
()

117 
uöt
 
eÊags
;

118 
asm
 vﬁ©ûe("pushÊ;Ö›»%0" : "Ù" (
eÊags
));

119  
eÊags
;

120 
	}
}

124 
ölöe
 

125 
	$bªakpoöt
() {

126 
asm
 volatile ("int $3");

127 
	}
}

129 
ölöe
 
uöt32_t


130 
	$ªad_dr
(
ªgnum
) {

131 
uöt32_t
 
vÆue
 = 0;

132 
ªgnum
) {

133 0: 
asm
 vﬁ©ûê("mov»%%db0, %0" : "Ù" (
vÆue
)); ;

134 1: 
asm
 vﬁ©ûê("mov»%%db1, %0" : "Ù" (
vÆue
)); ;

135 2: 
asm
 vﬁ©ûê("mov»%%db2, %0" : "Ù" (
vÆue
)); ;

136 3: 
asm
 vﬁ©ûê("mov»%%db3, %0" : "Ù" (
vÆue
)); ;

137 6: 
asm
 vﬁ©ûê("mov»%%db6, %0" : "Ù" (
vÆue
)); ;

138 7: 
asm
 vﬁ©ûê("mov»%%db7, %0" : "Ù" (
vÆue
)); ;

140  
vÆue
;

141 
	}
}

144 
	$wrôe_dr
(
ªgnum
, 
uöt32_t
 
vÆue
) {

145 
ªgnum
) {

146 0: 
asm
 vﬁ©ûê("mov»%0, %%db0" :: "r" (
vÆue
)); ;

147 1: 
asm
 vﬁ©ûê("mov»%0, %%db1" :: "r" (
vÆue
)); ;

148 2: 
asm
 vﬁ©ûê("mov»%0, %%db2" :: "r" (
vÆue
)); ;

149 3: 
asm
 vﬁ©ûê("mov»%0, %%db3" :: "r" (
vÆue
)); ;

150 6: 
asm
 vﬁ©ûê("mov»%0, %%db6" :: "r" (
vÆue
)); ;

151 7: 
asm
 vﬁ©ûê("mov»%0, %%db7" :: "r" (
vÆue
)); ;

153 
	}
}

155 
ölöe
 

156 
	$lidt
(
p£udodesc
 *
pd
) {

157 
asm
 vﬁ©ûê("lidà(%0)" :: "r" (
pd
) : "memory");

158 
	}
}

160 
ölöe
 

161 
	$°i
() {

162 
asm
 volatile ("sti");

163 
	}
}

166 
ölöe
 
uöt


167 
	$xchg
(vﬁ©ûê
uöt
 *
addr
, uöà
√wvÆ
)

169 
uöt
 
ªsu…
;

172 
asm
 volatile("lock; xchgl %0, %1" :

173 "+m" (*
addr
), "˜" (
ªsu…
) :

174 "1" (
√wvÆ
) :

176  
ªsu…
;

177 
	}
}

182 
ölöe
 

183 
	$˛i
() {

184 
asm
 volatile ("cli" ::: "memory");

185 
	}
}

187 
ölöe
 

188 
	$…r
(
uöt16_t
 
£l
) {

189 
asm
 vﬁ©ûê("…∏%0" :: "r" (
£l
) : "memory");

190 
	}
}

192 
ölöe
 
uöt32_t


193 
	$ªad_eÊags
() {

194 
uöt32_t
 
eÊags
;

195 
asm
 vﬁ©ûê("pushÊ;Ö›»%0" : "Ù" (
eÊags
));

196  
eÊags
;

197 
	}
}

199 
ölöe
 

200 
	$wrôe_eÊags
(
uöt32_t
 
eÊags
) {

201 
asm
 vﬁ©ûê("push»%0;Ö›Ê" :: "r" (
eÊags
));

202 
	}
}

204 
ölöe
 

205 
	$l¸0
(
uöçå_t
 
¸0
) {

206 
asm
 vﬁ©ûê("mov %0, %%¸0" :: "r" (
¸0
) : "memory");

207 
	}
}

209 
ölöe
 

210 
	$l¸3
(
uöçå_t
 
¸3
) {

211 
asm
 vﬁ©ûê("mov %0, %%¸3" :: "r" (
¸3
) : "memory");

212 
	}
}

214 
ölöe
 
uöçå_t


215 
	$r¸0
() {

216 
uöçå_t
 
¸0
;

217 
asm
 vﬁ©ûê("mov %%¸0, %0" : "Ù" (
¸0
) :: "memory");

218  
¸0
;

219 
	}
}

221 
ölöe
 
uöçå_t


222 
	$r¸1
() {

223 
uöçå_t
 
¸1
;

224 
asm
 vﬁ©ûê("mov %%¸1, %0" : "Ù" (
¸1
) :: "memory");

225  
¸1
;

226 
	}
}

228 
ölöe
 
uöçå_t


229 
	$r¸2
() {

230 
uöçå_t
 
¸2
;

231 
asm
 vﬁ©ûê("mov %%¸2, %0" : "Ù" (
¸2
) :: "memory");

232  
¸2
;

233 
	}
}

235 
ölöe
 
uöçå_t


236 
	$r¸3
() {

237 
uöçå_t
 
¸3
;

238 
asm
 vﬁ©ûê("mov %%¸3, %0" : "Ù" (
¸3
) :: "memory");

239  
¸3
;

240 
	}
}

242 
ölöe
 

243 
	$övÕg
(*
addr
) {

244 
asm
 vﬁ©ûê("övÕg (%0)" :: "r" (
addr
) : "memory");

245 
	}
}

247 
ölöe
 
	$__°rcmp
(c⁄° *
s1
, c⁄° *
s2
Ë
	`__©åibuã__
((
Æways_ölöe
));

248 
ölöe
 *
	$__°r˝y
(*
d°
, c⁄° *
§c
Ë
	`__©åibuã__
((
Æways_ölöe
));

249 
ölöe
 *
	$__mem£t
(*
s
, 
c
, 
size_t
 
n
Ë
	`__©åibuã__
((
Æways_ölöe
));

250 
ölöe
 *
	$__memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
n
Ë
	`__©åibuã__
((
Æways_ölöe
));

251 
ölöe
 *
	$__mem˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
n
Ë
	`__©åibuã__
((
Æways_ölöe
));

253 #i‚de‡
__HAVE_ARCH_STRCMP


254 
	#__HAVE_ARCH_STRCMP


	)

255 
ölöe
 

256 
	$__°rcmp
(c⁄° *
s1
, c⁄° *
s2
) {

257 
d0
, 
d1
, 
ªt
;

258 
asm
 volatile (

269 : "˜" (
ªt
), "=&S" (
d0
), "=&D" (
d1
)

270 : "1" (
s1
), "2" (
s2
)

272  
ªt
;

273 
	}
}

277 #i‚de‡
__HAVE_ARCH_STRCPY


278 
	#__HAVE_ARCH_STRCPY


	)

279 
ölöe
 *

280 
	$__°r˝y
(*
d°
, c⁄° *
§c
) {

281 
d0
, 
d1
, 
d2
;

282 
asm
 volatile (

287 : "=&S" (
d0
), "=&D" (
d1
), "=&a" (
d2
)

288 : "0" (
§c
), "1" (
d°
) : "memory");

289  
d°
;

290 
	}
}

293 #i‚de‡
__HAVE_ARCH_MEMSET


294 
	#__HAVE_ARCH_MEMSET


	)

295 
ölöe
 *

296 
	$__mem£t
(*
s
, 
c
, 
size_t
 
n
) {

297 
d0
, 
d1
;

298 
asm
 volatile (

300 : "=&c" (
d0
), "=&D" (
d1
)

301 : "0" (
n
), "a" (
c
), "1" (
s
)

303  
s
;

304 
	}
}

307 #i‚de‡
__HAVE_ARCH_MEMMOVE


308 
	#__HAVE_ARCH_MEMMOVE


	)

309 
ölöe
 *

310 
	$__memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
n
) {

311 i‡(
d°
 < 
§c
) {

312  
	`__mem˝y
(
d°
, 
§c
, 
n
);

314 
d0
, 
d1
, 
d2
;

315 
asm
 volatile (

319 : "=&c" (
d0
), "=&S" (
d1
), "=&D" (
d2
)

320 : "0" (
n
), "1" (¿- 1 + 
§c
), "2" (¿- 1 + 
d°
)

322  
d°
;

323 
	}
}

326 #i‚de‡
__HAVE_ARCH_MEMCPY


327 
	#__HAVE_ARCH_MEMCPY


	)

328 
ölöe
 *

329 
	$__mem˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
n
) {

330 
d0
, 
d1
, 
d2
;

331 
asm
 volatile (

338 : "=&c" (
d0
), "=&D" (
d1
), "=&S" (
d2
)

339 : "0" (
n
 / 4), "g" (n), "1" (
d°
), "2" (
§c
)

341  
d°
;

342 
	}
}

	@tools/mksfs.c

1 
	#_GNU_SOURCE


	)

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<°dlib.h
>

5 
	~<°döt.h
>

6 
	~<limôs.h
>

7 
	~<dúít.h
>

8 
	~<uni°d.h
>

9 
	~<f˙é.h
>

10 
	~<sys/°©.h
>

11 
	~<sys/ty≥s.h
>

12 
	~<î∫o.h
>

13 
	~<as£π.h
>

15 
	tboﬁ
;

17 
	#__îr‹
(
msg
, 
quô
, ...) \

19 
	`Ârötf
(
°dîr
, #msg ": fun˘i⁄ %†-Üöê%d: ", 
__FUNCTION__
, 
__LINE__
); \

20 i‡(
î∫o
 != 0) { \

21 
	`Ârötf
(
°dîr
, "[îr‹] %s: ", 
	`°ªº‹
(
î∫o
)); \

23 
	`Ârötf
(
°dîr
, "\n\t"), f¥ötf(°dîr, 
__VA_ARGS__
); \

24 
î∫o
 = 0; \

25 i‡(
quô
) { \

26 
	`exô
(-1); \

28 } 0)

	)

30 
	#w¨n
(...Ë
	`__îr‹
(
w¨n
, 0, 
__VA_ARGS__
)

	)

31 
	#bug
(...Ë
	`__îr‹
(
bug
, 1, 
__VA_ARGS__
)

	)

33 
	#°©ic_as£π
(
x
) \

34 
x
Ë{0: (x): ; }

	)

37 
	#GOLDEN_RATIO_PRIME_32
 0x9e370001UL

	)

39 
	#HASH_SHIFT
 10

	)

40 
	#HASH_LIST_SIZE
 (1 << 
HASH_SHIFT
)

	)

42 
ölöe
 
uöt32_t


43 
	$__hash32
(
uöt32_t
 
vÆ
, 
bôs
) {

44 
uöt32_t
 
hash
 = 
vÆ
 * 
GOLDEN_RATIO_PRIME_32
;

45  (
hash
 >> (32 - 
bôs
));

46 
	}
}

48 
uöt32_t


49 
	$hash32
(
uöt32_t
 
vÆ
) {

50  
	`__hash32
(
vÆ
, 
HASH_SHIFT
);

51 
	}
}

53 
uöt32_t


54 
	$hash64
(
uöt64_t
 
vÆ
) {

55  
	`__hash32
((
uöt32_t
)
vÆ
, 
HASH_SHIFT
);

56 
	}
}

59 
	$ß„_mÆloc
(
size_t
 
size
) {

60 *
ªt
;

61 i‡((
ªt
 = 
	`mÆloc
(
size
)Ë=
NULL
) {

62 
	`bug
("mÆlo¯%lu byã†Áûed.\n", ()
size
);

64  
ªt
;

65 
	}
}

68 
	$ß„_°rdup
(c⁄° *
°r
) {

69 *
ªt
;

70 i‡((
ªt
 = 
	`°rdup
(
°r
)Ë=
NULL
) {

71 
	`bug
("°rdu∞Áûed: %s\n", 
°r
);

73  
ªt
;

74 
	}
}

76 
°©
 *

77 
	$ß„_°©
(c⁄° *
fûíame
) {

78 
°©
 
__°©
;

79 i‡(
	`°©
(
fûíame
, &
__°©
) != 0) {

80 
	`bug
("°© %†Áûed.\n", 
fûíame
);

82  &
__°©
;

83 
	}
}

85 
°©
 *

86 
	$ß„_f°©
(
fd
) {

87 
°©
 
__°©
;

88 i‡(
	`f°©
(
fd
, &
__°©
) != 0) {

89 
	`bug
("f°© %d faûed.\n", 
fd
);

91  &
__°©
;

92 
	}
}

94 
°©
 *

95 
	$ß„_l°©
(c⁄° *
«me
) {

96 
°©
 
__°©
;

97 i‡(
	`l°©
(
«me
, &
__°©
) != 0) {

98 
	`bug
("l°© '%s' faûed.\n", 
«me
);

100  &
__°©
;

101 
	}
}

104 
	$ß„_fchdú
(
fd
) {

105 i‡(
	`fchdú
(
fd
) != 0) {

106 
	`bug
("fchdú faûed %d.\n", 
fd
);

108 
	}
}

110 
	#SFS_MAGIC
 0x2f8dbe2a

	)

111 
	#SFS_NDIRECT
 12

	)

112 
	#SFS_BLKSIZE
 4096

113 
	#SFS_MAX_NBLKS
 (1024UL * 512)

114 
	#SFS_MAX_INFO_LEN
 31

	)

115 
	#SFS_MAX_FNAME_LEN
 255

	)

116 
	#SFS_MAX_FILE_SIZE
 (1024UL * 1024 * 128)

117 

	)

118 
	#SFS_BLKBITS
 (
SFS_BLKSIZE
 * 
CHAR_BIT
)

	)

119 
	#SFS_TYPE_FILE
 1

	)

120 
	#SFS_TYPE_DIR
 2

	)

121 
	#SFS_TYPE_LINK
 3

	)

123 
	#SFS_BLKN_SUPER
 0

	)

124 
	#SFS_BLKN_ROOT
 1

	)

125 
	#SFS_BLKN_FREEMAP
 2

	)

127 
	sˇche_block
 {

128 
uöt32_t
 
	möo
;

129 
ˇche_block
 *
	mhash_√xt
;

130 *
	mˇche
;

133 
	sˇche_öode
 {

134 
	söode
 {

135 
uöt32_t
 
	msize
;

136 
uöt16_t
 
	mty≥
;

137 
uöt16_t
 
	m∆öks
;

138 
uöt32_t
 
	mblocks
;

139 
uöt32_t
 
	mdúe˘
[
SFS_NDIRECT
];

140 
uöt32_t
 
	mödúe˘
;

141 
uöt32_t
 
	mdb_ödúe˘
;

142 } 
	möode
;

143 
öo_t
 
	mªÆ
;

144 
uöt32_t
 
	möo
;

145 
uöt32_t
 
	mnblks
;

146 
ˇche_block
 *
	ml1
, *
	ml2
;

147 
ˇche_öode
 *
	mhash_√xt
;

150 
	ssfs_fs
 {

152 
uöt32_t
 
	mmagic
;

153 
uöt32_t
 
	mblocks
;

154 
uöt32_t
 
	munu£d_blocks
;

155 
	möfo
[
SFS_MAX_INFO_LEN
 + 1];

156 } 
	msu≥r
;

157 
	ssub∑th
 {

158 
sub∑th
 *
	m√xt
, *
	m¥ev
;

159 *
	msub«me
;

160 } 
	m__•_nû
, *
	m•_roŸ
, *
	m•_íd
;

161 
	mimgfd
;

162 
uöt32_t
 
	mnöos
, 
	m√xt_öo
;

163 
ˇche_öode
 *
	mroŸ
;

164 
ˇche_öode
 *
	möodes
[
HASH_LIST_SIZE
];

165 
ˇche_block
 *
	mblocks
[
HASH_LIST_SIZE
];

168 
	ssfs_íåy
 {

169 
uöt32_t
 
	möo
;

170 
	m«me
[
SFS_MAX_FNAME_LEN
 + 1];

173 
uöt32_t


174 
	$sfs_Æloc_öo
(
sfs_fs
 *
sfs
) {

175 i‡(
sfs
->
√xt_öo
 < sfs->
nöos
) {

176 
sfs
->
su≥r
.
unu£d_blocks
 --;

177  
sfs
->
√xt_öo
 ++;

179 
	`bug
("out of disk space.\n");

180 
	}
}

182 
ˇche_block
 *

183 
	$Æloc_ˇche_block
(
sfs_fs
 *
sfs
, 
uöt32_t
 
öo
) {

184 
ˇche_block
 *
cb
 = 
	`ß„_mÆloc
((cache_block));

185 
cb
->
öo
 = (öÿ!0Ë? inÿ: 
	`sfs_Æloc_öo
(
sfs
);

186 
cb
->
ˇche
 = 
	`mem£t
(
	`ß„_mÆloc
(
SFS_BLKSIZE
), 0, SFS_BLKSIZE);

187 
ˇche_block
 **
hód
 = 
sfs
->
blocks
 + 
	`hash32
(
öo
);

188 
cb
->
hash_√xt
 = *
hód
, *head = cb;

189  
cb
;

190 
	}
}

192 
ˇche_block
 *

193 
	$£¨ch_ˇche_block
(
sfs_fs
 *
sfs
, 
uöt32_t
 
öo
) {

194 
ˇche_block
 *
cb
 = 
sfs
->
blocks
[
	`hash32
(
öo
)];

195 
cb
 !
NULL
 && cb->
öo
 != ino) {

196 
cb
 = cb->
hash_√xt
;

198  
cb
;

199 
	}
}

201 
ˇche_öode
 *

202 
	$Æloc_ˇche_öode
(
sfs_fs
 *
sfs
, 
öo_t
 
ªÆ
, 
uöt32_t
 
öo
, 
uöt16_t
 
ty≥
) {

203 
ˇche_öode
 *
ci
 = 
	`ß„_mÆloc
((cache_inode));

204 
ci
->
öo
 = (öÿ!0Ë? inÿ: 
	`sfs_Æloc_öo
(
sfs
);

205 
ci
->
ªÆ
 =Ñól, ci->
nblks
 = 0, ci->
l1
 = ci->
l2
 = 
NULL
;

206 
öode
 *öodê&(
ci
->inode);

207 
	`mem£t
(
öode
, 0, (inode));

208 
öode
->
ty≥
 =Åype;

209 
ˇche_öode
 **
hód
 = 
sfs
->
öodes
 + 
	`hash64
(
ªÆ
);

210 
ci
->
hash_√xt
 = *
hód
, *head = ci;

211  
ci
;

212 
	}
}

214 
ˇche_öode
 *

215 
	$£¨ch_ˇche_öode
(
sfs_fs
 *
sfs
, 
öo_t
 
ªÆ
) {

216 
ˇche_öode
 *
ci
 = 
sfs
->
öodes
[
	`hash64
(
ªÆ
)];

217 
ci
 !
NULL
 && ci->
ªÆ
 !=Ñeal) {

218 
ci
 = ci->
hash_√xt
;

220  
ci
;

221 
	}
}

223 
sfs_fs
 *

224 
	$¸óã_sfs
(
imgfd
) {

225 
uöt32_t
 
nöos
, 
√xt_öo
;

226 
°©
 *°© = 
	`ß„_f°©
(
imgfd
);

227 i‡((
nöos
 = 
°©
->
°_size
 / 
SFS_BLKSIZE
Ë> 
SFS_MAX_NBLKS
) {

228 
nöos
 = 
SFS_MAX_NBLKS
;

229 
	`w¨n
("img file isÅoo big (%llu bytes, only use %u blocks).\n",

230 ()
°©
->
°_size
, 
nöos
);

232 i‡((
√xt_öo
 = 
SFS_BLKN_FREEMAP
 + (
nöos
 + 
SFS_BLKBITS
 - 1) / SFS_BLKBITS) >=Çinos) {

233 
	`bug
("img file isÅoo small (%llu bytes, %u blocks, bitmap useátÜeast %u blocks).\n",

234 ()
°©
->
°_size
, 
nöos
, 
√xt_öo
 - 2);

237 
sfs_fs
 *
sfs
 = 
	`ß„_mÆloc
((sfs_fs));

238 
sfs
->
su≥r
.
magic
 = 
SFS_MAGIC
;

239 
sfs
->
su≥r
.
blocks
 = 
nöos
, sfs->su≥r.
unu£d_blocks
 =Çöo†- 
√xt_öo
;

240 
	`¢¥ötf
(
sfs
->
su≥r
.
öfo
, 
SFS_MAX_INFO_LEN
, "simple file system");

242 
sfs
->
nöos
 =Çöos, sfs->
√xt_öo
 =Çext_öo, sfs->
imgfd
 = imgfd;

243 
sfs
->
•_roŸ
 = sfs->
•_íd
 = &(sfs->
__•_nû
);

244 
sfs
->
•_íd
->
¥ev
 = sfs->•_íd->
√xt
 = 
NULL
;

246 
i
;

247 
i
 = 0; i < 
HASH_LIST_SIZE
; i ++) {

248 
sfs
->
öodes
[
i
] = 
NULL
;

249 
sfs
->
blocks
[
i
] = 
NULL
;

252 
sfs
->
roŸ
 = 
	`Æloc_ˇche_öode
(sfs, 0, 
SFS_BLKN_ROOT
, 
SFS_TYPE_DIR
);

253  
sfs
;

254 
	}
}

257 
	$sub∑th_push
(
sfs_fs
 *
sfs
, c⁄° *
sub«me
) {

258 
sub∑th
 *sub∑th = 
	`ß„_mÆloc
((subpath));

259 
sub∑th
->
sub«me
 = 
	`ß„_°rdup
(subname);

260 
sfs
->
•_íd
->
√xt
 = 
sub∑th
;

261 
sub∑th
->
¥ev
 = 
sfs
->
•_íd
;

262 
sub∑th
->
√xt
 = 
NULL
;

263 
sfs
->
•_íd
 = 
sub∑th
;

264 
	}
}

267 
	$sub∑th_p›
(
sfs_fs
 *
sfs
) {

268 
	`as£π
(
sfs
->
•_roŸ
 !sfs->
•_íd
);

269 
sub∑th
 *sub∑th = 
sfs
->
•_íd
;

270 
sfs
->
•_íd
 = sfs->•_íd->
¥ev
, sfs->•_íd->
√xt
 = 
NULL
;

271 
	`‰ì
(
sub∑th
->
sub«me
), free(subpath);

272 
	}
}

275 
	$sub∑th_show
(
FILE
 *
fout
, 
sfs_fs
 *
sfs
, c⁄° *
«me
) {

276 
sub∑th
 *sub∑th = 
sfs
->
•_roŸ
;

277 
	`Ârötf
(
fout
, "current is: /");

278 (
sub∑th
 = sub∑th->
√xt
Ë!
NULL
) {

279 
	`Ârötf
(
fout
, "%s/", 
sub∑th
->
sub«me
);

281 i‡(
«me
 !
NULL
) {

282 
	`Ârötf
(
fout
, "%s", 
«me
);

284 
	`Ârötf
(
fout
, "\n");

285 
	}
}

288 
	$wrôe_block
(
sfs_fs
 *
sfs
, *
d©a
, 
size_t
 
Àn
, 
uöt32_t
 
öo
) {

289 
	`as£π
(
Àn
 <
SFS_BLKSIZE
 && 
öo
 < 
sfs
->
nöos
);

290 
buf„r
[
SFS_BLKSIZE
];

291 i‡(
Àn
 !
SFS_BLKSIZE
) {

292 
	`mem£t
(
buf„r
, 0, (buffer));

293 
d©a
 = 
	`mem˝y
(
buf„r
, d©a, 
Àn
);

295 
off_t
 
off£t
 = (off_t)
öo
 * 
SFS_BLKSIZE
;

296 
ssize_t
 
ªt
;

297 i‡((
ªt
 = 
	`pwrôe
(
sfs
->
imgfd
, 
d©a
, 
SFS_BLKSIZE
, 
off£t
)) != SFS_BLKSIZE) {

298 
	`bug
("wrôê%u block faûed: (%d/%d).\n", 
öo
, ()
ªt
, 
SFS_BLKSIZE
);

300 
	}
}

303 
	$Êush_ˇche_block
(
sfs_fs
 *
sfs
, 
ˇche_block
 *
cb
) {

304 
	`wrôe_block
(
sfs
, 
cb
->
ˇche
, 
SFS_BLKSIZE
, cb->
öo
);

305 
	}
}

308 
	$Êush_ˇche_öode
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
ci
) {

309 
	`wrôe_block
(
sfs
, &(
ci
->
öode
), (ci->öode), ci->
öo
);

310 
	}
}

313 
	$˛o£_sfs
(
sfs_fs
 *
sfs
) {

314 
buf„r
[
SFS_BLKSIZE
];

315 
uöt32_t
 
i
, 
j
, 
öo
 = 
SFS_BLKN_FREEMAP
;

316 
uöt32_t
 
nöos
 = 
sfs
->nöos, 
√xt_öo
 = sfs->next_ino;

317 
i
 = 0; i < 
nöos
; 
öo
 ++, i +
SFS_BLKBITS
) {

318 
	`mem£t
(
buf„r
, 0, (buffer));

319 i‡(
i
 + 
SFS_BLKBITS
 > 
√xt_öo
) {

320 
uöt32_t
 
°¨t
 = 0, 
íd
 = 
SFS_BLKBITS
;

321 i‡(
i
 < 
√xt_öo
) {

322 
°¨t
 = 
√xt_öo
 - 
i
;

324 i‡(
i
 + 
SFS_BLKBITS
 > 
nöos
) {

325 
íd
 = 
nöos
 - 
i
;

327 
uöt32_t
 *
d©a
 = (uöt32_à*)
buf„r
;

328 c⁄° 
uöt32_t
 
bôs
 = (bôsË* 
CHAR_BIT
;

329 
j
 = 
°¨t
; j < 
íd
; j ++) {

330 
d©a
[
j
 / 
bôs
] |= (1 << (j % bits));

333 
	`wrôe_block
(
sfs
, 
buf„r
, (buf„r), 
öo
);

335 
	`wrôe_block
(
sfs
, &(sfs->
su≥r
), (sfs->su≥r), 
SFS_BLKN_SUPER
);

337 
i
 = 0; i < 
HASH_LIST_SIZE
; i ++) {

338 
ˇche_block
 *
cb
 = 
sfs
->
blocks
[
i
];

339 
cb
 !
NULL
) {

340 
	`Êush_ˇche_block
(
sfs
, 
cb
);

341 
cb
 = cb->
hash_√xt
;

343 
ˇche_öode
 *
ci
 = 
sfs
->
öodes
[
i
];

344 
ci
 !
NULL
) {

345 
	`Êush_ˇche_öode
(
sfs
, 
ci
);

346 
ci
 = ci->
hash_√xt
;

349 
	}
}

351 
sfs_fs
 *

352 
	$›í_img
(c⁄° *
img«me
) {

353 c⁄° *
ex≥˘
 = ".img", *
ext
 = 
img«me
 + 
	`°æí
(imgname) - strlen(expect);

354 i‡(
ext
 <
img«me
 || 
	`°rcmp
”xt, 
ex≥˘
) != 0) {

355 
	`bug
("övÆid .img fûê«mê'%s'.\n", 
img«me
);

357 
imgfd
;

358 i‡((
imgfd
 = 
	`›í
(
img«me
, 
O_WRONLY
)) < 0) {

359 
	`bug
("›í '%s' faûed.\n", 
img«me
);

361  
	`¸óã_sfs
(
imgfd
);

362 
	}
}

364 
	#›í_bug
(
sfs
, 
«me
, ...) \

366 
	`sub∑th_show
(
°dîr
, 
sfs
, 
«me
); \

367 
	`bug
(
__VA_ARGS__
); \

368 } 0)

	)

370 
	#show_fuŒ∑th
(
sfs
, 
«me
Ë
	`sub∑th_show
(
°dîr
, sfs,Çame)

	)

372 
›í_dú
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
cuºít
, ˇche_öodê*
∑ª¡
);

373 
›í_fûe
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
fûe
, c⁄° *
fûíame
, 
fd
);

374 
›í_lök
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
fûe
, c⁄° *
fûíame
);

376 
	#SFS_BLK_NENTRY
 (
SFS_BLKSIZE
 / (
uöt32_t
))

	)

377 
	#SFS_L0_NBLKS
 
SFS_NDIRECT


	)

378 
	#SFS_L1_NBLKS
 (
SFS_BLK_NENTRY
 + 
SFS_L0_NBLKS
)

	)

379 
	#SFS_L2_NBLKS
 (
SFS_BLK_NENTRY
 * SFS_BLK_NENTRY + 
SFS_L1_NBLKS
)

	)

380 
	#SFS_LN_NBLKS
 (
SFS_MAX_FILE_SIZE
 / 
SFS_BLKSIZE
)

	)

383 
	$upd©e_ˇche
(
sfs_fs
 *
sfs
, 
ˇche_block
 **
cbp
, 
uöt32_t
 *
ö›
) {

384 
uöt32_t
 
öo
 = *
ö›
;

385 
ˇche_block
 *
cb
 = *
cbp
;

386 i‡(
öo
 == 0) {

387 
cb
 = 
	`Æloc_ˇche_block
(
sfs
, 0);

388 
öo
 = 
cb
->ino;

390 i‡(
cb
 =
NULL
 || cb->
öo
 != ino) {

391 
cb
 = 
	`£¨ch_ˇche_block
(
sfs
, 
öo
);

392 
	`as£π
(
cb
 !
NULL
 && cb->
öo
 == ino);

394 *
cbp
 = 
cb
, *
ö›
 = 
öo
;

395 
	}
}

398 
	$≠≥nd_block
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
fûe
, 
size_t
 
size
, 
uöt32_t
 
öo
, c⁄° *
fûíame
) {

399 
	`°©ic_as£π
(
SFS_LN_NBLKS
 <
SFS_L2_NBLKS
);

400 
	`as£π
(
size
 <
SFS_BLKSIZE
);

401 
uöt32_t
 
nblks
 = 
fûe
->nblks;

402 
öode
 *öodê&(
fûe
->inode);

403 i‡(
nblks
 >
SFS_LN_NBLKS
) {

404 
	`›í_bug
(
sfs
, 
fûíame
, "file isÅoo big.\n");

406 i‡(
nblks
 < 
SFS_L0_NBLKS
) {

407 
öode
->
dúe˘
[
nblks
] = 
öo
;

409 i‡(
nblks
 < 
SFS_L1_NBLKS
) {

410 
nblks
 -
SFS_L0_NBLKS
;

411 
	`upd©e_ˇche
(
sfs
, &(
fûe
->
l1
), &(
öode
->
ödúe˘
));

412 
uöt32_t
 *
d©a
 = 
fûe
->
l1
->
ˇche
;

413 
d©a
[
nblks
] = 
öo
;

415 i‡(
nblks
 < 
SFS_L2_NBLKS
) {

416 
nblks
 -
SFS_L1_NBLKS
;

417 
	`upd©e_ˇche
(
sfs
, &(
fûe
->
l2
), &(
öode
->
db_ödúe˘
));

418 
uöt32_t
 *
d©a2
 = 
fûe
->
l2
->
ˇche
;

419 
	`upd©e_ˇche
(
sfs
, &(
fûe
->
l1
), &
d©a2
[
nblks
 / 
SFS_BLK_NENTRY
]);

420 
uöt32_t
 *
d©a1
 = 
fûe
->
l1
->
ˇche
;

421 
d©a1
[
nblks
 % 
SFS_BLK_NENTRY
] = 
öo
;

423 
fûe
->
nblks
 ++;

424 
öode
->
size
 += size;

425 
öode
->
blocks
 ++;

426 
	}
}

429 
	$add_íåy
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
cuºít
, ˇche_öodê*
fûe
, c⁄° *
«me
) {

430 
sfs_íåy
 
__íåy
, *
íåy
 = &__entry;

431 
	`as£π
(
cuºít
->
öode
.
ty≥
 =
SFS_TYPE_DIR
 && 
	`°æí
(
«me
Ë<
SFS_MAX_FNAME_LEN
);

432 
íåy
->
öo
 = 
fûe
->öo, 
	`°r˝y
”¡ry->
«me
,Çame);

433 
uöt32_t
 
íåy_öo
 = 
	`sfs_Æloc_öo
(
sfs
);

434 
	`wrôe_block
(
sfs
, 
íåy
, ”¡ry->
«me
), 
íåy_öo
);

435 
	`≠≥nd_block
(
sfs
, 
cuºít
, (
íåy
->
«me
), 
íåy_öo
,Çame);

436 
fûe
->
öode
.
∆öks
 ++;

437 
	}
}

440 
	$add_dú
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
∑ª¡
, c⁄° *
dú«me
, 
curfd
, 
fd
, 
öo_t
 
ªÆ
) {

441 
	`as£π
(
	`£¨ch_ˇche_öode
(
sfs
, 
ªÆ
Ë=
NULL
);

442 
ˇche_öode
 *
cuºít
 = 
	`Æloc_ˇche_öode
(
sfs
, 
ªÆ
, 0, 
SFS_TYPE_DIR
);

443 
	`ß„_fchdú
(
fd
), 
	`sub∑th_push
(
sfs
, 
dú«me
);

444 
	`›í_dú
(
sfs
, 
cuºít
, 
∑ª¡
);

445 
	`ß„_fchdú
(
curfd
), 
	`sub∑th_p›
(
sfs
);

446 
	`add_íåy
(
sfs
, 
∑ª¡
, 
cuºít
, 
dú«me
);

447 
	}
}

450 
	$add_fûe
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
cuºít
, c⁄° *
fûíame
, 
fd
, 
öo_t
 
ªÆ
) {

451 
ˇche_öode
 *
fûe
;

452 i‡((
fûe
 = 
	`£¨ch_ˇche_öode
(
sfs
, 
ªÆ
)Ë=
NULL
) {

453 
fûe
 = 
	`Æloc_ˇche_öode
(
sfs
, 
ªÆ
, 0, 
SFS_TYPE_FILE
);

454 
	`›í_fûe
(
sfs
, 
fûe
, 
fûíame
, 
fd
);

456 
	`add_íåy
(
sfs
, 
cuºít
, 
fûe
, 
fûíame
);

457 
	}
}

460 
	$add_lök
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
cuºít
, c⁄° *
fûíame
, 
öo_t
 
ªÆ
) {

461 
ˇche_öode
 *
fûe
 = 
	`Æloc_ˇche_öode
(
sfs
, 
ªÆ
, 0, 
SFS_TYPE_LINK
);

462 
	`›í_lök
(
sfs
, 
fûe
, 
fûíame
);

463 
	`add_íåy
(
sfs
, 
cuºít
, 
fûe
, 
fûíame
);

464 
	}
}

467 
	$›í_dú
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
cuºít
, ˇche_öodê*
∑ª¡
) {

468 
DIR
 *
dú
;

469 i‡((
dú
 = 
	`›ídú
(".")Ë=
NULL
) {

470 
	`›í_bug
(
sfs
, 
NULL
, "opendir failed.\n");

472 
	`add_íåy
(
sfs
, 
cuºít
, current, ".");

473 
	`add_íåy
(
sfs
, 
cuºít
, 
∑ª¡
, "..");

474 
dúít
 *
dúíç
;

475 (
dúíç
 = 
	`ªaddú
(
dú
)Ë!
NULL
) {

476 c⁄° *
«me
 = 
dúíç
->
d_«me
;

477 i‡(
	`°rcmp
(
«me
, ".") == 0 || strcmp(name, "..") == 0) {

480 i‡(
«me
[0] == '.') {

483 i‡(
	`°æí
(
«me
Ë> 
SFS_MAX_FNAME_LEN
) {

484 
	`›í_bug
(
sfs
, 
NULL
, "fûê«mêi†toÿl⁄g: %s\n", 
«me
);

486 
°©
 *°© = 
	`ß„_l°©
(
«me
);

487 i‡(
	`S_ISLNK
(
°©
->
°_mode
)) {

488 
	`add_lök
(
sfs
, 
cuºít
, 
«me
, 
°©
->
°_öo
);

491 
fd
;

492 i‡((
fd
 = 
	`›í
(
«me
, 
O_RDONLY
)) < 0) {

493 
	`›í_bug
(
sfs
, 
NULL
, "›í faûed: %s\n", 
«me
);

495 i‡(
	`S_ISDIR
(
°©
->
°_mode
)) {

496 
	`add_dú
(
sfs
, 
cuºít
, 
«me
, 
	`dúfd
(
dú
), 
fd
, 
°©
->
°_öo
);

498 i‡(
	`S_ISREG
(
°©
->
°_mode
)) {

499 
	`add_fûe
(
sfs
, 
cuºít
, 
«me
, 
fd
, 
°©
->
°_öo
);

502 
mode
 = '?';

503 i‡(
	`S_ISFIFO
(
°©
->
°_mode
)Ë
mode
 = 'f';

504 i‡(
	`S_ISSOCK
(
°©
->
°_mode
)Ë
mode
 = 's';

505 i‡(
	`S_ISCHR
(
°©
->
°_mode
)Ë
mode
 = 'c';

506 i‡(
	`S_ISBLK
(
°©
->
°_mode
)Ë
mode
 = 'b';

507 
	`show_fuŒ∑th
(
sfs
, 
NULL
);

508 
	`w¨n
("unsuµ‹ãd modê%07x (%c): fûê%s\n", 
°©
->
°_mode
, 
mode
, 
«me
);

510 
	`˛o£
(
fd
);

513 
	`˛o£dú
(
dú
);

514 
	}
}

517 
	$›í_fûe
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
fûe
, c⁄° *
fûíame
, 
fd
) {

518 
buf„r
[
SFS_BLKSIZE
];

519 
ssize_t
 
ªt
, 
œ°
 = 
SFS_BLKSIZE
;

520 (
ªt
 = 
	`ªad
(
fd
, 
buf„r
, (buffer))) != 0) {

521 
	`as£π
(
œ°
 =
SFS_BLKSIZE
);

522 
uöt32_t
 
öo
 = 
	`sfs_Æloc_öo
(
sfs
);

523 
	`wrôe_block
(
sfs
, 
buf„r
, 
ªt
, 
öo
);

524 
	`≠≥nd_block
(
sfs
, 
fûe
, 
ªt
, 
öo
, 
fûíame
);

525 
œ°
 = 
ªt
;

527 i‡(
ªt
 < 0) {

528 
	`›í_bug
(
sfs
, 
fûíame
, "read file failed.\n");

530 
	}
}

533 
	$›í_lök
(
sfs_fs
 *
sfs
, 
ˇche_öode
 *
fûe
, c⁄° *
fûíame
) {

534 
buf„r
[
SFS_BLKSIZE
];

535 
uöt32_t
 
öo
 = 
	`sfs_Æloc_öo
(
sfs
);

536 
ssize_t
 
ªt
 = 
	`ªadlök
(
fûíame
, 
buf„r
, (buffer));

537 i‡(
ªt
 < 0 ||Ñë =
SFS_BLKSIZE
) {

538 
	`›í_bug
(
sfs
, 
fûíame
, "ªadÜök faûed, %d", ()
ªt
);

540 
	`wrôe_block
(
sfs
, 
buf„r
, 
ªt
, 
öo
);

541 
	`≠≥nd_block
(
sfs
, 
fûe
, 
ªt
, 
öo
, 
fûíame
);

542 
	}
}

545 
	$¸óã_img
(
sfs_fs
 *
sfs
, c⁄° *
home
) {

546 
curfd
, 
homefd
;

547 i‡((
curfd
 = 
	`›í
(".", 
O_RDONLY
)) < 0) {

548 
	`bug
("get current fd failed.\n");

550 i‡((
homefd
 = 
	`›í
(
home
, 
O_RDONLY
 | 
O_NOFOLLOW
)) < 0) {

551 
	`bug
("›í homêdúe˘‹y '%s' faûed.\n", 
home
);

553 
	`ß„_fchdú
(
homefd
);

554 
	`›í_dú
(
sfs
, sfs->
roŸ
, sfs->root);

555 
	`ß„_fchdú
(
curfd
);

556 
	`˛o£
(
curfd
), clo£(
homefd
);

557 
	`˛o£_sfs
(
sfs
);

559 
	}
}

562 
	$°©ic_check
() {

563 
	`°©ic_as£π
((
off_t
) == 8);

564 
	`°©ic_as£π
((
öo_t
) == 8);

565 
	`°©ic_as£π
(
SFS_MAX_NBLKS
 <= 0x80000000UL);

566 
	`°©ic_as£π
(
SFS_MAX_FILE_SIZE
 <= 0x80000000UL);

567 
	}
}

570 
	$maö
(
¨gc
, **
¨gv
) {

571 
	`°©ic_check
();

572 i‡(
¨gc
 != 3) {

573 
	`bug
("usage: <input *.img> <input dirname>\n");

575 c⁄° *
img«me
 = 
¨gv
[1], *
home
 =árgv[2];

576 i‡(
	`¸óã_img
(
	`›í_img
(
img«me
), 
home
) != 0) {

577 
	`bug
("create img failed.\n");

579 
	`¥ötf
("¸óã %†(%sËsuc˚ssfuŒy.\n", 
img«me
, 
home
);

581 
	}
}

	@tools/sign.c

1 
	~<°dio.h
>

2 
	~<î∫o.h
>

3 
	~<°rög.h
>

4 
	~<sys/°©.h
>

7 
	$maö
(
¨gc
, *
¨gv
[]) {

8 
°©
 
°
;

9 i‡(
¨gc
 != 3) {

10 
	`Ârötf
(
°dîr
, "Usage: <input filename> <output filename>\n");

13 i‡(
	`°©
(
¨gv
[1], &
°
) != 0) {

14 
	`Ârötf
(
°dîr
, "Eº‹ o≥nög fûê'%s': %s\n", 
¨gv
[1], 
	`°ªº‹
(
î∫o
));

17 
	`¥ötf
("'%s' size: %Œd byãs\n", 
¨gv
[1], ()
°
.
°_size
);

18 i‡(
°
.
°_size
 > 510) {

19 
	`Ârötf
(
°dîr
, "%Œd >> 510!!\n", ()
°
.
°_size
);

22 
buf
[512];

23 
	`mem£t
(
buf
, 0, (buf));

24 
FILE
 *
iÂ
 = 
	`f›í
(
¨gv
[1], "rb");

25 
size
 = 
	`‰ód
(
buf
, 1, 
°
.
°_size
, 
iÂ
);

26 i‡(
size
 !
°
.
°_size
) {

27 
	`Ârötf
(
°dîr
, "ªad '%s'Éº‹, sizêi†%d.\n", 
¨gv
[1], 
size
);

30 
	`f˛o£
(
iÂ
);

31 
buf
[510] = 0x55;

32 
buf
[511] = 0xAA;

33 
FILE
 *
oÂ
 = 
	`f›í
(
¨gv
[2], "wb+");

34 
size
 = 
	`fwrôe
(
buf
, 1, 512, 
oÂ
);

35 i‡(
size
 != 512) {

36 
	`Ârötf
(
°dîr
, "wrôê'%s'Éº‹, sizêi†%d.\n", 
¨gv
[2], 
size
);

39 
	`f˛o£
(
oÂ
);

40 
	`¥ötf
("buûd 512 byã†boŸ se˘‹: '%s' suc˚ss!\n", 
¨gv
[2]);

42 
	}
}

	@tools/vector.c

1 
	~<°dio.h
>

4 
	$maö
() {

5 
	`¥ötf
("# handler\n");

6 
	`¥ötf
(".text\n");

7 
	`¥ötf
(".globl __alltraps\n");

9 
i
;

10 
i
 = 0; i < 256; i ++) {

11 
	`¥ötf
(".glob»ve˘‹%d\n", 
i
);

12 
	`¥ötf
("ve˘‹%d:\n", 
i
);

13 i‡((
i
 < 8 || i > 14) && i != 17) {

14 
	`¥ötf
("Öushl $0\n");

16 
	`¥ötf
("Öush»$%d\n", 
i
);

17 
	`¥ötf
(" jmp __alltraps\n");

19 
	`¥ötf
("\n");

20 
	`¥ötf
("# vectorÅable\n");

21 
	`¥ötf
(".data\n");

22 
	`¥ötf
(".globl __vectors\n");

23 
	`¥ötf
("__vectors:\n");

24 
i
 = 0; i < 256; i ++) {

25 
	`¥ötf
(" .l⁄g ve˘‹%d\n", 
i
);

28 
	}
}

	@user/badarg.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

5 
	$maö
() {

6 
pid
, 
exô_code
;

7 i‡((
pid
 = 
	`f‹k
()) == 0) {

8 
	`˝rötf
("fork ok.\n");

9 
i
;

10 
i
 = 0; i < 10; i ++) {

11 
	`yõld
();

13 
	`exô
(0xbeaf);

15 
	`as£π
(
pid
 > 0);

16 
	`as£π
(
	`waôpid
(-1, 
NULL
) != 0);

17 
	`as£π
(
	`waôpid
(
pid
, (*)0xC0000000) != 0);

18 
	`as£π
(
	`waôpid
(
pid
, &
exô_code
) == 0 &&Éxit_code == 0xbeaf);

19 
	`˝rötf
("badargÖass.\n");

21 
	}
}

	@user/badsegment.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

7 
	$maö
() {

8 
asm
 volatile("movw $0x28,%ax; movw %ax,%ds");

9 
	`∑nic
("FAIL: T.T\n");

10 
	}
}

	@user/divzero.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

4 
	gzîo
;

7 
	$maö
() {

8 
	`˝rötf
("vÆuêi†%d.\n", 1 / 
zîo
);

9 
	`∑nic
("FAIL: T.T\n");

10 
	}
}

	@user/exit.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

4 
	gmagic
 = -0x10384;

7 
	$maö
() {

8 
pid
, 
code
;

9 
	`˝rötf
("IámÅheÖarent. ForkingÅhe child...\n");

10 i‡((
pid
 = 
	`f‹k
()) == 0) {

11 
	`˝rötf
("IámÅhe child.\n");

12 
	`yõld
();

13 
	`yõld
();

14 
	`yõld
();

15 
	`yõld
();

16 
	`yõld
();

17 
	`yõld
();

18 
	`yõld
();

19 
	`exô
(
magic
);

22 
	`˝rötf
("IámÖ¨ít, f‹ká chûdÖid %d\n",
pid
);

24 
	`as£π
(
pid
 > 0);

25 
	`˝rötf
("IámÅheÖarent, waitingÇow..\n");

27 
	`as£π
(
	`waôpid
(
pid
, &
code
Ë=0 && codê=
magic
);

28 
	`as£π
(
	`waôpid
(
pid
, &
code
Ë!0 && 
	`waô
() != 0);

29 
	`˝rötf
("waôpid %d ok.\n", 
pid
);

31 
	`˝rötf
("exitÖass.\n");

33 
	}
}

	@user/faultread.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

5 
	$maö
() {

6 
	`˝rötf
("IÑead %8x from 0.\n", *(*)0);

7 
	`∑nic
("FAIL: T.T\n");

8 
	}
}

	@user/faultreadkernel.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

5 
	$maö
() {

6 
	`˝rötf
("IÑead %08x from 0xfac00000!\n", *(*)0xfac00000);

7 
	`∑nic
("FAIL: T.T\n");

8 
	}
}

	@user/forktest.c

1 
	~<ulib.h
>

2 
	~<°dio.h
>

4 c⁄° 
	gmax_chûd
 = 32;

7 
	$maö
() {

8 
n
, 
pid
;

9 
n
 = 0;Ç < 
max_chûd
;Ç ++) {

10 i‡((
pid
 = 
	`f‹k
()) == 0) {

11 
	`˝rötf
("Iám chûd %d\n", 
n
);

12 
	`exô
(0);

14 
	`as£π
(
pid
 > 0);

17 i‡(
n
 > 
max_chûd
) {

18 
	`∑nic
("f‹k cœimedÅÿw‹k %dÅimes!\n", 
n
);

21 ; 
n
 > 0;Ç --) {

22 i‡(
	`waô
() != 0) {

23 
	`∑nic
("wait stoppedÉarly\n");

27 i‡(
	`waô
() == 0) {

28 
	`∑nic
("wait gotÅoo many\n");

31 
	`˝rötf
("forktestÖass.\n");

33 
	}
}

	@user/forktree.c

1 
	~<ulib.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

5 
	#DEPTH
 4

	)

6 
	#SLEEP_TIME
 400

	)

7 
f‹kåì
(c⁄° *
cur
);

10 
	$f‹kchûd
(c⁄° *
cur
, 
bønch
) {

11 
nxt
[
DEPTH
 + 1];

13 i‡(
	`°æí
(
cur
Ë>
DEPTH
)

16 
	`¢¥ötf
(
nxt
, 
DEPTH
 + 1, "%s%c", 
cur
, 
bønch
);

17 i‡(
	`f‹k
() == 0) {

18 
	`f‹kåì
(
nxt
);

19 
	`yõld
();

20 
	`exô
(0);

22 
	}
}

25 
	$f‹kåì
(c⁄° *
cur
) {

26 
	`˝rötf
("%04x: Iám '%s'\n", 
	`gëpid
(), 
cur
);

28 
	`f‹kchûd
(
cur
, '0');

29 
	`f‹kchûd
(
cur
, '1');

30 
	}
}

33 
	$maö
() {

34 
	`˝rötf
("f‹kåìÖro˚s†wû»¶ì∞%dÅicks\n",
SLEEP_TIME
);

35 
	`¶ìp
(
SLEEP_TIME
);

36 
	`f‹kåì
("");

38 
	}
}

	@user/hello.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

5 
	$maö
() {

6 
	`˝rötf
("Hello world!!.\n");

7 
	`˝rötf
("IámÖro˚s†%d.\n", 
	`gëpid
());

8 
	`˝rötf
("helloÖass.\n");

10 
	}
}

	@user/libs/dir.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<sysˇŒ.h
>

4 
	~<°©.h
>

5 
	~<dúít.h
>

6 
	~<fûe.h
>

7 
	~<dú.h
>

8 
	~<îr‹.h
>

9 
	~<uni°d.h
>

11 
DIR
 
	gdú
, *
	gdúp
=&
dú
;

12 
DIR
 *

13 
	$›ídú
(c⁄° *
∑th
) {

15 i‡((
dúp
->
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
)) < 0) {

16 
Áûed
;

18 
°©
 
__°©
, *stat = &__stat;

19 i‡(
	`f°©
(
dúp
->
fd
, 
°©
Ë!0 || !
	`S_ISDIR
(°©->
°_mode
)) {

20 
Áûed
;

22 
dúp
->
dúít
.
off£t
 = 0;

23  
dúp
;

25 
Áûed
:

26  
NULL
;

27 
	}
}

29 
dúít
 *

30 
	$ªaddú
(
DIR
 *
dúp
) {

31 i‡(
	`sys_gëdúíåy
(
dúp
->
fd
, &(dúp->
dúít
)) == 0) {

32  &(
dúp
->
dúít
);

34  
NULL
;

35 
	}
}

38 
	$˛o£dú
(
DIR
 *
dúp
) {

39 
	`˛o£
(
dúp
->
fd
);

40 
	}
}

43 
	$gëcwd
(*
buf„r
, 
size_t
 
Àn
) {

44  
	`sys_gëcwd
(
buf„r
, 
Àn
);

45 
	}
}

	@user/libs/dir.h

1 #i‚de‡
__USER_LIBS_DIR_H__


2 
	#__USER_LIBS_DIR_H__


	)

4 
	~<defs.h
>

5 
	~<dúít.h
>

8 
	mfd
;

9 
dúít
 
	mdúít
;

10 } 
	tDIR
;

12 
DIR
 *
›ídú
(c⁄° *
∑th
);

13 
dúít
 *
ªaddú
(
DIR
 *
dúp
);

14 
˛o£dú
(
DIR
 *
dúp
);

15 
chdú
(c⁄° *
∑th
);

16 
gëcwd
(*
buf„r
, 
size_t
 
Àn
);

	@user/libs/file.c

1 
	~<defs.h
>

2 
	~<°rög.h
>

3 
	~<sysˇŒ.h
>

4 
	~<°dio.h
>

5 
	~<°©.h
>

6 
	~<îr‹.h
>

7 
	~<uni°d.h
>

10 
	$›í
(c⁄° *
∑th
, 
uöt32_t
 
›í_Êags
) {

11  
	`sys_›í
(
∑th
, 
›í_Êags
);

12 
	}
}

15 
	$˛o£
(
fd
) {

16  
	`sys_˛o£
(
fd
);

17 
	}
}

20 
	$ªad
(
fd
, *
ba£
, 
size_t
 
Àn
) {

21  
	`sys_ªad
(
fd
, 
ba£
, 
Àn
);

22 
	}
}

25 
	$wrôe
(
fd
, *
ba£
, 
size_t
 
Àn
) {

26  
	`sys_wrôe
(
fd
, 
ba£
, 
Àn
);

27 
	}
}

30 
	$£ek
(
fd
, 
off_t
 
pos
, 
whí˚
) {

31  
	`sys_£ek
(
fd
, 
pos
, 
whí˚
);

32 
	}
}

35 
	$f°©
(
fd
, 
°©
 *stat) {

36  
	`sys_f°©
(
fd
, 
°©
);

37 
	}
}

40 
	$fsync
(
fd
) {

41  
	`sys_fsync
(
fd
);

42 
	}
}

45 
	$dup2
(
fd1
, 
fd2
) {

46  
	`sys_dup
(
fd1
, 
fd2
);

47 
	}
}

50 
	$å™smode
(
°©
 *stat) {

51 
uöt32_t
 
mode
 = 
°©
->
°_mode
;

52 i‡(
	`S_ISREG
(
mode
))  'r';

53 i‡(
	`S_ISDIR
(
mode
))  'd';

54 i‡(
	`S_ISLNK
(
mode
))  'l';

55 i‡(
	`S_ISCHR
(
mode
))  'c';

56 i‡(
	`S_ISBLK
(
mode
))  'b';

58 
	}
}

61 
	$¥öt_°©
(c⁄° *
«me
, 
fd
, 
°©
 *stat) {

62 
	`˝rötf
("[%03d] %s\n", 
fd
, 
«me
);

63 
	`˝rötf
(" modê : %c\n", 
	`å™smode
(
°©
));

64 
	`˝rötf
("Üök† : %lu\n", 
°©
->
°_∆öks
);

65 
	`˝rötf
(" block† : %lu\n", 
°©
->
°_blocks
);

66 
	`˝rötf
(" sizê : %lu\n", 
°©
->
°_size
);

67 
	}
}

	@user/libs/file.h

1 #i‚de‡
__USER_LIBS_FILE_H__


2 
	#__USER_LIBS_FILE_H__


	)

4 
	~<defs.h
>

6 
	g°©
;

8 
›í
(c⁄° *
∑th
, 
uöt32_t
 
›í_Êags
);

9 
˛o£
(
fd
);

10 
ªad
(
fd
, *
ba£
, 
size_t
 
Àn
);

11 
wrôe
(
fd
, *
ba£
, 
size_t
 
Àn
);

12 
£ek
(
fd
, 
off_t
 
pos
, 
whí˚
);

13 
f°©
(
fd
, 
°©
 *stat);

14 
fsync
(
fd
);

15 
dup
(
fd
);

16 
dup2
(
fd1
, 
fd2
);

17 
pùe
(*
fd_°‹e
);

18 
mkfifo
(c⁄° *
«me
, 
uöt32_t
 
›í_Êags
);

20 
¥öt_°©
(c⁄° *
«me
, 
fd
, 
°©
 *stat);

	@user/libs/lock.h

1 #i‚de‡
__USER_LIBS_LOCK_H__


2 
	#__USER_LIBS_LOCK_H__


	)

4 
	~<defs.h
>

5 
	~<©omic.h
>

6 
	~<ulib.h
>

8 
	#INIT_LOCK
 {0}

	)

10 vﬁ©ûê
	tboﬁ
 
	tlock_t
;

12 
ölöe
 

13 
	$lock_öô
(
lock_t
 *
l
) {

14 *
l
 = 0;

15 
	}
}

17 
ölöe
 
boﬁ


18 
	$åy_lock
(
lock_t
 *
l
) {

19  
	`ã°_™d_£t_bô
(0, 
l
);

20 
	}
}

22 
ölöe
 

23 
	$lock
(
lock_t
 *
l
) {

24 i‡(
	`åy_lock
(
l
)) {

25 
°ï
 = 0;

27 
	`yõld
();

28 i‡(++ 
°ï
 == 100) {

29 
°ï
 = 0;

30 
	`¶ìp
(10);

32 } 
	`åy_lock
(
l
));

34 
	}
}

36 
ölöe
 

37 
	$u∆ock
(
lock_t
 *
l
) {

38 
	`ã°_™d_˛ór_bô
(0, 
l
);

39 
	}
}

	@user/libs/panic.c

1 
	~<defs.h
>

2 
	~<°d¨g.h
>

3 
	~<°dio.h
>

4 
	~<ulib.h
>

5 
	~<îr‹.h
>

8 
	$__∑nic
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
, ...) {

10 
va_li°
 
≠
;

11 
	`va_°¨t
(
≠
, 
fmt
);

12 
	`˝rötf
("u£∏∑ni¯© %s:%d:\¿ ", 
fûe
, 
löe
);

13 
	`v˝rötf
(
fmt
, 
≠
);

14 
	`˝rötf
("\n");

15 
	`va_íd
(
≠
);

16 
	`exô
(-
E_PANIC
);

17 
	}
}

20 
	$__w¨n
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
, ...) {

21 
va_li°
 
≠
;

22 
	`va_°¨t
(
≠
, 
fmt
);

23 
	`˝rötf
("u£∏w¨nögáà%s:%d:\¿ ", 
fûe
, 
löe
);

24 
	`v˝rötf
(
fmt
, 
≠
);

25 
	`˝rötf
("\n");

26 
	`va_íd
(
≠
);

27 
	}
}

	@user/libs/stdio.c

1 
	~<defs.h
>

2 
	~<°dio.h
>

3 
	~<sysˇŒ.h
>

4 
	~<fûe.h
>

5 
	~<ulib.h
>

6 
	~<uni°d.h
>

13 
	$˝utch
(
c
, *
˙t
) {

14 
	`sys_putc
(
c
);

15 (*
˙t
) ++;

16 
	}
}

28 
	$v˝rötf
(c⁄° *
fmt
, 
va_li°
 
≠
) {

29 
˙t
 = 0;

30 
	`v¥ötfmt
((*)
˝utch
, 
NO_FD
, &
˙t
, 
fmt
, 
≠
);

31  
˙t
;

32 
	}
}

41 
	$˝rötf
(c⁄° *
fmt
, ...) {

42 
va_li°
 
≠
;

44 
	`va_°¨t
(
≠
, 
fmt
);

45 
˙t
 = 
	`v˝rötf
(
fmt
, 
≠
);

46 
	`va_íd
(
≠
);

48  
˙t
;

49 
	}
}

56 
	$˝uts
(c⁄° *
°r
) {

57 
˙t
 = 0;

58 
c
;

59 (
c
 = *
°r
 ++) != '\0') {

60 
	`˝utch
(
c
, &
˙t
);

62 
	`˝utch
('\n', &
˙t
);

63  
˙t
;

64 
	}
}

68 
	$Âutch
(
c
, *
˙t
, 
fd
) {

69 
	`wrôe
(
fd
, &
c
, ());

70 (*
˙t
) ++;

71 
	}
}

74 
	$vÂrötf
(
fd
, c⁄° *
fmt
, 
va_li°
 
≠
) {

75 
˙t
 = 0;

76 
	`v¥ötfmt
((*)
Âutch
, 
fd
, &
˙t
, 
fmt
, 
≠
);

77  
˙t
;

78 
	}
}

81 
	$Ârötf
(
fd
, c⁄° *
fmt
, ...) {

82 
va_li°
 
≠
;

84 
	`va_°¨t
(
≠
, 
fmt
);

85 
˙t
 = 
	`vÂrötf
(
fd
, 
fmt
, 
≠
);

86 
	`va_íd
(
≠
);

88  
˙t
;

89 
	}
}

	@user/libs/syscall.c

1 
	~<defs.h
>

2 
	~<uni°d.h
>

3 
	~<°d¨g.h
>

4 
	~<sysˇŒ.h
>

5 
	~<°©.h
>

6 
	~<dúít.h
>

9 
	#MAX_ARGS
 5

	)

11 
ölöe
 

12 
	$sysˇŒ
(
num
, ...) {

13 
va_li°
 
≠
;

14 
	`va_°¨t
(
≠
, 
num
);

15 
uöt32_t
 
a
[
MAX_ARGS
];

16 
i
, 
ªt
;

17 
i
 = 0; i < 
MAX_ARGS
; i ++) {

18 
a
[
i
] = 
	`va_¨g
(
≠
, 
uöt32_t
);

20 
	`va_íd
(
≠
);

22 
asm
 volatile (

24 : "˜" (
ªt
)

25 : "i" (
T_SYSCALL
),

26 "a" (
num
),

27 "d" (
a
[0]),

28 "c" (
a
[1]),

29 "b" (
a
[2]),

30 "D" (
a
[3]),

31 "S" (
a
[4])

33  
ªt
;

34 
	}
}

37 
	$sys_exô
(
îr‹_code
) {

38  
	`sysˇŒ
(
SYS_exô
, 
îr‹_code
);

39 
	}
}

42 
	$sys_f‹k
() {

43  
	`sysˇŒ
(
SYS_f‹k
);

44 
	}
}

47 
	$sys_waô
(
pid
, *
°‹e
) {

48  
	`sysˇŒ
(
SYS_waô
, 
pid
, 
°‹e
);

49 
	}
}

52 
	$sys_yõld
() {

53  
	`sysˇŒ
(
SYS_yõld
);

54 
	}
}

57 
	$sys_kûl
(
pid
) {

58  
	`sysˇŒ
(
SYS_kûl
, 
pid
);

59 
	}
}

62 
	$sys_gëpid
() {

63  
	`sysˇŒ
(
SYS_gëpid
);

64 
	}
}

67 
	$sys_putc
(
c
) {

68  
	`sysˇŒ
(
SYS_putc
, 
c
);

69 
	}
}

72 
	$sys_pgdú
() {

73  
	`sysˇŒ
(
SYS_pgdú
);

74 
	}
}

77 
	$sys_œb6_£t_¥i‹ôy
(
uöt32_t
 
¥i‹ôy
)

79 
	`sysˇŒ
(
SYS_œb6_£t_¥i‹ôy
, 
¥i‹ôy
);

80 
	}
}

83 
	$sys_¶ìp
(
time
) {

84  
	`sysˇŒ
(
SYS_¶ìp
, 
time
);

85 
	}
}

87 
size_t


88 
	$sys_gëtime
() {

89  
	`sysˇŒ
(
SYS_gëtime
);

90 
	}
}

93 
	$sys_exec
(c⁄° *
«me
, 
¨gc
, c⁄° **
¨gv
) {

94  
	`sysˇŒ
(
SYS_exec
, 
«me
, 
¨gc
, 
¨gv
);

95 
	}
}

98 
	$sys_›í
(c⁄° *
∑th
, 
uöt32_t
 
›í_Êags
) {

99  
	`sysˇŒ
(
SYS_›í
, 
∑th
, 
›í_Êags
);

100 
	}
}

103 
	$sys_˛o£
(
fd
) {

104  
	`sysˇŒ
(
SYS_˛o£
, 
fd
);

105 
	}
}

108 
	$sys_ªad
(
fd
, *
ba£
, 
size_t
 
Àn
) {

109  
	`sysˇŒ
(
SYS_ªad
, 
fd
, 
ba£
, 
Àn
);

110 
	}
}

113 
	$sys_wrôe
(
fd
, *
ba£
, 
size_t
 
Àn
) {

114  
	`sysˇŒ
(
SYS_wrôe
, 
fd
, 
ba£
, 
Àn
);

115 
	}
}

118 
	$sys_£ek
(
fd
, 
off_t
 
pos
, 
whí˚
) {

119  
	`sysˇŒ
(
SYS_£ek
, 
fd
, 
pos
, 
whí˚
);

120 
	}
}

123 
	$sys_f°©
(
fd
, 
°©
 *stat) {

124  
	`sysˇŒ
(
SYS_f°©
, 
fd
, 
°©
);

125 
	}
}

128 
	$sys_fsync
(
fd
) {

129  
	`sysˇŒ
(
SYS_fsync
, 
fd
);

130 
	}
}

133 
	$sys_gëcwd
(*
buf„r
, 
size_t
 
Àn
) {

134  
	`sysˇŒ
(
SYS_gëcwd
, 
buf„r
, 
Àn
);

135 
	}
}

138 
	$sys_gëdúíåy
(
fd
, 
dúít
 *dirent) {

139  
	`sysˇŒ
(
SYS_gëdúíåy
, 
fd
, 
dúít
);

140 
	}
}

143 
	$sys_dup
(
fd1
, 
fd2
) {

144  
	`sysˇŒ
(
SYS_dup
, 
fd1
, 
fd2
);

145 
	}
}

	@user/libs/syscall.h

1 #i‚de‡
__USER_LIBS_SYSCALL_H__


2 
	#__USER_LIBS_SYSCALL_H__


	)

4 
sys_exô
(
îr‹_code
);

5 
sys_f‹k
();

6 
sys_waô
(
pid
, *
°‹e
);

7 
sys_exec
(c⁄° *
«me
, 
¨gc
, c⁄° **
¨gv
);

8 
sys_yõld
();

9 
sys_kûl
(
pid
);

10 
sys_gëpid
();

11 
sys_putc
(
c
);

12 
sys_pgdú
();

13 
sys_¶ìp
(
time
);

14 
size_t
 
sys_gëtime
();

16 
	g°©
;

17 
	gdúít
;

19 
sys_›í
(c⁄° *
∑th
, 
uöt32_t
 
›í_Êags
);

20 
sys_˛o£
(
fd
);

21 
sys_ªad
(
fd
, *
ba£
, 
size_t
 
Àn
);

22 
sys_wrôe
(
fd
, *
ba£
, 
size_t
 
Àn
);

23 
sys_£ek
(
fd
, 
off_t
 
pos
, 
whí˚
);

24 
sys_f°©
(
fd
, 
°©
 *stat);

25 
sys_fsync
(
fd
);

26 
sys_gëcwd
(*
buf„r
, 
size_t
 
Àn
);

27 
sys_gëdúíåy
(
fd
, 
dúít
 *dirent);

28 
sys_dup
(
fd1
, 
fd2
);

29 
sys_œb6_£t_¥i‹ôy
(
uöt32_t
 
¥i‹ôy
);

	@user/libs/ulib.c

1 
	~<defs.h
>

2 
	~<sysˇŒ.h
>

3 
	~<°dio.h
>

4 
	~<ulib.h
>

5 
	~<°©.h
>

6 
	~<°rög.h
>

7 
	~<lock.h
>

9 
lock_t
 
	gf‹k_lock
 = 
INIT_LOCK
;

12 
	$lock_f‹k
() {

13 
	`lock
(&
f‹k_lock
);

14 
	}
}

17 
	$u∆ock_f‹k
() {

18 
	`u∆ock
(&
f‹k_lock
);

19 
	}
}

22 
	$exô
(
îr‹_code
) {

23 
	`sys_exô
(
îr‹_code
);

24 
	`˝rötf
("BUG:Éxit failed.\n");

26 
	}
}

29 
	$f‹k
() {

30  
	`sys_f‹k
();

31 
	}
}

34 
	$waô
() {

35  
	`sys_waô
(0, 
NULL
);

36 
	}
}

39 
	$waôpid
(
pid
, *
°‹e
) {

40  
	`sys_waô
(
pid
, 
°‹e
);

41 
	}
}

44 
	$yõld
() {

45 
	`sys_yõld
();

46 
	}
}

49 
	$kûl
(
pid
) {

50  
	`sys_kûl
(
pid
);

51 
	}
}

54 
	$gëpid
() {

55  
	`sys_gëpid
();

56 
	}
}

60 
	$¥öt_pgdú
() {

61 
	`sys_pgdú
();

62 
	}
}

65 
	$œb6_£t_¥i‹ôy
(
uöt32_t
 
¥i‹ôy
)

67 
	`sys_œb6_£t_¥i‹ôy
(
¥i‹ôy
);

68 
	}
}

71 
	$¶ìp
(
time
) {

72  
	`sys_¶ìp
(
time
);

73 
	}
}

76 
	$gëtime_m£c
() {

77  ()
	`sys_gëtime
();

78 
	}
}

81 
	$__exec
(c⁄° *
«me
, c⁄° **
¨gv
) {

82 
¨gc
 = 0;

83 
¨gv
[
¨gc
] !
NULL
) {

84 
¨gc
 ++;

86  
	`sys_exec
(
«me
, 
¨gc
, 
¨gv
);

87 
	}
}

	@user/libs/ulib.h

1 #i‚de‡
__USER_LIBS_ULIB_H__


2 
	#__USER_LIBS_ULIB_H__


	)

4 
	~<defs.h
>

6 
__w¨n
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
, ...);

7 
__n‹ëu∫
 
__∑nic
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
, ...);

9 
	#w¨n
(...) \

10 
	`__w¨n
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

12 
	#∑nic
(...) \

13 
	`__∑nic
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

15 
	#as£π
(
x
) \

17 i‡(!(
x
)) { \

18 
	`∑nic
("assertion failed: %s", #x); \

20 } 0)

	)

23 
	#°©ic_as£π
(
x
) \

24 
x
Ë{ 0: (x): ; }

	)

26 
Ârötf
(
fd
, c⁄° *
fmt
, ...);

28 
__n‹ëu∫
 
exô
(
îr‹_code
);

29 
f‹k
();

30 
waô
();

31 
waôpid
(
pid
, *
°‹e
);

32 
yõld
();

33 
kûl
(
pid
);

34 
gëpid
();

35 
¥öt_pgdú
();

36 
¶ìp
(
time
);

37 
gëtime_m£c
();

38 
__exec
(c⁄° *
«me
, c⁄° **
¨gv
);

40 
	#__exec0
(
«me
, 
∑th
, ...) \

41 ({ c⁄° *
¨gv
[] = {
∑th
, ##
__VA_ARGS__
, 
NULL
}; 
	`__exec
(
«me
,árgv); })

	)

43 
	#exec
(
∑th
, ...Ë
	`__exec0
(
NULL
,Ö©h, ##
__VA_ARGS__
)

	)

44 
	#√xec
(
«me
, 
∑th
, ...Ë
	`__exec0
“ame,Ö©h, ##
__VA_ARGS__
)

	)

46 
œb6_£t_¥i‹ôy
(
uöt32_t
 
¥i‹ôy
);

	@user/libs/umain.c

1 
	~<ulib.h
>

2 
	~<uni°d.h
>

3 
	~<fûe.h
>

4 
	~<°©.h
>

6 
maö
(
¨gc
, *
¨gv
[]);

9 
	$öôfd
(
fd2
, c⁄° *
∑th
, 
uöt32_t
 
›í_Êags
) {

10 
fd1
, 
ªt
;

11 i‡((
fd1
 = 
	`›í
(
∑th
, 
›í_Êags
)) < 0) {

12  
fd1
;

14 i‡(
fd1
 !
fd2
) {

15 
	`˛o£
(
fd2
);

16 
ªt
 = 
	`dup2
(
fd1
, 
fd2
);

17 
	`˛o£
(
fd1
);

19  
ªt
;

20 
	}
}

23 
	$umaö
(
¨gc
, *
¨gv
[]) {

24 
fd
;

25 i‡((
fd
 = 
	`öôfd
(0, "°dö:", 
O_RDONLY
)) < 0) {

26 
	`w¨n
("›í <°dö> faûed: %e.\n", 
fd
);

28 i‡((
fd
 = 
	`öôfd
(1, "°dout:", 
O_WRONLY
)) < 0) {

29 
	`w¨n
("›í <°dout> faûed: %e.\n", 
fd
);

31 
ªt
 = 
	`maö
(
¨gc
, 
¨gv
);

32 
	`exô
(
ªt
);

33 
	}
}

	@user/ls.c

1 
	~<ulib.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<dú.h
>

5 
	~<fûe.h
>

6 
	~<°©.h
>

7 
	~<dúít.h
>

8 
	~<uni°d.h
>

10 
	#¥ötf
(...Ë
	`Ârötf
(1, 
__VA_ARGS__
)

	)

11 
	#BUFSIZE
 4096

	)

14 
	$gëmode
(
uöt32_t
 
°_mode
) {

15 
mode
 = '?';

16 i‡(
	`S_ISREG
(
°_mode
)Ë
mode
 = '-';

17 i‡(
	`S_ISDIR
(
°_mode
)Ë
mode
 = 'd';

18 i‡(
	`S_ISLNK
(
°_mode
)Ë
mode
 = 'l';

19 i‡(
	`S_ISCHR
(
°_mode
)Ë
mode
 = 'c';

20 i‡(
	`S_ISBLK
(
°_mode
)Ë
mode
 = 'b';

21  
mode
;

22 
	}
}

25 
	$gë°©
(c⁄° *
«me
, 
°©
 *stat) {

26 
fd
, 
ªt
;

27 i‡((
fd
 = 
	`›í
(
«me
, 
O_RDONLY
)) < 0) {

28  
fd
;

30 
ªt
 = 
	`f°©
(
fd
, 
°©
);

31 
	`˛o£
(
fd
);

32  
ªt
;

33 
	}
}

36 
	$ls°©
(
°©
 *°©, c⁄° *
fûíame
) {

37 
	`¥ötf
(" [%c]", 
	`gëmode
(
°©
->
°_mode
));

38 
	`¥ötf
(" %3d(h)", 
°©
->
°_∆öks
);

39 
	`¥ötf
(" %8d(b)", 
°©
->
°_blocks
);

40 
	`¥ötf
(" %8d(s)", 
°©
->
°_size
);

41 
	`¥ötf
(" %s\n", 
fûíame
);

42 
	}
}

45 
	$lsdú
(c⁄° *
∑th
) {

46 
°©
 
__°©
, *stat = &__stat;

47 
ªt
;

48 
DIR
 *
dúp
 = 
	`›ídú
(".");

50 i‡(
dúp
 =
NULL
) {

53 
dúít
 *
dúíç
;

54 (
dúíç
 = 
	`ªaddú
(
dúp
)Ë!
NULL
) {

55 i‡((
ªt
 = 
	`gë°©
(
dúíç
->
«me
, 
°©
)) != 0) {

56 
Áûed
;

58 
	`ls°©
(
°©
, 
dúíç
->
«me
);

60 
	`¥ötf
("lsdir: step 4\n");

61 
	`˛o£dú
(
dúp
);

63 
Áûed
:

64 
	`˛o£dú
(
dúp
);

65  
ªt
;

66 
	}
}

69 
	$ls
(c⁄° *
∑th
) {

70 
°©
 
__°©
, *stat = &__stat;

71 
ªt
, 
ty≥
;

72 i‡((
ªt
 = 
	`gë°©
(
∑th
, 
°©
)) != 0) {

73  
ªt
;

76 c⁄° *
fûëy≥
[] = {

84 
	`gëmode
(
°©
->
°_mode
)) {

85 '0': 
ty≥
 = 0; ;

86 'd': 
ty≥
 = 1; ;

87 'l': 
ty≥
 = 2; ;

88 'c': 
ty≥
 = 3; ;

89 'b': 
ty≥
 = 4; ;

90 : 
ty≥
 = 5; ;

93 
	`¥ötf
(" @ i†%s", 
fûëy≥
[
ty≥
]);

94 
	`¥ötf
(" %d(hlöks)", 
°©
->
°_∆öks
);

95 
	`¥ötf
(" %d(blocks)", 
°©
->
°_blocks
);

96 
	`¥ötf
(" %d(byãsË: @'%s'\n", 
°©
->
°_size
, 
∑th
);

97 i‡(
	`S_ISDIR
(
°©
->
°_mode
)) {

98  
	`lsdú
(
∑th
);

101 
	}
}

104 
	$maö
(
¨gc
, **
¨gv
) {

105 i‡(
¨gc
 == 1) {

106  
	`ls
(".");

109 
i
, 
ªt
;

110 
i
 = 1; i < 
¨gc
; i ++) {

111 i‡((
ªt
 = 
	`ls
(
¨gv
[
i
])) != 0) {

112  
ªt
;

117 
	}
}

	@user/matrix.c

1 
	~<ulib.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<°dlib.h
>

6 
	#MATSIZE
 10

	)

8 
	gm©a
[
MATSIZE
][MATSIZE];

9 
	gm©b
[
MATSIZE
][MATSIZE];

10 
	gm©c
[
MATSIZE
][MATSIZE];

13 
	$w‹k
(
times
) {

14 
i
, 
j
, 
k
, 
size
 = 
MATSIZE
;

15 
i
 = 0; i < 
size
; i ++) {

16 
j
 = 0; j < 
size
; j ++) {

17 
m©a
[
i
][
j
] = 
m©b
[i][j] = 1;

21 
	`yõld
();

23 
	`˝rötf
("pid %d i†ru¬ög (%dÅimes)!.\n", 
	`gëpid
(), 
times
);

25 
times
 -- > 0) {

26 
i
 = 0; i < 
size
; i ++) {

27 
j
 = 0; j < 
size
; j ++) {

28 
m©c
[
i
][
j
] = 0;

29 
k
 = 0; k < 
size
; k ++) {

30 
m©c
[
i
][
j
] +
m©a
[i][
k
] * 
m©b
[k][j];

34 
i
 = 0; i < 
size
; i ++) {

35 
j
 = 0; j < 
size
; j ++) {

36 
m©a
[
i
][
j
] = 
m©b
[i][j] = 
m©c
[i][j];

40 
	`˝rötf
("pid %d d⁄e!.\n", 
	`gëpid
());

41 
	`exô
(0);

42 
	}
}

44 c⁄° 
	gtŸÆ
 = 21;

47 
	$maö
() {

48 
pids
[
tŸÆ
];

49 
	`mem£t
(
pids
, 0, (pids));

51 
i
;

52 
i
 = 0; i < 
tŸÆ
; i ++) {

53 i‡((
pids
[
i
] = 
	`f‹k
()) == 0) {

54 
	`§™d
(
i
 * i);

55 
times
 = ((()
	`ønd
()Ë% 
tŸÆ
);

56 
times
 = (times *Åimes + 10) * 100;

57 
	`w‹k
(
times
);

59 i‡(
pids
[
i
] < 0) {

60 
Áûed
;

64 
	`˝rötf
("fork ok.\n");

66 
i
 = 0; i < 
tŸÆ
; i ++) {

67 i‡(
	`waô
() != 0) {

68 
	`˝rötf
("wait failed.\n");

69 
Áûed
;

73 
	`˝rötf
("matrixÖass.\n");

76 
Áûed
:

77 
i
 = 0; i < 
tŸÆ
; i ++) {

78 i‡(
pids
[
i
] > 0) {

79 
	`kûl
(
pids
[
i
]);

82 
	`∑nic
("FAIL: T.T\n");

83 
	}
}

	@user/pgdir.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

5 
	$maö
() {

6 
	`˝rötf
("Iám %d,Öröàpgdú.\n", 
	`gëpid
());

7 
	`¥öt_pgdú
();

8 
	`˝rötf
("pgdirÖass.\n");

10 
	}
}

	@user/priority.c

1 
	~<ulib.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<°dlib.h
>

6 
	#TOTAL
 5

	)

8 
	#MAX_TIME
 2000

	)

9 
	#SLEEP_TIME
 400

	)

10 
	gacc
[
TOTAL
];

11 
	g°©us
[
TOTAL
];

12 
	gpids
[
TOTAL
];

15 
	$•ö_dñay
()

17 
i
;

18 vﬁ©ûê
j
;

19 
i
 = 0; i != 200; ++ i)

21 
j
 = !j;

23 
	}
}

26 
	$maö
() {

27 
i
,
time
;

28 
	`˝rötf
("¥i‹ôyÖro˚s†wû»¶ì∞%dÅicks\n",
SLEEP_TIME
);

29 
	`¶ìp
(
SLEEP_TIME
);

30 
	`mem£t
(
pids
, 0, (pids));

31 
	`œb6_£t_¥i‹ôy
(
TOTAL
 + 1);

33 
i
 = 0; i < 
TOTAL
; i ++) {

34 
acc
[
i
]=0;

35 i‡((
pids
[
i
] = 
	`f‹k
()) == 0) {

36 
	`œb6_£t_¥i‹ôy
(
i
 + 1);

37 
acc
[
i
] = 0;

39 
	`•ö_dñay
();

40 ++ 
acc
[
i
];

41 if(
acc
[
i
]%4000==0) {

42 if((
time
=
	`gëtime_m£c
())>
MAX_TIME
) {

43 
	`˝rötf
("chûdÖid %d,ác¯%d,Åimê%d\n",
	`gëpid
(),
acc
[
i
],
time
);

44 
	`exô
(
acc
[
i
]);

50 i‡(
pids
[
i
] < 0) {

51 
Áûed
;

55 
	`˝rötf
("main: fork ok,nowÇeedÅo waitÖids.\n");

57 
i
 = 0; i < 
TOTAL
; i ++) {

58 
°©us
[
i
]=0;

59 
	`waôpid
(
pids
[
i
],&
°©us
[i]);

60 
	`˝rötf
("maö:Öid %d,ác¯%d,Åimê%d\n",
pids
[
i
],
°©us
[i],
	`gëtime_m£c
());

62 
	`˝rötf
("main: waitÖids over\n");

63 
	`˝rötf
("stride sched correctÑesult:");

64 
i
 = 0; i < 
TOTAL
; i ++)

66 
	`˝rötf
(" %d", (
°©us
[
i
] * 2 / status[0] + 1) / 2);

68 
	`˝rötf
("\n");

72 
Áûed
:

73 
i
 = 0; i < 
TOTAL
; i ++) {

74 i‡(
pids
[
i
] > 0) {

75 
	`kûl
(
pids
[
i
]);

78 
	`∑nic
("FAIL: T.T\n");

79 
	}
}

	@user/sh.c

1 
	~<ulib.h
>

2 
	~<°dio.h
>

3 
	~<°rög.h
>

4 
	~<dú.h
>

5 
	~<fûe.h
>

6 
	~<îr‹.h
>

7 
	~<uni°d.h
>

9 
	#¥ötf
(...Ë
	`Ârötf
(1, 
__VA_ARGS__
)

	)

10 
	#putc
(
c
Ë
	`¥ötf
("%c", c)

	)

12 
	#BUFSIZE
 4096

	)

13 
	#WHITESPACE
 " \t\r\n"

	)

14 
	#SYMBOLS
 "<|>&;"

	)

16 
	gshcwd
[
BUFSIZE
];

19 
	$gëtokí
(**
p1
, **
p2
) {

20 *
s
;

21 i‡((
s
 = *
p1
Ë=
NULL
) {

24 
	`°rchr
(
WHITESPACE
, *
s
Ë!
NULL
) {

25 *
s
 ++ = '\0';

27 i‡(*
s
 == '\0') {

31 *
p2
 = 
s
;

32 
tokí
 = 'w';

33 i‡(
	`°rchr
(
SYMBOLS
, *
s
Ë!
NULL
) {

34 
tokí
 = *
s
, *s ++ = '\0';

37 
boﬁ
 
Êag
 = 0;

38 *
s
 !'\0' && (
Êag
 || 
	`°rchr
(
WHITESPACE
 
SYMBOLS
, *sË=
NULL
)) {

39 i‡(*
s
 == '"') {

40 *
s
 = ' ', 
Êag
 = !flag;

42 
s
 ++;

45 *
p1
 = (*
s
 !'\0' ? s : 
NULL
);

46  
tokí
;

47 
	}
}

50 
	$ªadlöe
(c⁄° *
¥om±
) {

51 
buf„r
[
BUFSIZE
];

52 i‡(
¥om±
 !
NULL
) {

53 
	`¥ötf
("%s", 
¥om±
);

55 
ªt
, 
i
 = 0;

57 
c
;

58 i‡((
ªt
 = 
	`ªad
(0, &
c
, ())) < 0) {

59  
NULL
;

61 i‡(
ªt
 == 0) {

62 i‡(
i
 > 0) {

63 
buf„r
[
i
] = '\0';

66  
NULL
;

69 i‡(
c
 == 3) {

70  
NULL
;

72 i‡(
c
 >' ' && 
i
 < 
BUFSIZE
 - 1) {

73 
	`putc
(
c
);

74 
buf„r
[
i
 ++] = 
c
;

76 i‡(
c
 ='\b' && 
i
 > 0) {

77 
	`putc
(
c
);

78 
i
 --;

80 i‡(
c
 == '\n' || c == '\r') {

81 
	`putc
(
c
);

82 
buf„r
[
i
] = '\0';

86  
buf„r
;

87 
	}
}

90 
	$ußge
() {

91 
	`¥ötf
("usage: sh [command-file]\n");

92 
	}
}

95 
	$ª›í
(
fd2
, c⁄° *
fûíame
, 
uöt32_t
 
›í_Êags
) {

96 
ªt
, 
fd1
;

97 
	`˛o£
(
fd2
);

98 i‡((
ªt
 = 
	`›í
(
fûíame
, 
›í_Êags
)Ë>0 &&Ñë !
fd2
) {

99 
	`˛o£
(
fd2
);

100 
fd1
 = 
ªt
,Ñë = 
	`dup2
(fd1, 
fd2
);

101 
	`˛o£
(
fd1
);

103  
ªt
 < 0 ?Ñet : 0;

104 
	}
}

107 
	$ã°fûe
(c⁄° *
«me
) {

108 
ªt
;

109 i‡((
ªt
 = 
	`›í
(
«me
, 
O_RDONLY
)) < 0) {

110  
ªt
;

112 
	`˛o£
(
ªt
);

114 
	}
}

117 
	$runcmd
(*
cmd
) {

118 
¨gv0
[
BUFSIZE
];

119 c⁄° *
¨gv
[
EXEC_MAX_ARG_NUM
 + 1];

120 *
t
;

121 
¨gc
, 
tokí
, 
ªt
, 
p
[2];

122 
agaö
:

123 
¨gc
 = 0;

125 
tokí
 = 
	`gëtokí
(&
cmd
, &
t
)) {

127 i‡(
¨gc
 =
EXEC_MAX_ARG_NUM
) {

128 
	`¥ötf
("shÉrror:Åoo manyárguments\n");

131 
¨gv
[
¨gc
 ++] = 
t
;

134 i‡(
	`gëtokí
(&
cmd
, &
t
) != 'w') {

135 
	`¥ötf
("shÉrror: syntaxÉrror: <Çot followed by word\n");

138 i‡((
ªt
 = 
	`ª›í
(0, 
t
, 
O_RDONLY
)) != 0) {

139  
ªt
;

143 i‡(
	`gëtokí
(&
cmd
, &
t
) != 'w') {

144 
	`¥ötf
("shÉrror: syntaxÉrror: >Çot followed by word\n");

147 i‡((
ªt
 = 
	`ª›í
(1, 
t
, 
O_RDWR
 | 
O_TRUNC
 | 
O_CREAT
)) != 0) {

148  
ªt
;

155 i‡((
ªt
 = 
	`f‹k
()) == 0) {

156 
	`˛o£
(0);

157 i‡((
ªt
 = 
	`dup2
(
p
[0], 0)) < 0) {

158  
ªt
;

160 
	`˛o£
(
p
[0]), close(p[1]);

161 
agaö
;

164 i‡(
ªt
 < 0) {

165  
ªt
;

167 
	`˛o£
(1);

168 i‡((
ªt
 = 
	`dup2
(
p
[1], 1)) < 0) {

169  
ªt
;

171 
	`˛o£
(
p
[0]), close(p[1]);

172 
runô
;

176 
runô
;

178 i‡((
ªt
 = 
	`f‹k
()) == 0) {

179 
runô
;

182 i‡(
ªt
 < 0) {

183  
ªt
;

185 
	`waôpid
(
ªt
, 
NULL
);

186 
agaö
;

190 
	`¥ötf
("shÉº‹: badÑëu∫ %d from gëtokí\n", 
tokí
);

195 
runô
:

196 i‡(
¨gc
 == 0) {

199 i‡(
	`°rcmp
(
¨gv
[0], "cd") == 0) {

200 i‡(
¨gc
 != 2) {

203 
	`°r˝y
(
shcwd
, 
¨gv
[1]);

206 i‡((
ªt
 = 
	`ã°fûe
(
¨gv
[0])) != 0) {

207 i‡(
ªt
 !-
E_NOENT
) {

208  
ªt
;

210 
	`¢¥ötf
(
¨gv0
, ◊rgv0), "/%s", 
¨gv
[0]);

211 
¨gv
[0] = 
¨gv0
;

213 
¨gv
[
¨gc
] = 
NULL
;

214  
	`__exec
(
NULL
, 
¨gv
);

215 
	}
}

218 
	$maö
(
¨gc
, **
¨gv
) {

219 
	`¥ötf
("user sh isÑunning!!!");

220 
ªt
, 
öãø˘ive
 = 1;

221 i‡(
¨gc
 == 2) {

222 i‡((
ªt
 = 
	`ª›í
(0, 
¨gv
[1], 
O_RDONLY
)) != 0) {

223  
ªt
;

225 
öãø˘ive
 = 0;

227 i‡(
¨gc
 > 2) {

228 
	`ußge
();

232 
	`as£π
(
shcwd
 !
NULL
);

234 *
buf„r
;

235 (
buf„r
 = 
	`ªadlöe
((
öãø˘ive
Ë? "$ " : 
NULL
)) != NULL) {

236 
shcwd
[0] = '\0';

237 
pid
;

238 i‡((
pid
 = 
	`f‹k
()) == 0) {

239 
ªt
 = 
	`runcmd
(
buf„r
);

240 
	`exô
(
ªt
);

242 
	`as£π
(
pid
 >= 0);

243 i‡(
	`waôpid
(
pid
, &
ªt
) == 0) {

244 i‡(
ªt
 =0 && 
shcwd
[0] != '\0') {

245 
ªt
 = 0;

247 i‡(
ªt
 != 0) {

248 
	`¥ötf
("îr‹: %d - %e\n", 
ªt
,Ñet);

253 
	}
}

	@user/sleep.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

5 
	$¶ìpy
(
pid
) {

6 
i
, 
time
 = 100;

7 
i
 = 0; i < 10; i ++) {

8 
	`¶ìp
(
time
);

9 
	`˝rötf
("¶ì∞%d x %d sli˚s.\n", 
i
 + 1, 
time
);

11 
	`exô
(0);

12 
	}
}

15 
	$maö
() {

16 
time
 = 
	`gëtime_m£c
();

17 
pid1
, 
exô_code
;

19 i‡((
pid1
 = 
	`f‹k
()) == 0) {

20 
	`¶ìpy
(
pid1
);

23 
	`as£π
(
	`waôpid
(
pid1
, &
exô_code
) == 0 &&Éxit_code == 0);

24 
	`˝rötf
("u£ %04d m£cs.\n", 
	`gëtime_m£c
(Ë- 
time
);

25 
	`˝rötf
("sleepÖass.\n");

27 
	}
}

	@user/sleepkill.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

5 
	$maö
() {

6 
pid
;

7 i‡((
pid
 = 
	`f‹k
()) == 0) {

8 
	`¶ìp
(~0);

9 
	`exô
(0xdead);

11 
	`as£π
(
pid
 > 0);

13 
	`¶ìp
(100);

14 
	`as£π
(
	`kûl
(
pid
) == 0);

15 
	`˝rötf
("sleepkillÖass.\n");

17 
	}
}

	@user/softint.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

5 
	$maö
() {

6 
asm
 volatile("int $14");

7 
	`∑nic
("FAIL: T.T\n");

8 
	}
}

	@user/spin.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

5 
	$maö
() {

6 
pid
, 
ªt
, 
i
 ,
j
;

7 
	`˝rötf
("IámÅheÖarent. ForkingÅhe child...\n");

8 
pid
 = 
	`f‹k
();

9 i‡(
pid
== 0) {

10 
	`˝rötf
("IámÅhe child. spinning ...\n");

12 }i‡(
pid
<0) {

13 
	`∑nic
("fork childÉrror\n");

15 
	`˝rötf
("IámÅheÖarent. RunningÅhe child...\n");

17 
	`yõld
();

18 
	`yõld
();

19 
	`yõld
();

21 
	`˝rötf
("IámÅheÖarent. KillingÅhe child...\n");

23 
	`as£π
((
ªt
 = 
	`kûl
(
pid
)) == 0);

24 
	`˝rötf
("kû»ªtu∫†%d\n", 
ªt
);

26 
	`as£π
((
ªt
 = 
	`waôpid
(
pid
, 
NULL
)) == 0);

27 
	`˝rötf
("waôÑëu∫†%d\n", 
ªt
);

29 
	`˝rötf
("spin mayÖass.\n");

31 
	}
}

	@user/testbss.c

1 
	~<°dio.h
>

2 
	~<ulib.h
>

4 
	#ARRAYSIZE
 (1024*1024)

	)

6 
uöt32_t
 
	gbig¨øy
[
ARRAYSIZE
];

9 
	$maö
() {

10 
	`˝rötf
("Making sure bss worksÑight...\n");

11 
i
;

12 
i
 = 0; i < 
ARRAYSIZE
; i ++) {

13 i‡(
big¨øy
[
i
] != 0) {

14 
	`∑nic
("big¨øy[%d] i¢'à˛óªd!\n", 
i
);

17 
i
 = 0; i < 
ARRAYSIZE
; i ++) {

18 
big¨øy
[
i
] = i;

20 
i
 = 0; i < 
ARRAYSIZE
; i ++) {

21 i‡(
big¨øy
[
i
] != i) {

22 
	`∑nic
("big¨øy[%d] didn'àhﬁd it†vÆue!\n", 
i
);

26 
	`˝rötf
("Yes, good. Now doingá wild write offÅheÉnd...\n");

27 
	`˝rötf
("testbss mayÖass.\n");

29 
big¨øy
[
ARRAYSIZE
 + 1024] = 0;

30 
asm
 volatile ("int $0x14");

31 
	`∑nic
("FAIL: T.T\n");

32 
	}
}

	@user/waitkill.c

1 
	~<ulib.h
>

2 
	~<°dio.h
>

5 
	$do_yõld
() {

6 
	`yõld
();

7 
	`yõld
();

8 
	`yõld
();

9 
	`yõld
();

10 
	`yõld
();

11 
	`yõld
();

12 
	}
}

14 
	g∑ª¡
, 
	gpid1
, 
	gpid2
;

17 
	$lo›
() {

18 
	`˝rötf
("child 1.\n");

20 
	}
}

23 
	$w‹k
() {

24 
	`˝rötf
("child 2.\n");

25 
	`do_yõld
();

26 i‡(
	`kûl
(
∑ª¡
) == 0) {

27 
	`˝rötf
("killÖarent ok.\n");

28 
	`do_yõld
();

29 i‡(
	`kûl
(
pid1
) == 0) {

30 
	`˝rötf
("kill child1 ok.\n");

31 
	`exô
(0);

34 
	`exô
(-1);

35 
	}
}

38 
	$maö
() {

39 
∑ª¡
 = 
	`gëpid
();

40 i‡((
pid1
 = 
	`f‹k
()) == 0) {

41 
	`lo›
();

44 
	`as£π
(
pid1
 > 0);

46 i‡((
pid2
 = 
	`f‹k
()) == 0) {

47 
	`w‹k
();

49 i‡(
pid2
 > 0) {

50 
	`˝rötf
("wait child 1.\n");

51 
	`waôpid
(
pid1
, 
NULL
);

52 
	`∑nic
("waôpid %dÑëu∫s\n", 
pid1
);

55 
	`kûl
(
pid1
);

57 
	`∑nic
("FAIL: T.T\n");

58 
	}
}

	@user/yield.c

1 
	~<ulib.h
>

2 
	~<°dio.h
>

5 
	$maö
() {

6 
i
;

7 
	`˝rötf
("Hñlo, IámÖro˚s†%d.\n", 
	`gëpid
());

8 
i
 = 0; i < 5; i ++) {

9 
	`yõld
();

10 
	`˝rötf
("Back i¿¥o˚s†%d, iãøti⁄ %d.\n", 
	`gëpid
(), 
i
);

12 
	`˝rötf
("AŒ d⁄êöÖro˚s†%d.\n", 
	`gëpid
());

13 
	`˝rötf
("yieldÖass.\n");

15 
	}
}

	@
1
.
0
149
2615
boot/asm.h
boot/bootmain.c
kern/debug/assert.h
kern/debug/kdebug.c
kern/debug/kdebug.h
kern/debug/kmonitor.c
kern/debug/kmonitor.h
kern/debug/panic.c
kern/debug/stab.h
kern/driver/clock.c
kern/driver/clock.h
kern/driver/console.c
kern/driver/console.h
kern/driver/ide.c
kern/driver/ide.h
kern/driver/intr.c
kern/driver/intr.h
kern/driver/kbdreg.h
kern/driver/picirq.c
kern/driver/picirq.h
kern/fs/devs/dev.c
kern/fs/devs/dev.h
kern/fs/devs/dev_disk0.c
kern/fs/devs/dev_stdin.c
kern/fs/devs/dev_stdout.c
kern/fs/file.c
kern/fs/file.h
kern/fs/fs.c
kern/fs/fs.h
kern/fs/iobuf.c
kern/fs/iobuf.h
kern/fs/sfs/bitmap.c
kern/fs/sfs/bitmap.h
kern/fs/sfs/sfs.c
kern/fs/sfs/sfs.h
kern/fs/sfs/sfs_fs.c
kern/fs/sfs/sfs_inode.c
kern/fs/sfs/sfs_io.c
kern/fs/sfs/sfs_lock.c
kern/fs/swap/swapfs.c
kern/fs/swap/swapfs.h
kern/fs/sysfile.c
kern/fs/sysfile.h
kern/fs/vfs/inode.c
kern/fs/vfs/inode.h
kern/fs/vfs/vfs.c
kern/fs/vfs/vfs.h
kern/fs/vfs/vfsdev.c
kern/fs/vfs/vfsfile.c
kern/fs/vfs/vfslookup.c
kern/fs/vfs/vfspath.c
kern/init/asm.h
kern/init/init.c
kern/libs/readline.c
kern/libs/stdio.c
kern/libs/string.c
kern/mm/default_pmm.c
kern/mm/default_pmm.h
kern/mm/kmalloc.c
kern/mm/kmalloc.h
kern/mm/memlayout.h
kern/mm/mmu.h
kern/mm/pmm.c
kern/mm/pmm.h
kern/mm/swap.c
kern/mm/swap.h
kern/mm/swap_fifo.c
kern/mm/swap_fifo.h
kern/mm/vmm.c
kern/mm/vmm.h
kern/process/proc.c
kern/process/proc.h
kern/schedule/default_sched.c
kern/schedule/default_sched.h
kern/schedule/sched.c
kern/schedule/sched.h
kern/smp/ioapic.c
kern/smp/ioapic.h
kern/smp/lapic.c
kern/smp/lapic.h
kern/smp/mp.c
kern/smp/mp.h
kern/sync/check_sync.c
kern/sync/monitor.c
kern/sync/monitor.h
kern/sync/sem.c
kern/sync/sem.h
kern/sync/sync.h
kern/sync/wait.c
kern/sync/wait.h
kern/syscall/syscall.c
kern/syscall/syscall.h
kern/trap/trap.c
kern/trap/trap.h
libs/atomic.h
libs/defs.h
libs/dirent.h
libs/elf.h
libs/error.h
libs/hash.c
libs/list.h
libs/param.h
libs/printfmt.c
libs/rand.c
libs/skew_heap.h
libs/stat.h
libs/stdarg.h
libs/stdio.h
libs/stdlib.h
libs/string.c
libs/string.h
libs/unistd.h
libs/x86.h
tools/mksfs.c
tools/sign.c
tools/vector.c
user/badarg.c
user/badsegment.c
user/divzero.c
user/exit.c
user/faultread.c
user/faultreadkernel.c
user/forktest.c
user/forktree.c
user/hello.c
user/libs/dir.c
user/libs/dir.h
user/libs/file.c
user/libs/file.h
user/libs/lock.h
user/libs/panic.c
user/libs/stdio.c
user/libs/syscall.c
user/libs/syscall.h
user/libs/ulib.c
user/libs/ulib.h
user/libs/umain.c
user/ls.c
user/matrix.c
user/pgdir.c
user/priority.c
user/sh.c
user/sleep.c
user/sleepkill.c
user/softint.c
user/spin.c
user/testbss.c
user/waitkill.c
user/yield.c
